<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù‡ÙƒØ± Ø§Ù„ÙˆØ²Ø§Ø±ÙŠ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #4F46E5;
            --primary-dark: #4338ca;
            --secondary: #10B981;
            --bg-app: #f8fafc;
            --gold: #FFD700;
        }

        body {
            font-family: 'Tajawal', sans-serif;
            background-color: var(--bg-app);
            overflow: hidden; 
            user-select: none;
            -webkit-user-select: none;
            touch-action: manipulation;
            height: 100vh;
            width: 100vw;
            margin: 0; padding: 0;
            overscroll-behavior: none;
        }

        .screen {
            display: none; 
            height: 100vh; 
            width: 100vw;
            position: absolute; 
            top: 0; 
            left: 0; 
            background: var(--bg-app); 
            z-index: 10;
            opacity: 0;
            transform: scale(0.98);
            transition: opacity 0.25s ease-out, transform 0.25s ease-out;
            will-change: opacity, transform;
        }
        .screen.active { 
            display: block; 
            z-index: 20; 
            opacity: 1;
            transform: scale(1);
        }

        .scroll-container {
            height: 100%;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 250px; 
        }
        .scroll-container::-webkit-scrollbar { display: none; }
        .scroll-container { -ms-overflow-style: none; scrollbar-width: none; }

        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes pulse-border { 0% { box-shadow: 0 0 0 0 rgba(79, 70, 229, 0.7); } 70% { box-shadow: 0 0 0 6px rgba(79, 70, 229, 0); } 100% { box-shadow: 0 0 0 0 rgba(79, 70, 229, 0); } }
        @keyframes spin-slow { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        @keyframes glitch { 0% { opacity: 1; transform: translate(0); } 20% { opacity: 0.8; transform: translate(-2px, 2px); } 40% { opacity: 1; transform: translate(2px, -2px); } 60% { opacity: 0.9; transform: translate(-1px, 1px); } 80% { opacity: 1; transform: translate(1px, -1px); } 100% { opacity: 1; transform: translate(0); } }

        @keyframes slideInLeft { from { transform: translateX(-100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes zoomInBounce { 0% { transform: scale(0); opacity: 0; } 60% { transform: scale(1.2); opacity: 1; } 100% { transform: scale(1); } }

        .bg-medical { background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%); position: relative; overflow: hidden; }
        .bg-medical::before { content: 'âœš'; position: absolute; font-size: 40px; color: rgba(14, 165, 233, 0.2); animation: float 3s infinite; top: 10px; left: 10px; }
        .bg-medical::after { content: 'ğŸ’Š'; position: absolute; font-size: 30px; opacity: 0.3; animation: spin-slow 10s infinite; bottom: 10px; right: 10px; }
        
        .bg-law { background: linear-gradient(135deg, #fef3c7 0%, #d97706 100%); position: relative; overflow: hidden; }
        .bg-law::before { content: 'âš–ï¸'; position: absolute; font-size: 40px; opacity: 0.3; animation: float 4s infinite; top: 5px; right: 20px; }
        .bg-law::after { content: 'ğŸ“œ'; position: absolute; font-size: 30px; opacity: 0.3; animation: float 5s infinite reverse; bottom: 5px; left: 20px; }

        .bg-edu { background: linear-gradient(135deg, #dcfce7 0%, #4ade80 100%); position: relative; overflow: hidden; }
        .bg-edu::before { content: 'ğŸ“š'; position: absolute; font-size: 35px; opacity: 0.3; animation: float 3s infinite; top: 10px; left: 20px; }
        .bg-edu::after { content: 'âœï¸'; position: absolute; font-size: 30px; opacity: 0.3; animation: float 4s infinite reverse; bottom: 10px; right: 20px; }

        .bg-eng { background: linear-gradient(135deg, #fef9c3 0%, #facc15 100%); position: relative; overflow: hidden; }
        .bg-eng::before { content: 'ğŸ“'; position: absolute; font-size: 35px; opacity: 0.3; animation: spin-slow 8s infinite; top: 5px; left: 10px; }
        .bg-eng::after { content: 'âš™ï¸'; position: absolute; font-size: 40px; opacity: 0.2; animation: spin-slow 4s infinite reverse; bottom: 5px; right: 10px; }

        .bg-smart { background: linear-gradient(135deg, #ffedd5 0%, #fb923c 100%); position: relative; overflow: hidden; }
        .bg-smart::before { content: 'ğŸ’¡'; position: absolute; font-size: 40px; opacity: 0.4; animation: pulse-border 2s infinite; top: 10px; right: 10px; }
        .bg-smart::after { content: 'ğŸ§ '; position: absolute; font-size: 30px; opacity: 0.3; animation: float 3s infinite; bottom: 10px; left: 10px; }

        .bg-love { background: linear-gradient(135deg, #fce7f3 0%, #f472b6 100%); position: relative; overflow: hidden; }
        .bg-love::before { content: 'â¤'; position: absolute; font-size: 20px; color: rgba(255,255,255,0.6); animation: float 2s infinite; top: 20px; left: 20%; }
        .bg-love::after { content: 'ğŸ’–'; position: absolute; font-size: 30px; opacity: 0.5; animation: float 3s infinite reverse; bottom: 10px; right: 20%; }

        .bg-rank-default { background: white; }

        .premium-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            color: white;
            font-size: 0.6rem;
            font-weight: bold;
            margin-right: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            vertical-align: middle;
        }

        .auth-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 9999; display: flex;
            align-items: center; justify-content: center;
        }

        .input-box {
            background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px;
            padding: 14px; width: 100%; outline: none; font-size: 1rem; transition: border-color 0.2s;
        }
        .input-box:focus { border-color: var(--primary); background: white; }

        .btn-main {
            background: var(--primary); color: white; padding: 14px;
            border-radius: 12px; font-weight: bold; width: 100%;
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.2); transition: transform 0.1s, background-color 0.2s;
            text-align: center; border: none; cursor: pointer;
            display: flex; justify-content: center; align-items: center; gap: 8px;
        }
        .btn-main:active { transform: scale(0.98); }
        .btn-main:hover { background-color: var(--primary-dark); }

        .nav-item.active { color: var(--primary); transform: translateY(-2px); }
        .nav-item { position: relative; transition: all 0.2s; } 
        
        .stat-btn {
            background: white; border: 1px solid #eee; padding: 15px; border-radius: 16px;
            display: flex; align-items: center; justify-content: space-between;
            width: 100%; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.02);
            transition: all 0.2s; position: relative; cursor: pointer;
        }
        .stat-btn:active { transform: scale(0.98); background-color: #f9fafb; }

        .red-dot {
            position: absolute; top: -2px; right: 25%;
            width: 10px; height: 10px; background-color: #ef4444;
            border-radius: 50%; border: 2px solid white;
            display: none; z-index: 50;
        }
        .red-dot.visible { display: block; }
        .btn-dot {
            position: absolute; top: 0; right: 0;
            width: 10px; height: 10px; background-color: #ef4444;
            border-radius: 50%; border: 2px solid white;
            display: none; z-index: 50;
        }
        .btn-dot.visible { display: block; }

        .hacker-avatar {
            font-size: 80px;
            color: #1e293b;
            position: relative;
            animation: float 3s ease-in-out infinite;
            margin-bottom: 20px;
        }
        .hacker-avatar .fa-user-secret {
            filter: drop-shadow(0 0 15px rgba(79, 70, 229, 0.5));
        }
        .hacker-text-intro {
            font-size: 2.5rem; font-weight: 900;
            background: linear-gradient(to right, #4F46E5, #9333EA);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            text-shadow: 0 0 20px rgba(79, 70, 229, 0.3);
            animation: glitch 3s infinite;
        }

        .auth-tabs {
            display: flex; background: #f1f5f9; padding: 4px;
            border-radius: 14px; margin-bottom: 24px;
        }
        .auth-tab {
            flex: 1; text-align: center; padding: 10px;
            font-weight: bold; color: #64748b; cursor: pointer;
            border-radius: 10px; transition: all 0.3s; font-size: 0.95rem;
        }
        .auth-tab.active {
            background: white; color: var(--primary);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .rank-img-container { 
            position: relative; display: flex; align-items: center; justify-content: center;
            width: 60px; height: 60px; margin-right: 5px;
        }
        .rank-img { 
            width: 48px; height: 48px; border-radius: 50%; object-fit: cover;
            padding: 2px; background: white; position: relative; z-index: 5;
        }
        .rank-badge-top {
            position: absolute; top: -5px; left: 50%; transform: translateX(-50%);
            background: #1f2937; color: white; font-size: 10px; font-weight: 900;
            padding: 2px 6px; border-radius: 8px; border: 2px solid white; z-index: 20;
            min-width: 20px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .rank-rays {
            position: absolute; inset: 0; border-radius: 50%; z-index: 1; 
            animation: spin-slow 10s linear infinite;
            mask-image: radial-gradient(transparent 58%, black 60%); 
            -webkit-mask-image: radial-gradient(transparent 58%, black 60%);
            opacity: 0.8;
        }
        .rays-gold { background: repeating-conic-gradient(from 0deg, #FFD700 0deg 10deg, transparent 10deg 20deg); }
        .rays-silver { background: repeating-conic-gradient(from 0deg, #C0C0C0 0deg 10deg, transparent 10deg 20deg); }
        .rays-bronze { background: repeating-conic-gradient(from 0deg, #CD7F32 0deg 10deg, transparent 10deg 20deg); }
        .rays-blue { background: repeating-conic-gradient(from 0deg, #3b82f6 0deg 10deg, transparent 10deg 20deg); }
        .rays-red { background: repeating-conic-gradient(from 0deg, #ef4444 0deg 10deg, transparent 10deg 20deg); }
        .rays-green { background: repeating-conic-gradient(from 0deg, #22c55e 0deg 10deg, transparent 10deg 20deg); }
        .rays-purple { background: repeating-conic-gradient(from 0deg, #a855f7 0deg 10deg, transparent 10deg 20deg); }
        
        .frame-rank-1 { border: 3px solid #FFD700; }
        .frame-rank-2 { border: 3px solid #C0C0C0; }
        .frame-rank-3 { border: 3px solid #CD7F32; }
        .frame-rank-common { border: 2px solid #e2e8f0; }
        .frame-rank-other-top { border: 2px solid #6366f1; }
        .name-crown { margin-right: 6px; font-size: 14px; animation: bounce 2s infinite; display: inline-block; }

        .reward-overlay { background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); }
        .reward-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; margin-bottom: 20px; }
        .day-box {
            background: #f1f5f9; border-radius: 8px; padding: 6px 2px;
            text-align: center; position: relative; border: 2px solid transparent;
            transition: all 0.2s; display: flex; flex-direction: column;
            align-items: center; justify-content: center; min-height: 50px;
        }
        .day-box p { font-size: 0.6rem; color: #94a3b8; font-weight: bold; margin-bottom: 2px; }
        .day-box span { font-size: 0.7rem; font-weight: 900; display: block; line-height: 1.1; }
        .day-box.claimed { background: #10B981; border-color: #059669; }
        .day-box.claimed p, .day-box.claimed span { color: white; }
        .day-box.claimed::after { content: 'âœ”'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: rgba(255,255,255,0.3); font-size: 20px; }
        .day-box.active { background: #FFFBEB; border-color: #F59E0B; transform: scale(1.05); box-shadow: 0 4px 10px rgba(245, 158, 11, 0.3); z-index: 10; }
        .day-box.active span { color: #D97706; }
        .day-box.active p { color: #D97706; }
        .day-box.locked { opacity: 0.6; }

        .new-maintenance-overlay {
            position: fixed; inset: 0; z-index: 11000;
            background: rgba(15, 23, 42, 0.95); 
            backdrop-filter: blur(15px);
            display: flex; align-items: center; justify-content: center;
        }
        .new-maintenance-card {
            background: linear-gradient(145deg, #ffffff, #f8fafc);
            border: 2px solid rgba(255, 255, 255, 0.8);
            border-radius: 32px;
            padding: 40px 30px;
            width: 90%; max-width: 400px;
            text-align: center;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5), inset 0 0 20px rgba(255, 255, 255, 0.8);
            position: relative; overflow: hidden;
            animation: slideUp 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .maint-icon-wrapper {
            position: relative; z-index: 1;
            width: 100px; height: 100px; margin: 0 auto 20px;
            background: linear-gradient(135deg, #EF4444 0%, #B91C1C 100%);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 10px 30px rgba(239, 68, 68, 0.5);
            border: 4px solid white;
        }
        .maint-icon-wrapper i { font-size: 40px; color: white; animation: pulse-border 2s infinite; }
        .maint-title { 
            position: relative; z-index: 1; 
            font-size: 1.8rem; font-weight: 900; color: #1e293b; margin-bottom: 10px; 
            background: linear-gradient(to right, #EF4444, #B91C1C);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }

        .ban-overlay {
            position: fixed; inset: 0; z-index: 20000;
            background: #0f172a;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center; color: white; padding: 20px;
        }
        .ban-icon { font-size: 80px; color: #ef4444; margin-bottom: 20px; }

        .toggle-wrapper { position: relative; width: 50px; height: 26px; }
        .toggle-checkbox { opacity: 0; width: 0; height: 0; }
        .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #9CA3AF; transition: .4s; border-radius: 34px; }
        .toggle-slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        .toggle-checkbox:checked + .toggle-slider { background-color: #10B981; }
        .toggle-checkbox:checked + .toggle-slider:before { transform: translateX(24px); }
        
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5); 
            z-index: 12000; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(5px);
        }
        .modal-content {
            background: white; width: 90%; max-width: 500px; max-height: 90vh;
            border-radius: 20px; padding: 20px; overflow-y: auto;
            animation: slideUp 0.3s ease-out; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        .answer-correct { background: #DCFCE7 !important; border-color: #22C55E !important; color: #166534 !important; position: relative; }
        .answer-correct::after { content: 'âœ“'; position: absolute; left: 15px; font-size: 1.2rem; font-weight: bold; color: #22C55E; }
        .answer-wrong { background: #FEE2E2 !important; border-color: #EF4444 !important; color: #991B1B !important; position: relative; }
        .answer-wrong::after { content: 'âœ—'; position: absolute; left: 15px; font-size: 1.2rem; font-weight: bold; color: #EF4444; }
        .answer-neutral { background: white !important; border-color: #E5E7EB !important; color: #374151 !important; }

        .countdown-container {
            background: linear-gradient(to right, #1e293b, #0f172a);
            color: white; padding: 10px; border-radius: 12px;
            margin-bottom: 15px; text-align: center;
            border: 2px solid #ffd700;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.2);
        }
        .timer-digits { font-family: monospace; font-size: 1.5rem; font-weight: bold; color: #ffd700; letter-spacing: 2px; }

        .vs-screen-overlay {
            position: fixed; inset: 0; z-index: 15000;
            background: radial-gradient(circle at center, #2e1065, #0f172a);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            overflow: hidden;
        }
        .vs-player-card {
            display: flex; flex-direction: column; align-items: center;
            z-index: 10;
        }
        .vs-avatar {
            width: 100px; height: 100px; border-radius: 50%;
            border: 4px solid #fff; box-shadow: 0 0 20px rgba(79, 70, 229, 0.6);
            object-fit: cover; background: #fff;
        }
        .vs-text { font-size: 5rem; font-weight: 900; color: #ffd700; text-shadow: 0 0 30px #d97706; font-style: italic; z-index: 20; }
        .animate-slide-left { animation: slideInLeft 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        .animate-slide-right { animation: slideInRight 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        .animate-zoom-bounce { animation: zoomInBounce 0.8s 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) both; }
        
        .game-avatar-small {
            width: 32px; height: 32px; border-radius: 50%; border: 2px solid white;
            object-fit: cover; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: inline-block; vertical-align: middle;
        }

        .room-code-display {
            font-family: monospace;
            font-size: 2rem;
            font-weight: 900;
            letter-spacing: 5px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            padding: 10px 20px;
            border: 3px dashed #667eea;
            border-radius: 15px;
            text-align: center;
            margin: 20px auto;
            display: inline-block;
        }

        .ready-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 12px;
            font-weight: bold;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        .ready-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }

        .ready-btn:active {
            transform: translateY(0);
        }

        .ready-btn.not-ready {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }

        .room-user-card {
            background: white;
            border-radius: 15px;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            border: 2px solid #e5e7eb;
            transition: all 0.3s;
        }

        .room-user-card.ready {
            border-color: #10b981;
            background: #f0fdf4;
        }

        .room-user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 3px solid #e5e7eb;
            object-fit: cover;
        }

        .room-user-card.ready .room-user-avatar {
            border-color: #10b981;
        }

        .room-counter {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9rem;
            backdrop-filter: blur(10px);
        }

        .beautiful-modal {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-radius: 25px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.15);
            border: 1px solid rgba(255,255,255,0.5);
            position: relative;
            overflow: hidden;
        }

        .beautiful-modal::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, #4f46e5, #9333ea);
            border-radius: 0 25px 0 100px;
            opacity: 0.1;
        }

        .beautiful-modal h3 {
            color: #1e293b;
            font-weight: 900;
            font-size: 1.5rem;
            margin-bottom: 20px;
            text-align: center;
            position: relative;
            z-index: 1;
        }

        .beautiful-btn {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 12px;
            font-weight: bold;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(79, 70, 229, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            margin-top: 15px;
        }

        .beautiful-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(79, 70, 229, 0.4);
        }

        .beautiful-btn:active {
            transform: translateY(0);
        }

        .beautiful-btn.secondary {
            background: linear-gradient(135deg, #64748b 0%, #475569 100%);
            box-shadow: 0 4px 15px rgba(100, 116, 139, 0.3);
        }

        .withdraw-btn {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            font-weight: bold;
            font-size: 1rem;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
            z-index: 100;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .withdraw-btn:hover {
            transform: translateX(-50%) translateY(-2px);
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.5);
        }

        .withdraw-btn:active {
            transform: translateX(-50%) translateY(0);
        }

        .premium-timer-container {
            background: linear-gradient(135deg, #0f172a, #1e293b);
            color: white;
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
            border: 2px solid #f59e0b;
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
        }

        .premium-timer-digits {
            font-family: monospace;
            font-size: 1.8rem;
            font-weight: bold;
            color: #fbbf24;
            letter-spacing: 3px;
        }

        .beautiful-alert {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
            border: 2px solid #e5e7eb;
            z-index: 20000;
            text-align: center;
            animation: slideUp 0.3s ease-out;
        }

        .beautiful-alert-icon {
            font-size: 60px;
            margin-bottom: 20px;
        }

        .beautiful-alert.success .beautiful-alert-icon {
            color: #10b981;
        }

        .beautiful-alert.error .beautiful-alert-icon {
            color: #ef4444;
        }

        .beautiful-alert.warning .beautiful-alert-icon {
            color: #f59e0b;
        }

        .beautiful-alert.info .beautiful-alert-icon {
            color: #3b82f6;
        }

        .beautiful-alert h3 {
            color: #1e293b;
            font-weight: 900;
            font-size: 1.4rem;
            margin-bottom: 15px;
        }

        .beautiful-alert p {
            color: #64748b;
            font-size: 1rem;
            line-height: 1.5;
            margin-bottom: 25px;
        }

        .beautiful-alert-btn {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 10px;
            font-weight: bold;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
        }

        .beautiful-alert-btn:hover {
            opacity: 0.9;
        }

        .result-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 30px;
            max-width: 500px;
            margin: 0 auto;
        }

        .result-emoji {
            font-size: 80px;
            margin-bottom: 20px;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }

        .result-title {
            font-size: 2.5rem;
            font-weight: 900;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #4f46e5, #9333ea);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .result-subtitle {
            font-size: 1.2rem;
            color: #64748b;
            margin-bottom: 30px;
            font-weight: 500;
        }

        .result-score-container {
            display: flex;
            justify-content: space-around;
            align-items: center;
            width: 100%;
            max-width: 400px;
            margin: 30px 0;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            padding: 20px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
        }

        .result-player {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .result-player-name {
            font-size: 0.9rem;
            color: #64748b;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .result-player-score {
            font-size: 3rem;
            font-weight: 900;
            color: #4f46e5;
        }

        .result-player.op .result-player-score {
            color: #ef4444;
        }

        .result-vs {
            font-size: 1.5rem;
            font-weight: 900;
            color: #94a3b8;
            margin: 0 20px;
        }

        .result-points-gained {
            background: linear-gradient(135deg, #fef3c7 0%, #fbbf24 100%);
            padding: 15px 30px;
            border-radius: 50px;
            font-weight: 900;
            font-size: 1.5rem;
            color: #92400e;
            margin: 20px 0;
            box-shadow: 0 5px 15px rgba(251, 191, 36, 0.3);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .banned-user-item {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
            border: 1px solid #fee2e2;
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
        }

        .banned-user-info {
            flex: 1;
        }

        .banned-user-name {
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 5px;
        }

        .banned-user-id {
            font-size: 0.8rem;
            color: #6b7280;
        }

        .unban-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .unban-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(16, 185, 129, 0.3);
        }

        .table-schedule {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            font-size: 12px;
        }
        .table-schedule th, .table-schedule td {
            border: 1px solid #e2e8f0;
            padding: 6px 4px;
            text-align: center;
        }
        .table-schedule th {
            background: #f1f5f9;
            font-weight: bold;
            color: #475569;
        }
        .table-schedule td {
            background: white;
        }
        .schedule-header {
            text-align: center;
            font-size: 16px;
            font-weight: 900;
            margin-bottom: 5px;
            color: #1e293b;
        }
        .schedule-subheader {
            text-align: center;
            font-size: 12px;
            color: #64748b;
            margin-bottom: 15px;
        }
        .schedule-footer {
            margin-top: 15px;
            display: flex;
            justify-content: space-between;
            font-size: 11px;
        }
        .schedule-footer-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
        }
        .watermark {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-45deg);
            font-size: 40px;
            color: rgba(0, 0, 0, 0.08);
            font-weight: bold;
            white-space: nowrap;
            pointer-events: none;
            z-index: 1;
        }

        .upload-question-item {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            border: 1px solid #e5e7eb;
        }
        .upload-question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid #f1f5f9;
        }
        .upload-question-grade {
            background: #3b82f6;
            color: white;
            padding: 3px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: bold;
        }
        .upload-question-subject {
            background: #10b981;
            color: white;
            padding: 3px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: bold;
        }
        .upload-question-type {
            background: #f59e0b;
            color: white;
            padding: 3px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: bold;
        }
        .upload-question-text {
            font-weight: bold;
            margin-bottom: 10px;
            padding-right: 10px;
            border-right: 3px solid #e5e7eb;
        }
        .upload-question-answers {
            background: #f8fafc;
            padding: 8px;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        .upload-question-answer {
            padding: 5px;
            margin-bottom: 3px;
            border-radius: 5px;
        }
        .upload-question-correct {
            background: #d1fae5;
            border: 1px solid #10b981;
        }
        .upload-question-buttons {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }
        .upload-accept-btn {
            background: #10b981;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            flex: 1;
        }
        .upload-reject-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            flex: 1;
        }
        .upload-sender {
            font-size: 11px;
            color: #6b7280;
            margin-top: 5px;
        }

        .auth-loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100000;
            backdrop-filter: blur(5px);
        }
        .auth-loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid #e2e8f0;
            border-top: 3px solid #4f46e5;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .points-negative {
            color: #ef4444 !important;
            animation: pulse-red 1s infinite;
        }
        @keyframes pulse-red {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .withdraw-game-btn {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            font-weight: bold;
            font-size: 1rem;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
            z-index: 100;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .withdraw-game-btn:hover {
            transform: translateX(-50%) translateY(-2px);
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.5);
        }

        .withdraw-game-btn:active {
            transform: translateX(-50%) translateY(0);
        }

        @media (min-width: 768px) {
            .input-box { font-size: 1.1rem; }
            .auth-overlay > div { max-width: 500px; }
        }
        
        /* Ø£Ø¶Ù Ù‡Ø°Ù‡ Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ø¯Ø§Ø®Ù„ Ø§Ù„Ù€ style */
#notifications-btn {
    position: relative;
    transition: transform 0.2s;
}

#notifications-btn:active {
    transform: scale(0.95);
}

.notification-item {
    background: white;
    border-radius: 16px;
    padding: 16px;
    margin-bottom: 12px;
    border: 1px solid #e5e7eb;
    position: relative;
    transition: all 0.2s;
    box-shadow: 0 2px 8px rgba(0,0,0,0.03);
}

.notification-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.06);
}

.notification-item.unread {
    background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
    border-left: 4px solid #3b82f6;
}

.notification-item.read {
    opacity: 0.8;
    background: #f9fafb;
}

.notification-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}

.notification-title {
    font-weight: 800;
    color: #1f2937;
    font-size: 0.95rem;
}

.notification-time {
    font-size: 0.7rem;
    color: #6b7280;
}

.notification-message {
    color: #4b5563;
    font-size: 0.85rem;
    line-height: 1.5;
    padding-left: 8px;
    border-left: 2px solid #e5e7eb;
}

.notification-type-icon {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-left: 12px;
    flex-shrink: 0;
}

.notification-type-icon.trophy {
    background: linear-gradient(135deg, #fbbf24, #f59e0b);
    color: white;
}

.notification-type-icon.game {
    background: linear-gradient(135deg, #10b981, #059669);
    color: white;
}

.notification-type-icon.system {
    background: linear-gradient(135deg, #8b5cf6, #7c3aed);
    color: white;
}

.notification-type-icon.friend {
    background: linear-gradient(135deg, #ec4899, #db2777);
    color: white;
}

.notification-dot {
    position: absolute;
    top: 16px;
    right: 16px;
    width: 8px;
    height: 8px;
    background-color: #3b82f6;
    border-radius: 50%;
}

.empty-notifications {
    text-align: center;
    padding: 60px 20px;
    color: #9ca3af;
}

.empty-notifications i {
    font-size: 48px;
    margin-bottom: 16px;
    opacity: 0.5;
}
        
        /* Ø£Ù†Ù…Ø§Ø· Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª */
#notifications-btn {
    position: relative;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
}

#notifications-btn:hover {
    background-color: #f3f4f6;
}

#notifications-btn:active {
    transform: scale(0.95);
}

#notification-badge {
    width: 10px;
    height: 10px;
    background: linear-gradient(135deg, #ef4444, #dc2626);
    border: 2px solid white;
    animation: pulse-red 1.5s infinite;
}

@keyframes pulse-red {
    0% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.2); opacity: 0.8; }
    100% { transform: scale(1); opacity: 1; }
}

.notification-item {
    animation: slideInRight 0.3s ease-out;
}

@keyframes slideInRight {
    from {
        transform: translateX(20px);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

/* Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ù‚Ø³Ù… CSS Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ */

/* ØªØµÙ…ÙŠÙ… Ø§Ù„ØºØ±ÙØ© */
.room-container {
    max-width: 500px;
    margin: 0 auto;
}

.room-header {
    background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
    border-radius: 20px;
    padding: 20px;
    color: white;
    text-align: center;
    margin-bottom: 20px;
    position: relative;
    overflow: hidden;
}

.room-header::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle, rgba(255,255,255,0.1) 1px, transparent 1px);
    background-size: 20px 20px;
    animation: float 3s infinite linear;
    opacity: 0.3;
}

.room-code-display {
    font-family: 'Courier New', monospace;
    font-size: 2.5rem;
    font-weight: 900;
    letter-spacing: 5px;
    background: linear-gradient(135deg, #ffd700 0%, #ff9800 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    padding: 10px 20px;
    border: 3px dashed #ff9800;
    border-radius: 15px;
    text-align: center;
    margin: 20px auto;
    display: inline-block;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
}

.room-user-card {
    background: white;
    border-radius: 15px;
    padding: 15px;
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 15px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    border: 2px solid #e5e7eb;
    transition: all 0.3s;
}

.room-user-card.ready {
    border-color: #10b981;
    background: #f0fdf4;
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(16, 185, 129, 0.15);
}

.room-user-avatar {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    border: 3px solid #e5e7eb;
    object-fit: cover;
    transition: all 0.3s;
}

.room-user-card.ready .room-user-avatar {
    border-color: #10b981;
    box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.3);
}

.room-counter {
    position: fixed;
    top: 20px;
    left: 20px;
    background: rgba(0,0,0,0.7);
    color: white;
    padding: 8px 20px;
    border-radius: 25px;
    font-weight: bold;
    font-size: 1rem;
    backdrop-filter: blur(10px);
    z-index: 100;
    border: 2px solid #4f46e5;
}

/* Ø²Ø± Ø§Ù„Ø¬Ø§Ù‡Ø² */
.ready-btn {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    border: none;
    padding: 15px 30px;
    border-radius: 12px;
    font-weight: bold;
    font-size: 1.1rem;
    cursor: pointer;
    transition: all 0.3s;
    box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    width: 100%;
}

.ready-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
}

.ready-btn:active {
    transform: translateY(0);
}

.ready-btn.not-ready {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
}

/* Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† */
.users-status {
    background: white;
    border-radius: 15px;
    padding: 15px;
    text-align: center;
    margin: 20px 0;
    border: 2px solid #e5e7eb;
}

.status-count {
    font-size: 2.5rem;
    font-weight: 900;
    color: #4f46e5;
    line-height: 1;
}

.status-text {
    font-size: 0.9rem;
    color: #64748b;
    margin-top: 5px;
}

/* ØªØ­Ø³ÙŠÙ† Ø´Ø§Ø´Ø© Ø¥Ù†Ø´Ø§Ø¡/Ø§Ù†Ø¶Ù…Ø§Ù… Ø§Ù„ØºØ±ÙØ© */
.room-form-card {
    background: white;
    border-radius: 25px;
    padding: 30px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.1);
    border: 1px solid rgba(255,255,255,0.5);
    position: relative;
    overflow: hidden;
}

.room-form-card::before {
    content: '';
    position: absolute;
    top: 0;
    right: 0;
    width: 100px;
    height: 100px;
    background: linear-gradient(135deg, #4f46e5, #9333ea);
    border-radius: 0 25px 0 100px;
    opacity: 0.1;
}

/* ØªØµÙ…ÙŠÙ… Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† */
.user-list {
    max-height: 400px;
    overflow-y: auto;
    padding-right: 10px;
}

.user-list::-webkit-scrollbar {
    width: 6px;
}

.user-list::-webkit-scrollbar-track {
    background: #f1f5f9;
    border-radius: 10px;
}

.user-list::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 10px;
}

.user-list::-webkit-scrollbar-thumb:hover {
    background: #94a3b8;
}

/* Ø±Ø³Ø§Ù„Ø© ÙØ§Ø±ØºØ© */
.empty-state {
    text-align: center;
    padding: 40px 20px;
    color: #64748b;
}

.empty-state-icon {
    font-size: 60px;
    margin-bottom: 15px;
    opacity: 0.5;
}

    </style>
</head>
<body>

    <div id="ban-screen" class="ban-overlay hidden">
        <i class="fas fa-ban ban-icon"></i>
        <h1 class="text-3xl font-black mb-4">ØªÙ… Ø­Ø¸Ø± Ø­Ø³Ø§Ø¨Ùƒ</h1>
        <p class="text-gray-400 mb-6">Ù„Ù‚Ø¯ ØªÙ… Ø­Ø¸Ø± Ø¬Ù‡Ø§Ø²Ùƒ ÙˆØ­Ø³Ø§Ø¨Ùƒ Ù…Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ø´ÙƒÙ„ Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ø§Ù†ØªÙ‡Ø§Ùƒ Ø§Ù„Ø´Ø±ÙˆØ·.</p>
        <div class="bg-red-900 bg-opacity-50 p-4 rounded-xl border border-red-700">
            <p class="text-red-300 text-sm font-bold">Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</p>
        </div>
    </div>

    <div id="intro-screen" class="auth-overlay flex-col bg-slate-50" style="z-index: 10000;">
        <div class="hacker-avatar">
            <i class="fas fa-user-secret"></i>
        </div>
        <h1 class="hacker-text-intro mb-6">Ù‡ÙƒØ± Ø§Ù„ÙˆØ²Ø§Ø±ÙŠ</h1>
        <div class="w-64 h-2 bg-gray-200 rounded-full overflow-hidden relative">
            <div class="absolute top-0 left-0 h-full bg-indigo-600 animate-[width_2s_ease-out_forwards]" style="width: 0%; animation-name: loadBar; animation-duration: 2s; animation-fill-mode: forwards;"></div>
        </div>
        <p class="mt-4 text-gray-500 font-bold text-sm tracking-widest animate-pulse">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±...</p>
        <style> @keyframes loadBar { 0% { width: 0%; } 100% { width: 100%; } } </style>
    </div>

    <div id="vs-screen" class="vs-screen-overlay hidden">
        <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')] opacity-30"></div>
        <div class="flex items-center justify-center gap-6 w-full max-w-lg relative">
            <div class="vs-player-card animate-slide-left">
                <img id="vs-p1-img" src="" class="vs-avatar mb-3">
                <p id="vs-p1-name" class="text-white font-bold text-lg text-center truncate w-32"></p>
            </div>
            
            <div class="vs-text animate-zoom-bounce">VS</div>
            
            <div class="vs-player-card animate-slide-right">
                <img id="vs-p2-img" src="" class="vs-avatar mb-3">
                <p id="vs-p2-name" class="text-white font-bold text-lg text-center truncate w-32"></p>
            </div>
        </div>
        <p class="text-indigo-300 font-bold mt-10 tracking-widest animate-pulse">Ø¬Ø§Ø±ÙŠ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠ...</p>
    </div>

    <div id="daily-reward-screen" class="fixed inset-0 reward-overlay z-[9000] hidden flex flex-col items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl relative overflow-hidden animate-[slideUp_0.4s_ease-out]">
            <div class="text-center mb-4">
                <h2 class="text-2xl font-black text-indigo-800">Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„ÙŠÙˆÙ…ÙŠ ğŸ“…</h2>
            </div>
            <div id="reward-grid-container" class="reward-grid"></div>
            <div class="text-center mt-6">
                <button onclick="claimReward()" class="w-full bg-gradient-to-r from-green-500 to-emerald-600 text-white py-4 rounded-xl font-bold shadow-lg active:scale-95 transition flex items-center justify-center gap-2">
                      <span>Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ù‡Ø¯ÙŠØ©</span>
                      <i class="fas fa-gift animate-bounce"></i>
                </button>
            </div>
            <button onclick="document.getElementById('daily-reward-screen').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>

    <div id="maintenance-popup" class="new-maintenance-overlay hidden">
        <div class="new-maintenance-card">
            <div class="maint-icon-wrapper"><i class="fas fa-tools"></i></div>
            <h2 class="maint-title">Ø§Ù„Ù†Ø¸Ø§Ù… ØªØ­Øª Ø§Ù„ØµÙŠØ§Ù†Ø©</h2>
            <div class="bg-white/90 border border-slate-200 rounded-2xl p-5 mb-6 text-slate-700 font-bold leading-relaxed">
                <p id="maintenance-msg-display">Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©...</p>
            </div>
            <button onclick="closeMaintenancePopup()" class="bg-slate-800 text-white px-8 py-4 rounded-full font-bold text-lg hover:scale-105 transition shadow-xl w-full flex items-center justify-center gap-2">
                <i class="fas fa-check-circle"></i> Ø­Ø³Ù†Ø§
            </button>
        </div>
    </div>

    <div id="forgot-password-modal" class="modal-overlay hidden">
        <div class="bg-white rounded-3xl p-8 w-11/12 max-w-sm shadow-2xl animate-[slideUp_0.2s_ease-out]">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-gradient-to-r from-indigo-500 to-purple-500 rounded-full flex items-center justify-center mx-auto mb-3">
                    <i class="fas fa-key text-2xl text-white"></i>
                </div>
                <h3 class="text-xl font-black text-gray-800">Ø§Ø³ØªØ¹Ø§Ø¯Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</h3>
            </div>
            <div class="mb-6">
                <label class="block text-sm font-bold text-gray-600 mb-2">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                <input type="email" id="forgot-email" placeholder="Ø£Ø¯Ø®Ù„ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø§Ù„Ù…Ø³Ø¬Ù„" class="input-box">
            </div>
            <div class="flex gap-3">
                <button onclick="closeForgotPassword()" class="flex-1 bg-gray-100 text-gray-600 py-3 rounded-xl font-bold hover:bg-gray-200 transition">Ø¥Ù„ØºØ§Ø¡</button>
                <button onclick="sendResetLink()" class="flex-1 bg-gradient-to-r from-indigo-500 to-purple-500 text-white py-3 rounded-xl font-bold shadow-md hover:opacity-90 transition">Ø¥Ø±Ø³Ø§Ù„</button>
            </div>
        </div>
    </div>

    <div id="auth-loading" class="auth-loading hidden">
        <div class="auth-loading-spinner"></div>
        <p class="text-gray-700 font-bold" id="auth-loading-text">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...</p>
    </div>

    <div id="auth-screen" class="auth-overlay hidden">
        <div class="w-full max-w-md p-8 h-full overflow-y-auto flex flex-col justify-center">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-black text-indigo-600 mb-2">Ù‡ÙƒØ± Ø§Ù„ÙˆØ²Ø§Ø±ÙŠ</h1>
            </div>
            <div class="auth-tabs">
                <div id="tab-login-btn" onclick="switchAuthTab('login')" class="auth-tab active">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</div>
                <div id="tab-signup-btn" onclick="switchAuthTab('signup')" class="auth-tab">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</div>
            </div>

            <form id="login-form" onsubmit="event.preventDefault(); handleLogin();">
                <div class="mb-4">
                    <label class="block text-xs font-bold text-gray-500 mb-1 mr-1">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø£Ùˆ Ø§Ù„Ù…Ø¹Ø±Ù (ID)</label>
                    <input type="text" id="login-identifier" placeholder="example@gmail.com Ø£Ùˆ Ø§Ù„Ù…Ø¹Ø±Ù" class="input-box" required>
                </div>
                <div class="mb-4">
                    <label class="block text-xs font-bold text-gray-500 mb-1 mr-1">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                    <input type="password" id="login-pass" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" class="input-box" required>
                </div>
                <div class="flex items-center mb-6">
                    <input type="checkbox" id="remember-me" class="w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                    <label for="remember-me" class="mr-2 text-sm text-gray-600">ØªØ°ÙƒØ±Ù†ÙŠ</label>
                </div>
                <button type="submit" class="btn-main">Ø¯Ø®ÙˆÙ„</button>
                <div class="text-center mt-4">
                    <button type="button" onclick="openForgotPassword()" class="text-sm text-indigo-600 hover:text-indigo-800 font-medium hover:underline">Ù‡Ù„ Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±ØŸ</button>
                </div>
            </form>

            <form id="signup-form" class="hidden" onsubmit="event.preventDefault(); handleSignup();">
                <div class="flex justify-center mb-6">
                    <div class="relative cursor-pointer group" onclick="document.getElementById('signup-img').click()">
                        <img id="preview-img" src="https://ui-avatars.com/api/?name=User&background=random&size=128" class="w-24 h-24 rounded-full object-cover border-4 border-gray-100 shadow-md transition group-hover:border-indigo-200">
                        <div class="absolute bottom-0 right-0 bg-indigo-600 w-8 h-8 rounded-full flex items-center justify-center text-white border-2 border-white shadow-sm">
                            <i class="fas fa-camera text-xs"></i>
                        </div>
                    </div>
                    <input type="file" id="signup-img" hidden accept="image/*" onchange="handleImagePreview(this)">
                </div>
                <div class="space-y-3">
                    <div><input type="text" id="signup-name" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¸Ø§Ù‡Ø±" class="input-box" required></div>
                    <div><input type="email" id="signup-email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ (@gmail.com)" class="input-box" required></div>
                    <div><input type="password" id="signup-pass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (6+ Ø£Ø­Ø±Ù)" class="input-box" required minlength="6"></div>
                </div>
                <div class="mt-4 text-xs text-gray-500">
                    <p>â“˜ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„</p>
                </div>
                <button type="submit" class="btn-main mt-6 bg-indigo-600">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</button>
            </form>
        </div>
    </div>

    <div id="main-app" class="hidden w-full h-full relative">
        
        <!-- ÙÙŠ Ù‚Ø³Ù… Ø§Ù„Ù€ header Ø¯Ø§Ø®Ù„ div#main-app -->
<div class="absolute top-0 w-full h-20 bg-white/95 backdrop-blur-sm shadow-sm z-30 flex items-center justify-between px-5 pt-2">
    <div>
        <h1 class="font-black text-lg text-indigo-900">Ù‡ÙƒØ± Ø§Ù„ÙˆØ²Ø§Ø±ÙŠ</h1>
        <p id="header-grade-badge" class="text-xs text-indigo-600 font-bold bg-indigo-50 px-2 py-0.5 rounded-full hidden">...</p>
    </div>
    <div class="flex items-center gap-2">
        <!-- Ø²Ø± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯ -->
        <button id="notifications-btn" onclick="openNotificationsScreen()" class="relative p-2 rounded-full hover:bg-gray-100 transition">
            <i class="fas fa-bell text-xl text-gray-600"></i>
            <div id="notification-badge" class="absolute top-1 right-1 w-3 h-3 bg-red-500 rounded-full hidden border border-white"></div>
        </button>
        
        <button id="add-subscription-btn" class="hidden bg-gradient-to-r from-yellow-500 to-orange-500 text-white px-3 py-1 rounded-full text-xs font-bold shadow-sm hover:shadow-md transition">+ Ø¥Ø¶Ø§ÙØ© Ø§Ø´ØªØ±Ø§Ùƒ</button>
        <div class="bg-yellow-50 px-3 py-1 rounded-full border border-yellow-100 flex items-center gap-2 shadow-sm">
            <span id="header-points" class="font-bold text-yellow-700">0</span>
            <i class="fas fa-gem text-yellow-500"></i>
        </div>
    </div>
</div>

        <div id="tab-challenges" class="screen pt-20">
            <div class="scroll-container px-5 py-6">
                <div id="grade-selector-card" class="bg-white p-6 rounded-2xl shadow-sm mb-6 border border-gray-100">
                    <div class="text-center mb-4">
                        <div class="w-12 h-12 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-2"><i class="fas fa-school text-xl"></i></div>
                        <h3 class="font-bold text-gray-800">Ø­Ø¯Ø¯ Ù…Ø±Ø­Ù„ØªÙƒ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©</h3>
                    </div>
                    <select id="grade-select" class="input-box mb-4 text-center">
                        <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±Ø­Ù„Ø© --</option>
                        <option value="6sci">Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ù„Ø¹Ù„Ù…ÙŠ</option>
                        <option value="6lit">Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ù„Ø£Ø¯Ø¨ÙŠ</option>
                        <option value="3med">Ø§Ù„Ø«Ø§Ù„Ø« Ù…ØªÙˆØ³Ø·</option>
                    </select>
                    <button onclick="saveUserGrade()" class="btn-main py-3 text-sm">Ø­ÙØ¸ Ø§Ù„Ù…Ø±Ø­Ù„Ø©</button>
                </div>

                <div id="challenge-active-card" class="bg-white p-6 rounded-2xl shadow-sm mb-6 hidden">
                    <h3 class="font-bold text-gray-800 mb-4 border-r-4 border-indigo-500 pr-3">Ø¨Ø¯Ø¡ ØªØ­Ø¯ÙŠ Ø¬Ø¯ÙŠØ¯ ğŸ”¥</h3>
                    <label class="block text-sm font-bold text-gray-600 mb-2">Ø§Ù„Ù…Ø§Ø¯Ø©</label>
                    <select id="challenge-subject" class="input-box mb-4 bg-gray-50"></select>

                    <label class="block text-sm font-bold text-gray-600 mb-2">Ù†ÙˆØ¹ Ø§Ù„ØªØ­Ø¯ÙŠ</label>
                    <div class="grid grid-cols-2 gap-3 mb-6">
                        <button onclick="setQType('mcq')" id="btn-mcq" class="py-3 rounded-xl border-2 border-indigo-100 text-gray-500 font-bold active:scale-95 transition">Ø§Ø®ØªÙŠØ§Ø±Ø§Øª</button>
                        <button onclick="setQType('tf')" id="btn-tf" class="py-3 rounded-xl border-2 border-indigo-100 text-gray-500 font-bold active:scale-95 transition">ØµØ­ ÙˆØ®Ø·Ø£</button>
                    </div>

                    <button onclick="startMatchmaking('online')" class="btn-main bg-gradient-to-r from-indigo-600 to-purple-600 mb-4 h-12">
                        <i class="fas fa-user-graduate ml-2"></i> Ø§Ù„Ù„Ø¹Ø¨ Ø¶Ø¯ Ø·Ø§Ù„Ø¨ (Ø­Ù‚ÙŠÙ‚ÙŠ)
                    </button>

                    <button onclick="startMatchmaking('ai')" class="btn-main bg-gradient-to-r from-emerald-500 to-green-600 mb-3 h-12">
                        <i class="fas fa-robot ml-2"></i> Ø¶Ø¯ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
                        <span id="ai-remaining" class="text-xs bg-white text-green-600 px-2 py-1 rounded-full mr-2">10</span>
                    </button>

                    <button onclick="openFriendChallenge()" class="btn-main bg-gradient-to-r from-pink-500 to-rose-600 h-12">
                        <i class="fas fa-users ml-2"></i> ØªØ­Ø¯Ù‘ÙŠ Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡ (ØºØ±Ù)
                    </button>
                </div>

                <div id="searching-ui" class="hidden flex-col items-center justify-center py-10 min-h-[300px]">
                    <div class="w-24 h-24 rounded-full bg-indigo-50 flex items-center justify-center relative mb-6">
                        <div class="absolute inset-0 rounded-full border-4 border-indigo-500 opacity-20 animate-ping"></div>
                        <i class="fas fa-search text-3xl text-indigo-600"></i>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800" id="search-msg">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...</h3>
                    <button onclick="cancelSearch()" class="mt-8 text-red-500 font-bold text-sm bg-red-50 px-4 py-2 rounded-full">Ø¥Ù„ØºØ§Ø¡</button>
                </div>
            </div>
        </div>

        <div id="game-overlay" class="fixed inset-0 bg-gray-50 z-[100] hidden flex-col">
            <div class="bg-white p-3 shadow-sm flex justify-between items-center z-10 border-b border-gray-100 h-20">
                <div class="flex items-center gap-2 w-1/3 overflow-hidden">
                    <img id="game-p1-img" src="" class="game-avatar-small">
                    <div class="overflow-hidden">
                        <p id="p1-name" class="text-[10px] text-gray-500 font-bold truncate">...</p>
                        <p id="game-my-score" class="text-xl font-black text-indigo-600">0</p>
                    </div>
                </div>
                
                <div class="w-1/3 flex justify-center">
                    <div id="game-timer" class="w-10 h-10 bg-gray-800 text-white rounded-full flex items-center justify-center font-bold text-md shadow-md">15</div>
                </div>

                <div class="flex items-center gap-2 w-1/3 overflow-hidden justify-end">
                    <div class="overflow-hidden text-left">
                        <p id="p2-name" class="text-[10px] text-gray-500 font-bold truncate">...</p>
                        <p id="game-op-score" class="text-xl font-black text-red-500">0</p>
                    </div>
                    <img id="game-p2-img" src="" class="game-avatar-small">
                </div>
            </div>

            <div class="flex-1 overflow-y-auto p-5 pb-20">
                <div class="bg-white p-6 rounded-2xl shadow-sm mb-6 text-center border-t-4 border-indigo-500 relative mt-4">
                    <span id="q-progress" class="absolute -top-3 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white text-xs px-3 py-1 rounded-full">1 / 10</span>
                    <p id="q-text" class="text-lg font-bold text-gray-800 leading-relaxed mt-2">...</p>
                </div>
                <div id="answers-container" class="space-y-3"></div>
                <p id="waiting-msg" class="text-center text-gray-400 text-sm hidden animate-pulse mt-4">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ø®ØµÙ…...</p>
                <p id="ai-thinking-msg" class="text-center text-green-600 text-sm hidden animate-pulse mt-4 font-bold">Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ ÙŠÙÙƒØ±...</p>
            </div>

            <button id="withdraw-game-btn" class="withdraw-game-btn hidden">
                <i class="fas fa-sign-out-alt"></i> Ø§Ù†Ø³Ø­Ø§Ø¨
            </button>
        </div>

        <div id="result-screen" class="fixed inset-0 bg-white z-[200] hidden">
            <div class="result-container">
                <button onclick="closeResultScreen()" class="absolute top-6 right-6 w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center text-gray-600 hover:bg-gray-200">
                    <i class="fas fa-times"></i>
                </button>
                <div id="result-icon-container" class="result-emoji">ğŸ†</div>
                <h2 id="result-title" class="result-title">Ù…Ø¨Ø±ÙˆÙƒ!</h2>
                <p id="result-msg" class="result-subtitle">Ù„Ù‚Ø¯ Ù‚Ù…Øª Ø¨Ø£Ø¯Ø§Ø¡ Ø±Ø§Ø¦Ø¹</p>
                
                <div class="result-score-container">
                    <div class="result-player">
                        <p class="result-player-name">Ø£Ù†Øª</p>
                        <p id="final-my-score" class="result-player-score">0</p>
                    </div>
                    <div class="result-vs">VS</div>
                    <div class="result-player op">
                        <p id="final-op-name" class="result-player-name">Ø§Ù„Ø®ØµÙ…</p>
                        <p id="final-op-score" class="result-player-score">0</p>
                    </div>
                </div>
                
                <div class="result-points-gained">
                    <span id="result-points-gained-text">+0</span>
                    <i class="fas fa-gem"></i>
                </div>
                
                <button onclick="closeResultScreen()" class="beautiful-btn">
                    <i class="fas fa-home"></i>
                    <span>Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
                </button>
            </div>
        </div>

        <div id="tab-leaderboard" class="screen pt-20">
            <div class="scroll-container px-4">
                <div class="countdown-container">
                    <p class="text-xs text-gray-300 mb-1">Ø§Ù„Ø¬ÙˆØ§Ø¦Ø² Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ© ğŸ (ØªÙ†ØªÙ‡ÙŠ Ø§Ù„Ø¬Ù…Ø¹Ø© 00:00)</p>
                    <div id="weekly-timer" class="timer-digits">00:00:00:00</div>
                </div>

                <div class="bg-gradient-to-r from-yellow-400 to-yellow-600 text-white p-4 rounded-2xl mb-4 shadow-lg flex items-center justify-between">
                    <div>
                        <p class="font-bold text-sm opacity-90">ØªØ±ØªÙŠØ¨Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ</p>
                        <h2 id="my-rank-text" class="text-2xl font-bold">#...</h2>
                    </div>
                    <i class="fas fa-trophy text-4xl opacity-50"></i>
                </div>
                <div id="leaderboard-list" class="space-y-4 pb-10 flex flex-col"></div>
                <button id="load-more-leaderboard" onclick="loadMoreLeaderboard()" class="beautiful-btn secondary hidden mt-4 mb-10">
                    <i class="fas fa-chevron-down"></i> Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø²ÙŠØ¯
                </button>
            </div>
        </div>

        <div id="tab-schedule" class="screen pt-20">
            <div class="scroll-container px-5 py-6">
                <section id="schedule-input-page">
                    <div class="bg-white p-6 rounded-2xl shadow-sm mb-6">
                        <header class="text-center mb-4">
                            <div class="inline-block p-2 rounded-full bg-indigo-100 text-primary mb-2">
                                <i class="fa-solid fa-layer-group text-2xl text-indigo-600"></i>
                            </div>
                            <h1 class="text-xl font-bold text-gray-800">Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠ</h1>
                        </header>

                        <form onsubmit="handleScheduleFormSubmit(event)">
                            <div class="mb-4">
                                <label class="block text-gray-700 text-sm font-bold mb-2">Ø§Ù„Ù…Ø§Ø¯Ø©</label>
                                <input type="text" id="subjectName" required placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©..." class="input-box">
                            </div>

                            <div class="mb-4">
                                <label class="block text-gray-700 text-sm font-bold mb-2">Ø§Ù„ÙØµÙˆÙ„ (Ø§Ù„Ø£ØµØ¹Ø¨ ÙŠØ£Ø®Ø° ÙˆÙ‚ØªØ§Ù‹ Ø£ÙƒØ«Ø±)</label>
                                <div id="chaptersList" class="space-y-2 max-h-40 overflow-y-auto mb-2"></div>
                                <button type="button" onclick="addChapterRow()" class="w-full py-2 border-2 border-dashed border-indigo-300 text-indigo-500 rounded-xl hover:bg-indigo-50 text-sm font-bold">+ Ø¥Ø¶Ø§ÙØ© ÙØµÙ„</button>
                            </div>

                            <div class="mb-4">
                                <label class="block text-gray-700 text-sm font-bold mb-2">Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ (Ø³Ø§Ø¹Ø§Øª)</label>
                                <input type="number" id="totalHours" required min="1" max="999" placeholder="Ù…Ø«Ø§Ù„: 10" class="input-box text-center font-bold text-lg">
                            </div>

                            <div class="grid grid-cols-3 gap-4 mb-6">
                                <div>
                                    <label class="block text-gray-700 text-xs font-bold mb-2">ÙˆÙ‚Øª Ø§Ù„Ù†ÙˆÙ…ØŸ</label>
                                    <select id="needSleep" class="input-box text-sm font-bold">
                                        <option value="yes">Ø§Ø­Ø³Ø¨ ÙˆÙ‚Øª Ø§Ù„Ù†ÙˆÙ…</option>
                                        <option value="no">Ù„Ø§ ØªØ­Ø³Ø¨Ù‡</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-gray-700 text-xs font-bold mb-2">Ø§Ù„Ø§Ø³ØªØ±Ø§Ø­Ø©</label>
                                    <select id="breakDuration" class="input-box text-sm font-bold">
                                        <option value="10">10 Ø¯Ù‚Ø§Ø¦Ù‚</option>
                                        <option value="15">15 Ø¯Ù‚ÙŠÙ‚Ø©</option>
                                        <option value="20">20 Ø¯Ù‚ÙŠÙ‚Ø©</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-gray-700 text-xs font-bold mb-2">ÙˆÙ‚Øª Ø§Ù„Ø¯Ø±Ø§Ø³Ø© Ø§Ù„Ù…ÙØ¶Ù„</label>
                                    <select id="studyTimePref" class="input-box text-sm font-bold">
                                        <option value="morning">ØµØ¨Ø§Ø­Ø§Ù‹</option>
                                        <option value="evening">Ù…Ø³Ø§Ø¡Ù‹</option>
                                        <option value="any">Ø£ÙŠ ÙˆÙ‚Øª</option>
                                    </select>
                                </div>
                            </div>

                            <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-4 rounded-xl shadow-lg hover:bg-indigo-700 transition-all text-lg">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¢Ù†</button>
                        </form>
                    </div>
                </section>

                <section id="schedule-result-page" class="hidden">
                    <div id="schedule-card" class="bg-white rounded-2xl overflow-hidden shadow-xl border border-gray-200 mb-6 relative">
                        <div class="watermark">Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù…Ù† ØªØ·Ø¨ÙŠÙ‚ Ù‡ÙƒØ± Ø§Ù„ÙˆØ²Ø§Ø±ÙŠ</div>
                        <div class="h-3 bg-indigo-600 w-full"></div>
                        <div class="p-5">
                            <div class="text-center mb-4">
                                <h2 class="schedule-header" id="displaySubject"></h2>
                                <p class="schedule-subheader" id="displayScheduleTime"></p>
                            </div>

                            <div class="mb-6 overflow-x-auto">
                                <table class="table-schedule">
                                    <thead>
                                        <tr>
                                            <th width="40%">Ø§Ù„Ù†Ø´Ø§Ø·</th>
                                            <th width="60%">Ø§Ù„ÙˆÙ‚Øª</th>
                                        </tr>
                                    </thead>
                                    <tbody id="scheduleBody"></tbody>
                                </table>
                            </div>

                            <div class="schedule-footer">
                                <div class="schedule-footer-item">
                                    <span class="font-bold text-indigo-600 text-sm" id="statStudy"></span>
                                    <span class="text-xs text-gray-500">ØµØ§ÙÙŠ Ø§Ù„Ø¯Ø±Ø§Ø³Ø©</span>
                                </div>
                                <div class="schedule-footer-item">
                                    <span class="font-bold text-pink-600 text-sm" id="statBreak"></span>
                                    <span class="text-xs text-gray-500">Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø±Ø§Ø­Ø©</span>
                                </div>
                                <div class="schedule-footer-item">
                                    <span class="font-bold text-blue-600 text-sm" id="statSleep"></span>
                                    <span class="text-xs text-gray-500">ÙˆÙ‚Øª Ø§Ù„Ù†ÙˆÙ…</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="schedule-action-buttons" class="space-y-3">
                        <button onclick="downloadScheduleAsImage()" class="w-full bg-indigo-100 text-indigo-700 font-bold py-3 rounded-xl hover:bg-indigo-200 flex items-center justify-center gap-2">
                            <i class="fa-solid fa-download"></i> Ø­ÙØ¸ ÙƒØµÙˆØ±Ø©
                        </button>
                        <button onclick="resetSchedule()" class="w-full bg-white text-red-500 border border-red-200 font-bold py-3 rounded-xl hover:bg-red-50 flex items-center justify-center gap-2">
                            <i class="fa-solid fa-trash-can"></i> Ø­Ø°Ù ÙˆØ¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙŠØ¯
                        </button>
                    </div>
                </section>
            </div>
        </div>

        <div id="tab-profile" class="screen pt-20">
            <div class="scroll-container px-5">
                <div class="bg-white p-6 rounded-3xl shadow-sm text-center mb-6 mt-4 relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-16 bg-gradient-to-r from-indigo-500 to-purple-500 opacity-10"></div>
                    <div class="relative z-10">
                        <img id="profile-img" src="" class="w-24 h-24 rounded-full mx-auto border-4 border-white shadow-md mb-3 object-cover">
                        <div class="flex items-center justify-center gap-2 flex-wrap" id="profile-name-container">
                            <h2 id="profile-name-text" class="text-xl font-bold text-gray-800">...</h2>
                            <button onclick="editProfileName()" class="w-6 h-6 rounded-full bg-indigo-50 text-indigo-600 flex items-center justify-center hover:bg-indigo-100 transition">
                                <i class="fas fa-pen text-xs"></i>
                            </button>
                        </div>
                        <p class="text-xs text-gray-400 mt-1" id="profile-id-text">ID: ...</p>
                        <div class="flex items-center justify-center gap-1 mt-2">
                            <p class="text-xs text-gray-600 max-w-xs mx-auto" id="profile-bio-text">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³ÙŠØ±Ø© Ø°Ø§ØªÙŠØ©</p>
                            <button onclick="editProfileBio()" class="text-indigo-600 hover:text-indigo-800">
                                <i class="fas fa-pen text-xs"></i>
                            </button>
                        </div>
                        <button onclick="document.getElementById('edit-pic-input').click()" class="text-indigo-600 text-xs font-bold mt-2 hover:underline block mx-auto">ØªØºÙŠÙŠØ± Ø§Ù„ØµÙˆØ±Ø©</button>
                        <input type="file" id="edit-pic-input" hidden accept="image/*" onchange="updateProfilePic(this)">
                    </div>
                </div>

                <div class="space-y-3 pb-20">
                    <button onclick="openPage('screen-wallet')" class="stat-btn border-green-100 bg-green-50">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-white flex items-center justify-center text-green-600"><i class="fas fa-wallet"></i></div>
                            <span class="font-bold text-green-700">Ø£Ù…ÙˆØ§Ù„ÙŠ</span>
                        </div>
                        <i class="fas fa-chevron-left text-gray-300"></i>
                    </button>

                    <button onclick="openPage('screen-premium-in-profile')" class="stat-btn border-yellow-100 bg-yellow-50">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-white flex items-center justify-center text-yellow-600"><i class="fas fa-crown"></i></div>
                            <span class="font-bold text-yellow-700">Ù„Ù„Ù…Ù…ÙŠØ²ÙŠÙ†</span>
                        </div>
                        <i class="fas fa-chevron-left text-gray-300"></i>
                    </button>

                    <button onclick="window.open('https://t.me/mslmh19', '_blank')" class="stat-btn border-blue-100 bg-blue-50">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-white flex items-center justify-center text-blue-600"><i class="fas fa-headset"></i></div>
                            <span class="font-bold text-blue-700">Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¯Ø¹Ù…</span>
                        </div>
                        <i class="fas fa-chevron-left text-gray-300"></i>
                    </button>

                    <button onclick="openPage('screen-upload-questions')" class="stat-btn border-purple-100 bg-purple-50">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-white flex items-center justify-center text-purple-600"><i class="fas fa-upload"></i></div>
                            <span class="font-bold text-purple-700">Ø±ÙØ¹ Ø£Ø³Ø¦Ù„Ø©</span>
                        </div>
                        <i class="fas fa-chevron-left text-gray-300"></i>
                    </button>

                    <div id="admin-hub-btn-container" class="hidden">
                        <button onclick="openPage('screen-admin-hub')" class="stat-btn border-red-200 bg-red-50 shadow-md">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-white flex items-center justify-center text-red-600 relative">
                                    <i class="fas fa-user-shield"></i>
                                    <div id="admin-btn-badge" class="btn-dot"></div>
                                </div>
                                <span class="font-bold text-red-800">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
                            </div>
                            <i class="fas fa-chevron-left text-red-300"></i>
                        </button>
                    </div>

                    <button onclick="logout()" class="stat-btn mt-6 border-red-100 text-red-500">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-sign-out-alt px-3"></i>
                            <span class="font-bold">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</span>
                        </div>
                    </button>
                </div>
            </div>
        </div>

        <div id="screen-wallet" class="screen pt-20">
            <div class="absolute top-0 w-full h-20 bg-white shadow-sm z-30 flex items-center px-5 gap-4">
                <button onclick="backToProfile()" class="text-gray-500"><i class="fas fa-arrow-right text-xl"></i></button>
                <h1 class="font-bold text-lg text-gray-800">Ù…Ø­ÙØ¸ØªÙŠ ğŸ’µ</h1>
            </div>
            <div class="scroll-container px-5 py-6 text-center">
                <div class="bg-gradient-to-br from-green-500 to-emerald-700 text-white p-8 rounded-3xl shadow-lg mb-6">
                    <p class="text-green-100 text-sm mb-2 font-bold">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ</p>
                    <h1 class="text-5xl font-black mb-1">$<span id="wallet-balance">0</span></h1>
                </div>
                <div id="withdraw-section" class="hidden">
                     <a href="https://t.me/mslmh19" target="_blank" class="w-full bg-blue-500 text-white py-4 rounded-xl font-bold shadow-lg hover:bg-blue-600 transition flex items-center justify-center gap-2 animate-pulse">
                        <i class="fab fa-telegram-plane"></i>
                        <span>Ø§Ù„Ù…Ø·Ø§Ù„Ø¨Ø© Ø¨Ø§Ù„Ø£Ù…ÙˆØ§Ù„ Ø§Ù„Ø¢Ù†</span>
                    </a>
                </div>
                <p id="withdraw-locked-msg" class="text-gray-400 text-sm mt-4">Ø¹Ø°Ø±Ø§Ù‹ØŒ ÙŠØ¬Ø¨ Ø£Ù† ØªØµÙ„ Ø¥Ù„Ù‰ 100$ Ù„ØªØªÙ…ÙƒÙ† Ù…Ù† Ø§Ù„Ø³Ø­Ø¨.</p>
            </div>
        </div>

        <div id="screen-premium-in-profile" class="screen pt-20">
            <div class="absolute top-0 w-full h-20 bg-white shadow-sm z-30 flex items-center px-5 gap-4">
                <button onclick="backToProfile()" class="text-gray-500"><i class="fas fa-arrow-right text-xl"></i></button>
                <h1 class="font-bold text-lg text-gray-800">Ù‚Ø³Ù… Ø§Ù„Ù…Ù…ÙŠØ²ÙŠÙ†</h1>
            </div>
            <div class="scroll-container px-5 py-6">
                <div id="premium-locked-view">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-yellow-100 mb-6">
                        <h3 class="font-bold text-gray-800 mb-4 text-center">ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ù…Ù…ÙŠØ² ğŸ”‘</h3>
                        <input type="text" id="premium-code-input" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„ØªÙØ¹ÙŠÙ„ Ù‡Ù†Ø§" class="input-box mb-3 text-center font-mono font-bold text-lg tracking-widest text-indigo-700 uppercase">
                        <button onclick="activatePremiumCode()" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold shadow-md hover:bg-indigo-700 transition mb-4">ØªØ£ÙƒÙŠØ¯ Ø§Ù„ÙƒÙˆØ¯</button>
                        
                        <div class="flex flex-col gap-2">
                            <button onclick="window.open('https://t.me/mslmh19', '_blank')" class="w-full bg-blue-500 text-white py-3 rounded-xl font-bold shadow-md hover:bg-blue-600 transition flex items-center justify-center gap-2">
                                <i class="fab fa-telegram-plane"></i> Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚
                            </button>
                            <button onclick="showPremiumDetails()" class="w-full bg-yellow-50 text-yellow-700 py-3 rounded-xl font-bold border border-yellow-200 hover:bg-yellow-100 transition">
                                <i class="fas fa-info-circle ml-1"></i> ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ù…ÙŠØ²
                            </button>
                        </div>
                    </div>
                </div>

                <div id="premium-active-view" class="hidden">
                    <div class="premium-timer-container">
                        <p class="text-xs text-gray-300 mb-1">Ø§Ù„Ù…Ø¯Ø© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© Ù„Ø§Ø´ØªØ±Ø§ÙƒÙƒ</p>
                        <div id="premium-countdown" class="premium-timer-digits">ØªØ­Ù…ÙŠÙ„...</div>
                    </div>

                    <div class="grid grid-cols-1 gap-4 mb-6">
                        <button onclick="openBadgeSelector()" class="bg-white p-4 rounded-2xl shadow-sm border border-indigo-100 flex items-center gap-4 hover:shadow-md transition group">
                            <div class="w-12 h-12 rounded-full bg-indigo-50 flex items-center justify-center text-indigo-600 group-hover:bg-indigo-600 group-hover:text-white transition"><i class="fas fa-check-circle text-xl"></i></div>
                            <div class="text-right">
                                <h3 class="font-bold text-gray-800">Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØªÙˆØ«ÙŠÙ‚</h3>
                            </div>
                            <i class="fas fa-chevron-left mr-auto text-gray-300"></i>
                        </button>

                        <button onclick="openBgSelector()" class="bg-white p-4 rounded-2xl shadow-sm border border-purple-100 flex items-center gap-4 hover:shadow-md transition group">
                            <div class="w-12 h-12 rounded-full bg-purple-50 flex items-center justify-center text-purple-600 group-hover:bg-purple-600 group-hover:text-white transition"><i class="fas fa-image text-xl"></i></div>
                            <div class="text-right">
                                <h3 class="font-bold text-gray-800">Ø®Ù„ÙÙŠØ© Ø§Ù„ØªØµÙ†ÙŠÙ</h3>
                            </div>
                            <i class="fas fa-chevron-left mr-auto text-gray-300"></i>
                        </button>
                    </div>

                    <div class="space-y-3">
                        <div class="flex items-center justify-between bg-green-50 p-3 rounded-xl border border-green-200">
                            <div class="flex items-center gap-2">
                                <i class="fas fa-bolt text-green-600"></i>
                                <span class="font-bold text-sm text-green-800">Ù…Ø¶Ø§Ø¹ÙØ© Ø§Ù„Ù†Ù‚Ø§Ø· (2x)</span>
                            </div>
                            <span class="bg-green-200 text-green-800 text-[10px] px-2 py-1 rounded font-bold">Ù†Ø´Ø· âœ…</span>
                        </div>
                        <div class="flex items-center justify-between bg-emerald-50 p-3 rounded-xl border border-emerald-200">
                            <div class="flex items-center gap-2">
                                <i class="fas fa-dollar-sign text-emerald-600"></i>
                                <span class="font-bold text-sm text-emerald-800">Ù…Ø¶Ø§Ø¹ÙØ© Ø§Ù„Ø£Ù…ÙˆØ§Ù„ (2x)</span>
                            </div>
                            <span class="bg-emerald-200 text-emerald-800 text-[10px] px-2 py-1 rounded font-bold">Ù†Ø´Ø· âœ…</span>
                        </div>
                        <div class="flex items-center justify-between bg-blue-50 p-3 rounded-xl border border-blue-200">
                            <div class="flex items-center gap-2">
                                <i class="fas fa-robot text-blue-600"></i>
                                <span class="font-bold text-sm text-blue-800">15 Ù…Ø­Ø§ÙˆÙ„Ø© ÙŠÙˆÙ…ÙŠØ© (Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ)</span>
                            </div>
                            <span class="bg-blue-200 text-blue-800 text-[10px] px-2 py-1 rounded font-bold">Ù†Ø´Ø· âœ…</span>
                        </div>
                        <div class="flex items-center justify-between bg-purple-50 p-3 rounded-xl border border-purple-200">
                            <div class="flex items-center gap-2">
                                <i class="fas fa-crown text-purple-600"></i>
                                <span class="font-bold text-sm text-purple-800">Ø¹Ù„Ø§Ù…Ø© ØªÙˆØ«ÙŠÙ‚ Ù…Ù…ÙŠØ²Ø©</span>
                            </div>
                            <span class="bg-purple-200 text-purple-800 text-[10px] px-2 py-1 rounded font-bold">Ù†Ø´Ø· âœ…</span>
                        </div>
                        <div class="flex items-center justify-between bg-pink-50 p-3 rounded-xl border border-pink-200">
                            <div class="flex items-center gap-2">
                                <i class="fas fa-palette text-pink-600"></i>
                                <span class="font-bold text-sm text-pink-800">Ø®Ù„ÙÙŠØ© Ù…ØªØ­Ø±ÙƒØ© ÙÙŠ Ø§Ù„ØªØµÙ†ÙŠÙ</span>
                            </div>
                            <span class="bg-pink-200 text-pink-800 text-[10px] px-2 py-1 rounded font-bold">Ù†Ø´Ø· âœ…</span>
                        </div>
                        <div class="flex items-center justify-between bg-amber-50 p-3 rounded-xl border border-amber-200">
                            <div class="flex items-center gap-2">
                                <i class="fas fa-star text-amber-600"></i>
                                <span class="font-bold text-sm text-amber-800">Ø£ÙˆÙ„ÙˆÙŠØ© ÙÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ø¨Ø§Ø±ÙŠØ§Øª</span>
                            </div>
                            <span class="bg-amber-200 text-amber-800 text-[10px] px-2 py-1 rounded font-bold">Ù†Ø´Ø· âœ…</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="screen-admin-hub" class="screen pt-20">
            <div class="absolute top-0 w-full h-20 bg-white shadow-sm z-30 flex items-center px-5 gap-4">
                <button onclick="backToProfile()" class="text-gray-500"><i class="fas fa-arrow-right text-xl"></i></button>
                <h1 class="font-bold text-lg text-gray-800">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</h1>
            </div>
            <div class="scroll-container px-5 py-6">
                <div class="grid grid-cols-3 gap-3">
                    <button onclick="openPage('screen-admin-panel')" class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex flex-col items-center justify-center gap-2 hover:bg-gray-50">
                        <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center text-red-600"><i class="fas fa-cogs text-xl"></i></div>
                        <span class="font-bold text-sm text-gray-700">Ø§Ù„Ù†Ø¸Ø§Ù…</span>
                    </button>
                    <button onclick="openPage('screen-admin-users')" class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex flex-col items-center justify-center gap-2 hover:bg-gray-50">
                        <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center text-blue-600"><i class="fas fa-users-cog text-xl"></i></div>
                        <span class="font-bold text-sm text-gray-700">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</span>
                    </button>
                    <button onclick="openPage('screen-admin-all')" class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex flex-col items-center justify-center gap-2 hover:bg-gray-50">
                        <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center text-green-600"><i class="fas fa-edit text-xl"></i></div>
                        <span class="font-bold text-sm text-gray-700">ØªØ¹Ø¯ÙŠÙ„</span>
                    </button>
                    <button onclick="openPage('screen-admin-subscription')" class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex flex-col items-center justify-center gap-2 hover:bg-gray-50">
                        <div class="w-12 h-12 bg-indigo-100 rounded-full flex items-center justify-center text-indigo-600"><i class="fas fa-ticket-alt text-xl"></i></div>
                        <span class="font-bold text-sm text-gray-700">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª</span>
                    </button>
                    <button onclick="openPage('screen-admin-stats')" class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex flex-col items-center justify-center gap-2 hover:bg-gray-50">
                        <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center text-purple-600"><i class="fas fa-chart-pie text-xl"></i></div>
                        <span class="font-bold text-sm text-gray-700">Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</span>
                    </button>
                    <button onclick="openPage('screen-review-questions')" class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex flex-col items-center justify-center gap-2 hover:bg-gray-50">
                        <div class="w-12 h-12 bg-yellow-100 rounded-full flex items-center justify-center text-yellow-600"><i class="fas fa-check-circle text-xl"></i></div>
                        <span class="font-bold text-sm text-gray-700">Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</span>
                    </button>
                </div>
            </div>
        </div>

        <div id="screen-admin-subscription" class="screen pt-20">
            <div class="absolute top-0 w-full h-20 bg-white shadow-sm z-30 flex items-center px-5 gap-4">
                <button onclick="openPage('screen-admin-hub')" class="text-gray-500"><i class="fas fa-arrow-right text-xl"></i></button>
                <h1 class="font-bold text-lg text-gray-800">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª</h1>
            </div>
            <div class="scroll-container px-5 py-6">
                <div class="flex flex-col gap-4">
                    <button onclick="openPage('screen-admin-generate-code')" class="bg-white p-6 rounded-2xl shadow-sm border border-green-100 flex flex-col items-center justify-center gap-3 hover:bg-green-50 transition">
                        <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center text-green-600"><i class="fas fa-key text-2xl"></i></div>
                        <h3 class="font-bold text-gray-800">ØªÙƒÙˆÙŠÙ† ÙƒÙˆØ¯</h3>
                    </button>

                    <button onclick="openPage('screen-admin-delete-code')" class="bg-white p-6 rounded-2xl shadow-sm border border-red-100 flex flex-col items-center justify-center gap-3 hover:bg-red-50 transition">
                        <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center text-red-600"><i class="fas fa-trash-alt text-2xl"></i></div>
                        <h3 class="font-bold text-gray-800">Ø­Ø°Ù ÙƒÙˆØ¯ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</h3>
                    </button>

                    <button onclick="openPage('screen-admin-premium-users')" class="bg-white p-6 rounded-2xl shadow-sm border border-blue-100 flex flex-col items-center justify-center gap-3 hover:bg-blue-50 transition">
                        <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center text-blue-600"><i class="fas fa-crown text-2xl"></i></div>
                        <h3 class="font-bold text-gray-800">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ù…ÙŠØ²ÙŠÙ†</h3>
                    </button>
                </div>
            </div>
        </div>

        <div id="screen-admin-generate-code" class="screen pt-20">
            <div class="absolute top-0 w-full h-20 bg-white shadow-sm z-30 flex items-center px-5 gap-4">
                <button onclick="openPage('screen-admin-subscription')" class="text-gray-500"><i class="fas fa-arrow-right text-xl"></i></button>
                <h1 class="font-bold text-lg text-gray-800">ØªÙƒÙˆÙŠÙ† ÙƒÙˆØ¯ Ø¬Ø¯ÙŠØ¯</h1>
            </div>
            <div class="scroll-container px-5 py-6">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                    <h3 class="font-bold text-gray-800 mb-3">ØªÙƒÙˆÙŠÙ† ÙƒÙˆØ¯ Ø§Ø´ØªØ±Ø§Ùƒ Ù…Ù…ÙŠØ²</h3>
                    <div class="mb-6">
                        <label class="block text-xs font-bold text-gray-500 mb-2">Ù…Ø¯Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</label>
                        <select id="admin-sub-duration" class="input-box mb-3">
                            <option value="7">Ø£Ø³Ø¨ÙˆØ¹ (7 Ø£ÙŠØ§Ù…)</option>
                            <option value="30">Ø´Ù‡Ø± (30 ÙŠÙˆÙ…)</option>
                            <option value="90">3 Ø£Ø´Ù‡Ø± (90 ÙŠÙˆÙ…)</option>
                            <option value="180">6 Ø£Ø´Ù‡Ø± (180 ÙŠÙˆÙ…)</option>
                            <option value="365">Ø³Ù†Ø© (365 ÙŠÙˆÙ…)</option>
                        </select>
                        <button onclick="generateSubscriptionCode()" class="btn-main bg-green-600 mb-4">
                            <i class="fas fa-key ml-2"></i> ØªÙƒÙˆÙŠÙ† ÙˆØªÙˆÙ„ÙŠØ¯ ÙƒÙˆØ¯
                        </button>
                        
                        <div id="generated-code-display" class="hidden bg-green-50 border border-green-200 p-4 rounded-xl text-center mt-4">
                            <p class="text-xs text-green-500 mb-1">Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯:</p>
                            <h2 class="text-2xl font-mono font-bold text-green-800 select-all" id="gen-code-text">...</h2>
                            <div class="flex justify-center gap-2 mt-3">
                                <button onclick="copyGenCode()" class="bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-green-700 transition flex items-center gap-1">
                                    <i class="fas fa-copy"></i> Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯
                                </button>
                                <button onclick="document.getElementById('generated-code-display').classList.add('hidden')" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm font-bold hover:bg-gray-300 transition">
                                    Ø¥Ø®ÙØ§Ø¡
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="screen-admin-delete-code" class="screen pt-20">
            <div class="absolute top-0 w-full h-20 bg-white shadow-sm z-30 flex items-center px-5 gap-4">
                <button onclick="openPage('screen-admin-subscription')" class="text-gray-500"><i class="fas fa-arrow-right text-xl"></i></button>
                <h1 class="font-bold text-lg text-gray-800">Ø­Ø°Ù ÙƒÙˆØ¯ Ø§Ø´ØªØ±Ø§Ùƒ</h1>
            </div>
            <div class="scroll-container px-5 py-6">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-red-100">
                    <h3 class="font-bold text-red-800 mb-3">Ø­Ø°Ù ÙƒÙˆØ¯ Ø§Ø´ØªØ±Ø§Ùƒ</h3>
                    <input type="text" id="admin-delete-code-input" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ Ù„Ø­Ø°ÙÙ‡" class="input-box mb-4 uppercase">
                    <button onclick="deleteSubscriptionCode()" class="btn-main bg-red-600 hover:bg-red-700">
                        <i class="fas fa-trash-alt ml-2"></i> Ø­Ø°Ù Ø§Ù„ÙƒÙˆØ¯
                    </button>
                </div>
            </div>
        </div>

        <div id="screen-admin-premium-users" class="screen pt-20">
            <div class="absolute top-0 w-full h-20 bg-white shadow-sm z-30 flex items-center px-5 gap-4">
                <button onclick="openPage('screen-admin-subscription')" class="text-gray-500"><i class="fas fa-arrow-right text-xl"></i></button>
                <h1 class="font-bold text-lg text-gray-800">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ù…ÙŠØ²ÙŠÙ†</h1>
            </div>
            <div class="scroll-container px-5 py-6">
                <div id="premium-users-list" class="space-y-3">
                    <p class="text-center text-gray-400">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
                </div>
            </div>
        </div>

        <div id="screen-admin-panel" class="screen pt-20">
            <div class="absolute top-0 w-full h-20 bg-white shadow-sm z-30 flex items-center px-5 gap-4">
                <button onclick="openPage('screen-admin-hub')" class="text-gray-500"><i class="fas fa-arrow-right text-xl"></i></button>
                <h1 class="font-bold text-lg text-gray-800">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</h1>
            </div>
            <div class="scroll-container px-5 py-6">
                <div class="bg-yellow-50 border border-yellow-200 rounded-2xl p-5 shadow-sm">
                    <h3 class="font-bold text-yellow-800 mb-2">ğŸ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¬ÙˆØ§Ø¦Ø² Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©</h3>
                    <button onclick="manualWeeklyDistribution()" class="w-full bg-yellow-500 text-white font-bold py-3 rounded-xl shadow-md hover:bg-yellow-600">ØªÙˆØ²ÙŠØ¹ ÙˆØªØµÙÙŠØ± Ø§Ù„Ø¢Ù†</button>
                </div>
            </div>
        </div>

        <div id="screen-admin-users" class="screen pt-20">
            <div class="absolute top-0 w-full h-20 bg-white shadow-sm z-30 flex items-center px-5 gap-4">
                <button onclick="openPage('screen-admin-hub')" class="text-gray-500"><i class="fas fa-arrow-right text-xl"></i></button>
                <h1 class="font-bold text-lg text-gray-800">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h1>
            </div>
            <div class="scroll-container px-5 py-6">
                <div class="flex gap-2 mb-6">
                    <input type="text" id="admin-user-search" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (ID)" class="input-box">
                    <button onclick="searchUserForAdmin()" class="btn-main w-auto px-6"><i class="fas fa-search"></i></button>
                </div>
                <div id="admin-user-result" class="hidden bg-white p-5 rounded-2xl shadow-md border border-gray-100"></div>
                
                <div id="banned-users-section" class="mt-8 hidden">
                    <h3 class="font-bold text-gray-800 mb-4 text-center">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø­Ø¸ÙˆØ±ÙŠÙ†</h3>
                    <div id="banned-users-list" class="space-y-3"></div>
                </div>
            </div>
        </div>

        <div id="screen-admin-stats" class="screen pt-20">
            <div class="absolute top-0 w-full h-20 bg-white shadow-sm z-30 flex items-center px-5 gap-4">
                <button onclick="openPage('screen-admin-hub')" class="text-gray-500"><i class="fas fa-arrow-right text-xl"></i></button>
                <h1 class="font-bold text-lg text-gray-800">Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</h1>
            </div>
            <div class="scroll-container px-5 py-6">
                <div id="stats-content" class="space-y-4"><p class="text-center text-gray-400">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p></div>
            </div>
        </div>

        <div id="screen-admin-all" class="screen pt-20">
            <div class="absolute top-0 w-full h-20 bg-white shadow-sm z-30 flex items-center px-5 gap-4">
                <button onclick="openPage('screen-admin-hub')" class="text-gray-500"><i class="fas fa-arrow-right text-xl"></i></button>
                <h1 class="font-bold text-lg text-gray-800">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…Ø±ÙÙˆØ¹Ø©</h1>
            </div>
            <div class="scroll-container px-5 py-6">
                <div class="bg-white p-3 rounded-xl mb-4 shadow-sm border border-gray-100">
                    <p class="text-xs font-bold text-gray-400 mb-2">ØªØµÙÙŠØ© Ø­Ø³Ø¨:</p>
                    <div class="flex gap-2">
                        <select id="admin-filter-grade" class="input-box text-sm p-2" onchange="filterAdminQuestions()">
                            <option value="">ÙƒÙ„ Ø§Ù„Ù…Ø±Ø§Ø­Ù„</option>
                            <option value="6sci">Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ù„Ø¹Ù„Ù…ÙŠ</option>
                            <option value="6lit">Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ù„Ø£Ø¯Ø¨ÙŠ</option>
                            <option value="3med">Ø§Ù„Ø«Ø§Ù„Ø« Ù…ØªÙˆØ³Ø·</option>
                        </select>
                        <select id="admin-filter-subject" class="input-box text-sm p-2" onchange="filterAdminQuestions()"><option value="">ÙƒÙ„ Ø§Ù„Ù…ÙˆØ§Ø¯</option></select>
                        <select id="admin-filter-type" class="input-box text-sm p-2" onchange="filterAdminQuestions()">
                            <option value="">ÙƒÙ„ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹</option>
                            <option value="mcq">Ø§Ø®ØªÙŠØ§Ø±Ø§Øª</option>
                            <option value="tf">ØµØ­/Ø®Ø·Ø£</option>
                        </select>
                    </div>
                </div>
                <div id="admin-all-list" class="space-y-3 pb-20"></div>
            </div>
        </div>

        <div id="screen-review-questions" class="screen pt-20">
            <div class="absolute top-0 w-full h-20 bg-white shadow-sm z-30 flex items-center px-5 gap-4">
                <button onclick="openPage('screen-admin-hub')" class="text-gray-500"><i class="fas fa-arrow-right text-xl"></i></button>
                <h1 class="font-bold text-lg text-gray-800">Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</h1>
            </div>
            <div class="scroll-container px-5 py-6">
                <div id="review-questions-list" class="space-y-3">
                    <p class="text-center text-gray-400">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©...</p>
                </div>
            </div>
        </div>

        <div id="screen-upload-questions" class="screen pt-20">
            <div class="absolute top-0 w-full h-20 bg-white shadow-sm z-30 flex items-center px-5 gap-4">
                <button onclick="backToProfile()" class="text-gray-500"><i class="fas fa-arrow-right text-xl"></i></button>
                <h1 class="font-bold text-lg text-gray-800">Ø±ÙØ¹ Ø£Ø³Ø¦Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©</h1>
            </div>
            <div class="scroll-container px-5 py-6">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                    <h3 class="font-bold text-gray-800 mb-4 text-center">Ø±ÙØ¹ Ø³Ø¤Ø§Ù„ Ø¬Ø¯ÙŠØ¯</h3>
                    
                    <div id="upload-step-1">
                        <div class="mb-4">
                            <label class="block text-sm font-bold text-gray-600 mb-2">Ø§Ù„Ù…Ø§Ø¯Ø©</label>
                            <select id="upload-subject" class="input-box" onchange="onUploadSubjectChange()">
                                <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø¯Ø©</option>
                            </select>
                        </div>

                        <div class="mb-6">
                            <label class="block text-sm font-bold text-gray-600 mb-2">Ù†ÙˆØ¹ Ø§Ù„Ø³Ø¤Ø§Ù„</label>
                            <div class="grid grid-cols-2 gap-3">
                                <button onclick="setUploadQType('mcq')" id="upload-btn-mcq" class="py-3 rounded-xl border-2 border-indigo-100 text-gray-500 font-bold active:scale-95 transition">Ø§Ø®ØªÙŠØ§Ø±Ø§Øª</button>
                                <button onclick="setUploadQType('tf')" id="upload-btn-tf" class="py-3 rounded-xl border-2 border-indigo-100 text-gray-500 font-bold active:scale-95 transition">ØµØ­ ÙˆØ®Ø·Ø£</button>
                            </div>
                        </div>

                        <button onclick="goToUploadStep2()" class="beautiful-btn">
                            <i class="fas fa-arrow-left"></i> Ø§Ù„ØªØ§Ù„ÙŠ
                        </button>
                    </div>

                    <div id="upload-step-2-mcq" class="hidden">
                        <div class="mb-4">
                            <label class="block text-sm font-bold text-gray-600 mb-2">Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„</label>
                            <textarea id="upload-question-text" class="input-box h-24" placeholder="Ø§ÙƒØªØ¨ Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„ Ù‡Ù†Ø§..." maxlength="500"></textarea>
                        </div>

                        <div class="space-y-3 mb-4">
                            <div>
                                <label class="block text-sm font-bold text-gray-600 mb-2">Ø§Ù„Ø®ÙŠØ§Ø± 1</label>
                                <div class="flex gap-2">
                                    <input type="text" id="upload-answer-1" class="input-box flex-1" placeholder="Ø§Ù„Ù†Øµ">
                                    <button onclick="setCorrectAnswer(1)" id="upload-correct-1" class="w-12 bg-gray-100 text-gray-600 rounded-lg">âœ“</button>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-gray-600 mb-2">Ø§Ù„Ø®ÙŠØ§Ø± 2</label>
                                <div class="flex gap-2">
                                    <input type="text" id="upload-answer-2" class="input-box flex-1" placeholder="Ø§Ù„Ù†Øµ">
                                    <button onclick="setCorrectAnswer(2)" id="upload-correct-2" class="w-12 bg-gray-100 text-gray-600 rounded-lg">âœ“</button>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-gray-600 mb-2">Ø§Ù„Ø®ÙŠØ§Ø± 3</label>
                                <div class="flex gap-2">
                                    <input type="text" id="upload-answer-3" class="input-box flex-1" placeholder="Ø§Ù„Ù†Øµ">
                                    <button onclick="setCorrectAnswer(3)" id="upload-correct-3" class="w-12 bg-gray-100 text-gray-600 rounded-lg">âœ“</button>
                                </div>
                            </div>
                        </div>

                        <div class="flex gap-3">
                            <button onclick="goToUploadStep1()" class="beautiful-btn secondary flex-1">
                                <i class="fas fa-arrow-right"></i> Ø±Ø¬ÙˆØ¹
                            </button>
                            <button onclick="submitQuestionMCQ()" class="beautiful-btn flex-1">
                                <i class="fas fa-paper-plane"></i> Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©
                            </button>
                        </div>
                    </div>

                    <div id="upload-step-2-tf" class="hidden">
                        <div class="mb-4">
                            <label class="block text-sm font-bold text-gray-600 mb-2">Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„</label>
                            <textarea id="upload-tf-question" class="input-box h-24" placeholder="Ø§ÙƒØªØ¨ Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„ Ù‡Ù†Ø§..." maxlength="500"></textarea>
                        </div>

                        <div class="mb-6">
                            <label class="block text-sm font-bold text-gray-600 mb-2">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©</label>
                            <div class="grid grid-cols-2 gap-3">
                                <button onclick="setTFAnswer(true)" id="upload-tf-true" class="py-3 rounded-xl border-2 border-green-100 text-gray-500 font-bold">ØµØ­</button>
                                <button onclick="setTFAnswer(false)" id="upload-tf-false" class="py-3 rounded-xl border-2 border-red-100 text-gray-500 font-bold">Ø®Ø·Ø£</button>
                            </div>
                        </div>

                        <div class="flex gap-3">
                            <button onclick="goToUploadStep1()" class="beautiful-btn secondary flex-1">
                                <i class="fas fa-arrow-right"></i> Ø±Ø¬ÙˆØ¹
                            </button>
                            <button onclick="submitQuestionTF()" class="beautiful-btn flex-1">
                                <i class="fas fa-paper-plane"></i> Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ø´Ø§Ø´Ø© ØªØ­Ø¯ÙŠ Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡ -->
<div id="screen-friend-challenge" class="screen pt-20">
    <div class="absolute top-0 w-full h-20 bg-white shadow-sm z-30 flex items-center px-5 gap-4">
        <button onclick="backToChallenges()" class="text-gray-500"><i class="fas fa-arrow-right text-xl"></i></button>
        <h1 class="font-bold text-lg text-gray-800">ØªØ­Ø¯ÙŠ Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡</h1>
    </div>
    <div class="scroll-container px-5 py-6">
        <div id="room-content" class="room-container">
            <div class="empty-state">
                <div class="empty-state-icon">
                    <i class="fas fa-users"></i>
                </div>
                <h3 class="text-lg font-bold text-gray-700 mb-2">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØºØ±ÙØ©...</h3>
                <p class="text-gray-500">ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹</p>
            </div>
        </div>
    </div>
</div>

<!-- Ø´Ø§Ø´Ø© Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ© -->
<div id="screen-create-room" class="screen pt-20">
    <div class="absolute top-0 w-full h-20 bg-white shadow-sm z-30 flex items-center px-5 gap-4">
        <button onclick="backToFriendChallenge()" class="text-gray-500"><i class="fas fa-arrow-right text-xl"></i></button>
        <h1 class="font-bold text-lg text-gray-800">Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ©</h1>
    </div>
    <div class="scroll-container px-5 py-6">
        <div class="room-form-card">
            <h3 class="font-bold text-gray-800 mb-6 text-center text-xl">Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ© Ù„ØªØ­Ø¯ÙŠ ØµØ¯ÙŠÙ‚</h3>
            
            <div class="mb-6">
                <label class="block text-sm font-bold text-gray-600 mb-3">Ø§Ù„Ù…Ø§Ø¯Ø©</label>
                <select id="room-subject" class="input-box text-lg text-center py-4">
                    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø¯Ø©</option>
                </select>
            </div>

            <div class="mb-8">
                <label class="block text-sm font-bold text-gray-600 mb-3">Ù†ÙˆØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</label>
                <div class="grid grid-cols-2 gap-4">
                    <button onclick="setRoomQType('mcq')" id="room-btn-mcq" class="py-4 rounded-xl border-2 border-indigo-100 text-gray-500 font-bold text-lg active:scale-95 transition">
                        Ø§Ø®ØªÙŠØ§Ø±Ø§Øª
                    </button>
                    <button onclick="setRoomQType('tf')" id="room-btn-tf" class="py-4 rounded-xl border-2 border-indigo-100 text-gray-500 font-bold text-lg active:scale-95 transition">
                        ØµØ­ ÙˆØ®Ø·Ø£
                    </button>
                </div>
            </div>

            <button onclick="createRoom()" class="beautiful-btn py-4 text-lg">
                <i class="fas fa-plus-circle text-xl"></i> 
                <span>Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØºØ±ÙØ©</span>
            </button>
            
            <p class="text-center text-gray-500 text-sm mt-6">
                â“˜ Ù…Ø¯Ø© Ø§Ù„ØºØ±ÙØ©: 10 Ø¯Ù‚Ø§Ø¦Ù‚ ÙÙ‚Ø·
            </p>
        </div>
    </div>
</div>

<!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ ØºØ±ÙØ© -->
<div id="screen-join-room" class="screen pt-20">
    <div class="absolute top-0 w-full h-20 bg-white shadow-sm z-30 flex items-center px-5 gap-4">
        <button onclick="backToFriendChallenge()" class="text-gray-500"><i class="fas fa-arrow-right text-xl"></i></button>
        <h1 class="font-bold text-lg text-gray-800">Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ ØºØ±ÙØ©</h1>
    </div>
    <div class="scroll-container px-5 py-6">
        <div class="room-form-card">
            <h3 class="font-bold text-gray-800 mb-6 text-center text-xl">Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ ØºØ±ÙØ© ØµØ¯ÙŠÙ‚</h3>
            
            <div class="mb-8">
                <label class="block text-sm font-bold text-gray-600 mb-3">Ø±Ù‚Ù… Ø§Ù„ØºØ±ÙØ© (8 Ø£Ø±Ù‚Ø§Ù…)</label>
                <input type="text" id="room-code-input" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„ØºØ±ÙØ©" 
                       class="input-box text-center font-mono text-2xl tracking-widest py-4" 
                       maxlength="8" inputmode="numeric">
            </div>

            <button onclick="joinRoom()" class="beautiful-btn py-4 text-lg mb-4">
                <i class="fas fa-sign-in-alt text-xl"></i> 
                <span>Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„ØºØ±ÙØ©</span>
            </button>
            
            <button onclick="backToFriendChallenge()" class="beautiful-btn secondary py-4 text-lg">
                <i class="fas fa-times text-xl"></i>
                <span>Ø¥Ù„ØºØ§Ø¡</span>
            </button>
        </div>
    </div>
</div>

<!-- Ù†Ø§ÙØ°Ø© Ù…Ù†Ø¨Ø«Ù‚Ø© Ù„ØªØ­Ø¯ÙŠ Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡ -->
<div id="friend-challenge-modal" class="modal-overlay hidden">
    <div class="beautiful-modal">
        <button onclick="closeFriendChallengeModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
            <i class="fas fa-times text-xl"></i>
        </button>
        <h3 class="font-bold text-2xl mb-8 text-center text-indigo-700">ØªØ­Ø¯ÙŠ Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡</h3>
        
        <div class="space-y-4">
            <button onclick="openCreateRoomScreen()" class="beautiful-btn py-5 text-lg">
                <i class="fas fa-plus-circle text-2xl"></i>
                <span class="text-xl">Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ©</span>
            </button>
            
            <button onclick="openJoinRoomScreen()" class="beautiful-btn secondary py-5 text-lg">
                <i class="fas fa-search text-2xl"></i>
                <span class="text-xl">Ø§Ø¨Ø­Ø« Ø¹Ù† ØºØ±ÙØ©</span>
            </button>
        </div>
        
        <div class="mt-8 text-center text-gray-500 text-sm">
            <p>â“˜ Ø§Ù†Ø´Ø¦ ØºØ±ÙØ© ÙˆØ´Ø§Ø±Ùƒ Ø§Ù„Ø±Ù‚Ù… Ù…Ø¹ Ø£ØµØ¯Ù‚Ø§Ø¦Ùƒ Ù„Ù„Ø§Ù†Ø¶Ù…Ø§Ù…</p>
            <p class="mt-1">Ù…Ø¯Ø© Ø§Ù„ØºØ±ÙØ©: 10 Ø¯Ù‚Ø§Ø¦Ù‚ ÙÙ‚Ø·</p>
        </div>
    </div>
</div>
        
        <div class="fixed bottom-0 w-full bg-white border-t border-gray-100 flex justify-around items-center h-20 pb-2 z-40 shadow-[0_-5px_20px_rgba(0,0,0,0.03)]">
            <div onclick="switchTab('challenges')" class="nav-item active flex-1 flex flex-col items-center justify-center h-full cursor-pointer">
                <i class="fas fa-gamepad text-xl mb-1"></i><span class="text-[10px] font-bold">Ø§Ù„ØªØ­Ø¯ÙŠØ§Øª</span>
            </div>
            <div onclick="switchTab('leaderboard')" class="nav-item flex-1 flex flex-col items-center justify-center h-full cursor-pointer text-gray-400">
                <i class="fas fa-trophy text-xl mb-1"></i><span class="text-[10px] font-bold">Ø§Ù„ØªØµÙ†ÙŠÙ</span>
            </div>
            <div onclick="switchTab('schedule')" class="nav-item flex-1 flex flex-col items-center justify-center h-full cursor-pointer text-gray-400">
                <i class="fas fa-calendar-alt text-xl mb-1"></i><span class="text-[10px] font-bold">Ø¬Ø¯ÙˆÙ„ ÙŠÙˆÙ…ÙŠ</span>
            </div>
            <div onclick="switchTab('profile')" class="nav-item flex-1 flex flex-col items-center justify-center h-full cursor-pointer text-gray-400 relative">
                <i class="fas fa-user text-xl mb-1"></i><span class="text-[10px] font-bold">Ø­Ø³Ø§Ø¨ÙŠ</span>
                <div id="profile-tab-badge" class="red-dot"></div>
            </div>
        </div>
        
        <div id="premium-details-modal" class="modal-overlay hidden">
            <div class="modal-content relative bg-gradient-to-br from-indigo-900 to-indigo-800 text-white border-2 border-yellow-500">
                <button onclick="document.getElementById('premium-details-modal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
                <div class="text-center mb-6">
                    <i class="fas fa-crown text-5xl text-yellow-400 mb-3 animate-bounce"></i>
                    <h2 class="text-2xl font-black text-yellow-400">Ù…Ù…ÙŠØ²Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ù…ÙŠØ²</h2>
                </div>
                <div class="space-y-4 text-right">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-yellow-500 text-indigo-900 flex items-center justify-center font-bold"><i class="fas fa-check"></i></div>
                        <p class="font-bold">ØªÙˆØ«ÙŠÙ‚ Ù…Ù…ÙŠØ² Ù„Ù„Ø­Ø³Ø§Ø¨ (Ø¹Ù„Ø§Ù…Ø© Ø¨Ø¬Ø§Ù†Ø¨ Ø§Ù„Ø§Ø³Ù…).</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-yellow-500 text-indigo-900 flex items-center justify-center font-bold"><i class="fas fa-check"></i></div>
                        <p class="font-bold">Ø®Ù„ÙÙŠØ© Ù…Ù…ÙŠØ²Ø© Ù…ØªØ­Ø±ÙƒØ© ÙÙŠ Ø§Ù„ØªØµÙ†ÙŠÙ.</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-yellow-500 text-indigo-900 flex items-center justify-center font-bold">2x</div>
                        <p class="font-bold">Ù†Ù‚Ø§Ø· Ù…Ø¶Ø§Ø¹ÙØ© Ù…Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ§Øª.</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-yellow-500 text-indigo-900 flex items-center justify-center font-bold">$$</div>
                        <p class="font-bold">Ø£Ù…ÙˆØ§Ù„ Ù…Ø¶Ø§Ø¹ÙØ© Ø¹Ù†Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø§Ø³Ø¨ÙˆØ¹.</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-yellow-500 text-indigo-900 flex items-center justify-center font-bold">15</div>
                        <p class="font-bold">15 Ù…Ø­Ø§ÙˆÙ„Ø© ÙŠÙˆÙ…ÙŠØ© ÙÙŠ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ.</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-yellow-500 text-indigo-900 flex items-center justify-center font-bold"><i class="fas fa-star"></i></div>
                        <p class="font-bold">Ø£ÙˆÙ„ÙˆÙŠØ© ÙÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ø¨Ø§Ø±ÙŠØ§Øª.</p>
                    </div>
                </div>
                <button onclick="document.getElementById('premium-details-modal').classList.add('hidden')" class="mt-8 w-full bg-yellow-500 text-indigo-900 font-bold py-3 rounded-xl hover:bg-yellow-400 transition">ÙÙ‡Ù…ØªØŒ Ø´ÙƒØ±Ø§Ù‹</button>
            </div>
        </div>

        <div id="badge-selector-modal" class="modal-overlay hidden">
            <div class="modal-content relative">
                 <button onclick="document.getElementById('badge-selector-modal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400"><i class="fas fa-times"></i></button>
                 <h3 class="font-bold text-lg mb-4 text-indigo-700 text-center">Ø§Ø®ØªØ± Ù„Ù‚Ø¨ Ø§Ù„ØªÙˆØ«ÙŠÙ‚</h3>
                 <div class="grid grid-cols-2 gap-3 max-h-[60vh] overflow-y-auto p-2" id="badge-grid"></div>
            </div>
        </div>

        <div id="bg-selector-modal" class="modal-overlay hidden">
             <div class="modal-content relative">
                 <button onclick="document.getElementById('bg-selector-modal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400"><i class="fas fa-times"></i></button>
                 <h3 class="font-bold text-lg mb-4 text-purple-700 text-center">Ø§Ø®ØªØ± Ø®Ù„ÙÙŠØ© Ø§Ù„ØªØµÙ†ÙŠÙ</h3>
                 <div class="space-y-3" id="bg-grid"></div>
            </div>
        </div>
        
        <div id="edit-modal" class="modal-overlay hidden">
            <div class="modal-content relative">
                <button onclick="document.getElementById('edit-modal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
                <h3 class="font-bold text-lg mb-4 text-indigo-700 border-b pb-2">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø´Ø§Ù…Ù„</h3>
                <input type="hidden" id="edit-q-id">
                <label class="block text-xs font-bold text-gray-500 mb-1">Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„</label>
                <textarea id="edit-q-text" class="input-box h-20 mb-3 text-sm"></textarea>
                <div class="flex gap-2 mb-3">
                     <div class="flex-1"><label class="block text-xs font-bold text-gray-500 mb-1">Ø§Ù„ØµÙ</label><select id="edit-q-grade" class="input-box text-sm p-2"><option value="6sci">6 Ø¹Ù„Ù…ÙŠ</option><option value="6lit">6 Ø£Ø¯Ø¨ÙŠ</option><option value="3med">3 Ù…ØªÙˆØ³Ø·</option></select></div>
                     <div class="flex-1"><label class="block text-xs font-bold text-gray-500 mb-1">Ø§Ù„Ù…Ø§Ø¯Ø©</label><select id="edit-q-subject" class="input-box text-sm p-2"></select></div>
                </div>
                <div id="edit-mcq-fields" class="hidden">
                     <label class="block text-xs font-bold text-gray-500 mb-1">Ø§Ù„Ø®ÙŠØ§Ø± 1</label><input type="text" id="edit-ans-0" class="input-box mb-2 p-2 text-sm">
                     <label class="block text-xs font-bold text-gray-500 mb-1">Ø§Ù„Ø®ÙŠØ§Ø± 2</label><input type="text" id="edit-ans-1" class="input-box mb-2 p-2 text-sm">
                     <label class="block text-xs font-bold text-gray-500 mb-1">Ø§Ù„Ø®ÙŠØ§Ø± 3</label><input type="text" id="edit-ans-2" class="input-box mb-3 p-2 text-sm">
                     <label class="block text-xs font-bold text-green-600 mb-1">Ø±Ù‚Ù… Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© (0, 1, 2)</label>
                     <select id="edit-correct-mcq" class="input-box p-2 text-sm"><option value="0">Ø§Ù„Ø®ÙŠØ§Ø± 1</option><option value="1">Ø§Ù„Ø®ÙŠØ§Ø± 2</option><option value="2">Ø§Ù„Ø®ÙŠØ§Ø± 3</option></select>
                </div>
                <div id="edit-tf-fields" class="hidden">
                    <label class="block text-xs font-bold text-green-600 mb-1">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©</label>
                    <select id="edit-correct-tf" class="input-box p-2 text-sm"><option value="true">ØµØ­</option><option value="false">Ø®Ø·Ø£</option></select>
                </div>
                <button onclick="saveFullEditQ()" class="btn-main mt-6 bg-indigo-600 text-sm">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
            </div>
        </div>

        <div id="add-subscription-modal" class="modal-overlay hidden">
            <div class="modal-content relative">
                <button onclick="document.getElementById('add-subscription-modal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
                <h3 class="font-bold text-lg mb-4 text-indigo-700 text-center">Ø¥Ø¶Ø§ÙØ© Ø§Ø´ØªØ±Ø§Ùƒ</h3>
                <input type="text" id="add-subscription-code" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ" class="input-box mb-4 text-center font-mono text-lg uppercase">
                <button onclick="addSubscriptionTime()" class="btn-main bg-green-600 hover:bg-green-700">
                    <i class="fas fa-plus-circle ml-2"></i> Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¯Ø©
                </button>
            </div>
        </div>

        <div id="edit-bio-modal" class="modal-overlay hidden">
            <div class="modal-content relative">
                <button onclick="document.getElementById('edit-bio-modal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
                <h3 class="font-bold text-lg mb-4 text-indigo-700 text-center">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø³ÙŠØ±Ø© Ø§Ù„Ø°Ø§ØªÙŠØ©</h3>
                <textarea id="edit-bio-input" class="input-box h-32 mb-4" placeholder="Ø§ÙƒØªØ¨ Ù†Ø¨Ø°Ø© Ø¹Ù†Ùƒ..." maxlength="25"></textarea>
                <button onclick="saveProfileBio()" class="btn-main bg-indigo-600 hover:bg-indigo-700">Ø­ÙØ¸</button>
            </div>
        </div>

        <div id="edit-name-modal" class="modal-overlay hidden">
            <div class="modal-content relative">
                <button onclick="document.getElementById('edit-name-modal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
                <h3 class="font-bold text-lg mb-4 text-indigo-700 text-center">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù…</h3>
                <input type="text" id="edit-name-input" class="input-box mb-4" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯">
                <button onclick="saveProfileName()" class="btn-main bg-indigo-600 hover:bg-indigo-700">Ø­ÙØ¸</button>
            </div>
        </div>

        <div id="beautiful-alert" class="beautiful-alert hidden">
            <div id="beautiful-alert-icon" class="beautiful-alert-icon">!</div>
            <h3 id="beautiful-alert-title" class="beautiful-alert-title">ØªÙ†Ø¨ÙŠÙ‡</h3>
            <p id="beautiful-alert-message" class="beautiful-alert-message">...</p>
            <button id="beautiful-alert-ok-btn" class="beautiful-alert-btn">Ø­Ø³Ù†Ø§Ù‹</button>
        </div>

        <div id="friend-challenge-modal" class="modal-overlay hidden">
            <div class="beautiful-modal">
                <button onclick="closeFriendChallengeModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
                <h3 class="font-bold text-lg mb-6 text-center text-indigo-700">ØªØ­Ø¯ÙŠ Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡</h3>
                
                <div class="space-y-4">
                    <button onclick="openCreateRoomScreen()" class="beautiful-btn">
                        <i class="fas fa-plus-circle"></i> Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ©
                    </button>
                    
                    <button onclick="openJoinRoomScreen()" class="beautiful-btn secondary">
                        <i class="fas fa-sign-in-alt"></i> Ø§Ø¨Ø­Ø« Ø¹Ù† ØºØ±ÙØ©
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Ø£Ø¶Ù Ù‡Ø°Ø§ Ø¨Ø¹Ø¯ Ù‚Ø³Ù… tab-profile Ù…Ø¨Ø§Ø´Ø±Ø© -->
<div id="screen-notifications" class="screen pt-20">
    <div class="absolute top-0 w-full h-20 bg-white shadow-sm z-30 flex items-center px-5 gap-4">
        <button onclick="backToMain()" class="text-gray-500"><i class="fas fa-arrow-right text-xl"></i></button>
        <h1 class="font-bold text-lg text-gray-800">Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</h1>
        <button onclick="markAllNotificationsAsRead()" class="mr-auto text-indigo-600 text-sm font-bold">ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„ ÙƒÙ…Ù‚Ø±ÙˆØ¡</button>
    </div>
    <div class="scroll-container px-5 py-6">
        <div id="notifications-list" class="space-y-3 pb-20">
            <div class="text-center py-10">
                <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-3">
                    <i class="fas fa-bell text-2xl text-gray-400"></i>
                </div>
                <p class="text-gray-500 font-bold">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</p>
                <p class="text-gray-400 text-sm mt-1">Ø³ÙŠØ¸Ù‡Ø± Ù‡Ù†Ø§ Ø¢Ø®Ø± Ø¥Ø´Ø¹Ø§Ø±Ø§ØªÙƒ</p>
            </div>
        </div>
    </div>
</div>

<script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, setDoc, updateDoc, onSnapshot, query, where, orderBy, limit, deleteDoc, serverTimestamp, increment, getDoc, writeBatch, Timestamp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAfLOjiPiSQW9opdiIgQif3pAp8zsezy58",
            authDomain: "ministerial-hacker.firebaseapp.com",
            databaseURL: "https://ministerial-hacker-default-rtdb.firebaseio.com",
            projectId: "ministerial-hacker",
            storageBucket: "ministerial-hacker.firebasestorage.app",
            messagingSenderId: "557133038084",
            appId: "1:557133038084:web:c8cb7df6ef0abef2beab51",
            measurementId: "G-WYMSX2LRTW"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        
        const ADMIN_EMAIL = "mslmalmyaly223@gmail.com";

        setPersistence(auth, browserLocalPersistence).catch(e => console.error("Persistence Error", e));

        let currentUser = null;
        let userData = null;
        let allAdminQuestions = []; 
        let adminListenerUnsubscribe = null;
        let countdownInterval = null;
        
        let premiumInterval = null;
        const BADGES_LIST = ["Ø³Ø¬Ø§Ø¬", "Ø³Ø¬Ø§Ø¬Ø©", "Ø¯ÙƒØªÙˆØ±", "Ø¯ÙƒØªÙˆØ±Ø©", "ÙƒØ³Ù„Ø§Ù†", "ÙƒØ³ÙˆÙ„Ø©", "Ø´Ø·ÙˆØ±", "Ø´Ø·ÙˆØ±Ø©", "Ù†Ø§ÙŠÙ…", "Ù†Ø§ÙŠÙ…Ø©", "Ù†Ø¹Ø³Ø§Ù†", "Ù†Ø¹Ø³Ø§Ù†Ø©", "Ù…Ø§ÙƒÙˆ ÙˆØ§Ù‡Ø³", "Ù…Ù‡Ù†Ø¯Ø³", "Ù…Ù‡Ù†Ø¯Ø³Ø©", "ÙˆØ§Ø­Ø¯ Ø¹Ø±Ø§Ù‚", "ØµÚ¯Ø§Ø±ÙƒÙ…", "ØµÚ¯Ø§Ø±ØªÙƒÙ…", "ÙØ³ØªÙ‚Ø©", "Ø§Ù„Ù…Ø­Ø§Ù…ÙŠ", "Ø§Ù„Ù…Ø­Ø§Ù…ÙŠØ©"];
        const BACKGROUNDS_LIST = [
            { id: 'bg-medical', name: 'Ø·Ø¨ÙŠ (Ø³Ù…Ø§Ø¦ÙŠ)', class: 'bg-medical' },
            { id: 'bg-law', name: 'Ù‚Ø§Ù†ÙˆÙ† (Ø¬ÙˆØ²ÙŠ)', class: 'bg-law' },
            { id: 'bg-edu', name: 'ØªØ¹Ù„ÙŠÙ… (Ø£Ø®Ø¶Ø±)', class: 'bg-edu' },
            { id: 'bg-eng', name: 'Ù‡Ù†Ø¯Ø³Ø© (Ø£ØµÙØ±)', class: 'bg-eng' },
            { id: 'bg-smart', name: 'Ø°ÙƒÙŠ (Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ)', class: 'bg-smart' },
            { id: 'bg-love', name: 'Ø­Ø¨ (ÙˆØ±Ø¯ÙŠ)', class: 'bg-love' }
        ];

        const subjects = {
            '6sci': ['Ø§Ø³Ù„Ø§Ù…ÙŠØ©', 'Ø¹Ø±Ø¨ÙŠ', 'Ø§Ù†ÙƒÙ„ÙŠØ²ÙŠ', 'Ø§Ø­ÙŠØ§Ø¡', 'Ø±ÙŠØ§Ø¶ÙŠØ§Øª', 'ÙƒÙŠÙ…ÙŠØ§Ø¡', 'ÙÙŠØ²ÙŠØ§Ø¡'],
            '6lit': ['Ø§Ø³Ù„Ø§Ù…ÙŠØ©', 'Ø¹Ø±Ø¨ÙŠ', 'Ø§Ù†ÙƒÙ„ÙŠØ²ÙŠ', 'ØªØ§Ø±ÙŠØ®', 'Ø±ÙŠØ§Ø¶ÙŠØ§Øª', 'Ø¬ØºØ±Ø§ÙÙŠØ©', 'Ø§Ù‚ØªØµØ§Ø¯'],
            '3med': ['Ø§Ø³Ù„Ø§Ù…ÙŠØ©', 'Ø¹Ø±Ø¨ÙŠ', 'Ø§Ù†ÙƒÙ„ÙŠØ²ÙŠ', 'Ø±ÙŠØ§Ø¶ÙŠØ§Øª', 'ÙƒÙŠÙ…ÙŠØ§Ø¡', 'ÙÙŠØ²ÙŠØ§Ø¡', 'Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ§Øª', 'Ø§Ø­ÙŠØ§Ø¡']
        };

        const sharedSubjects = ['Ø§Ø³Ù„Ø§Ù…ÙŠØ©', 'Ø¹Ø±Ø¨ÙŠ', 'Ø§Ù†ÙƒÙ„ÙŠØ²ÙŠ'];

        let uploadQType = 'mcq';
        let uploadCorrectAnswer = null;
        let uploadTFAnswer = null;
        let dailyAIRemaining = 10;
        let uploadSubject = null;
        
        // Ù…ØªØºÙŠØ±Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ù†Ø¸Ø§Ù…
        let allLeaderboardUsers = [];
        let leaderboardOffset = 0;
        const LEADERBOARD_LIMIT = 50;
        const LEADERBOARD_CHUNK_SIZE = 25;
        
        let currentGameData = null;
        let gameTimerInterval = null;
        let gameQuestions = [];
        let currentQuestionIndex = 0;
        let myScore = 0;
        let opponentScore = 0;
        let gameType = null;
        let opponentId = null;
        let opponentData = null;
        let gameId = null;
        let currentGameTimer = 15;
        let gameRoomId = null;
        let isGameActive = false;
        let playerAnswers = [];
        let opponentAnswers = [];

        onAuthStateChanged(auth, async (user) => {
            const intro = document.getElementById('intro-screen');
            const authScreen = document.getElementById('auth-screen');
            const mainApp = document.getElementById('main-app');
            const banScreen = document.getElementById('ban-screen');

            if (user) {
                currentUser = user;
                console.log("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­ØŒ UID:", user.uid);

                try {
                    const docSnap = await getDoc(doc(db, "users", user.uid));
                    if (docSnap.exists()) {
                        userData = docSnap.data();
                        console.log("ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:", userData.name);

                        if (userData.isBanned === true) {
                            banScreen.classList.remove('hidden');
                            await signOut(auth);
                            localStorage.setItem('device_banned', 'true');
                            return;
                        }

                        if (localStorage.getItem('device_banned') === 'true' && userData.email !== ADMIN_EMAIL) {
                            banScreen.classList.remove('hidden');
                            await signOut(auth);
                            return;
                        }

                        await updateDoc(doc(db, "users", user.uid), { 
                            lastActive: serverTimestamp(),
                            lastLogin: new Date().toISOString()
                        });
                        
                        setupProfileUI();
                        setupHeaderUI();
                        setupAdminUI();
                        checkDailyReward();
                        checkPremiumStatus();
                        if(userData.email === ADMIN_EMAIL) checkAdminNotifications();
                        checkPendingQuestionsNotification();

                        if (userData.grade) {
                            document.getElementById('grade-selector-card').classList.add('hidden');
                            document.getElementById('challenge-active-card').classList.remove('hidden');
                            document.getElementById('header-grade-badge').innerText = getGradeName(userData.grade);
                            document.getElementById('header-grade-badge').classList.remove('hidden');
                            populateSubjectsForGrade(userData.grade);
                        } else {
                            document.getElementById('grade-selector-card').classList.remove('hidden');
                            document.getElementById('challenge-active-card').classList.add('hidden');
                            document.getElementById('header-grade-badge').classList.add('hidden');
                        }
                        
                        setTimeout(() => {
                            intro.classList.add('hidden');
                            authScreen.classList.add('hidden');
                            mainApp.classList.remove('hidden');
                            if(!document.querySelector('.screen.active')) switchTab('challenges');
                            startWeeklyCountdown();
                            loadUserSchedule();
                        }, 2500);
                        
                    } else {
                        console.log("Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŒ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬...");
                        await signOut(auth);
                        location.reload();
                    }
                } catch(e) { 
                    console.error("Auth Data Error:", e); 
                    showBeautifulAlert('error', 'Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
                    await signOut(auth);
                    location.reload();
                }
            } else {
                console.log("Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„");
                setTimeout(() => {
                    intro.classList.add('hidden');
                    mainApp.classList.add('hidden');
                    banScreen.classList.add('hidden');
                    authScreen.classList.remove('hidden');
                    window.switchAuthTab('login');
                }, 2000);
            }
        });

        async function compressImage(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        let width = img.width;
                        let height = img.height;
                        const maxSize = 200;
                        
                        if (width > height) {
                            if (width > maxSize) {
                                height = Math.round((height * maxSize) / width);
                                width = maxSize;
                            }
                        } else {
                            if (height > maxSize) {
                                width = Math.round((width * maxSize) / height);
                                height = maxSize;
                            }
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        const compressedDataUrl = canvas.toDataURL('image/jpeg', 0.8);
                        resolve(compressedDataUrl);
                    };
                };
            });
        }

        async function uploadImageToStorage(file, userId) {
            try {
                const compressedImage = await compressImage(file);
                const blob = await fetch(compressedImage).then(r => r.blob());
                
                const storageRef = ref(storage, `profile_images/${userId}_${Date.now()}.jpg`);
                const snapshot = await uploadBytes(storageRef, blob);
                const downloadURL = await getDownloadURL(snapshot.ref);
                
                return downloadURL;
            } catch (error) {
                console.error("Error uploading image:", error);
                throw error;
            }
        }

        function startWeeklyCountdown() {
            if(countdownInterval) clearInterval(countdownInterval);
            const timerEl = document.getElementById('weekly-timer');
            
            function updateTimer() {
                const now = new Date();
                const day = now.getDay(); 
                const hour = now.getHours();
                const minute = now.getMinutes();
                const second = now.getSeconds();
                
                let daysUntilFriday = 5 - day;
                if (day > 5 || (day === 5 && (hour > 0 || minute > 0 || second > 0))) {
                    daysUntilFriday += 7;
                }
                
                const target = new Date(now);
                target.setDate(now.getDate() + daysUntilFriday);
                target.setHours(0, 0, 0, 0);
                
                const diff = target - now;
                
                if (diff <= 0) {
                    timerEl.innerText = "00:00:00:00";
                    if (!window.weeklyRewardDistributed) {
                        window.weeklyRewardDistributed = true;
                        setTimeout(() => autoDistributeWeeklyPrizes(), 1000);
                    }
                    return;
                }

                const d = Math.floor(diff / (1000 * 60 * 60 * 24));
                const h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const s = Math.floor((diff % (1000 * 60)) / 1000);

                timerEl.innerText = `${d}:${h<10?'0'+h:h}:${m<10?'0'+m:m}:${s<10?'0'+s:s}`;
                
                if (d === 0 && h === 0 && m === 0 && s < 60) {
                    window.weeklyRewardDistributed = false;
                }
            }
            updateTimer();
            countdownInterval = setInterval(updateTimer, 1000);
        }

        async function autoDistributeWeeklyPrizes() {
            try {
                console.log("Ø¨Ø¯Ø¡ Ø§Ù„ØªÙˆØ²ÙŠØ¹ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ø¬ÙˆØ§Ø¦Ø² Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©...");
                
                const q = query(collection(db, "users"), orderBy("points", "desc"), limit(10));
                const snap = await getDocs(q);
                const prizes = [10, 7, 5, 3, 2, 1, 1, 1, 1, 1];
                
                let batch = writeBatch(db);
                
                snap.docs.forEach((d, index) => {
                    if(index < 10) {
                        const prize = prizes[index];
                        const newBalance = (d.data().balance || 0) + prize;
                        batch.update(doc(db, "users", d.id), { 
                            balance: newBalance,
                            lastWeeklyPrize: prize,
                            lastWeeklyRank: index + 1
                        });
                    }
                });
                await batch.commit();

                const qReset = query(collection(db, "users"), orderBy("points", "desc"), limit(150));
                const snapReset = await getDocs(qReset);
                
                let resetBatch = writeBatch(db);
                snapReset.docs.forEach(d => {
                    resetBatch.update(doc(db, "users", d.id), { 
                        points: 0,
                        previousPoints: d.data().points || 0
                    });
                });
                await resetBatch.commit();
                
                await setDoc(doc(db, "system_settings", "last_weekly_distribution"), {
                    timestamp: serverTimestamp(),
                    distributedBy: 'auto-system'
                }, { merge: true });
                
                console.log("âœ… ØªÙ… Ø§Ù„ØªÙˆØ²ÙŠØ¹ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ø¬ÙˆØ§Ø¦Ø² ÙˆØªØµÙÙŠØ± Ø§Ù„Ù†Ù‚Ø§Ø· Ø¨Ù†Ø¬Ø§Ø­!");
                
                if (document.getElementById('tab-leaderboard').classList.contains('active')) {
                    loadLeaderboard();
                }
                
                if (userData && userData.email === ADMIN_EMAIL) {
                    showBeautifulAlert('success', 'ØªÙ… Ø§Ù„ØªÙˆØ²ÙŠØ¹', 'âœ… ØªÙ… Ø§Ù„ØªÙˆØ²ÙŠØ¹ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ø¬ÙˆØ§Ø¦Ø² Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ© ÙˆØªØµÙÙŠØ± Ø§Ù„Ù†Ù‚Ø§Ø·!');
                }
                
            } catch (error) {
                console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙˆØ²ÙŠØ¹ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ:", error);
                setTimeout(() => {
                    if (!window.retryWeeklyDistribution) {
                        window.retryWeeklyDistribution = true;
                        autoDistributeWeeklyPrizes();
                    }
                }, 5 * 60 * 1000);
            }
        }

        function showBeautifulAlert(type, title, message) {
            const alert = document.getElementById('beautiful-alert');
            const icon = document.getElementById('beautiful-alert-icon');
            const alertTitle = document.getElementById('beautiful-alert-title');
            const alertMessage = document.getElementById('beautiful-alert-message');
            
            alert.classList.remove('success', 'error', 'warning', 'info');
            alert.classList.add(type);
            
            if (type === 'success') {
                icon.innerHTML = '<i class="fas fa-check-circle"></i>';
            } else if (type === 'error') {
                icon.innerHTML = '<i class="fas fa-times-circle"></i>';
            } else if (type === 'warning') {
                icon.innerHTML = '<i class="fas fa-exclamation-triangle"></i>';
            } else {
                icon.innerHTML = '<i class="fas fa-info-circle"></i>';
            }
            
            alertTitle.textContent = title;
            alertMessage.textContent = message;
            
            alert.classList.remove('hidden');
        }

        function closeBeautifulAlert() {
            document.getElementById('beautiful-alert').classList.add('hidden');
        }
        
        document.getElementById('beautiful-alert-ok-btn').addEventListener('click', closeBeautifulAlert);

        function getArabicError(code) {
            switch(code) {
                case 'auth/email-already-in-use': return 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„';
                case 'auth/invalid-email': return 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ§Ù„Ø­';
                case 'auth/weak-password': return 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¶Ø¹ÙŠÙØ©';
                case 'auth/user-disabled': return 'ØªÙ… ØªØ¹Ø·ÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨';
                case 'auth/user-not-found': return 'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯';
                case 'auth/wrong-password': return 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©';
                case 'auth/too-many-requests': return 'Ù…Ø­Ø§ÙˆÙ„Ø§Øª ÙƒØ«ÙŠØ±Ø© Ø¬Ø¯Ø§Ù‹ØŒ Ø­Ø§ÙˆÙ„ Ù„Ø§Ø­Ù‚Ø§Ù‹';
                case 'auth/network-request-failed': return 'ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø´Ø¨ÙƒØ©';
                case 'auth/operation-not-allowed': return 'Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­Ø©';
                case 'storage/unauthorized': return 'ØºÙŠØ± Ù…ØµØ±Ø­ Ø¨ØªØ®Ø²ÙŠÙ† Ø§Ù„ØµÙˆØ±';
                case 'storage/canceled': return 'ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©';
                case 'storage/unknown': return 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ ÙÙŠ Ø§Ù„ØªØ®Ø²ÙŠÙ†';
                default: return 'Ø­Ø¯Ø« Ø®Ø·Ø£: ' + code;
            }
        }

        function populateSubjectsForGrade(grade) {
            console.log('Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ø¯ Ù„Ù„Ù…Ø±Ø­Ù„Ø©:', grade);
            
            if (!grade) {
                console.error('Ø§Ù„Ù…Ø±Ø­Ù„Ø© ØºÙŠØ± Ù…Ø­Ø¯Ø¯Ø©');
                return;
            }
            
            const gradeSubjects = subjects[grade];
            if (!gradeSubjects) {
                console.error('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¯ Ù„Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø±Ø­Ù„Ø©:', grade);
                return;
            }
            
            const challengeSubjectSelect = document.getElementById('challenge-subject');
            if (challengeSubjectSelect) {
                challengeSubjectSelect.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø¯Ø© --</option>';
                gradeSubjects.forEach(subject => {
                    const option = document.createElement('option');
                    option.value = subject;
                    option.textContent = subject;
                    challengeSubjectSelect.appendChild(option);
                });
                console.log('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ø¯ ÙÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ§Øª:', gradeSubjects.length, 'Ù…Ø§Ø¯Ø©');
            }
            
            const roomSubjectSelect = document.getElementById('room-subject');
            if (roomSubjectSelect) {
                roomSubjectSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø¯Ø©</option>';
                gradeSubjects.forEach(subject => {
                    const option = document.createElement('option');
                    option.value = subject;
                    option.textContent = subject;
                    roomSubjectSelect.appendChild(option);
                });
                console.log('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ø¯ ÙÙŠ Ø§Ù„ØºØ±Ù:', gradeSubjects.length, 'Ù…Ø§Ø¯Ø©');
            }
            
            const uploadSubjectSelect = document.getElementById('upload-subject');
            if (uploadSubjectSelect) {
                uploadSubjectSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø¯Ø©</option>';
                gradeSubjects.forEach(subject => {
                    const option = document.createElement('option');
                    option.value = subject;
                    option.textContent = subject;
                    uploadSubjectSelect.appendChild(option);
                });
            }
        }

        window.switchAuthTab = (tab) => {
            if(tab === 'login') {
                document.getElementById('login-form').classList.remove('hidden');
                document.getElementById('signup-form').classList.add('hidden');
                document.getElementById('tab-login-btn').classList.add('active');
                document.getElementById('tab-signup-btn').classList.remove('active');
            } else {
                document.getElementById('login-form').classList.add('hidden');
                document.getElementById('signup-form').classList.remove('hidden');
                document.getElementById('tab-login-btn').classList.remove('active');
                document.getElementById('tab-signup-btn').classList.add('active');
            }
        };

        function showAuthLoading(text) {
            document.getElementById('auth-loading-text').innerText = text;
            document.getElementById('auth-loading').classList.remove('hidden');
        }

        function hideAuthLoading() {
            document.getElementById('auth-loading').classList.add('hidden');
        }

        window.handleLogin = async () => {
            try {
                const identifier = document.getElementById('login-identifier').value.trim();
                const pass = document.getElementById('login-pass').value;
                
                if (!identifier || !pass) {
                    showBeautifulAlert('warning', 'ØªÙ†Ø¨ÙŠÙ‡', 'ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„');
                    return;
                }
                
                showAuthLoading('Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');
                
                let emailToUse = identifier;
                
                if (!identifier.includes('@')) {
                    const usersQuery = query(collection(db, "users"), where("uniqueId", "==", identifier.toUpperCase()));
                    const querySnapshot = await getDocs(usersQuery);
                    
                    if (querySnapshot.empty) {
                        hideAuthLoading();
                        showBeautifulAlert('error', 'Ø®Ø·Ø£', 'Ø§Ù„Ù…Ø¹Ø±Ù ØºÙŠØ± ØµØ­ÙŠØ­ Ø£Ùˆ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
                        return;
                    }
                    
                    const userData = querySnapshot.docs[0].data();
                    emailToUse = userData.email;
                }
                
                setTimeout(async () => {
                    try {
                        await signInWithEmailAndPassword(auth, emailToUse, pass);
                        hideAuthLoading();
                        showBeautifulAlert('success', 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„', 'Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ø¹ÙˆØ¯ØªÙƒ!');
                    } catch (e) {
                        hideAuthLoading();
                        showBeautifulAlert('error', 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„', getArabicError(e.code));
                    }
                }, 500);
                
            } catch (e) {
                hideAuthLoading();
                showBeautifulAlert('error', 'Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹: ' + e.message);
            }
        };

        window.handleSignup = async () => {
            try {
                const name = document.getElementById('signup-name').value.trim();
                const email = document.getElementById('signup-email').value.trim();
                const pass = document.getElementById('signup-pass').value;
                
                if(!name || !email || !pass) {
                    showBeautifulAlert('warning', 'ØªÙ†Ø¨ÙŠÙ‡', 'ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ ÙƒØ§ÙØ© Ø§Ù„Ø­Ù‚ÙˆÙ„');
                    return;
                }
                
                if(!email.endsWith("@gmail.com")) {
                    showBeautifulAlert('warning', 'ØªÙ†Ø¨ÙŠÙ‡', 'ÙŠØ¬Ø¨ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§ÙŠÙ…ÙŠÙ„ Gmail');
                    return;
                }
                
                if(pass.length < 6) {
                    showBeautifulAlert('warning', 'ØªÙ†Ø¨ÙŠÙ‡', 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
                    return;
                }

                showAuthLoading('Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨Ùƒ...');

                let photoURL = `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=random&size=128`;
                const imgFile = document.getElementById('signup-img').files[0];
                if(imgFile) {
                    try {
                        photoURL = await uploadImageToStorage(imgFile, "new_user_" + Date.now());
                    } catch (error) {
                        console.error("Error uploading profile image:", error);
                    }
                }

                setTimeout(async () => {
                    try {
                        const cred = await createUserWithEmailAndPassword(auth, email, pass);
                        
                        await setDoc(doc(db, "users", cred.user.uid), {
                            uid: cred.user.uid,
                            name: name,
                            email: email,
                            photo: photoURL,
                            uniqueId: generateId(),
                            points: 0,
                            balance: 0,
                            role: 'user',
                            isBanned: false,
                            bio: "",
                            invitedCount: 0,
                            createdAt: serverTimestamp(),
                            lastRewardDayKey: null, 
                            rewardMonthKey: null,    
                            daysClaimedInMonth: 0,
                            isPremium: false,
                            premiumExpiry: null,
                            selectedBadge: null,
                            selectedBadgeColor: null,
                            selectedBgTheme: 'bg-rank-default',
                            lastLogin: new Date().toISOString(),
                            dailyAIRemaining: 10,
                            lastAIReset: new Date().toISOString().split('T')[0]
                        });

                        hideAuthLoading();
                        showBeautifulAlert('success', 'Ù…Ø¨Ø±ÙˆÙƒ!', 'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­ØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„');

                    } catch (e) {
                        hideAuthLoading();
                        showBeautifulAlert('error', 'Ø®Ø·Ø£', getArabicError(e.code));
                    }
                }, 1000);

            } catch (e) {
                hideAuthLoading();
                showBeautifulAlert('error', 'Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹: ' + e.message);
            }
        };

        window.logout = () => {
            if(adminListenerUnsubscribe) adminListenerUnsubscribe(); 
            if(premiumInterval) clearInterval(premiumInterval);
            signOut(auth);
        };

        function getIraqDate() {
            const dateStr = new Date().toLocaleString("en-US", {timeZone: "Asia/Baghdad"});
            return new Date(dateStr);
        }

        window.checkDailyReward = async () => {
            const iraqDate = getIraqDate();
            const currentDayKey = `${iraqDate.getDate()}-${iraqDate.getMonth()}-${iraqDate.getFullYear()}`;
            const currentMonthKey = `${iraqDate.getMonth()}-${iraqDate.getFullYear()}`;

            if (userData.lastRewardDayKey === currentDayKey) return; 

            let userDaysClaimed = userData.daysClaimedInMonth || 0;
            if (userData.rewardMonthKey !== currentMonthKey) userDaysClaimed = 0;

            const nextDayToClaim = userDaysClaimed + 1;
            const grid = document.getElementById('reward-grid-container');
            grid.innerHTML = '';
            for(let i=1; i<=30; i++) {
                let pts = 5;
                if(i > 10 && i <= 20) pts = 10;
                if(i > 20) pts = 15;

                let cls = "day-box";
                if (i < nextDayToClaim) cls += " claimed"; 
                else if (i === nextDayToClaim) cls += " active"; 
                else cls += " locked"; 
                grid.innerHTML += `<div class="${cls}"><p>ÙŠÙˆÙ… ${i}</p><span>${pts} Ù†Ù‚Ø§Ø·</span></div>`;
            }
            document.getElementById('daily-reward-screen').classList.remove('hidden');
        };

        window.claimReward = async () => {
            const iraqDate = getIraqDate();
            const currentDayKey = `${iraqDate.getDate()}-${iraqDate.getMonth()}-${iraqDate.getFullYear()}`;
            const currentMonthKey = `${iraqDate.getMonth()}-${iraqDate.getFullYear()}`;

            let userDaysClaimed = userData.daysClaimedInMonth || 0;
            if (userData.rewardMonthKey !== currentMonthKey) userDaysClaimed = 0;

            const dayToClaim = userDaysClaimed + 1;
            let rewardAmount = 5;
            if(dayToClaim > 10 && dayToClaim <= 20) rewardAmount = 10;
            if(dayToClaim > 20) rewardAmount = 15;

            await updateDoc(doc(db, "users", currentUser.uid), {
                points: increment(rewardAmount),
                lastRewardDayKey: currentDayKey,
                rewardMonthKey: currentMonthKey,
                daysClaimedInMonth: increment(1) 
            });
            userData.points += rewardAmount;
            userData.lastRewardDayKey = currentDayKey;
            userData.rewardMonthKey = currentMonthKey;
            userData.daysClaimedInMonth = dayToClaim;
            setupHeaderUI();
            document.getElementById('daily-reward-screen').classList.add('hidden');
            
            showBeautifulAlert('success', 'ØªÙ… Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…', `ğŸ‰ Ù„Ù‚Ø¯ Ø­ØµÙ„Øª Ø¹Ù„Ù‰ ${rewardAmount} Ù†Ù‚Ø§Ø·!`);
        };

        function setupProfileUI() {
            document.getElementById('profile-name-text').innerText = userData.name;
            document.getElementById('profile-id-text').innerText = "ID: " + userData.uniqueId;
            document.getElementById('profile-img').src = userData.photo;
            
            let bioText = userData.bio || "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³ÙŠØ±Ø© Ø°Ø§ØªÙŠØ©";
            if (bioText.length > 25) {
                bioText = bioText.substring(0, 25) + "...";
            }
            document.getElementById('profile-bio-text').innerText = bioText;
            
            const container = document.getElementById('profile-name-container');
            const existingBadge = container.querySelector('.premium-badge');
            if(existingBadge) existingBadge.remove();

            if (userData.isPremium && userData.selectedBadge && isPremiumValid(userData)) {
                const badgeSpan = document.createElement('span');
                badgeSpan.className = "premium-badge";
                badgeSpan.style.backgroundColor = userData.selectedBadgeColor || '#f59e0b';
                badgeSpan.innerText = userData.selectedBadge;
                container.insertBefore(badgeSpan, document.getElementById('profile-name-text').nextSibling);
            }

            document.getElementById('wallet-balance').innerText = userData.balance || 0;
            if ((userData.balance || 0) >= 100) {
                document.getElementById('withdraw-section').classList.remove('hidden');
                document.getElementById('withdraw-locked-msg').classList.add('hidden');
            } else {
                document.getElementById('withdraw-section').classList.add('hidden');
                document.getElementById('withdraw-locked-msg').classList.remove('hidden');
            }
        }
        
        function setupHeaderUI() { 
            const pointsElement = document.getElementById('header-points');
            const points = userData.points || 0;
            
            if (points < 0) {
                pointsElement.innerText = points;
                pointsElement.classList.add('points-negative');
            } else {
                pointsElement.innerText = points;
                pointsElement.classList.remove('points-negative');
            }
            
            const addSubscriptionBtn = document.getElementById('add-subscription-btn');
            if (isPremiumValid(userData) && document.getElementById('screen-premium-in-profile').classList.contains('active')) {
                addSubscriptionBtn.classList.remove('hidden');
            } else {
                addSubscriptionBtn.classList.add('hidden');
            }
        }
        
        function setupAdminUI() { 
            if (userData.email === ADMIN_EMAIL) {
                document.getElementById('admin-hub-btn-container').classList.remove('hidden'); 
                loadBannedUsers();
            }
        }

        window.saveUserGrade = async () => {
            const g = document.getElementById('grade-select').value;
            if (!g) {
                showBeautifulAlert('warning', 'ØªÙ†Ø¨ÙŠÙ‡', 'ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø±Ø­Ù„Ø©');
                return;
            }
            
            await updateDoc(doc(db, "users", currentUser.uid), { grade: g });
            userData.grade = g;
            
            populateSubjectsForGrade(g);
            
            document.getElementById('grade-selector-card').classList.add('hidden');
            document.getElementById('challenge-active-card').classList.remove('hidden');
            document.getElementById('header-grade-badge').innerText = getGradeName(g);
            document.getElementById('header-grade-badge').classList.remove('hidden');
            
            setQType('mcq');
            
            showBeautifulAlert('success', 'ØªÙ… Ø§Ù„Ø­ÙØ¸', `ØªÙ… Ø­ÙØ¸ Ù…Ø±Ø­Ù„Ø© ${getGradeName(g)} Ø¨Ù†Ø¬Ø§Ø­`);
        };

        function getGradeName(code) { 
            return code==='6sci'?'Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ù„Ø¹Ù„Ù…ÙŠ':code==='6lit'?'Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ù„Ø£Ø¯Ø¨ÙŠ':'Ø§Ù„Ø«Ø§Ù„Ø« Ù…ØªÙˆØ³Ø·'; 
        }

        function isPremiumValid(user) {
            if(!user.isPremium || !user.premiumExpiry) return false;
            const now = new Date();
            const expiry = user.premiumExpiry.toDate();
            const isValid = expiry > now;
            
            if (!isValid && user.isPremium) {
                deactivatePremiumFeatures(user.uid);
            }
            
            return isValid;
        }

        async function deactivatePremiumFeatures(uid) {
            try {
                await updateDoc(doc(db, "users", uid), {
                    isPremium: false,
                    selectedBadge: null,
                    selectedBadgeColor: null,
                    selectedBgTheme: 'bg-rank-default'
                });
                
                if (uid === currentUser?.uid) {
                    userData.isPremium = false;
                    userData.selectedBadge = null;
                    userData.selectedBadgeColor = null;
                    userData.selectedBgTheme = 'bg-rank-default';
                    checkPremiumStatus();
                    setupProfileUI();
                }
            } catch (error) {
                console.error("Error deactivating premium:", error);
            }
        }

        function checkPremiumStatus() {
            const lockedView = document.getElementById('premium-locked-view');
            const activeView = document.getElementById('premium-active-view');
            
            if (isPremiumValid(userData)) {
                lockedView.classList.add('hidden');
                activeView.classList.remove('hidden');
                startPremiumTimer();
            } else {
                lockedView.classList.remove('hidden');
                activeView.classList.add('hidden');
                if(premiumInterval) clearInterval(premiumInterval);
            }
        }

        function startPremiumTimer() {
            if(premiumInterval) clearInterval(premiumInterval);
            const display = document.getElementById('premium-countdown');
            const expiry = userData.premiumExpiry.toDate();

            function update() {
                const now = new Date();
                const diff = expiry - now;
                if(diff <= 0) {
                    display.innerText = "00:00:00:00";
                    clearInterval(premiumInterval);
                    deactivatePremiumFeatures(currentUser.uid);
                    return;
                }
                
                const months = Math.floor(diff / (1000 * 60 * 60 * 24 * 30));
                const days = Math.floor((diff % (1000 * 60 * 60 * 24 * 30)) / (1000 * 60 * 60 * 24));
                const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                
                display.innerText = `${months}:${days<10?'0'+days:days}:${hours<10?'0'+hours:hours}:${minutes<10?'0'+minutes:minutes}:${seconds<10?'0'+seconds:seconds}`;
            }
            update();
            premiumInterval = setInterval(update, 1000);
        }

        window.showPremiumDetails = () => { 
            document.getElementById('premium-details-modal').classList.remove('hidden'); 
        }
        
        window.activatePremiumCode = async () => {
            const codeInput = document.getElementById('premium-code-input').value.trim().toUpperCase();
            if(!codeInput) {
                showBeautifulAlert('warning', 'ØªÙ†Ø¨ÙŠÙ‡', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙƒÙˆØ¯');
                return;
            }

            try {
                const q = query(collection(db, "premium_codes"), where("code", "==", codeInput));
                const snap = await getDocs(q);
                
                if(snap.empty) {
                    showBeautifulAlert('error', 'Ø®Ø·Ø£', 'âŒ Ø§Ù„ÙƒÙˆØ¯ ØºÙŠØ± ØµØ­ÙŠØ­ Ø£Ùˆ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
                    return;
                }
                
                const codeDoc = snap.docs[0];
                const codeData = codeDoc.data();

                if(codeData.used) {
                    showBeautifulAlert('error', 'Ø®Ø·Ø£', 'âŒ Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ù‚Ø¨Ù„ ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰');
                    return;
                }

                if(codeData.isActive === false) {
                    showBeautifulAlert('error', 'Ø®Ø·Ø£', 'âŒ Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ù…Ø¹Ø·Ù„ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©');
                    return;
                }

                const durationDays = codeData.durationDays;
                let newExpiry = new Date();
                
                if (isPremiumValid(userData)) {
                    newExpiry = userData.premiumExpiry.toDate();
                    newExpiry.setDate(newExpiry.getDate() + durationDays);
                } else {
                    newExpiry.setDate(newExpiry.getDate() + durationDays);
                }

                const batch = writeBatch(db);
                
                batch.update(doc(db, "premium_codes", codeDoc.id), { 
                    used: true, 
                    usedBy: currentUser.uid, 
                    usedAt: serverTimestamp() 
                });
                
                batch.update(doc(db, "users", currentUser.uid), { 
                    isPremium: true,
                    premiumExpiry: Timestamp.fromDate(newExpiry),
                    dailyAIRemaining: 15
                });
                
                await batch.commit();
                
                userData.isPremium = true;
                userData.premiumExpiry = Timestamp.fromDate(newExpiry);
                userData.dailyAIRemaining = 15;

                showBeautifulAlert('success', 'Ù…Ø¨Ø±ÙˆÙƒ!', `ğŸ‰ ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ù…Ù…ÙŠØ² Ù„Ù…Ø¯Ø© ${durationDays} ÙŠÙˆÙ….\n\nØ§Ù„ÙƒÙˆØ¯ Ø§Ø³ØªØ®Ø¯Ù… ÙˆÙ„Ù† ÙŠØ¹Ù…Ù„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.`);
                checkPremiumStatus();
                setupHeaderUI();
                document.getElementById('premium-code-input').value = "";

            } catch(e) { 
                console.error("Ø®Ø·Ø£ ÙÙŠ ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯:", e);
                showBeautifulAlert('error', 'Ø®Ø·Ø£', 'âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯: ' + e.message); 
            }
        };

        document.getElementById('add-subscription-btn').addEventListener('click', function() {
            if (!isPremiumValid(userData)) {
                showBeautifulAlert('error', 'Ø®Ø·Ø£', 'âŒ ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ù…Ø´ØªØ±ÙƒØ§Ù‹ Ù…Ù…ÙŠØ²Ø§Ù‹ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙŠØ²Ø©');
                return;
            }
            document.getElementById('add-subscription-modal').classList.remove('hidden');
        });

        window.addSubscriptionTime = async function() {
            const codeInput = document.getElementById('add-subscription-code').value.trim().toUpperCase();
            if(!codeInput) {
                showBeautifulAlert('warning', 'ØªÙ†Ø¨ÙŠÙ‡', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙƒÙˆØ¯');
                return;
            }

            try {
                const q = query(collection(db, "premium_codes"), where("code", "==", codeInput));
                const snap = await getDocs(q);
                
                if(snap.empty) {
                    showBeautifulAlert('error', 'Ø®Ø·Ø£', 'âŒ Ø§Ù„ÙƒÙˆØ¯ ØºÙŠØ± ØµØ­ÙŠØ­ Ø£Ùˆ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
                    return;
                }
                
                const codeDoc = snap.docs[0];
                const codeData = codeDoc.data();

                if(codeData.used) {
                    showBeautifulAlert('error', 'Ø®Ø·Ø£', 'âŒ Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ù‚Ø¨Ù„ ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰');
                    return;
                }

                if(codeData.isActive === false) {
                    showBeautifulAlert('error', 'Ø®Ø·Ø£', 'âŒ Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ù…Ø¹Ø·Ù„ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©');
                    return;
                }

                const durationDays = codeData.durationDays;
                let newExpiry = new Date();
                
                if (isPremiumValid(userData)) {
                    newExpiry = userData.premiumExpiry.toDate();
                    newExpiry.setDate(newExpiry.getDate() + durationDays);
                } else {
                    newExpiry.setDate(newExpiry.getDate() + durationDays);
                }

                const batch = writeBatch(db);
                
                batch.update(doc(db, "premium_codes", codeDoc.id), { 
                    used: true, 
                    usedBy: currentUser.uid, 
                    usedAt: serverTimestamp() 
                });
                
                batch.update(doc(db, "users", currentUser.uid), { 
                    premiumExpiry: Timestamp.fromDate(newExpiry)
                });
                
                await batch.commit();
                
                userData.premiumExpiry = Timestamp.fromDate(newExpiry);

                showBeautifulAlert('success', 'ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©', `ğŸ‰ ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© ${durationDays} ÙŠÙˆÙ… Ù„Ø§Ø´ØªØ±Ø§ÙƒÙƒ!\n\nØ§Ù„Ù…Ø¯Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©: ${newExpiry.toLocaleDateString('ar-EG')}`);
                checkPremiumStatus();
                document.getElementById('add-subscription-code').value = "";
                document.getElementById('add-subscription-modal').classList.add('hidden');

            } catch(e) { 
                console.error("Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¯Ø©:", e);
                showBeautifulAlert('error', 'Ø®Ø·Ø£', 'âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¯Ø©: ' + e.message); 
            }
        };

        window.openBadgeSelector = () => {
            const grid = document.getElementById('badge-grid');
            grid.innerHTML = '';
            BADGES_LIST.forEach(txt => {
                const btn = document.createElement('button');
                const colors = ['#f87171', '#fbbf24', '#34d399', '#60a5fa', '#818cf8', '#a78bfa', '#f472b6'];
                const randomColor = colors[Math.floor(Math.random() * colors.length)];
                
                btn.className = "p-3 rounded-lg border-2 border-gray-100 font-bold text-white shadow-sm hover:scale-105 transition";
                btn.style.backgroundColor = randomColor;
                btn.innerText = txt;
                btn.onclick = () => saveBadgeChoice(txt, randomColor);
                grid.appendChild(btn);
            });
            document.getElementById('badge-selector-modal').classList.remove('hidden');
        };

        async function saveBadgeChoice(txt, color) {
            await updateDoc(doc(db, "users", currentUser.uid), { selectedBadge: txt, selectedBadgeColor: color });
            userData.selectedBadge = txt;
            userData.selectedBadgeColor = color;
            document.getElementById('badge-selector-modal').classList.add('hidden');
            setupProfileUI();
            showBeautifulAlert('success', 'ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«', 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØªÙˆØ«ÙŠÙ‚ âœ…');
        }

        window.openBgSelector = () => {
            const list = document.getElementById('bg-grid');
            list.innerHTML = '';
            BACKGROUNDS_LIST.forEach(bg => {
                const btn = document.createElement('button');
                btn.className = `w-full h-20 rounded-xl shadow-md border-2 border-transparent hover:border-indigo-500 transition mb-2 ${bg.class} flex items-center justify-center`;
                btn.innerHTML = `<span class="bg-white/80 px-3 py-1 rounded-full font-bold text-gray-800 text-sm">${bg.name}</span>`;
                btn.onclick = () => saveBgChoice(bg.id, bg.class);
                list.appendChild(btn);
            });
            document.getElementById('bg-selector-modal').classList.remove('hidden');
        };

        async function saveBgChoice(id, cssClass) {
             await updateDoc(doc(db, "users", currentUser.uid), { selectedBgTheme: cssClass });
             userData.selectedBgTheme = cssClass;
             document.getElementById('bg-selector-modal').classList.add('hidden');
             showBeautifulAlert('success', 'ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«', 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø®Ù„ÙÙŠØ© Ø§Ù„ØªØµÙ†ÙŠÙ âœ…');
        }

        window.openPage = async (screenId) => {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
            
            if (screenId === 'screen-admin-all') { 
                populateAdminFilterSubjects(); 
                loadAdminAllContent(); 
            }
            else if (screenId === 'screen-admin-stats') loadStatsContent();
            else if (screenId === 'screen-admin-premium-users') loadPremiumUsers();
            else if (screenId === 'screen-wallet') setupProfileUI(); 
            else if (screenId === 'screen-premium-in-profile') {
                checkPremiumStatus();
                setupHeaderUI();
            }
            else if (screenId === 'screen-admin-users') {
                loadBannedUsers();
            }
            else if (screenId === 'screen-review-questions') {
                loadReviewQuestions();
            }
            else if (screenId === 'screen-upload-questions') {
                initUploadQuestions();
            }
        };

        window.backToProfile = () => { 
             document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
             switchTab('profile');
        };

        window.editProfileName = () => {
            document.getElementById('edit-name-input').value = userData.name || "";
            document.getElementById('edit-name-modal').classList.remove('hidden');
        };

        window.saveProfileName = async () => {
            const newName = document.getElementById('edit-name-input').value.trim();
            if (!newName) {
                showBeautifulAlert('warning', 'ØªÙ†Ø¨ÙŠÙ‡', 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù…');
                return;
            }
            await updateDoc(doc(db, "users", currentUser.uid), { name: newName });
            userData.name = newName;
            document.getElementById('profile-name-text').innerText = newName;
            document.getElementById('edit-name-modal').classList.add('hidden');
            showBeautifulAlert('success', 'ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«', 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø§Ø³Ù… âœ…');
        };

        window.editProfileBio = () => {
            document.getElementById('edit-bio-input').value = userData.bio || "";
            document.getElementById('edit-bio-modal').classList.remove('hidden');
        };

        window.saveProfileBio = async () => {
            let newBio = document.getElementById('edit-bio-input').value.trim();
            if (newBio.length > 25) {
                newBio = newBio.substring(0, 25);
            }
            await updateDoc(doc(db, "users", currentUser.uid), { bio: newBio });
            userData.bio = newBio;
            document.getElementById('profile-bio-text').innerText = newBio || "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³ÙŠØ±Ø© Ø°Ø§ØªÙŠØ©";
            document.getElementById('edit-bio-modal').classList.add('hidden');
            showBeautifulAlert('success', 'ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«', 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³ÙŠØ±Ø© Ø§Ù„Ø°Ø§ØªÙŠØ© âœ…');
        };

        async function loadStatsContent() {
             const div = document.getElementById('stats-content');
             try {
                 const usersSnap = await getDocs(collection(db, "users"));
                 const total = usersSnap.size;
                 const today = new Date(); today.setHours(0,0,0,0);
                 let newUsers = 0; let activeNow = 0; const now = new Date();
                 usersSnap.forEach(d => {
                     const u = d.data();
                     if(!u) return;
                     if(u.createdAt && u.createdAt.toDate && u.createdAt.toDate() >= today) newUsers++;
                     if (u.lastActive && u.lastActive.toDate && (now - u.lastActive.toDate()) < 15 * 60 * 1000) activeNow++;
                 });
                 if(activeNow === 0) activeNow = 1; 
                 div.innerHTML = `<div class="bg-white p-5 rounded-2xl shadow-sm flex justify-between items-center"><div><p class="text-sm text-gray-500">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„ÙƒÙ„ÙŠ</p><p class="text-2xl font-bold text-gray-800">${total}</p></div><div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center text-blue-600"><i class="fas fa-users"></i></div></div><div class="bg-white p-5 rounded-2xl shadow-sm flex justify-between items-center"><div><p class="text-sm text-gray-500">Ù†Ø´Ø·ÙŠÙ† Ø§Ù„Ø¢Ù†</p><p class="text-2xl font-bold text-green-500">${activeNow}</p></div><div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center text-green-600"><i class="fas fa-wifi"></i></div></div><div class="bg-white p-5 rounded-2xl shadow-sm flex justify-between items-center"><div><p class="text-sm text-gray-500">Ø³Ø¬Ù„ÙˆØ§ Ø§Ù„ÙŠÙˆÙ…</p><p class="text-2xl font-bold text-purple-500">${newUsers}</p></div><div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center text-purple-600"><i class="fas fa-user-plus"></i></div></div>`;
             } catch (error) {
                 div.innerHTML = '<p class="text-center text-gray-400">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</p>';
             }
        }

        async function loadAdminAllContent() {
             const div = document.getElementById('admin-all-list');
             if(allAdminQuestions.length === 0) {
                 div.innerHTML = '<p class="text-center text-gray-400">Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ ÙƒÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>';
                 try {
                     const q = await getDocs(query(collection(db, "questions"), orderBy("createdAt", "desc"), limit(100)));
                     allAdminQuestions = [];
                     q.forEach(d => allAdminQuestions.push({id: d.id, ...d.data()}));
                 } catch (error) {
                     div.innerHTML = '<p class="text-center text-gray-400">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</p>';
                     return;
                 }
             }
             filterAdminQuestions();
        }

        window.populateAdminFilterSubjects = () => {
            const grade = document.getElementById('admin-filter-grade').value;
            const subSel = document.getElementById('admin-filter-subject');
            subSel.innerHTML = '<option value="">ÙƒÙ„ Ø§Ù„Ù…ÙˆØ§Ø¯</option>';
            if(grade && subjects[grade]) subjects[grade].forEach(s => subSel.innerHTML += `<option value="${s}">${s}</option>`);
        }

        window.renderAdminAllList = (list) => {
            const div = document.getElementById('admin-all-list');
            if(list.length === 0) { 
                div.innerHTML = "<p class='text-center text-gray-400 mt-4'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</p>"; 
                return; 
            }
            let html = `<p class="text-xs text-gray-400 mb-2">ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰: ${list.length} Ø³Ø¤Ø§Ù„</p>`;
            list.slice(0, 50).forEach(q => { 
                html += `<div class="bg-white rounded-xl p-3 mb-2 border border-gray-100 shadow-sm flex flex-col gap-2"><div class="flex justify-between items-start"><div><span class="text-xs bg-indigo-50 text-indigo-600 px-2 py-1 rounded font-bold">${q.grade || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'} | ${q.subject}</span><span class="text-xs text-gray-400 ml-2">${q.type==='mcq'?'Ø§Ø®ØªÙŠØ§Ø±Ø§Øª':'ØµØ­/Ø®Ø·Ø£'}</span></div><div class="flex gap-1"><button onclick="openEditModal('${q.id}')" class="bg-blue-100 text-blue-600 px-3 py-1 rounded-lg text-xs font-bold hover:bg-blue-200 transition"><i class="fas fa-edit ml-1"></i>ØªØ¹Ø¯ÙŠÙ„</button><button onclick="deleteApprovedQ('${q.id}')" class="bg-red-100 text-red-600 px-3 py-1 rounded-lg text-xs font-bold hover:bg-red-200 transition"><i class="fas fa-trash"></i></button></div></div><p class="font-bold text-gray-700 text-sm leading-6 border-r-2 border-indigo-200 pr-2">${q.question}</p></div>`;
            });
            div.innerHTML = html;
        };

        window.filterAdminQuestions = () => {
            if(event && event.target && event.target.id === 'admin-filter-grade') populateAdminFilterSubjects();
            const gr = document.getElementById('admin-filter-grade').value;
            const sub = document.getElementById('admin-filter-subject').value;
            const type = document.getElementById('admin-filter-type').value;
            const filtered = allAdminQuestions.filter(q => {
                const matchesGrade = gr ? (q.grade === gr) : true;
                const matchesSubject = sub ? (q.subject === sub) : true;
                const matchesType = type ? (q.type === type) : true;
                return matchesGrade && matchesSubject && matchesType;
            });
            renderAdminAllList(filtered);
        };

        window.openEditModal = (id) => {
            const q = allAdminQuestions.find(i => i.id === id);
            if(!q) return;
            document.getElementById('edit-q-id').value = id;
            document.getElementById('edit-q-text').value = q.question;
            document.getElementById('edit-q-grade').value = q.grade || '6sci';
            const subSel = document.getElementById('edit-q-subject');
            subSel.innerHTML = "";
            subjects[q.grade || '6sci'].forEach(s => subSel.innerHTML += `<option value="${s}">${s}</option>`);
            subSel.value = q.subject;
            document.getElementById('edit-q-grade').onchange = () => {
                const g = document.getElementById('edit-q-grade').value;
                subSel.innerHTML = "";
                subjects[g].forEach(s => subSel.innerHTML += `<option value="${s}">${s}</option>`);
            };
            if(q.type === 'mcq') {
                document.getElementById('edit-mcq-fields').classList.remove('hidden');
                document.getElementById('edit-tf-fields').classList.add('hidden');
                document.getElementById('edit-ans-0').value = q.answers[0];
                document.getElementById('edit-ans-1').value = q.answers[1];
                document.getElementById('edit-ans-2').value = q.answers[2];
                document.getElementById('edit-correct-mcq').value = q.correct;
            } else {
                document.getElementById('edit-mcq-fields').classList.add('hidden');
                document.getElementById('edit-tf-fields').classList.remove('hidden');
                document.getElementById('edit-correct-tf').value = q.correct;
            }
            document.getElementById('edit-modal').classList.remove('hidden');
        };

        window.saveFullEditQ = async () => {
            const id = document.getElementById('edit-q-id').value;
            const originalQ = allAdminQuestions.find(i => i.id === id);
            const type = originalQ.type;
            const updates = { question: document.getElementById('edit-q-text').value, grade: document.getElementById('edit-q-grade').value, subject: document.getElementById('edit-q-subject').value };
            if(type === 'mcq') {
                updates.answers = [document.getElementById('edit-ans-0').value, document.getElementById('edit-ans-1').value, document.getElementById('edit-ans-2').value];
                updates.correct = parseInt(document.getElementById('edit-correct-mcq').value);
            } else { updates.correct = document.getElementById('edit-correct-tf').value; }
            await updateDoc(doc(db, "questions", id), updates);
            const idx = allAdminQuestions.findIndex(i => i.id === id);
            if(idx !== -1) allAdminQuestions[idx] = { ...allAdminQuestions[idx], ...updates };
            const activeScreen = document.querySelector('.screen.active').id;
            if (activeScreen === 'screen-admin-all') filterAdminQuestions();
            document.getElementById('edit-modal').classList.add('hidden');
            showBeautifulAlert('success', 'ØªÙ… Ø§Ù„Ø­ÙØ¸', 'ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!');
        };

        window.deleteApprovedQ = async (id) => {
            if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¤Ø§Ù„ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ")) {
                await deleteDoc(doc(db, "questions", id));
                allAdminQuestions = allAdminQuestions.filter(q => q.id !== id);
                filterAdminQuestions();
                showBeautifulAlert('success', 'ØªÙ… Ø§Ù„Ø­Ø°Ù', 'ØªÙ… Ø­Ø°Ù Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­');
            }
        };

        async function checkPendingQuestionsNotification() {
            if (!currentUser || !userData || userData.email !== ADMIN_EMAIL) return;
            
            try {
                const q = query(collection(db, "pending_questions"), where("status", "==", "pending"));
                const snapshot = await getDocs(q);
                
                const badgeTab = document.getElementById('profile-tab-badge');
                const badgeBtn = document.getElementById('admin-btn-badge');
                
                if (!snapshot.empty) {
                    badgeTab.classList.add('visible');
                    badgeBtn.classList.add('visible');
                } else {
                    badgeTab.classList.remove('visible');
                    badgeBtn.classList.remove('visible');
                }
            } catch (error) {
                console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©:", error);
            }
        }

        async function checkAdminNotifications() {
            await checkPendingQuestionsNotification();
        }

        window.switchTab = (tab) => {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('tab-'+tab).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => { n.classList.remove('active'); n.classList.remove('text-indigo-600'); n.classList.add('text-gray-400'); });
            const navs = document.querySelectorAll('.nav-item');
            if(tab==='challenges') navs[0].classList.add('active', 'text-indigo-600');
            if(tab==='leaderboard') { 
                navs[1].classList.add('active', 'text-indigo-600'); 
                loadLeaderboard(); 
            }
            if(tab==='schedule') { 
                navs[2].classList.add('active', 'text-indigo-600'); 
                initSchedule(); 
            }
            if(tab==='profile') navs[3].classList.add('active', 'text-indigo-600');
        };
        
        async function loadLeaderboard() {
            const div = document.getElementById('leaderboard-list');
            const loadMoreBtn = document.getElementById('load-more-leaderboard');
            div.innerHTML = '<div class="flex flex-col items-center justify-center py-10"><div class="w-12 h-12 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin mb-3"></div><p class="text-gray-500 font-bold">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØµÙ†ÙŠÙ...</p></div>';
            leaderboardOffset = 0;
            
            try {
                const q = query(collection(db, "users"), orderBy("points", "desc"), limit(LEADERBOARD_LIMIT));
                const snap = await getDocs(q);
                allLeaderboardUsers = [];
                snap.forEach(d => { 
                    allLeaderboardUsers.push({ id: d.id, ...d.data() });
                });
                
                allLeaderboardUsers.sort((a, b) => (b.points || 0) - (a.points || 0));

                const myIndex = allLeaderboardUsers.findIndex(u => u.uid === currentUser.uid);
                if(myIndex !== -1) document.getElementById('my-rank-text').innerText = "#" + (myIndex + 1);
                else document.getElementById('my-rank-text').innerText = "#" + (allLeaderboardUsers.length + 1);

                renderLeaderboardChunk(0, LEADERBOARD_CHUNK_SIZE);
                
                if (allLeaderboardUsers.length > LEADERBOARD_CHUNK_SIZE) {
                    loadMoreBtn.classList.remove('hidden');
                } else {
                    loadMoreBtn.classList.add('hidden');
                }

            } catch (error) {
                div.innerHTML = '<p class="text-center text-gray-400">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØµÙ†ÙŠÙ</p>';
                loadMoreBtn.classList.add('hidden');
            }
        }

        function renderLeaderboardChunk(start, end) {
            const div = document.getElementById('leaderboard-list');
            div.innerHTML = '';
            
            const usersToShow = allLeaderboardUsers.slice(start, end);
            
            usersToShow.forEach((u, index) => {
                const globalIndex = start + index;
                let frameClass = "frame-rank-common";
                let crown = "";
                let rankBadge = `<div class="rank-badge-top">${globalIndex + 1}</div>`;
                let raysHtml = ""; 
                let backgroundClass = 'bg-rank-default';
                
                if (u.isPremium && u.premiumExpiry && u.premiumExpiry.toDate() > new Date()) {
                    backgroundClass = u.selectedBgTheme || 'bg-rank-default';
                }

                if (globalIndex === 0) { 
                    frameClass = "frame-rank-1"; 
                    crown = `<i class="fas fa-crown text-yellow-500 name-crown"></i>`; 
                    raysHtml = `<div class="rank-rays rays-gold"></div>`; 
                }
                else if (globalIndex === 1) { 
                    frameClass = "frame-rank-2"; 
                    raysHtml = `<div class="rank-rays rays-silver"></div>`; 
                }
                else if (globalIndex === 2) { 
                    frameClass = "frame-rank-3"; 
                    raysHtml = `<div class="rank-rays rays-bronze"></div>`; 
                }
                else if (globalIndex <= 9) { 
                    const colors = ['rays-blue', 'rays-red', 'rays-green', 'rays-purple', 'rays-blue', 'rays-red'];
                    frameClass = "frame-rank-other-top"; 
                    raysHtml = `<div class="rank-rays ${colors[globalIndex-3]}"></div>`; 
                }
                
                let badgeHtml = "";
                if (u.isPremium && u.premiumExpiry && u.premiumExpiry.toDate() > new Date() && u.selectedBadge) {
                    badgeHtml = `<span class="premium-badge" style="background-color: ${u.selectedBadgeColor || '#f59e0b'}">${u.selectedBadge}</span>`;
                }
                
                let prizeMoney = "";
                if (globalIndex === 0) prizeMoney = " <span class='text-xs text-green-300'>10$</span>";
                else if (globalIndex === 1) prizeMoney = " <span class='text-xs text-green-300'>7$</span>";
                else if (globalIndex === 2) prizeMoney = " <span class='text-xs text-green-300'>5$</span>";
                else if (globalIndex === 3) prizeMoney = " <span class='text-xs text-green-300'>3$</span>";
                else if (globalIndex === 4) prizeMoney = " <span class='text-xs text-green-300'>2$</span>";
                else if (globalIndex >= 5 && globalIndex <= 9) prizeMoney = " <span class='text-xs text-green-300'>1$</span>";
                
                let resetBtn = "";
                if (currentUser && userData && userData.email === ADMIN_EMAIL) {
                    resetBtn = `<button onclick="resetUserPoints('${u.id}', '${u.name}')" class="w-6 h-6 rounded bg-red-100 text-red-500 flex items-center justify-center mr-2"><i class="fas fa-trash-alt text-xs"></i></button>`;
                }
                
                div.innerHTML += `
                    <div class="flex items-center justify-between p-4 rounded-xl shadow-sm mb-3 relative overflow-hidden ${backgroundClass}">
                        <div class="flex items-center gap-4 z-10">
                            <div class="rank-img-container">
                                ${rankBadge}
                                ${raysHtml}
                                <img src="${u.photo}" class="rank-img ${frameClass}">
                            </div>
                            <div>
                                <p class="font-bold text-gray-800 text-sm flex items-center">
                                    ${crown} 
                                    ${u.name}
                                    ${badgeHtml}
                                </p>
                                <p class="text-[10px] text-gray-600">ID: ${u.uniqueId}</p>
                                <p class="text-[10px] text-gray-500 mt-1">${u.bio || ""}</p>
                                ${u.isPremium && u.premiumExpiry && u.premiumExpiry.toDate() > new Date() ? 
                                    `<p class="text-[10px] text-yellow-600 font-bold">ğŸ‘‘ Ù…Ù…ÙŠØ²</p>` : 
                                    ''}
                            </div>
                        </div>
                        <div class="flex items-center z-10">
                            ${resetBtn}
                            <div class="text-right">
                                <span class="font-black text-indigo-600 text-lg">${u.points || 0} ğŸ’${prizeMoney}</span>
                            </div>
                        </div>
                    </div>`;
            });
        }

        window.loadMoreLeaderboard = function() {
            leaderboardOffset += LEADERBOARD_CHUNK_SIZE;
            const nextChunk = allLeaderboardUsers.slice(leaderboardOffset, leaderboardOffset + LEADERBOARD_CHUNK_SIZE);
            
            if (nextChunk.length === 0) {
                document.getElementById('load-more-leaderboard').classList.add('hidden');
                return;
            }
            
            nextChunk.forEach((u, index) => {
                const globalIndex = leaderboardOffset + index;
                let frameClass = "frame-rank-common";
                let rankBadge = `<div class="rank-badge-top">${globalIndex + 1}</div>`;
                let backgroundClass = 'bg-rank-default';
                
                if (u.isPremium && u.premiumExpiry && u.premiumExpiry.toDate() > new Date()) {
                    backgroundClass = u.selectedBgTheme || 'bg-rank-default';
                }
                
                let badgeHtml = "";
                if (u.isPremium && u.premiumExpiry && u.premiumExpiry.toDate() > new Date() && u.selectedBadge) {
                    badgeHtml = `<span class="premium-badge" style="background-color: ${u.selectedBadgeColor || '#f59e0b'}">${u.selectedBadge}</span>`;
                }
                
                let resetBtn = "";
                if (currentUser && userData && userData.email === ADMIN_EMAIL) {
                    resetBtn = `<button onclick="resetUserPoints('${u.id}', '${u.name}')" class="w-6 h-6 rounded bg-red-100 text-red-500 flex items-center justify-center mr-2"><i class="fas fa-trash-alt text-xs"></i></button>`;
                }
                
                const div = document.getElementById('leaderboard-list');
                div.innerHTML += `
                    <div class="flex items-center justify-between p-4 rounded-xl shadow-sm mb-3 relative overflow-hidden ${backgroundClass}">
                        <div class="flex items-center gap-4 z-10">
                            <div class="rank-img-container">
                                ${rankBadge}
                                <img src="${u.photo}" class="rank-img ${frameClass}">
                            </div>
                            <div>
                                <p class="font-bold text-gray-800 text-sm flex items-center">
                                    ${u.name}
                                    ${badgeHtml}
                                </p>
                                <p class="text-[10px] text-gray-600">ID: ${u.uniqueId}</p>
                                <p class="text-[10px] text-gray-500 mt-1">${u.bio || ""}</p>
                            </div>
                        </div>
                        <div class="flex items-center z-10">
                            ${resetBtn}
                            <div class="text-right">
                                <span class="font-black text-indigo-600 text-lg">${u.points || 0} ğŸ’</span>
                            </div>
                        </div>
                    </div>`;
            });
            
            if (leaderboardOffset + LEADERBOARD_CHUNK_SIZE >= allLeaderboardUsers.length || leaderboardOffset >= LEADERBOARD_LIMIT) {
                document.getElementById('load-more-leaderboard').classList.add('hidden');
            }
        };

        window.resetUserPoints = async (uid, name) => {
            if(confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØµÙÙŠØ± Ù†Ù‚Ø§Ø· Ø§Ù„Ø·Ø§Ù„Ø¨: ${name}ØŸ`)) {
                await updateDoc(doc(db, "users", uid), { points: 0 });
                showBeautifulAlert('success', 'ØªÙ… Ø§Ù„ØªØµÙÙŠØ±', 'ØªÙ… ØªØµÙÙŠØ± Ø§Ù„Ù†Ù‚Ø§Ø· Ø¨Ù†Ø¬Ø§Ø­!');
                loadLeaderboard(); 
            }
        };

        async function loadBannedUsers() {
            try {
                const q = query(collection(db, "users"), where("isBanned", "==", true));
                const snap = await getDocs(q);
                
                const section = document.getElementById('banned-users-section');
                const list = document.getElementById('banned-users-list');
                
                if(snap.empty) {
                    section.classList.add('hidden');
                    return;
                }
                
                section.classList.remove('hidden');
                list.innerHTML = '';
                
                snap.forEach(doc => {
                    const u = doc.data();
                    list.innerHTML += `
                        <div class="banned-user-item">
                            <div class="banned-user-info">
                                <p class="banned-user-name">${u.name}</p>
                                <p class="banned-user-id">ID: ${u.uniqueId}</p>
                            </div>
                            <button onclick="unbanUser('${doc.id}', '${u.name}')" class="unban-btn">
                                <i class="fas fa-unlock"></i> ÙÙƒ Ø§Ù„Ø­Ø¸Ø±
                            </button>
                        </div>
                    `;
                });
                
            } catch (error) {
                console.error("Error loading banned users:", error);
            }
        }

        window.unbanUser = async (uid, name) => {
            if(confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ ÙÙƒ Ø§Ù„Ø­Ø¸Ø± Ø¹Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ${name}ØŸ`)) {
                try {
                    await updateDoc(doc(db, "users", uid), { isBanned: false });
                    showBeautifulAlert('success', 'ØªÙ… ÙÙƒ Ø§Ù„Ø­Ø¸Ø±', `ØªÙ… ÙÙƒ Ø§Ù„Ø­Ø¸Ø± Ø¹Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ${name}`);
                    loadBannedUsers();
                } catch (error) {
                    console.error("Error unbanning user:", error);
                    showBeautifulAlert('error', 'Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ÙÙƒ Ø§Ù„Ø­Ø¸Ø±');
                }
            }
        };

        window.searchUserForAdmin = async () => {
            const uidInput = document.getElementById('admin-user-search').value.trim();
            const resDiv = document.getElementById('admin-user-result');
            if(!uidInput) {
                showBeautifulAlert('warning', 'ØªÙ†Ø¨ÙŠÙ‡', 'Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¹Ø±Ù (ID)');
                return;
            }
            
            resDiv.classList.remove('hidden');
            resDiv.innerHTML = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...';
            
            try {
                const q = query(collection(db, "users"), where("uniqueId", "==", uidInput));
                const snap = await getDocs(q);
                
                if(snap.empty) {
                    resDiv.innerHTML = '<p class="text-red-500">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯</p>';
                    return;
                }
                
                const uData = snap.docs[0].data();
                const docId = snap.docs[0].id;
                const isBanned = uData.isBanned === true;
                const balance = uData.balance || 0;
                const deserves = balance >= 100;
                const createdAt = uData.createdAt ? uData.createdAt.toDate().toLocaleDateString('ar-EG') : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
                const lastLogin = uData.lastLogin ? new Date(uData.lastLogin).toLocaleDateString('ar-EG') : 'Ù„Ù… ÙŠØ³Ø¬Ù„ Ø¯Ø®ÙˆÙ„';

                resDiv.innerHTML = `
                    <div class="text-center mb-4">
                        <img src="${uData.photo}" class="w-16 h-16 rounded-full mx-auto mb-2">
                        <h3 class="font-bold">${uData.name}</h3>
                        <p class="text-xs text-gray-500">ID: ${uData.uniqueId}</p>
                        <p class="text-xs text-gray-500">${uData.email}</p>
                    </div>
                    <div class="mb-4 text-right">
                        <p class="text-sm"><span class="font-bold">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:</span> ${uData.email || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</p>
                        <p class="text-sm"><span class="font-bold">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:</span> <span class="text-gray-400">(Ù…Ø´ÙØ±Ø© ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…)</span></p>
                        <p class="text-sm"><span class="font-bold">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„:</span> ${createdAt}</p>
                        <p class="text-sm"><span class="font-bold">Ø¢Ø®Ø± Ø¯Ø®ÙˆÙ„:</span> ${lastLogin}</p>
                        <p class="text-sm"><span class="font-bold">Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©:</span> ${uData.grade ? getGradeName(uData.grade) : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>
                        <p class="text-sm"><span class="font-bold">Ø§Ù„Ø³ÙŠØ±Ø© Ø§Ù„Ø°Ø§ØªÙŠØ©:</span> ${uData.bio || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}</p>
                        <p class="text-sm"><span class="font-bold">Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø¸Ø±:</span> ${isBanned ? 'ğŸ›‘ Ù…Ø­Ø¸ÙˆØ±' : 'âœ… Ù†Ø´Ø·'}</p>
                        <p class="text-sm"><span class="font-bold">Ø­Ø³Ø§Ø¨ Ù…Ù…ÙŠØ²:</span> ${uData.isPremium ? 'âœ… Ù†Ø¹Ù…' : 'âŒ Ù„Ø§'}</p>
                    </div>
                    <div class="grid grid-cols-2 gap-2 mb-4 text-xs font-bold text-center">
                        <div class="bg-gray-50 p-2 rounded">Ø§Ù„Ù†Ù‚Ø§Ø·: ${uData.points || 0}</div>
                        <div class="bg-gray-50 p-2 rounded">Ø§Ù„Ø¯ÙˆÙ„Ø§Ø±Ø§Øª: $${balance}</div>
                    </div>
                    <div class="mb-4 text-center">
                        <p class="text-sm font-bold ${deserves ? 'text-green-600' : 'text-red-500'}">
                            ${deserves ? 'âœ… ÙŠØ³ØªØ­Ù‚ Ø§Ù„Ø³Ø­Ø¨' : 'âŒ Ù„Ø§ ÙŠØ³ØªØ­Ù‚ Ø§Ù„Ø³Ø­Ø¨'}
                        </p>
                        ${deserves ? `<button onclick="resetUserBalance('${docId}')" class="mt-2 bg-yellow-500 text-white px-4 py-2 rounded text-xs font-bold">ØªØµÙÙŠØ± Ø§Ù„Ø¯ÙˆÙ„Ø§Ø±Ø§Øª</button>` : ''}
                    </div>
                    <button onclick="toggleBan('${docId}', ${!isBanned})" class="w-full py-3 rounded-xl font-bold text-white ${isBanned ? 'bg-green-500' : 'bg-red-500'}">
                        ${isBanned ? 'Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¸Ø± (ÙÙƒ Ø§Ù„Ù‚ÙŠØ¯)' : 'Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹'}
                    </button>
                `;
            } catch (error) {
                resDiv.innerHTML = '<p class="text-red-500">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«</p>';
            }
        };

        window.toggleBan = async (docId, shouldBan) => {
            if(confirm(shouldBan ? "Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø¸Ø± Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ Ù„Ù† ÙŠØªÙ…ÙƒÙ† Ù…Ù† Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø¬Ø¯Ø¯Ø§Ù‹." : "Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¸Ø±ØŸ")) {
                await updateDoc(doc(db, "users", docId), { isBanned: shouldBan });
                showBeautifulAlert('success', 'ØªÙ…', shouldBan ? "ØªÙ… Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" : "ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¸Ø±");
                searchUserForAdmin();
                loadBannedUsers();
            }
        };

        window.resetUserBalance = async (docId) => {
             if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØµÙÙŠØ± Ø¯ÙˆÙ„Ø§Ø±Ø§Øª Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ (ÙŠØ¹Ù†ÙŠ Ø£Ù†Ùƒ Ø¯ÙØ¹Øª Ù„Ù‡)")) {
                 await updateDoc(doc(db, "users", docId), { balance: 0 });
                 showBeautifulAlert('success', 'ØªÙ… Ø§Ù„ØªØµÙÙŠØ±', 'ØªÙ… ØªØµÙÙŠØ± Ø§Ù„Ø±ØµÙŠØ¯');
                 searchUserForAdmin();
             }
        };

        window.manualWeeklyDistribution = async () => {
             if(!confirm("âš ï¸ ØªØ­Ø°ÙŠØ±: Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø³ÙŠÙ‚ÙˆÙ… Ø¨ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¬ÙˆØ§Ø¦Ø² Ø¹Ù„Ù‰ Ø§Ù„Ù€ 10 Ø§Ù„Ø£ÙˆØ§Ø¦Ù„ ÙˆØªØµÙÙŠØ± Ù†Ù‚Ø§Ø· Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† (Ø£Ø¹Ù„Ù‰ 150). Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ")) return;
             
             const q = query(collection(db, "users"), orderBy("points", "desc"), limit(10));
             const snap = await getDocs(q);
             const prizes = [10, 7, 5, 3, 2, 1, 1, 1, 1, 1];
             
             let batch = writeBatch(db);
             
             snap.docs.forEach((d, index) => {
                 if(index < 10) {
                     const prize = prizes[index];
                     const newBalance = (d.data().balance || 0) + prize;
                     batch.update(doc(db, "users", d.id), { balance: newBalance });
                 }
             });
             await batch.commit();

             const qReset = query(collection(db, "users"), orderBy("points", "desc"), limit(150));
             const snapReset = await getDocs(qReset);
             
             let resetBatch = writeBatch(db);
             snapReset.docs.forEach(d => {
                 resetBatch.update(doc(db, "users", d.id), { points: 0 });
             });
             await resetBatch.commit();
             
             showBeautifulAlert('success', 'ØªÙ… Ø§Ù„ØªÙˆØ²ÙŠØ¹', 'âœ… ØªÙ… ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¬ÙˆØ§Ø¦Ø² ÙˆØªØµÙÙŠØ± Ø§Ù„Ù†Ù‚Ø§Ø· Ø¨Ù†Ø¬Ø§Ø­!');
        };

        window.generateSubscriptionCode = async function() {
            try {
                if (!currentUser || !userData || userData.email !== ADMIN_EMAIL) {
                    showBeautifulAlert('error', 'Ø®Ø·Ø£', 'â›” Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù„Ù‚ÙŠØ§Ù… Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡');
                    return;
                }

                const durationSelect = document.getElementById('admin-sub-duration');
                const durationDays = parseInt(durationSelect.value);
                
                if (!durationDays || durationDays <= 0) {
                    showBeautifulAlert('warning', 'ØªÙ†Ø¨ÙŠÙ‡', 'â›” ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ù…Ø¯Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ');
                    return;
                }

                const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
                let code;
                let isUnique = false;
                let attempts = 0;
                
                while (!isUnique && attempts < 10) {
                    code = '';
                    for (let i = 0; i < 8; i++) {
                        code += chars.charAt(Math.floor(Math.random() * chars.length));
                    }
                    
                    const q = query(collection(db, "premium_codes"), where("code", "==", code));
                    const querySnapshot = await getDocs(q);
                    isUnique = querySnapshot.empty;
                    attempts++;
                }
                
                if (!isUnique) {
                    showBeautifulAlert('error', 'Ø®Ø·Ø£', 'âŒ ØªØ¹Ø°Ø± Ø¥Ù†Ø´Ø§Ø¡ ÙƒÙˆØ¯ ÙØ±ÙŠØ¯ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰');
                    return;
                }

                await addDoc(collection(db, "premium_codes"), {
                    code: code,
                    durationDays: durationDays,
                    createdBy: currentUser.uid,
                    createdAt: serverTimestamp(),
                    used: false,
                    usedBy: null,
                    usedAt: null,
                    isActive: true
                });

                const displayDiv = document.getElementById('generated-code-display');
                const codeText = document.getElementById('gen-code-text');
                
                codeText.textContent = code;
                displayDiv.classList.remove('hidden');
                
                showBeautifulAlert('success', 'ØªÙ… Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡', `âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ÙƒÙˆØ¯ Ø§Ø´ØªØ±Ø§Ùƒ Ø¬Ø¯ÙŠØ¯:\n\nØ§Ù„ÙƒÙˆØ¯: ${code}\nØ§Ù„Ù…Ø¯Ø©: ${durationDays} ÙŠÙˆÙ…\n\nØ§Ù„ÙƒÙˆØ¯ ÙŠØ³ØªØ®Ø¯Ù… Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·!`);

            } catch (error) {
                console.error("Ø®Ø·Ø£ ÙÙŠ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ÙƒÙˆØ¯:", error);
                showBeautifulAlert('error', 'Ø®Ø·Ø£', `âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ÙƒÙˆØ¯: ${error.message}`);
            }
        };

        window.copyGenCode = function() {
            const codeText = document.getElementById('gen-code-text').textContent;
            if (!codeText || codeText === '...') {
                showBeautifulAlert('warning', 'ØªÙ†Ø¨ÙŠÙ‡', 'âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙƒÙˆØ¯ Ù„Ø¹Ø±Ø¶Ù‡');
                return;
            }
            
            navigator.clipboard.writeText(codeText)
                .then(() => {
                    showBeautifulAlert('success', 'ØªÙ… Ø§Ù„Ù†Ø³Ø®', 'âœ… ØªÙ… Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯ Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø©!');
                })
                .catch(err => {
                    console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù†Ø³Ø®:", err);
                    const tempInput = document.createElement('input');
                    tempInput.value = codeText;
                    document.body.appendChild(tempInput);
                    tempInput.select();
                    document.execCommand('copy');
                    document.body.removeChild(tempInput);
                    showBeautifulAlert('success', 'ØªÙ… Ø§Ù„Ù†Ø³Ø®', 'âœ… ØªÙ… Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯ Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø©!');
                });
        };

        window.deleteSubscriptionCode = async function() {
            try {
                const codeInput = document.getElementById('admin-delete-code-input').value.trim().toUpperCase();
                
                if (!codeInput) {
                    showBeautifulAlert('warning', 'ØªÙ†Ø¨ÙŠÙ‡', 'âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙˆØ¯ Ù„Ù„Ø­Ø°Ù');
                    return;
                }

                if (!confirm(`âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„ÙƒÙˆØ¯ "${codeInput}"ØŸ\n\nÙ‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù†Ù‡Ø§Ø¦ÙŠ ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡.`)) {
                    return;
                }

                const q = query(collection(db, "premium_codes"), where("code", "==", codeInput));
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    showBeautifulAlert('error', 'Ø®Ø·Ø£', 'âŒ Ø§Ù„ÙƒÙˆØ¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
                    return;
                }

                const codeDoc = querySnapshot.docs[0];
                await deleteDoc(doc(db, "premium_codes", codeDoc.id));
                
                document.getElementById('admin-delete-code-input').value = '';
                showBeautifulAlert('success', 'ØªÙ… Ø§Ù„Ø­Ø°Ù', `âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„ÙƒÙˆØ¯ "${codeInput}" Ø¨Ù†Ø¬Ø§Ø­`);

            } catch (error) {
                console.error("Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„ÙƒÙˆØ¯:", error);
                showBeautifulAlert('error', 'Ø®Ø·Ø£', `âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„ÙƒÙˆØ¯: ${error.message}`);
            }
        };

        async function loadPremiumUsers() {
            const listDiv = document.getElementById('premium-users-list');
            listDiv.innerHTML = '<p class="text-center text-gray-400">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>';
            
            try {
                const q = query(collection(db, "users"), where("isPremium", "==", true));
                const snap = await getDocs(q);
                
                if(snap.empty) {
                    listDiv.innerHTML = '<p class="text-center text-gray-400 py-10">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…Ù…ÙŠØ²ÙŠÙ†</p>';
                    return;
                }
                
                let html = '';
                const now = new Date();
                
                snap.docs.forEach(doc => {
                    const u = doc.data();
                    let remainingDays = "Ù…Ù†ØªÙ‡ÙŠ";
                    if (u.premiumExpiry) {
                        const expiry = u.premiumExpiry.toDate();
                        const diff = expiry - now;
                        if(diff > 0) {
                            remainingDays = Math.ceil(diff / (1000 * 60 * 60 * 24)) + " ÙŠÙˆÙ…";
                        }
                    }
                    
                    html += `
                        <div class="bg-white rounded-xl p-4 border border-yellow-100 shadow-sm">
                            <div class="flex justify-between items-center">
                                <div>
                                    <p class="font-bold text-gray-800">${u.name}</p>
                                    <p class="text-xs text-gray-500">ID: ${u.uniqueId}</p>
                                </div>
                                <div class="text-right">
                                    <span class="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded font-bold">${remainingDays}</span>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                listDiv.innerHTML = html;
            } catch (error) {
                listDiv.innerHTML = '<p class="text-center text-gray-400">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ù…ÙŠØ²ÙŠÙ†</p>';
            }
        }

        window.handleImagePreview = (input) => {
            if(input.files[0]) {
                const r = new FileReader();
                r.onload = (e) => document.getElementById('preview-img').src = e.target.result;
                r.readAsDataURL(input.files[0]);
            }
        };
        
        function generateId() { 
            return Math.random().toString(36).substr(2, 8).toUpperCase(); 
        }

        window.updateProfilePic = async (input) => {
            if(input.files[0]) {
                try {
                    showBeautifulAlert('info', 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹', 'Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©...');
                    const photoURL = await uploadImageToStorage(input.files[0], currentUser.uid);
                    
                    await updateDoc(doc(db, "users", currentUser.uid), { photo: photoURL });
                    userData.photo = photoURL;
                    document.getElementById('profile-img').src = photoURL;
                    
                    showBeautifulAlert('success', 'ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«', 'ØªÙ… ØªØ­Ø¯ÙŠØ« ØµÙˆØ±Ø© Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ âœ…');
                } catch (error) {
                    console.error("Error updating profile picture:", error);
                    showBeautifulAlert('error', 'Ø®Ø·Ø£', 'âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©: ' + getArabicError(error.code));
                }
            }
        };

        async function loadUserSchedule() {
            if (!currentUser) return;
            
            try {
                const scheduleDoc = await getDoc(doc(db, "user_schedules", currentUser.uid));
                if (scheduleDoc.exists()) {
                    const scheduleData = scheduleDoc.data();
                    document.getElementById('subjectName').value = scheduleData.subject || '';
                    document.getElementById('totalHours').value = scheduleData.totalHours || '';
                    document.getElementById('needSleep').value = scheduleData.needSleep ? 'yes' : 'no';
                    document.getElementById('breakDuration').value = scheduleData.breakDuration || 10;
                    document.getElementById('studyTimePref').value = scheduleData.studyTimePref || 'any';
                    
                    const chaptersList = document.getElementById('chaptersList');
                    chaptersList.innerHTML = '';
                    
                    if (scheduleData.chapters && scheduleData.chapters.length > 0) {
                        scheduleData.chapters.forEach(ch => {
                            addChapterRow(ch.name, ch.difficulty);
                        });
                    } else {
                        addChapterRow();
                    }
                    
                    scheduleData.chapters = scheduleData.chapters || [];
                    calculateAndRenderScheduleFromData(scheduleData);
                }
            } catch (error) {
                console.error("Error loading user schedule:", error);
            }
        }

        async function saveUserScheduleToDB(scheduleData) {
            if (!currentUser) return;
            
            try {
                await setDoc(doc(db, "user_schedules", currentUser.uid), {
                    ...scheduleData,
                    userId: currentUser.uid,
                    lastUpdated: serverTimestamp(),
                    updatedAt: new Date().toISOString()
                });
            } catch (error) {
                console.error("Error saving schedule to DB:", error);
            }
        }

        let scheduleData = { subject: '', chapters: [], totalHours: 0, needSleep: true, breakDuration: 10, studyTimePref: 'any' };
        
        function initSchedule() {
            const chaptersList = document.getElementById('chaptersList');
            chaptersList.innerHTML = '';
            addChapterRow();
            
            loadUserSchedule();
        }
        
        window.handleScheduleFormSubmit = function(e) {
            e.preventDefault();
            
            const needSleepSelect = document.getElementById('needSleep');
            if (!needSleepSelect.value) {
                showBeautifulAlert('warning', 'ØªÙ†Ø¨ÙŠÙ‡', 'ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø®ÙŠØ§Ø± ÙˆÙ‚Øª Ø§Ù„Ù†ÙˆÙ… (Ø§Ø­Ø³Ø¨ ÙˆÙ‚Øª Ø§Ù„Ù†ÙˆÙ… Ø£Ùˆ Ù„Ø§ ØªØ­Ø³Ø¨Ù‡)');
                return;
            }
            
            scheduleData.subject = document.getElementById('subjectName').value;
            scheduleData.totalHours = parseFloat(document.getElementById('totalHours').value);
            scheduleData.needSleep = document.getElementById('needSleep').value === 'yes';
            scheduleData.breakDuration = parseInt(document.getElementById('breakDuration').value);
            scheduleData.studyTimePref = document.getElementById('studyTimePref').value;
            
            scheduleData.chapters = [];
            document.querySelectorAll('#chaptersList > div').forEach((row, idx) => {
                const diff = parseFloat(row.querySelector('.diff-select').value);
                const nameVal = row.querySelector('.name-input').value;
                const name = nameVal ? nameVal : `ÙØµÙ„ ${idx + 1}`;
                scheduleData.chapters.push({ name, difficulty: diff });
            });

            if (scheduleData.chapters.length === 0) {
                showBeautifulAlert('warning', 'ØªÙ†Ø¨ÙŠÙ‡', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© ÙØµÙ„ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
                return;
            }

            saveUserScheduleToDB(scheduleData);
            
            calculateAndRenderScheduleFromData(scheduleData);
        };

        function calculateAndRenderScheduleFromData(scheduleData) {
            let totalMins = scheduleData.totalHours * 60;
            let sleepMins = 0;

            if (scheduleData.needSleep && scheduleData.totalHours > 16) {
                const days = scheduleData.totalHours / 24;
                sleepMins = Math.floor(days * 8 * 60);
                totalMins -= sleepMins;
            }

            const studyRatio = 60 / (60 + scheduleData.breakDuration);
            const netStudyMins = Math.round(totalMins * studyRatio);
            const totalBreakMins = totalMins - netStudyMins;

            const totalPoints = scheduleData.chapters.reduce((acc, c) => acc + c.difficulty, 0);

            document.getElementById('schedule-input-page').classList.add('hidden');
            document.getElementById('schedule-result-page').classList.remove('hidden');
            document.getElementById('displaySubject').innerText = scheduleData.subject;
            
            let timeText = "Ù…Ø¯Ù‘Ø©: " + scheduleData.totalHours + " Ø³ | ÙˆÙ‚Øª: ";
            if (scheduleData.studyTimePref === 'morning') timeText += "ØµØ¨Ø§Ø­";
            else if (scheduleData.studyTimePref === 'evening') timeText += "Ù…Ø³Ø§Ø¡";
            else timeText += "Ø£ÙŠ ÙˆÙ‚Øª";
            document.getElementById('displayScheduleTime').innerText = timeText;

            const tbody = document.getElementById('scheduleBody');
            tbody.innerHTML = '';

            let currentTime = 0;
            if (scheduleData.studyTimePref === 'evening') currentTime = 16 * 60;
            else if (scheduleData.studyTimePref === 'any') currentTime = 8 * 60;

            scheduleData.chapters.forEach((ch, idx) => {
                const share = ch.difficulty / totalPoints;
                const chapterMins = Math.round(netStudyMins * share);
                
                const startHour = Math.floor(currentTime / 60);
                const startMin = currentTime % 60;
                currentTime += chapterMins;
                const endHour = Math.floor(currentTime / 60);
                const endMin = currentTime % 60;
                
                const breakMins = scheduleData.breakDuration;
                
                const tr1 = document.createElement('tr');
                tr1.innerHTML = `
                    <td>${ch.name}</td>
                    <td>${formatTime2(startHour, startMin)}<br>${formatTime2(endHour, endMin)}</td>
                `;
                tbody.appendChild(tr1);
                
                if (idx < scheduleData.chapters.length - 1) {
                    const breakStartHour = Math.floor(currentTime / 60);
                    const breakStartMin = currentTime % 60;
                    currentTime += breakMins;
                    const breakEndHour = Math.floor(currentTime / 60);
                    const breakEndMin = currentTime % 60;
                    
                    const tr2 = document.createElement('tr');
                    tr2.innerHTML = `
                        <td>Ø§Ø³ØªØ±Ø§Ø­Ø©</td>
                        <td>${formatTime2(breakStartHour, breakStartMin)}<br>${formatTime2(breakEndHour, breakEndMin)}</td>
                    `;
                    tbody.appendChild(tr2);
                }
            });

            if (scheduleData.needSleep && scheduleData.totalHours > 16) {
                const sleepStart = 22 * 60;
                const sleepEnd = 6 * 60;
                const trSleep = document.createElement('tr');
                trSleep.innerHTML = `
                    <td>Ù†ÙˆÙ…</td>
                    <td>${formatTime2(22, 0)}<br>${formatTime2(6, 0)}</td>
                `;
                tbody.appendChild(trSleep);
            }

            document.getElementById('statStudy').innerText = formatTime(netStudyMins);
            document.getElementById('statBreak').innerText = formatTime(totalBreakMins);
            document.getElementById('statSleep').innerText = formatTime(sleepMins);
        }

        function formatTime2(hour, min) {
            min = Math.round(min);
            
            if (min >= 60) {
                hour += Math.floor(min / 60);
                min = min % 60;
            }
            
            hour = hour % 24;
            
            let displayHour = hour % 12;
            if (displayHour === 0) displayHour = 12;
            
            const ampm = hour < 12 ? 'Øµ' : 'Ù…';
            
            return `${displayHour}:${min < 10 ? '0' + min : min} ${ampm}`;
        }

        function formatTime(m) {
            if(m < 60) return Math.round(m) + ' Ø¯';
            const h = Math.floor(m/60);
            const rem = Math.round(m%60);
            return rem > 0 ? `${h}Ø³ ${rem}Ø¯` : `${h}Ø³`;
        }

        window.addChapterRow = function(name = '', difficulty = 1.5) {
            const container = document.getElementById('chaptersList');
            const index = container.children.length + 1;
            const div = document.createElement('div');
            div.className = 'flex gap-2 items-center';
            div.innerHTML = `
                <span class="bg-indigo-50 text-indigo-600 font-bold py-2 px-3 rounded text-sm">${index}</span>
                <select class="diff-select w-24 p-2 rounded bg-white border text-xs font-bold focus:border-indigo-500 outline-none">
                    <option value="1" ${difficulty === 1 ? 'selected' : ''}>Ø³Ù‡Ù„</option>
                    <option value="1.5" ${difficulty === 1.5 ? 'selected' : ''}>Ù…ØªÙˆØ³Ø·</option>
                    <option value="2.5" ${difficulty === 2.5 ? 'selected' : ''}>ØµØ¹Ø¨</option>
                </select>
                <input type="text" placeholder="Ø§Ø³Ù… Ø§Ù„ÙØµÙ„" class="name-input flex-1 p-2 rounded bg-white border text-sm focus:border-indigo-500 outline-none" value="${name}">
                <button type="button" onclick="this.parentElement.remove()" class="text-red-400 hover:text-red-600 px-2"><i class="fa-solid fa-xmark"></i></button>
            `;
            container.appendChild(div);
        };

        window.downloadScheduleAsImage = function() {
            const el = document.getElementById('schedule-card');
            const btn = event.target.closest('button');
            const oldTxt = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';
            
            const script = document.createElement('script');
            script.src = "https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js";
            script.onload = function() {
                html2canvas(el, { scale: 2, backgroundColor: "#ffffff" }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = `Ø¬Ø¯ÙˆÙ„-${Date.now()}.png`;
                    link.href = canvas.toDataURL("image/png");
                    link.click();
                    btn.innerHTML = oldTxt;
                });
            };
            document.head.appendChild(script);
        };

        window.resetSchedule = async function() {
            if(confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙˆØ¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙŠØ¯ØŸ')) {
                try {
                    if (currentUser) {
                        await deleteDoc(doc(db, "user_schedules", currentUser.uid));
                    }
                    
                    document.getElementById('subjectName').value = '';
                    document.getElementById('totalHours').value = '';
                    document.getElementById('needSleep').value = '';
                    document.getElementById('breakDuration').value = '10';
                    document.getElementById('studyTimePref').value = 'any';
                    
                    const chaptersList = document.getElementById('chaptersList');
                    chaptersList.innerHTML = '';
                    addChapterRow();
                    
                    document.getElementById('schedule-result-page').classList.add('hidden');
                    document.getElementById('schedule-input-page').classList.remove('hidden');
                    
                    showBeautifulAlert('success', 'ØªÙ… Ø§Ù„Ø­Ø°Ù', 'ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­');
                } catch (error) {
                    console.error("Error resetting schedule:", error);
                    showBeautifulAlert('error', 'Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ø¬Ø¯ÙˆÙ„');
                }
            }
        };

        window.showComingSoon = function() {
            showBeautifulAlert('info', 'ØªØ¬Ø±ÙŠØ¨ÙŠ', 'Ù‡Ø°Ø§ Ø§Ù„Ø²Ø± Ù„Ù„Ø´ÙƒÙ„ ÙÙ‚Ø· ÙˆÙ„Ø§ ÙŠØ¹Ù…Ù„ Ø­Ø§Ù„ÙŠØ§Ù‹');
        };

        function initUploadQuestions() {
            if (!userData.grade) {
                showBeautifulAlert('warning', 'ØªÙ†Ø¨ÙŠÙ‡', 'ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ù…Ø±Ø­Ù„ØªÙƒ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹');
                setTimeout(() => backToProfile(), 1000);
                return;
            }
            
            const subjectSelect = document.getElementById('upload-subject');
            subjectSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø¯Ø©</option>';
            const gradeSubjects = subjects[userData.grade] || [];
            gradeSubjects.forEach(sub => {
                subjectSelect.innerHTML += `<option value="${sub}">${sub}</option>`;
            });
            
            uploadQType = 'mcq';
            uploadCorrectAnswer = null;
            uploadTFAnswer = null;
            
            document.getElementById('upload-step-1').classList.remove('hidden');
            document.getElementById('upload-step-2-mcq').classList.add('hidden');
            document.getElementById('upload-step-2-tf').classList.add('hidden');
            
            document.getElementById('upload-btn-mcq').className = `py-3 rounded-xl border-2 border-indigo-600 bg-indigo-50 text-indigo-600 font-bold active:scale-95 transition`;
            document.getElementById('upload-btn-tf').className = `py-3 rounded-xl border-2 border-indigo-100 text-gray-500 font-bold active:scale-95 transition`;
        }

        window.onUploadSubjectChange = function() {
            uploadSubject = document.getElementById('upload-subject').value;
        };

        window.setUploadQType = (t) => {
            uploadQType = t;
            document.getElementById('upload-btn-mcq').className = `py-3 rounded-xl border-2 font-bold transition flex-1 ${t==='mcq'?'border-indigo-600 bg-indigo-50 text-indigo-600':'border-indigo-100 text-gray-500'}`;
            document.getElementById('upload-btn-tf').className = `py-3 rounded-xl border-2 font-bold transition flex-1 ${t==='tf'?'border-indigo-600 bg-indigo-50 text-indigo-600':'border-indigo-100 text-gray-500'}`;
        };

        window.goToUploadStep1 = function() {
            document.getElementById('upload-step-1').classList.remove('hidden');
            document.getElementById('upload-step-2-mcq').classList.add('hidden');
            document.getElementById('upload-step-2-tf').classList.add('hidden');
        };

        window.goToUploadStep2 = function() {
            if (!uploadSubject) {
                showBeautifulAlert('warning', 'ØªÙ†Ø¨ÙŠÙ‡', 'ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø§Ø¯Ø© Ø£ÙˆÙ„Ø§Ù‹');
                return;
            }
            
            if (!uploadQType) {
                showBeautifulAlert('warning', 'ØªÙ†Ø¨ÙŠÙ‡', 'ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø£ÙˆÙ„Ø§Ù‹');
                return;
            }
            
            document.getElementById('upload-step-1').classList.add('hidden');
            
            if (uploadQType === 'mcq') {
                document.getElementById('upload-step-2-mcq').classList.remove('hidden');
                document.getElementById('upload-step-2-tf').classList.add('hidden');
                
                document.getElementById('upload-question-text').value = '';
                document.getElementById('upload-answer-1').value = '';
                document.getElementById('upload-answer-2').value = '';
                document.getElementById('upload-answer-3').value = '';
                uploadCorrectAnswer = null;
                resetCorrectButtons();
            } else {
                document.getElementById('upload-step-2-mcq').classList.add('hidden');
                document.getElementById('upload-step-2-tf').classList.remove('hidden');
                
                document.getElementById('upload-tf-question').value = '';
                uploadTFAnswer = null;
                resetTFButtons();
            }
        };

        function resetCorrectButtons() {
            for (let i = 1; i <= 3; i++) {
                const btn = document.getElementById('upload-correct-' + i);
                btn.className = 'w-12 bg-gray-100 text-gray-600 rounded-lg';
                btn.innerHTML = 'âœ“';
            }
        }

        function resetTFButtons() {
            document.getElementById('upload-tf-true').className = 'py-3 rounded-xl border-2 border-green-100 text-gray-500 font-bold';
            document.getElementById('upload-tf-false').className = 'py-3 rounded-xl border-2 border-red-100 text-gray-500 font-bold';
        }

        window.setCorrectAnswer = function(num) {
            uploadCorrectAnswer = num;
            resetCorrectButtons();
            const btn = document.getElementById('upload-correct-' + num);
            btn.className = 'w-12 bg-green-500 text-white rounded-lg';
            btn.innerHTML = 'âœ“';
        };

        window.setTFAnswer = function(isTrue) {
            uploadTFAnswer = isTrue;
            resetTFButtons();
            if (isTrue) {
                document.getElementById('upload-tf-true').className = 'py-3 rounded-xl border-2 border-green-500 bg-green-50 text-green-600 font-bold';
                document.getElementById('upload-tf-false').className = 'py-3 rounded-xl border-2 border-red-100 text-gray-500 font-bold';
            } else {
                document.getElementById('upload-tf-true').className = 'py-3 rounded-xl border-2 border-green-100 text-gray-500 font-bold';
                document.getElementById('upload-tf-false').className = 'py-3 rounded-xl border-2 border-red-500 bg-red-50 text-red-600 font-bold';
            }
        };

        window.submitQuestionMCQ = async function() {
            const questionText = document.getElementById('upload-question-text').value.trim();
            const answer1 = document.getElementById('upload-answer-1').value.trim();
            const answer2 = document.getElementById('upload-answer-2').value.trim();
            const answer3 = document.getElementById('upload-answer-3').value.trim();
            
            if (!questionText) {
                showBeautifulAlert('warning', 'ØªÙ†Ø¨ÙŠÙ‡', 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„');
                return;
            }
            
            if (!answer1 || !answer2 || !answer3) {
                showBeautifulAlert('warning', 'ØªÙ†Ø¨ÙŠÙ‡', 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª');
                return;
            }
            
            if (uploadCorrectAnswer === null) {
                showBeautifulAlert('warning', 'ØªÙ†Ø¨ÙŠÙ‡', 'ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©');
                return;
            }
            
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ø³Ø¤Ø§Ù„ ØµØ­ÙŠØ­ ÙˆÙ…Ù† Ø¶Ù…Ù† Ø§Ù„Ù…Ù†Ù‡Ø¬ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØŸ')) {
                return;
            }
            
            try {
                await addDoc(collection(db, "pending_questions"), {
                    question: questionText,
                    answers: [answer1, answer2, answer3],
                    correct: uploadCorrectAnswer,
                    type: 'mcq',
                    grade: userData.grade,
                    subject: uploadSubject,
                    senderId: currentUser.uid,
                    senderName: userData.name,
                    status: 'pending',
                    createdAt: serverTimestamp()
                });
                
                showBeautifulAlert('success', 'ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„', 'âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø³Ø¤Ø§Ù„ Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©. Ø³ØªØªÙ… Ø¥Ø¶Ø§ÙØ© 5 Ù†Ù‚Ø§Ø· Ù„Ùƒ Ø¨Ø¹Ø¯ Ù‚Ø¨ÙˆÙ„Ù‡.');
                
                document.getElementById('upload-question-text').value = '';
                document.getElementById('upload-answer-1').value = '';
                document.getElementById('upload-answer-2').value = '';
                document.getElementById('upload-answer-3').value = '';
                uploadCorrectAnswer = null;
                resetCorrectButtons();
                
                goToUploadStep1();
                
            } catch (error) {
                console.error("Error submitting question:", error);
                showBeautifulAlert('error', 'Ø®Ø·Ø£', 'âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø³Ø¤Ø§Ù„');
            }
        };

        window.submitQuestionTF = async function() {
            const questionText = document.getElementById('upload-tf-question').value.trim();
            
            if (!questionText) {
                showBeautifulAlert('warning', 'ØªÙ†Ø¨ÙŠÙ‡', 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„');
                return;
            }
            
            if (uploadTFAnswer === null) {
                showBeautifulAlert('warning', 'ØªÙ†Ø¨ÙŠÙ‡', 'ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©');
                return;
            }
            
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ø³Ø¤Ø§Ù„ ØµØ­ÙŠØ­ ÙˆÙ…Ù† Ø¶Ù…Ù† Ø§Ù„Ù…Ù†Ù‡Ø¬ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØŸ')) {
                return;
            }
            
            try {
                await addDoc(collection(db, "pending_questions"), {
                    question: questionText,
                    correct: uploadTFAnswer,
                    type: 'tf',
                    grade: userData.grade,
                    subject: uploadSubject,
                    senderId: currentUser.uid,
                    senderName: userData.name,
                    status: 'pending',
                    createdAt: serverTimestamp()
                });
                
                showBeautifulAlert('success', 'ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„', 'âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø³Ø¤Ø§Ù„ Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©. Ø³ØªØªÙ… Ø¥Ø¶Ø§ÙØ© 5 Ù†Ù‚Ø§Ø· Ù„Ùƒ Ø¨Ø¹Ø¯ Ù‚Ø¨ÙˆÙ„Ù‡.');
                
                document.getElementById('upload-tf-question').value = '';
                uploadTFAnswer = null;
                resetTFButtons();
                
                goToUploadStep1();
                
            } catch (error) {
                console.error("Error submitting question:", error);
                showBeautifulAlert('error', 'Ø®Ø·Ø£', 'âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø³Ø¤Ø§Ù„');
            }
        };

        async function loadReviewQuestions() {
            const listDiv = document.getElementById('review-questions-list');
            
            if (!userData || userData.email !== ADMIN_EMAIL) {
                listDiv.innerHTML = `
                    <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-6 text-center">
                        <i class="fas fa-shield-alt text-yellow-500 text-3xl mb-3"></i>
                        <p class="text-yellow-700 font-bold">â›” ØµÙ„Ø§Ø­ÙŠØ© Ù…Ø­Ø¯ÙˆØ¯Ø©</p>
                        <p class="text-gray-600 text-sm mt-2">Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… Ù…Ø®ØµØµ Ù„Ù„Ø¥Ø¯Ø§Ø±Ø© ÙÙ‚Ø·</p>
                    </div>
                `;
                return;
            }
            
            listDiv.innerHTML = '<p class="text-center text-gray-400 animate-pulse">ğŸ“¥ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©...</p>';
            
            try {
                const q = query(collection(db, "pending_questions"), where("status", "==", "pending"));
                const snapshot = await getDocs(q);
                
                if (snapshot.empty) {
                    listDiv.innerHTML = `
                        <div class="bg-green-50 border border-green-200 rounded-xl p-8 text-center">
                            <i class="fas fa-check-circle text-green-500 text-4xl mb-3"></i>
                            <p class="text-green-700 font-bold">ğŸ‰ ÙƒÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ØªÙ…Øª Ù…Ø±Ø§Ø¬Ø¹ØªÙ‡Ø§</p>
                            <p class="text-gray-600 text-sm mt-2">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©</p>
                        </div>
                    `;
                    return;
                }
                
                console.log(`âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${snapshot.size} Ø³Ø¤Ø§Ù„ Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©`);
                
                let questions = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    questions.push({
                        id: doc.id,
                        ...data,
                        createdAt: data.createdAt ? data.createdAt.toDate() : new Date(),
                        timestamp: data.createdAt ? data.createdAt.toDate().getTime() : Date.now()
                    });
                });
                
                questions.sort((a, b) => b.timestamp - a.timestamp);
                
                let html = `
                    <div class="mb-4 p-3 bg-indigo-50 rounded-xl border border-indigo-100">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="font-bold text-indigo-700 text-sm">Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©: ${questions.length}</p>
                                <p class="text-xs text-indigo-500">(Ù…Ù† Ø§Ù„Ø£Ø­Ø¯Ø« Ù„Ù„Ø£Ù‚Ø¯Ù…)</p>
                            </div>
                            <span class="bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full text-xs font-bold">
                                ğŸ”„ Ù…Ø±ØªØ¨Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
                            </span>
                        </div>
                    </div>
                `;
                
                questions.forEach((item, index) => {
                    const data = item;
                    
                    const dateStr = data.createdAt.toLocaleDateString('ar-EG', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    let answersHtml = '';
                    if (data.type === 'mcq') {
                        answersHtml = `
                            <div class="upload-question-answers mt-3">
                                <p class="text-xs text-gray-500 mb-2 font-bold">Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª:</p>
                                ${(data.answers || []).map((ans, idx) => `
                                    <div class="upload-question-answer ${idx === data.correct ? 'upload-question-correct' : ''}">
                                        <span class="font-bold">${idx + 1}.</span> ${ans || '...'}
                                        ${idx === data.correct ? '<span class="text-green-500 text-xs mr-2">âœ“ ØµØ­</span>' : ''}
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    } else {
                        answersHtml = `
                            <div class="upload-question-answers mt-3">
                                <p class="text-xs text-gray-500 mb-2 font-bold">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©:</p>
                                <div class="upload-question-answer ${data.correct ? 'upload-question-correct' : ''}">
                                    ${data.correct ? 'âœ… ØµØ­' : 'âŒ Ø®Ø·Ø£'}
                                </div>
                            </div>
                        `;
                    }
                    
                    html += `
                        <div class="upload-question-item mb-4 border-l-4 ${index === 0 ? 'border-l-blue-500' : 'border-l-gray-300'}">
                            <div class="upload-question-header">
                                <div class="flex justify-between items-start">
                                    <div class="flex gap-2 flex-wrap">
                                        <span class="upload-question-grade">${data.grade ? getGradeName(data.grade) : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</span>
                                        <span class="upload-question-subject" style="background:#10b981">${data.subject || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</span>
                                        <span class="upload-question-type">${data.type === 'mcq' ? 'Ø§Ø®ØªÙŠØ§Ø±Ø§Øª' : 'ØµØ­/Ø®Ø·Ø£'}</span>
                                        ${index === 0 ? '<span class="bg-blue-100 text-blue-700 px-2 py-1 rounded text-xs font-bold">ğŸ†• Ø§Ù„Ø£Ø­Ø¯Ø«</span>' : ''}
                                    </div>
                                    <div class="text-xs text-gray-500" title="${data.createdAt.toISOString()}">
                                        ğŸ“… ${dateStr}
                                    </div>
                                </div>
                            </div>
                            
                            <p class="upload-question-text mt-3">${data.question || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Øµ Ù„Ù„Ø³Ø¤Ø§Ù„'}</p>
                            
                            ${answersHtml}
                            
                            <div class="mt-4 pt-3 border-t border-gray-100">
                                <div class="flex justify-between items-center">
                                    <p class="upload-sender text-sm">
                                        <span class="text-gray-500">ğŸ“¤ Ù…Ø±Ø³Ù„:</span>
                                        <span class="font-bold text-purple-600 mr-2">${data.senderName || data.senderId || 'Ù…Ø¬Ù‡ÙˆÙ„'}</span>
                                    </p>
                                    <span class="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded">
                                        #${index + 1}
                                    </span>
                                </div>
                            </div>
                            
                            <div class="upload-question-buttons mt-4">
                                <button onclick="acceptQuestion('${item.id}')" class="upload-accept-btn hover:scale-105 transition">
                                    <i class="fas fa-check"></i> Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø³Ø¤Ø§Ù„ (+5 Ù†Ù‚Ø§Ø· Ù„Ù„Ù…Ø±Ø³Ù„)
                                </button>
                                <button onclick="rejectQuestion('${item.id}')" class="upload-reject-btn hover:scale-105 transition">
                                    <i class="fas fa-times"></i> Ø±ÙØ¶ Ø§Ù„Ø³Ø¤Ø§Ù„
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                html += `
                    <div class="mt-6 text-center">
                        <button onclick="loadReviewQuestions()" class="bg-gray-100 text-gray-700 px-6 py-3 rounded-xl font-bold hover:bg-gray-200 transition flex items-center gap-2 mx-auto">
                            <i class="fas fa-sync-alt"></i> ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
                        </button>
                        <p class="text-xs text-gray-400 mt-2">Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: ${new Date().toLocaleTimeString('ar-EG')}</p>
                    </div>
                `;
                
                listDiv.innerHTML = html;
                
            } catch (error) {
                console.error("âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©:", error);
                listDiv.innerHTML = `
                    <div class="bg-red-50 border border-red-200 rounded-xl p-6 text-center">
                        <i class="fas fa-exclamation-triangle text-red-500 text-3xl mb-3"></i>
                        <p class="text-red-700 font-bold">ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</p>
                        <p class="text-red-600 text-sm mt-2">${error.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</p>
                        <button onclick="loadReviewQuestions()" class="mt-4 bg-red-100 text-red-700 px-6 py-2 rounded-lg font-bold hover:bg-red-200 transition">
                            <i class="fas fa-redo"></i> Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
                        </button>
                    </div>
                `;
            }
        }

        window.acceptQuestion = async function(questionId) {
            try {
                const questionDoc = await getDoc(doc(db, "pending_questions", questionId));
                if (!questionDoc.exists()) return;
                
                const questionData = questionDoc.data();
                
                await addDoc(collection(db, "questions"), {
                    question: questionData.question,
                    answers: questionData.answers || [],
                    correct: questionData.correct,
                    type: questionData.type,
                    grade: questionData.grade,
                    subject: questionData.subject,
                    createdAt: serverTimestamp()
                });
                
                await updateDoc(doc(db, "pending_questions", questionId), {
                    status: 'accepted',
                    reviewedAt: serverTimestamp(),
                    reviewedBy: currentUser.uid
                });
                
                if (questionData.senderId) {
                    await updateDoc(doc(db, "users", questionData.senderId), {
                        points: increment(5)
                    });
                }
                
                loadReviewQuestions();
                checkPendingQuestionsNotification();
                
            } catch (error) {
                console.error("Error accepting question:", error);
                showBeautifulAlert('error', 'Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø³Ø¤Ø§Ù„');
            }
        };

        window.rejectQuestion = async function(questionId) {
            try {
                await updateDoc(doc(db, "pending_questions", questionId), {
                    status: 'rejected',
                    reviewedAt: serverTimestamp(),
                    reviewedBy: currentUser.uid
                });
                
                loadReviewQuestions();
                checkPendingQuestionsNotification();
                
            } catch (error) {
                console.error("Error rejecting question:", error);
                showBeautifulAlert('error', 'Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø±ÙØ¶ Ø§Ù„Ø³Ø¤Ø§Ù„');
            }
        };



        async function loadGameQuestions(subject, qType, maxQuestions) {
            try {
                const q = query(
                    collection(db, "questions"),
                    where("grade", "==", userData.grade),
                    where("subject", "==", subject),
                    where("type", "==", qType),
                    limit(50)
                );
                
                const snap = await getDocs(q);
                gameQuestions = [];
                
                snap.forEach(doc => {
                    gameQuestions.push({ id: doc.id, ...doc.data() });
                });
                
                if (gameQuestions.length < maxQuestions) {
                    showBeautifulAlert('warning', 'ØªØ­Ø°ÙŠØ±', `Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© ÙƒØ§ÙÙŠØ© ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (${gameQuestions.length} ÙÙ‚Ø·)`);
                    maxQuestions = Math.min(gameQuestions.length, 5);
                }
                
                gameQuestions = shuffleArray(gameQuestions).slice(0, maxQuestions);
                currentQuestionIndex = 0;
                myScore = 0;
                opponentScore = 0;
                playerAnswers = [];
                opponentAnswers = [];
                isGameActive = true;
                
            } catch (error) {
                console.error("Error loading questions:", error);
                showBeautifulAlert('error', 'Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©');
                cancelSearch();
            }
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function startGame() {
            if (!isGameActive || gameQuestions.length === 0) {
                showBeautifulAlert('error', 'Ø®Ø·Ø£', 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© Ù…ØªØ§Ø­Ø©');
                return;
            }
            
            document.getElementById('game-overlay').classList.remove('hidden');
            
            document.getElementById('game-p1-img').src = userData.photo;
            document.getElementById('p1-name').textContent = userData.name;
            document.getElementById('game-my-score').textContent = myScore;
            
            document.getElementById('game-p2-img').src = opponentData?.photo || 'https://ui-avatars.com/api/?name=Opponent';
            document.getElementById('p2-name').textContent = opponentData?.name || 'Ø§Ù„Ø®ØµÙ…';
            document.getElementById('game-op-score').textContent = opponentScore;
            
            const withdrawBtn = document.getElementById('withdraw-game-btn');
            withdrawBtn.classList.remove('hidden');
            withdrawBtn.onclick = withdrawFromGame;
            
            showNextQuestion();
        }

        function showNextQuestion() {
            if (!isGameActive || currentQuestionIndex >= gameQuestions.length) {
                endGame();
                return;
            }
            
            const question = gameQuestions[currentQuestionIndex];
            
            document.getElementById('q-progress').textContent = `${currentQuestionIndex + 1} / ${gameQuestions.length}`;
            document.getElementById('q-text').textContent = question.question;
            
            const answersContainer = document.getElementById('answers-container');
            answersContainer.innerHTML = '';
            
            document.getElementById('waiting-msg').classList.add('hidden');
            document.getElementById('ai-thinking-msg').classList.add('hidden');
            
            if (question.type === 'mcq') {
                question.answers.forEach((answer, index) => {
                    const btn = document.createElement('button');
                    btn.className = 'w-full bg-white border-2 border-gray-200 rounded-xl p-4 text-right font-bold text-gray-700 hover:bg-gray-50 transition answer-neutral';
                    btn.textContent = answer;
                    btn.onclick = () => selectAnswer(index);
                    answersContainer.appendChild(btn);
                });
            } else {
                const trueBtn = document.createElement('button');
                trueBtn.className = 'w-full bg-white border-2 border-gray-200 rounded-xl p-4 text-right font-bold text-gray-700 hover:bg-gray-50 transition answer-neutral';
                trueBtn.textContent = 'ØµØ­';
                trueBtn.onclick = () => selectAnswer(true);
                answersContainer.appendChild(trueBtn);
                
                const falseBtn = document.createElement('button');
                falseBtn.className = 'w-full bg-white border-2 border-gray-200 rounded-xl p-4 text-right font-bold text-gray-700 hover:bg-gray-50 transition answer-neutral';
                falseBtn.textContent = 'Ø®Ø·Ø£';
                falseBtn.onclick = () => selectAnswer(false);
                answersContainer.appendChild(falseBtn);
            }
            
            startTimer();
            
            if (gameType === 'ai' && isGameActive) {
                setTimeout(() => {
                    if (isGameActive) {
                        document.getElementById('ai-thinking-msg').classList.remove('hidden');
                        setTimeout(() => {
                            if (isGameActive) {
                                const aiAnswer = generateAIAnswer(question);
                                opponentAnswers.push({
                                    questionIndex: currentQuestionIndex,
                                    answer: aiAnswer,
                                    isCorrect: aiAnswer === question.correct
                                });
                                
                                if (aiAnswer === question.correct) {
                                    opponentScore++;
                                    document.getElementById('game-op-score').textContent = opponentScore;
                                }
                            }
                        }, 1000 + Math.random() * 2000);
                    }
                }, 1000);
            }
        }

        function startTimer() {
            currentGameTimer = 15;
            document.getElementById('game-timer').textContent = currentGameTimer;
            
            if (gameTimerInterval) clearInterval(gameTimerInterval);
            
            gameTimerInterval = setInterval(() => {
                currentGameTimer--;
                document.getElementById('game-timer').textContent = currentGameTimer;
                
                if (currentGameTimer <= 0) {
                    clearInterval(gameTimerInterval);
                    if (isGameActive) {
                        playerAnswers.push({
                            questionIndex: currentQuestionIndex,
                            answer: null,
                            isCorrect: false
                        });
                        
                        if (gameType === 'online') {
                            document.getElementById('waiting-msg').classList.remove('hidden');
                        }
                        
                        currentQuestionIndex++;
                        setTimeout(() => {
                            if (isGameActive) {
                                showNextQuestion();
                            }
                        }, 2000);
                    }
                }
            }, 1000);
        }

        function selectAnswer(answer) {
            if (!isGameActive) return;
            
            clearInterval(gameTimerInterval);
            
            const question = gameQuestions[currentQuestionIndex];
            const isCorrect = answer === question.correct;
            
            playerAnswers.push({
                questionIndex: currentQuestionIndex,
                answer: answer,
                isCorrect: isCorrect
            });
            
            if (isCorrect) {
                myScore++;
                document.getElementById('game-my-score').textContent = myScore;
            }
            
            const answersContainer = document.getElementById('answers-container');
            const buttons = answersContainer.querySelectorAll('button');
            
            if (question.type === 'mcq') {
                buttons.forEach((btn, index) => {
                    if (index === question.correct) {
                        btn.classList.remove('answer-neutral');
                        btn.classList.add('answer-correct');
                    } else if (index === answer && !isCorrect) {
                        btn.classList.remove('answer-neutral');
                        btn.classList.add('answer-wrong');
                    }
                });
            } else {
                buttons.forEach(btn => {
                    if ((btn.textContent === 'ØµØ­' && question.correct === true) || 
                        (btn.textContent === 'Ø®Ø·Ø£' && question.correct === false)) {
                        btn.classList.remove('answer-neutral');
                        btn.classList.add('answer-correct');
                    } else if ((btn.textContent === 'ØµØ­' && answer === true && !isCorrect) || 
                               (btn.textContent === 'Ø®Ø·Ø£' && answer === false && !isCorrect)) {
                        btn.classList.remove('answer-neutral');
                        btn.classList.add('answer-wrong');
                    }
                });
            }
            
            if (gameType === 'online') {
                document.getElementById('waiting-msg').classList.remove('hidden');
            }
            
            currentQuestionIndex++;
            setTimeout(() => {
                if (isGameActive) {
                    showNextQuestion();
                }
            }, 2000);
        }

        function generateAIAnswer(question) {
            if (question.type === 'mcq') {
                return Math.floor(Math.random() * 3);
            } else {
                return Math.random() > 0.5;
            }
        }

        async function endGame() {
            isGameActive = false;
            clearInterval(gameTimerInterval);
            
            document.getElementById('game-overlay').classList.add('hidden');
            
            const finalMyScore = document.getElementById('final-my-score');
            const finalOpScore = document.getElementById('final-op-score');
            const finalOpName = document.getElementById('final-op-name');
            const resultTitle = document.getElementById('result-title');
            const resultMsg = document.getElementById('result-msg');
            const resultIcon = document.getElementById('result-icon-container');
            const resultPoints = document.getElementById('result-points-gained-text');
            
            finalMyScore.textContent = myScore;
            finalOpScore.textContent = opponentScore;
            finalOpName.textContent = opponentData?.name || 'Ø§Ù„Ø®ØµÙ…';
            
            let pointsGained = 0;
            let pointsMultiplier = userData.isPremium && isPremiumValid(userData) ? 2 : 1;
            
            if (myScore > opponentScore) {
                resultTitle.textContent = 'ğŸ‰ Ø§Ù†ØªØµØ±Øª!';
                resultMsg.textContent = 'Ø£Ø­Ø³Ù†Øª! Ù„Ù‚Ø¯ ÙØ²Øª ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ØªØ­Ø¯ÙŠ';
                resultIcon.textContent = 'ğŸ†';
                pointsGained = myScore * 2 * pointsMultiplier;
            } else if (myScore < opponentScore) {
                resultTitle.textContent = 'ğŸ’” Ø®Ø³Ø±Øª';
                resultMsg.textContent = 'Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ ÙÙŠ Ø§Ù„Ù…Ø±Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©';
                resultIcon.textContent = 'ğŸ˜¢';
                pointsGained = -Math.floor(opponentScore * 0.5);
            } else {
                resultTitle.textContent = 'ğŸ¤ ØªØ¹Ø§Ø¯Ù„';
                resultMsg.textContent = 'Ù†ØªÙŠØ¬Ø© Ù…ØªÙƒØ§ÙØ¦Ø© Ø¨ÙŠÙ† Ø§Ù„Ø·Ø±ÙÙŠÙ†';
                resultIcon.textContent = 'âš–ï¸';
                if (myScore > 0) {
                    pointsGained = myScore * 1 * pointsMultiplier;
                }
            }
            
            if (pointsGained > 0) {
                resultPoints.textContent = `+${pointsGained}`;
                resultPoints.parentElement.style.background = 'linear-gradient(135deg, #fef3c7 0%, #fbbf24 100%)';
            } else if (pointsGained < 0) {
                resultPoints.textContent = `${pointsGained}`;
                resultPoints.parentElement.style.background = 'linear-gradient(135deg, #fee2e2 0%, #f87171 100%)';
            } else {
                resultPoints.textContent = '+0';
                resultPoints.parentElement.style.background = 'linear-gradient(135deg, #f1f5f9 0%, #cbd5e1 100%)';
            }
            
            await updateUserPoints(pointsGained);
            
            if (gameType === 'online' && opponentId && opponentId !== 'ai') {
                const opponentPoints = opponentScore > myScore ? opponentScore * 2 : 
                                     opponentScore < myScore ? -Math.floor(myScore * 0.5) :
                                     opponentScore > 0 ? opponentScore * 1 : 0;
                
                if (opponentPoints !== 0) {
                    await updateDoc(doc(db, "users", opponentId), {
                        points: increment(opponentPoints)
                    });
                }
            }
            
            if (gameId) {
                await deleteDoc(doc(db, "matchmaking", gameId));
                gameId = null;
            }
            
            document.getElementById('result-screen').classList.remove('hidden');
        }

        async function updateUserPoints(points) {
            const newPoints = (userData.points || 0) + points;
            
            await updateDoc(doc(db, "users", currentUser.uid), {
                points: increment(points)
            });
            
            userData.points = newPoints;
            setupHeaderUI();
            
            if (newPoints <= -10) {
                showBeautifulAlert('error', 'Ù…Ø­Ø¸ÙˆØ± Ù…Ù† Ø§Ù„Ù„Ø¹Ø¨', 'âŒ Ù†Ù‚Ø§Ø·Ùƒ Ø£ØµØ¨Ø­Øª Ø³Ø§Ù„Ø¨Ø© -10 Ø£Ùˆ Ø£Ù‚Ù„. ÙŠØ¬Ø¨ Ø±ÙØ¹ Ø£Ø³Ø¦Ù„Ø© ÙˆØ§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù†Ù‚Ø§Ø· Ø¥ÙŠØ¬Ø§Ø¨ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹.');
            }
        }

        window.withdrawFromGame = async function() {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø§Ù†Ø³Ø­Ø§Ø¨ØŸ Ø³ÙŠØªÙ… Ø®ØµÙ… 10 Ù†Ù‚Ø§Ø· ÙˆØ³ÙŠØ­ØµÙ„ Ø§Ù„Ø®ØµÙ… Ø¹Ù„Ù‰ 10 Ù†Ù‚Ø§Ø·.')) {
                return;
            }
            
            isGameActive = false;
            clearInterval(gameTimerInterval);
            
            await updateUserPoints(-10);
            
            if (gameType === 'online' && opponentId && opponentId !== 'ai') {
                await updateDoc(doc(db, "users", opponentId), {
                    points: increment(10)
                });
            }
            
            if (gameId) {
                await deleteDoc(doc(db, "matchmaking", gameId));
                gameId = null;
            }
            
            showBeautifulAlert('warning', 'Ø§Ù†Ø³Ø­Ø§Ø¨', 'Ù„Ù‚Ø¯ Ø§Ù†Ø³Ø­Ø¨Øª Ù…Ù† Ø§Ù„Ù„Ø¹Ø¨Ø© ÙˆØªÙ… Ø®ØµÙ… 10 Ù†Ù‚Ø§Ø· Ù…Ù†Ùƒ.');
            
            document.getElementById('game-overlay').classList.add('hidden');
            document.getElementById('searching-ui').classList.add('hidden');
            document.getElementById('challenge-active-card').classList.remove('hidden');
        };

        window.cancelSearch = function() {
            if (gameId) {
                deleteDoc(doc(db, "matchmaking", gameId));
                gameId = null;
            }
            
            document.getElementById('searching-ui').classList.add('hidden');
            document.getElementById('challenge-active-card').classList.remove('hidden');
        };

        window.closeResultScreen = function() {
            document.getElementById('result-screen').classList.add('hidden');
            document.getElementById('challenge-active-card').classList.remove('hidden');
        };

        window.openFriendChallenge = function() {
            document.getElementById('friend-challenge-modal').classList.remove('hidden');
        };

        window.closeFriendChallengeModal = function() {
            document.getElementById('friend-challenge-modal').classList.add('hidden');
        };

        window.openCreateRoomScreen = function() {
            document.getElementById('friend-challenge-modal').classList.add('hidden');
            openPage('screen-create-room');
            populateSubjectsForGrade(userData.grade);
        };

        window.openJoinRoomScreen = function() {
            document.getElementById('friend-challenge-modal').classList.add('hidden');
            openPage('screen-join-room');
        };

        window.backToChallenges = function() {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('tab-challenges').classList.add('active');
        };

        window.backToFriendChallenge = function() {
            openPage('screen-friend-challenge');
        };

        

        window.closeMaintenancePopup = function() {
            document.getElementById('maintenance-popup').classList.add('hidden');
        };

        window.openForgotPassword = function() {
            document.getElementById('forgot-password-modal').classList.remove('hidden');
        };

        window.closeForgotPassword = function() {
            document.getElementById('forgot-password-modal').classList.add('hidden');
        };

        window.sendResetLink = async function() {
            const email = document.getElementById('forgot-email').value.trim();
            
            if (!email) {
                showBeautifulAlert('warning', 'ØªÙ†Ø¨ÙŠÙ‡', 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ');
                return;
            }
            
            try {
                showAuthLoading('Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©...');
                
                setTimeout(() => {
                    hideAuthLoading();
                    showBeautifulAlert('success', 'ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„', 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø§Ø³ØªØ¹Ø§Ø¯Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¥Ù„Ù‰ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ');
                    closeForgotPassword();
                }, 2000);
                
            } catch (error) {
                hideAuthLoading();
                showBeautifulAlert('error', 'Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©');
            }
        };
        
        
// ====== Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø¹Ø¯Ù„ Ù…Ø¹ ØªØ­Ø³ÙŠÙ† Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ ======

// Ø¯Ø§Ù„Ø© Ù…Ø­Ø³Ù†Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø¨Ø§Ø¯Ø¬ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
async function updateNotificationBadge() {
    const badge = document.getElementById('notification-badge');
    if (!badge) {
        console.log("âŒ Ø¹Ù†ØµØ± Ø§Ù„Ø¨Ø§Ø¯Ø¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ DOM");
        return;
    }
    
    if (!currentUser || !currentUser.uid) {
        console.log("âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù… Ø­Ø§Ù„ÙŠØŒ Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¨Ø§Ø¯Ø¬");
        badge.classList.add('hidden');
        return;
    }
    
    console.log("ğŸ”„ Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« Ø¨Ø§Ø¯Ø¬ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…:", currentUser.uid);
    
    try {
        // Ø§Ø³ØªØ¹Ù„Ø§Ù… Ù…Ø¨Ø³Ø· Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
        const notificationsRef = collection(db, "notifications");
        
        // Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø¨Ø³ÙŠØ· Ø¨Ø¯ÙˆÙ† where Ù…ØªØ¹Ø¯Ø¯Ø© Ù„ØªØ¬Ù†Ø¨ Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„ÙÙ‡Ø±Ø³Ø©
        const q = query(
            notificationsRef,
            where("userId", "==", currentUser.uid)
            // Ø¥Ø²Ø§Ù„Ø© where("read", "==", false) Ù„ØªØ¬Ù†Ø¨ Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„ÙÙ‡Ø±Ø³Ø©
        );
        
        console.log("ğŸ“ ØªÙ†ÙÙŠØ° Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù…...");
        const querySnapshot = await getDocs(q);
        console.log("âœ… ØªÙ… ØªÙ†ÙÙŠØ° Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø¨Ù†Ø¬Ø§Ø­ØŒ Ø§Ù„Ù†ØªØ§Ø¦Ø¬:", querySnapshot.size);
        
        // Ø§Ù„ØªØµÙÙŠØ© Ù…Ø­Ù„ÙŠØ§Ù‹ ÙÙŠ Ø§Ù„Ø¬Ø§ÙØ§Ø³ÙƒØ±Ø¨Øª
        let unreadCount = 0;
        querySnapshot.forEach((doc) => {
            const data = doc.data();
            if (data.read === false) {
                unreadCount++;
            }
        });
        
        console.log("ğŸ“Š Ø¹Ø¯Ø¯ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ØºÙŠØ± Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡Ø©:", unreadCount);
        
        if (unreadCount > 0) {
            console.log("ğŸ”” ÙŠÙˆØ¬Ø¯ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ØºÙŠØ± Ù…Ù‚Ø±ÙˆØ¡Ø©");
            badge.classList.remove('hidden');
        } else {
            console.log("ğŸ“­ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ØºÙŠØ± Ù…Ù‚Ø±ÙˆØ¡Ø©");
            badge.classList.add('hidden');
        }
        
    } catch (error) {
        console.error("âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø¨Ø§Ø¯Ø¬ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª:", error);
        console.error("ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø®Ø·Ø£:", error.message);
        console.error("ÙƒÙˆØ¯ Ø§Ù„Ø®Ø·Ø£:", error.code);
        
        // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¨Ø§Ø¯Ø¬ ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£
        badge.classList.add('hidden');
        
        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ®Ø¯Ø§Ù… localStorage ÙƒØ¨Ø¯ÙŠÙ„
        try {
            const localNotifications = JSON.parse(localStorage.getItem('local_notifications') || '[]');
            const unread = localNotifications.filter(n => 
                n.userId === currentUser.uid && n.read === false
            ).length;
            
            if (unread > 0) {
                badge.classList.remove('hidden');
            }
        } catch (localError) {
            console.log("âŒ ÙØ´Ù„ Ø§Ø³ØªØ®Ø¯Ø§Ù… localStorage Ø£ÙŠØ¶Ù‹Ø§");
        }
    }
}

// Ø¯Ø§Ù„Ø© Ù…Ø­Ø³Ù†Ø© Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
async function loadNotifications() {
    const list = document.getElementById('notifications-list');
    if (!list) {
        console.error("âŒ Ø¹Ù†ØµØ± Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");
        return;
    }
    
    console.log("ğŸ”„ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª...");
    
    try {
        // Ø¥Ø¸Ù‡Ø§Ø± Ø­Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
        list.innerHTML = `
            <div class="text-center py-10">
                <div class="w-12 h-12 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin mb-3 mx-auto"></div>
                <p class="text-gray-500 font-bold">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª...</p>
            </div>
        `;
        
        if (!currentUser || !currentUser.uid) {
            list.innerHTML = `
                <div class="text-center py-10">
                    <i class="fas fa-user-slash text-4xl text-gray-400 mb-4"></i>
                    <p class="font-bold text-lg mb-2 text-gray-700">ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹</p>
                    <p class="text-gray-500 text-sm">Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ø¹Ø±Ø¶ Ø¥Ø´Ø¹Ø§Ø±Ø§ØªÙƒ</p>
                </div>
            `;
            return;
        }
        
        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù…Ù† Firebase
        try {
            const notificationsRef = collection(db, "notifications");
            const q = query(
                notificationsRef,
                where("userId", "==", currentUser.uid)
            );
            
            console.log("ğŸ“ Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù…Ù† Firebase...");
            const querySnapshot = await getDocs(q);
            console.log("âœ… ØªÙ… Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¨Ù†Ø¬Ø§Ø­ØŒ Ø§Ù„Ø¹Ø¯Ø¯:", querySnapshot.size);
            
            if (querySnapshot.empty) {
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† localStorage ÙƒØ¨Ø¯ÙŠÙ„
                await loadNotificationsFromLocalStorage(list);
                return;
            }
            
            let notifications = [];
            querySnapshot.forEach((doc) => {
                notifications.push({
                    id: doc.id,
                    ...doc.data()
                });
            });
            
            // Ø§Ù„ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ® (Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹)
            notifications.sort((a, b) => {
                const timeA = a.createdAt?.toDate?.() || new Date(0);
                const timeB = b.createdAt?.toDate?.() || new Date(0);
                return timeB - timeA;
            });
            
            displayNotificationsList(notifications, list);
            
            // Ø­ÙØ¸ Ù†Ø³Ø®Ø© ÙÙŠ localStorage Ù„Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ
            saveNotificationsToLocalStorage(notifications);
            
        } catch (firebaseError) {
            console.error("âŒ Ø®Ø·Ø£ ÙÙŠ FirebaseØŒ Ø¬Ø±Ø¨ localStorage:", firebaseError);
            await loadNotificationsFromLocalStorage(list);
        }
        
    } catch (error) {
        console.error("âŒ Ø®Ø·Ø£ Ø¹Ø§Ù… ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª:", error);
        list.innerHTML = getErrorHTML("Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹", error.message);
    }
}

// Ø¯Ø§Ù„Ø© Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù…Ù† localStorage
async function loadNotificationsFromLocalStorage(list) {
    try {
        const localNotifications = JSON.parse(localStorage.getItem('local_notifications') || '[]');
        const userNotifications = localNotifications.filter(n => 
            n.userId === currentUser?.uid
        ).sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
        
        if (userNotifications.length === 0) {
            list.innerHTML = getEmptyNotificationsHTML();
            return;
        }
        
        displayNotificationsList(userNotifications, list);
        
    } catch (error) {
        console.error("âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù…Ù† localStorage:", error);
        list.innerHTML = getEmptyNotificationsHTML();
    }
}

// Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
function displayNotificationsList(notifications, container) {
    if (notifications.length === 0) {
        container.innerHTML = getEmptyNotificationsHTML();
        return;
    }
    
    let html = `
        <div class="mb-4 p-3 bg-blue-50 rounded-xl border border-blue-100">
            <div class="flex justify-between items-center">
                <div>
                    <p class="font-bold text-blue-700 text-sm">Ø¹Ø¯Ø¯ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª: ${notifications.length}</p>
                    <p class="text-xs text-blue-500">(Ù…Ù† Ø§Ù„Ø£Ø­Ø¯Ø« Ù„Ù„Ø£Ù‚Ø¯Ù…)</p>
                </div>
                <button onclick="markAllNotificationsAsRead()" class="bg-blue-100 text-blue-600 px-3 py-1 rounded-lg text-xs font-bold hover:bg-blue-200">
                    ğŸ“Œ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„ ÙƒÙ…Ù‚Ø±ÙˆØ¡
                </button>
            </div>
        </div>
    `;
    
    notifications.forEach((notification, index) => {
        const timeAgo = getTimeAgo(notification.createdAt?.toDate?.() || new Date(notification.createdAt));
        const type = notification.type || 'system';
        const isUnread = notification.read === false;
        
        html += `
            <div class="notification-item ${isUnread ? 'unread' : 'read'} ${index === 0 ? 'border-l-4 border-l-blue-500' : ''}">
                ${isUnread ? '<div class="notification-dot"></div>' : ''}
                <div class="flex items-start">
                    <div class="notification-type-icon ${getNotificationIconClass(type)}">
                        <i class="${getNotificationIcon(type)}"></i>
                    </div>
                    <div class="flex-1">
                        <div class="notification-header">
                            <h3 class="notification-title">${notification.title || 'Ø¥Ø´Ø¹Ø§Ø± Ø¬Ø¯ÙŠØ¯'}</h3>
                            <span class="notification-time">${timeAgo}</span>
                        </div>
                        <p class="notification-message">${notification.message || 'Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙØ§ØµÙŠÙ„'}</p>
                        ${notification.data ? 
                            `<div class="mt-2 p-2 bg-gray-50 rounded text-xs text-gray-600">
                                ${JSON.stringify(notification.data, null, 2)}
                            </div>` 
                            : ''}
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// Ø¯Ø§Ù„Ø© Ù„Ø­ÙØ¸ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙÙŠ localStorage
function saveNotificationsToLocalStorage(notifications) {
    try {
        const existing = JSON.parse(localStorage.getItem('local_notifications') || '[]');
        
        // Ø¯Ù…Ø¬ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙˆØªØ¬Ù†Ø¨ Ø§Ù„ØªÙƒØ±Ø§Ø±
        const merged = [...existing];
        notifications.forEach(newNotif => {
            if (!merged.some(existingNotif => existingNotif.id === newNotif.id)) {
                merged.push(newNotif);
            }
        });
        
        // Ø­ÙØ¸ Ø¢Ø®Ø± 50 Ø¥Ø´Ø¹Ø§Ø± ÙÙ‚Ø·
        const toSave = merged.slice(-50);
        localStorage.setItem('local_notifications', JSON.stringify(toSave));
        
    } catch (error) {
        console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙÙŠ localStorage:", error);
    }
}

// Ø¯ÙˆØ§Ù„ HTML Ù…Ø³Ø§Ø¹Ø¯Ø©
function getEmptyNotificationsHTML() {
    return `
        <div class="empty-notifications">
            <i class="fas fa-bell-slash text-5xl mb-4 text-gray-300"></i>
            <p class="font-bold text-xl mb-2 text-gray-600">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</p>
            <p class="text-gray-400 text-sm">Ø¹Ù†Ø¯Ù…Ø§ ØªØªÙ„Ù‚Ù‰ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©ØŒ Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§</p>
            <div class="mt-6 p-3 bg-yellow-50 rounded-lg border border-yellow-100">
                <p class="text-xs text-yellow-700">ğŸ’¡ ØªÙ„Ù…ÙŠØ­: Ø³ØªØ¸Ù‡Ø± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¨Ø¹Ø¯:</p>
                <ul class="text-xs text-yellow-600 mt-1 pr-2">
                    <li>â€¢ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ø¨Ø§Ø±ÙŠØ§Øª (ÙÙˆØ²/Ø®Ø³Ø§Ø±Ø©/ØªØ¹Ø§Ø¯Ù„)</li>
                    <li>â€¢ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¬ÙˆØ§Ø¦Ø² Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©</li>
                    <li>â€¢ ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ù‡Ù…Ø©</li>
                </ul>
            </div>
        </div>
    `;
}

function getErrorHTML(title, message) {
    return `
        <div class="text-center py-10">
            <i class="fas fa-exclamation-triangle text-5xl text-red-400 mb-4"></i>
            <p class="font-bold text-xl mb-2 text-red-600">${title}</p>
            <p class="text-gray-500 text-sm mb-4">${message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</p>
            <div class="flex gap-2 justify-center">
                <button onclick="loadNotifications()" class="bg-indigo-100 text-indigo-600 px-4 py-2 rounded-lg text-sm font-bold hover:bg-indigo-200">
                    <i class="fas fa-redo ml-1"></i> Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
                </button>
                <button onclick="clearNotificationCache()" class="bg-gray-100 text-gray-600 px-4 py-2 rounded-lg text-sm font-bold hover:bg-gray-200">
                    <i class="fas fa-trash ml-1"></i> Ù…Ø³Ø­ Ø§Ù„ÙƒØ§Ø´
                </button>
            </div>
        </div>
    `;
}

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø­ Ø§Ù„ÙƒØ§Ø´
window.clearNotificationCache = function() {
    try {
        localStorage.removeItem('local_notifications');
        showBeautifulAlert('success', 'ØªÙ… Ø§Ù„Ù…Ø³Ø­', 'ØªÙ… Ù…Ø³Ø­ Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø¤Ù‚ØªØ©');
        loadNotifications();
    } catch (error) {
        showBeautifulAlert('error', 'Ø®Ø·Ø£', 'ÙØ´Ù„ Ù…Ø³Ø­ Ø§Ù„ÙƒØ§Ø´');
    }
};

// ====== Ø¯ÙˆØ§Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ======

// Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø£Ø³Ø¨ÙˆØ¹ÙŠ
async function sendWeeklyNotification(userId, userName, rank, prizeAmount) {
    try {
        if (!userId) {
            console.log("âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø¨Ø¯ÙˆÙ† Ù…Ø¹Ø±Ù Ù…Ø³ØªØ®Ø¯Ù…");
            return;
        }
        
        let title = "ğŸ‰ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¬ÙˆØ§Ø¦Ø² Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©";
        let message = `Ù…Ø±Ø­Ø¨Ø§Ù‹ ${userName || 'ØµØ¯ÙŠÙ‚ÙŠ'}ØŒ `;
        
        if (rank <= 10 && prizeAmount > 0) {
            message += `Ù…Ø¨Ø±ÙˆÙƒ! Ù„Ù‚Ø¯ Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ ÙˆØ£Ù†Øª ÙÙŠ Ø§Ù„Ù…Ø±ÙƒØ² ${rank} ğŸ†\nÙ„Ù‚Ø¯ Ø±Ø¨Ø­Øª ${prizeAmount}$ Ù…Ù† Ø§Ù„Ø¬ÙˆØ§Ø¦Ø² Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©.\nÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„ÙŠÙ‡Ø§ ÙÙŠ Ù‚Ø³Ù… Ø£Ù…ÙˆØ§Ù„ÙŠ.`;
        } else if (rank === 999) {
            message += `Ù„Ù„Ø£Ø³ÙØŒ Ù„Ù… ØªØ±Ø¨Ø­ Ù…Ø¹Ù†Ø§ Ù…Ù† Ø§Ù„Ø¬ÙˆØ§Ø¦Ø² Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ© Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø±Ø©.\nÙ„Ù… ØªÙƒÙ† Ø¶Ù…Ù† Ø§Ù„Ù…Ø±Ø§ÙƒØ² Ø§Ù„Ø¹Ø´Ø±Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ ÙÙŠ Ø§Ù„ØªØµÙ†ÙŠÙ.\nØ­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ù‚Ø§Ø¯Ù…! ğŸ’ª`;
        } else {
            message += `ØªÙ… ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¬ÙˆØ§Ø¦Ø² Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©.\nØ£Ù†Øª ÙÙŠ Ø§Ù„Ù…Ø±ÙƒØ² ${rank}.\nØ­Ø§ÙˆÙ„ ØªØ­Ø³ÙŠÙ† Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ù‚Ø§Ø¯Ù…!`;
        }
        
        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¥Ù„Ù‰ Firebase
        try {
            await addDoc(collection(db, "notifications"), {
                userId: userId,
                title: title,
                message: message,
                type: 'weekly',
                read: false,
                createdAt: serverTimestamp(),
                data: { rank, prizeAmount, userName }
            });
            console.log("âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ Ø¥Ù„Ù‰ Firebase");
        } catch (firebaseError) {
            console.error("âŒ ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø¥Ù„Ù‰ FirebaseØŒ Ø¬Ø±Ø¨ localStorage:", firebaseError);
            
            // Ø­ÙØ¸ ÙÙŠ localStorage ÙƒØ¨Ø¯ÙŠÙ„
            const localNotification = {
                id: 'weekly_' + Date.now(),
                userId: userId,
                title: title,
                message: message,
                type: 'weekly',
                read: false,
                createdAt: new Date().toISOString(),
                data: { rank, prizeAmount, userName }
            };
            
            saveNotificationToLocalStorage(localNotification);
        }
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨Ø§Ø¯Ø¬ Ø¨Ø¹Ø¯ 2 Ø«Ø§Ù†ÙŠØ©
        setTimeout(() => {
            if (userId === currentUser?.uid) {
                updateNotificationBadge();
            }
        }, 2000);
        
    } catch (error) {
        console.error("âŒ Ø®Ø·Ø£ Ø¹Ø§Ù… ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ:", error);
    }
}

// Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù…Ø¨Ø§Ø±Ø§Ø©
async function sendGameNotification(userId, result, opponentName, pointsGained, isAI = false, isRoom = false) {
    try {
        if (!userId) {
            console.log("âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù…Ø¨Ø§Ø±Ø§Ø© Ø¨Ø¯ÙˆÙ† Ù…Ø¹Ø±Ù Ù…Ø³ØªØ®Ø¯Ù…");
            return;
        }
        
        let title, message, type;
        
        if (pointsGained > 0) {
            title = "ğŸ‰ ÙÙˆØ² Ø±Ø§Ø¦Ø¹!";
            message = `Ù…Ø¨Ø±ÙˆÙƒ! Ù„Ù‚Ø¯ ÙØ²Øª ÙÙŠ Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø© ${isAI ? 'Ø¶Ø¯ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ' : isRoom ? 'Ø¶Ø¯ ØµØ¯ÙŠÙ‚Ùƒ' : 'Ø¶Ø¯ Ù„Ø§Ø¹Ø¨ Ø­Ù‚ÙŠÙ‚ÙŠ'}\n`;
            message += `Ø§Ù„Ù†ØªÙŠØ¬Ø©: ${result}\n`;
            message += `Ø±Ø¨Ø­Øª ${pointsGained} Ù†Ù‚Ø·Ø© Ø¬Ø¯ÙŠØ¯Ø©!`;
            type = 'win';
        } else if (pointsGained < 0) {
            title = "ğŸ’” Ø®Ø³Ø§Ø±Ø© Ù…Ø¤Ù‚ØªØ©";
            message = `Ù„Ù„Ø£Ø³ÙØŒ Ù„Ù‚Ø¯ Ø®Ø³Ø±Øª ÙÙŠ Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø© ${isAI ? 'Ø¶Ø¯ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ' : isRoom ? 'Ø¶Ø¯ ØµØ¯ÙŠÙ‚Ùƒ' : 'Ø¶Ø¯ Ù„Ø§Ø¹Ø¨ Ø­Ù‚ÙŠÙ‚ÙŠ'}\n`;
            message += `Ø§Ù„Ù†ØªÙŠØ¬Ø©: ${result}\n`;
            message += `Ø®Ø³Ø±Øª ${Math.abs(pointsGained)} Ù†Ù‚Ø·Ø©. Ù„Ø§ ØªØ³ØªØ³Ù„Ù… ÙˆØ­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰!`;
            type = 'loss';
        } else {
            title = "âš–ï¸ ØªØ¹Ø§Ø¯Ù„ Ù…Ø«ÙŠØ±Ø©";
            message = `ØªØ¹Ø§Ø¯Ù„ Ù…Ø«ÙŠØ±! Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø© ${isAI ? 'Ø¶Ø¯ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ' : isRoom ? 'Ø¶Ø¯ ØµØ¯ÙŠÙ‚Ùƒ' : 'Ø¶Ø¯ Ù„Ø§Ø¹Ø¨ Ø­Ù‚ÙŠÙ‚ÙŠ'} Ø¨Ø§Ù„ØªØ¹Ø§Ø¯Ù„\n`;
            message += `Ø§Ù„Ù†ØªÙŠØ¬Ø©: ${result}\n`;
            message += `Ù„ÙƒÙ„ Ù„Ø§Ø¹Ø¨ Ù†ÙØ³ Ø§Ù„Ù†Ù‚Ø§Ø·!`;
            type = 'draw';
        }
        
        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¥Ù„Ù‰ Firebase
        try {
            await addDoc(collection(db, "notifications"), {
                userId: userId,
                title: title,
                message: message,
                type: 'game',
                gameType: type,
                read: false,
                createdAt: serverTimestamp(),
                data: { result, opponentName, pointsGained, isAI, isRoom }
            });
            console.log("âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø© Ø¥Ù„Ù‰ Firebase");
        } catch (firebaseError) {
            console.error("âŒ ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø¥Ù„Ù‰ FirebaseØŒ Ø¬Ø±Ø¨ localStorage:", firebaseError);
            
            // Ø­ÙØ¸ ÙÙŠ localStorage ÙƒØ¨Ø¯ÙŠÙ„
            const localNotification = {
                id: 'game_' + Date.now(),
                userId: userId,
                title: title,
                message: message,
                type: 'game',
                gameType: type,
                read: false,
                createdAt: new Date().toISOString(),
                data: { result, opponentName, pointsGained, isAI, isRoom }
            };
            
            saveNotificationToLocalStorage(localNotification);
        }
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨Ø§Ø¯Ø¬
        setTimeout(() => {
            if (userId === currentUser?.uid) {
                updateNotificationBadge();
            }
        }, 2000);
        
    } catch (error) {
        console.error("âŒ Ø®Ø·Ø£ Ø¹Ø§Ù… ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø©:", error);
    }
}

// Ø¯Ø§Ù„Ø© Ù„Ø­ÙØ¸ Ø¥Ø´Ø¹Ø§Ø± ÙˆØ§Ø­Ø¯ ÙÙŠ localStorage
function saveNotificationToLocalStorage(notification) {
    try {
        const existing = JSON.parse(localStorage.getItem('local_notifications') || '[]');
        
        // ØªØ¬Ù†Ø¨ Ø§Ù„ØªÙƒØ±Ø§Ø±
        if (!existing.some(n => n.id === notification.id)) {
            existing.push(notification);
            
            // Ø­ÙØ¸ Ø¢Ø®Ø± 50 Ø¥Ø´Ø¹Ø§Ø± ÙÙ‚Ø·
            const toSave = existing.slice(-50);
            localStorage.setItem('local_notifications', JSON.stringify(toSave));
            
            console.log("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± ÙÙŠ localStorage");
        }
    } catch (error) {
        console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± ÙÙŠ localStorage:", error);
    }
}

// ====== Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ======

window.openNotificationsScreen = function() {
    openPage('screen-notifications');
    
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¨Ø¹Ø¯ ØªØ£Ø®ÙŠØ± Ø¨Ø³ÙŠØ·
    setTimeout(() => {
        loadNotifications();
        markNotificationsAsRead();
    }, 300);
};

async function markNotificationsAsRead() {
    try {
        if (!currentUser || !currentUser.uid) {
            console.log("âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù… Ø­Ø§Ù„ÙŠ Ù„ØªØ­Ø¯ÙŠØ« Ø¥Ø´Ø¹Ø§Ø±Ø§ØªÙ‡");
            return;
        }
        
        // ØªØ­Ø¯ÙŠØ« ÙÙŠ Firebase
        try {
            const q = query(
                collection(db, "notifications"),
                where("userId", "==", currentUser.uid),
                where("read", "==", false)
            );
            
            const snap = await getDocs(q);
            if (!snap.empty) {
                const batch = writeBatch(db);
                snap.forEach(doc => {
                    batch.update(doc.ref, { 
                        read: true, 
                        readAt: serverTimestamp() 
                    });
                });
                await batch.commit();
                console.log("âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙÙŠ Firebase");
            }
        } catch (firebaseError) {
            console.error("âŒ ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Firebase:", firebaseError);
        }
        
        // ØªØ­Ø¯ÙŠØ« ÙÙŠ localStorage
        try {
            const localNotifications = JSON.parse(localStorage.getItem('local_notifications') || '[]');
            const updated = localNotifications.map(n => 
                n.userId === currentUser.uid && n.read === false 
                    ? { ...n, read: true } 
                    : n
            );
            
            localStorage.setItem('local_notifications', JSON.stringify(updated));
            console.log("âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙÙŠ localStorage");
        } catch (localError) {
            console.error("âŒ ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« localStorage:", localError);
        }
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨Ø§Ø¯Ø¬
        updateNotificationBadge();
        
    } catch (error) {
        console.error("âŒ Ø®Ø·Ø£ Ø¹Ø§Ù… ÙÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙƒÙ…Ù‚Ø±ÙˆØ¡Ø©:", error);
    }
}

window.markAllNotificationsAsRead = async function() {
    try {
        if (!currentUser || !currentUser.uid) {
            showBeautifulAlert('error', 'Ø®Ø·Ø£', 'ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹');
            return;
        }
        
        // ØªØ­Ø¯ÙŠØ« ÙÙŠ Firebase
        try {
            const q = query(
                collection(db, "notifications"),
                where("userId", "==", currentUser.uid),
                where("read", "==", false)
            );
            
            const snap = await getDocs(q);
            if (!snap.empty) {
                const batch = writeBatch(db);
                snap.forEach(doc => {
                    batch.update(doc.ref, { 
                        read: true, 
                        readAt: serverTimestamp() 
                    });
                });
                await batch.commit();
            }
        } catch (firebaseError) {
            console.error("âŒ ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Firebase:", firebaseError);
        }
        
        // ØªØ­Ø¯ÙŠØ« ÙÙŠ localStorage
        try {
            const localNotifications = JSON.parse(localStorage.getItem('local_notifications') || '[]');
            const updated = localNotifications.map(n => 
                n.userId === currentUser.uid 
                    ? { ...n, read: true } 
                    : n
            );
            
            localStorage.setItem('local_notifications', JSON.stringify(updated));
        } catch (localError) {
            console.error("âŒ ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« localStorage:", localError);
        }
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨Ø§Ø¯Ø¬ ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
        updateNotificationBadge();
        loadNotifications();
        
        showBeautifulAlert('success', 'ØªÙ…', 'ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙƒÙ…Ù‚Ø±ÙˆØ¡Ø© âœ…');
        
    } catch (error) {
        console.error("âŒ Ø®Ø·Ø£ Ø¹Ø§Ù…:", error);
        showBeautifulAlert('error', 'Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª');
    }
};

// ====== Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© ======

function getTimeAgo(date) {
    if (!date) return 'Ù…Ù†Ø° Ù‚Ù„ÙŠÙ„';
    
    const now = new Date();
    const diff = now - date;
    const seconds = Math.floor(diff / 1000);
    const minutes = Math.floor(seconds / 60);
    const hours = Math.floor(minutes / 60);
    const days = Math.floor(hours / 24);
    
    if (seconds < 60) return 'Ø§Ù„Ø¢Ù†';
    if (minutes < 60) return `Ù…Ù†Ø° ${minutes} Ø¯Ù‚ÙŠÙ‚Ø©`;
    if (hours < 24) return `Ù…Ù†Ø° ${hours} Ø³Ø§Ø¹Ø©`;
    if (days < 7) return `Ù…Ù†Ø° ${days} ÙŠÙˆÙ…`;
    if (days < 30) return `Ù…Ù†Ø° ${Math.floor(days / 7)} Ø£Ø³Ø¨ÙˆØ¹`;
    
    return date.toLocaleDateString('ar-EG', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

function getNotificationIcon(type) {
    switch(type) {
        case 'weekly': return 'fas fa-trophy';
        case 'game': return 'fas fa-gamepad';
        case 'win': return 'fas fa-trophy';
        case 'loss': return 'fas fa-times-circle';
        case 'draw': return 'fas fa-balance-scale';
        case 'system': return 'fas fa-cog';
        case 'friend': return 'fas fa-user-friends';
        default: return 'fas fa-bell';
    }
}

function getNotificationIconClass(type) {
    switch(type) {
        case 'weekly': return 'trophy';
        case 'game': return 'game';
        case 'win': return 'trophy';
        case 'loss': return 'system';
        case 'draw': return 'game';
        case 'system': return 'system';
        case 'friend': return 'friend';
        default: return 'system';
    }
}

// ====== ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù… ======

// ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨Ø§Ø¯Ø¬ ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚Ø©
setInterval(() => {
    if (currentUser && document.getElementById('notification-badge')) {
        updateNotificationBadge();
    }
}, 60000);

// ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨Ø§Ø¯Ø¬ Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª
document.addEventListener('visibilitychange', function() {
    if (!document.hidden && currentUser) {
        setTimeout(updateNotificationBadge, 1000);
    }
});

// ============================================
// Ù†Ø¸Ø§Ù… Ø§Ù„ØºØ±Ù - Friend Challenge System
// ============================================

let currentRoom = null;
let roomListenerUnsubscribe = null;
let roomTimeout = null;
let userReadyStatus = false;

// ============================================
// 1. ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø²Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ - ØªØ­Ø¯Ù‘ÙŠ Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡ (ØºØ±Ù)
// ============================================
window.openFriendChallenge = function() {
    document.getElementById('friend-challenge-modal').classList.remove('hidden');
};

window.closeFriendChallengeModal = function() {
    document.getElementById('friend-challenge-modal').classList.add('hidden');
};

window.openCreateRoomScreen = function() {
    closeFriendChallengeModal();
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById('screen-create-room').classList.add('active');
    
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ø¯ Ù„Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
    if (userData && userData.grade) {
        populateSubjectsForGrade(userData.grade);
        setRoomQType('mcq');
    }
};

window.openJoinRoomScreen = function() {
    closeFriendChallengeModal();
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById('screen-join-room').classList.add('active');
};

window.backToFriendChallenge = function() {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById('screen-friend-challenge').classList.add('active');
};

window.backToChallenges = function() {
    // Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„ØºØ±ÙØ© Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ØªØµÙ„Ø§Ù‹
    if (currentRoom) {
        leaveRoom();
    }
    
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    switchTab('challenges');
};

// ============================================
// 2. Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ© Ø¬Ø¯ÙŠØ¯Ø©
// ============================================
window.createRoom = async function() {
    try {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø§Ø¯Ø© ÙˆÙ†ÙˆØ¹ Ø§Ù„Ø³Ø¤Ø§Ù„
        const subject = document.getElementById('room-subject').value;
        const roomQType = window.roomQType || 'mcq';
        
        if (!subject) {
            showBeautifulAlert('warning', 'ØªÙ†Ø¨ÙŠÙ‡', 'ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø§Ø¯Ø© Ø£ÙˆÙ„Ø§Ù‹');
            return;
        }
        
        if (!roomQType) {
            showBeautifulAlert('warning', 'ØªÙ†Ø¨ÙŠÙ‡', 'ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø£ÙˆÙ„Ø§Ù‹');
            return;
        }
        
        // Ø¥Ù†Ø´Ø§Ø¡ Ø±Ù‚Ù… ØºØ±ÙØ© Ø¹Ø´ÙˆØ§Ø¦ÙŠ (8 Ø£Ø±Ù‚Ø§Ù…)
        const roomCode = Math.floor(10000000 + Math.random() * 90000000).toString();
        
        // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØºØ±ÙØ© ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        const roomData = {
            roomCode: roomCode,
            creatorId: currentUser.uid,
            creatorName: userData.name,
            creatorPhoto: userData.photo,
            creatorGrade: userData.grade,
            subject: subject,
            questionType: roomQType,
            status: 'waiting',
            users: [{
                uid: currentUser.uid,
                name: userData.name,
                photo: userData.photo,
                isReady: false,
                isCreator: true,
                grade: userData.grade
            }],
            readyCount: 0,
            totalUsers: 1,
            createdAt: serverTimestamp(),
            expiresAt: Timestamp.fromDate(new Date(Date.now() + 10 * 60 * 1000)), // 10 Ø¯Ù‚Ø§Ø¦Ù‚
            gameStarted: false,
            gameId: null
        };
        
        const roomRef = doc(db, "rooms", roomCode);
        await setDoc(roomRef, roomData);
        
        // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ Ø´Ø§Ø´Ø© Ø§Ù„ØºØ±ÙØ©
        await joinRoomById(roomCode);
        
        showBeautifulAlert('success', 'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØºØ±ÙØ©', `âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ© Ø¬Ø¯ÙŠØ¯Ø©\nØ±Ù‚Ù… Ø§Ù„ØºØ±ÙØ©: ${roomCode}\nØ´Ø§Ø±Ùƒ Ø§Ù„Ø±Ù‚Ù… Ù…Ø¹ Ø£ØµØ¯Ù‚Ø§Ø¦Ùƒ Ù„Ù„Ø§Ù†Ø¶Ù…Ø§Ù…`);
        
    } catch (error) {
        console.error("Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØºØ±ÙØ©:", error);
        showBeautifulAlert('error', 'Ø®Ø·Ø£', 'âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØºØ±ÙØ©');
    }
};

// ============================================
// 3. Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ø¥Ù„Ù‰ ØºØ±ÙØ©
// ============================================
window.joinRoom = async function() {
    const roomCodeInput = document.getElementById('room-code-input').value.trim();
    
    if (!roomCodeInput || roomCodeInput.length !== 8) {
        showBeautifulAlert('warning', 'ØªÙ†Ø¨ÙŠÙ‡', 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… ØºØ±ÙØ© ØµØ§Ù„Ø­ (8 Ø£Ø±Ù‚Ø§Ù…)');
        return;
    }
    
    try {
        await joinRoomById(roomCodeInput);
    } catch (error) {
        console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„ØºØ±ÙØ©:", error);
        showBeautifulAlert('error', 'Ø®Ø·Ø£', 'âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ ØºØ±ÙØ© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù… Ø£Ùˆ Ø­Ø¯Ø« Ø®Ø·Ø£');
    }
};

async function joinRoomById(roomCode) {
    try {
        const roomRef = doc(db, "rooms", roomCode);
        const roomSnap = await getDoc(roomRef);
        
        if (!roomSnap.exists()) {
            showBeautifulAlert('error', 'Ø®Ø·Ø£', 'âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ ØºØ±ÙØ© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù…');
            return;
        }
        
        const roomData = roomSnap.data();
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù…Ø¯Ø© Ø§Ù„ØºØ±ÙØ©
        if (roomData.expiresAt && roomData.expiresAt.toDate() < new Date()) {
            showBeautifulAlert('error', 'Ø®Ø·Ø£', 'âŒ Ø§Ù†ØªÙ‡Øª Ù…Ø¯Ø© Ù‡Ø°Ù‡ Ø§Ù„ØºØ±ÙØ©');
            return;
        }
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„ØºØ±ÙØ© Ù„Ù… ØªØ¨Ø¯Ø£ Ø¨Ø¹Ø¯
        if (roomData.gameStarted) {
            showBeautifulAlert('error', 'Ø®Ø·Ø£', 'âŒ Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø© Ø¨Ø¯Ø£Øª Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ØºØ±ÙØ©');
            return;
        }
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©
        if (roomData.creatorGrade !== userData.grade) {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…Ø´ØªØ±ÙƒØ©
            const sharedSubjects = ['Ø§Ø³Ù„Ø§Ù…ÙŠØ©', 'Ø¹Ø±Ø¨ÙŠ', 'Ø§Ù†ÙƒÙ„ÙŠØ²ÙŠ'];
            if (!sharedSubjects.includes(roomData.subject)) {
                showBeautifulAlert('error', 'Ø®Ø·Ø£', `âŒ Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ø¥Ù„Ù‰ Ù‡Ø°Ù‡ Ø§Ù„ØºØ±ÙØ©\nØ§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ© ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚Ø©`);
                return;
            }
        }
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„ÙŠØ³ Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„ØºØ±ÙØ©
        const isAlreadyInRoom = roomData.users.some(user => user.uid === currentUser.uid);
        if (isAlreadyInRoom) {
            showBeautifulAlert('warning', 'ØªÙ†Ø¨ÙŠÙ‡', 'Ø£Ù†Øª Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ØºØ±ÙØ©');
        }
        
        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ù„Ù‰ Ø§Ù„ØºØ±ÙØ©
        const newUser = {
            uid: currentUser.uid,
            name: userData.name,
            photo: userData.photo,
            isReady: false,
            isCreator: false,
            grade: userData.grade
        };
        
        await updateDoc(roomRef, {
            users: [...roomData.users, newUser],
            totalUsers: roomData.totalUsers + 1,
            [`userReady_${currentUser.uid}`]: false
        });
        
        // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØºØ±ÙØ©
        currentRoom = roomCode;
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById('screen-friend-challenge').classList.add('active');
        
        // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„ØºØ±ÙØ©
        listenToRoomUpdates(roomCode);
        
    } catch (error) {
        console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„ØºØ±ÙØ©:", error);
        throw error;
    }
}

// ============================================
// 4. Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„ØºØ±ÙØ©
// ============================================
function listenToRoomUpdates(roomCode) {
    if (roomListenerUnsubscribe) {
        roomListenerUnsubscribe();
    }
    
    const roomRef = doc(db, "rooms", roomCode);
    roomListenerUnsubscribe = onSnapshot(roomRef, async (snapshot) => {
        if (!snapshot.exists()) {
            showBeautifulAlert('info', 'ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØºØ±ÙØ©', 'ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØºØ±ÙØ© Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø§Ù„Ùƒ');
            backToChallenges();
            return;
        }
        
        const roomData = snapshot.data();
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ÙˆÙ‚Øª
        if (roomData.expiresAt && roomData.expiresAt.toDate() < new Date()) {
            showBeautifulAlert('info', 'Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ø¯Ø©', 'Ø§Ù†ØªÙ‡Øª Ù…Ø¯Ø© Ø§Ù„ØºØ±ÙØ© (10 Ø¯Ù‚Ø§Ø¦Ù‚)');
            await deleteDoc(roomRef);
            backToChallenges();
            return;
        }
        
        // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØºØ±ÙØ©
        updateRoomUI(roomData);
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø©
        if (roomData.gameStarted && roomData.gameId) {
            startRoomGame(roomData.gameId);
        }
    });
    
    // Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø¤Ù‚Øª Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ØºØ±ÙØ©
    setupRoomTimer(roomCode);
}

// ============================================
// 5. ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØºØ±ÙØ© (Ù…Ø·Ø§Ø¨Ù‚ Ù„Ù„ØµÙˆØ±Ø©)
// ============================================
function updateRoomUI(roomData) {
    const roomContent = document.getElementById('room-content');
    if (!roomContent) return;
    
    const isCreator = roomData.creatorId === currentUser.uid;
    const currentUserInRoom = roomData.users.find(u => u.uid === currentUser.uid);
    const readyCount = roomData.users.filter(u => u.isReady).length;
    const totalUsers = roomData.users.length;
    
    let usersHTML = '';
    
    // ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†: Ø§Ù„Ù…Ø§Ù„Ùƒ Ø£ÙˆÙ„Ø§Ù‹
    const sortedUsers = [...roomData.users].sort((a, b) => {
        if (a.isCreator) return -1;
        if (b.isCreator) return 1;
        return 0;
    });
    
    sortedUsers.forEach(user => {
        usersHTML += `
            <div class="room-user-card ${user.isReady ? 'ready' : ''}">
                <div class="flex items-center gap-4">
                    <img src="${user.photo}" class="room-user-avatar" alt="ØµÙˆØ±Ø© ${user.name}">
                    <div class="text-right flex-1">
                        <h4 class="font-bold text-gray-800 flex items-center gap-2 justify-end">
                            ${user.name}
                            ${user.isCreator ? '<span class="bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded">Ø§Ù„Ù…Ø§Ù„Ùƒ</span>' : ''}
                        </h4>
                        <p class="text-xs text-gray-500 mt-1">${user.grade ? getGradeName(user.grade) : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>
                    </div>
                </div>
                <div class="ml-auto">
                    <span class="text-xs ${user.isReady ? 'text-green-600 font-bold' : 'text-gray-400'}">
                        ${user.isReady ? 'âœ… Ø¬Ø§Ù‡Ø²' : 'â³ ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±'}
                    </span>
                </div>
            </div>
        `;
    });
    
    // Ø­Ø³Ø§Ø¨ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ
    const timeLeft = roomData.expiresAt ? Math.max(0, Math.floor((roomData.expiresAt.toDate() - new Date()) / 1000)) : 600;
    const minutes = Math.floor(timeLeft / 60);
    const seconds = timeLeft % 60;
    
    roomContent.innerHTML = `
        <div class="room-counter">
            â±ï¸ ${minutes}:${seconds < 10 ? '0' : ''}${seconds}
        </div>
        
        <div class="bg-white rounded-3xl p-6 shadow-lg mb-6">
            <div class="text-center mb-6">
                <h2 class="text-2xl font-black text-indigo-800 mb-2">ØºØ±ÙØ© Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø©</h2>
                <div class="room-code-display">${roomData.roomCode}</div>
                
                <div class="mt-4 grid grid-cols-2 gap-4 text-center">
                    <div class="bg-gray-50 p-3 rounded-xl">
                        <p class="text-sm text-gray-500">Ø§Ù„Ù…Ø§Ø¯Ø©</p>
                        <p class="font-bold text-gray-800">${roomData.subject}</p>
                    </div>
                    <div class="bg-gray-50 p-3 rounded-xl">
                        <p class="text-sm text-gray-500">Ù†ÙˆØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</p>
                        <p class="font-bold text-gray-800">${roomData.questionType === 'mcq' ? 'Ø§Ø®ØªÙŠØ§Ø±Ø§Øª' : 'ØµØ­/Ø®Ø·Ø£'}</p>
                    </div>
                </div>
            </div>
            
            <div class="mb-6">
                <h3 class="font-bold text-gray-800 mb-4 border-r-4 border-indigo-500 pr-3">Ø§Ù„Ù„Ø§Ø¹Ø¨ÙˆÙ† ÙÙŠ Ø§Ù„ØºØ±ÙØ©</h3>
                ${usersHTML}
            </div>
            
            <div class="text-center mb-4">
                <p class="text-lg font-bold text-gray-700">
                    ${readyCount}/${totalUsers} Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¬Ø§Ù‡Ø²ÙŠÙ†
                </p>
                <p class="text-sm text-gray-500 mt-1">ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„Ø¬Ù…ÙŠØ¹ Ø¬Ø§Ù‡Ø²ÙŠÙ† Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø©</p>
            </div>
            
            <div class="flex gap-3">
                ${isCreator ? 
                    `<button onclick="deleteRoom('${roomData.roomCode}')" class="beautiful-btn secondary flex-1">
                        <i class="fas fa-trash"></i> Ø­Ø°Ù Ø§Ù„ØºØ±ÙØ©
                    </button>` :
                    `<button onclick="leaveRoom()" class="beautiful-btn secondary flex-1">
                        <i class="fas fa-sign-out-alt"></i> Ù…ØºØ§Ø¯Ø±Ø©
                    </button>`
                }
                
                <button onclick="toggleReady()" class="beautiful-btn flex-1 ${currentUserInRoom?.isReady ? 'not-ready' : ''}">
                    ${currentUserInRoom?.isReady ? 
                        '<i class="fas fa-times"></i> Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¬Ø§Ù‡Ø²ÙŠØ©' : 
                        '<i class="fas fa-check"></i> Ø¬Ø§Ù‡Ø²'
                    }
                </button>
            </div>
        </div>
    `;
}

// ============================================
// 6. ØªØ¨Ø¯ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ø§Ù‡Ø²ÙŠØ©
// ============================================
window.toggleReady = async function() {
    if (!currentRoom) return;
    
    try {
        const roomRef = doc(db, "rooms", currentRoom);
        const roomSnap = await getDoc(roomRef);
        
        if (!roomSnap.exists()) return;
        
        const roomData = roomSnap.data();
        const currentUserInRoom = roomData.users.find(u => u.uid === currentUser.uid);
        
        if (!currentUserInRoom) return;
        
        const newReadyStatus = !currentUserInRoom.isReady;
        
        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ø§Ù‡Ø²ÙŠØ© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
        const updatedUsers = roomData.users.map(user => {
            if (user.uid === currentUser.uid) {
                return { ...user, isReady: newReadyStatus };
            }
            return user;
        });
        
        const readyCount = updatedUsers.filter(u => u.isReady).length;
        
        await updateDoc(roomRef, {
            users: updatedUsers,
            readyCount: readyCount,
            [`userReady_${currentUser.uid}`]: newReadyStatus
        });
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¬Ù…ÙŠØ¹ Ø¬Ø§Ù‡Ø²ÙŠÙ†
        if (readyCount === roomData.users.length && roomData.users.length >= 2) {
            await startRoomGameSession(roomData);
        }
        
    } catch (error) {
        console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø¬Ø§Ù‡Ø²ÙŠØ©:", error);
    }
};

// ============================================
// 7. Ø¨Ø¯Ø¡ Ù…Ø¨Ø§Ø±Ø§Ø© Ø§Ù„ØºØ±ÙØ©
// ============================================
async function startRoomGameSession(roomData) {
    try {
        const roomRef = doc(db, "rooms", currentRoom);
        
        // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¹Ø±ÙƒØ© Ø¬Ø¯ÙŠØ¯Ø©
        const battleRef = await addDoc(collection(db, "battles"), {
            player1: roomData.users[0].uid,
            player2: roomData.users[1].uid,
            player1Name: roomData.users[0].name,
            player2Name: roomData.users[1].name,
            player1Photo: roomData.users[0].photo,
            player2Photo: roomData.users[1].photo,
            subject: roomData.subject,
            grade: roomData.creatorGrade,
            questionType: roomData.questionType,
            status: 'starting',
            createdAt: serverTimestamp(),
            roomCode: currentRoom
        });
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØºØ±ÙØ© Ø¨Ù…Ø¹Ø±ÙƒØ© Ø¬Ø¯ÙŠØ¯Ø©
        await updateDoc(roomRef, {
            gameStarted: true,
            gameId: battleRef.id
        });
        
    } catch (error) {
        console.error("Ø®Ø·Ø£ ÙÙŠ Ø¨Ø¯Ø¡ Ù…Ø¨Ø§Ø±Ø§Ø© Ø§Ù„ØºØ±ÙØ©:", error);
    }
}

function startRoomGame(gameId) {
    if (roomListenerUnsubscribe) {
        roomListenerUnsubscribe();
    }
    
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø±ÙƒØ© ÙˆØ§Ù„Ø¨Ø¯Ø¡
    loadBattle(gameId);
}

// ============================================
// 8. Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„ØºØ±ÙØ©
// ============================================
window.leaveRoom = async function() {
    if (!currentRoom) return;
    
    if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„ØºØ±ÙØ©ØŸ')) {
        try {
            const roomRef = doc(db, "rooms", currentRoom);
            const roomSnap = await getDoc(roomRef);
            
            if (roomSnap.exists()) {
                const roomData = roomSnap.data();
                
                // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø§Ù„ØºØ±ÙØ©
                const updatedUsers = roomData.users.filter(user => user.uid !== currentUser.uid);
                
                if (updatedUsers.length === 0) {
                    // Ø¥Ø°Ø§ Ù„Ù… ÙŠØ¨Ù‚Ù‰ Ø£Ø­Ø¯ØŒ Ø­Ø°Ù Ø§Ù„ØºØ±ÙØ©
                    await deleteDoc(roomRef);
                } else {
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØºØ±ÙØ© Ù…Ø¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…ØªØ¨Ù‚ÙŠÙ†
                    await updateDoc(roomRef, {
                        users: updatedUsers,
                        totalUsers: updatedUsers.length
                    });
                }
            }
            
            // ØªÙ†Ø¸ÙŠÙ
            cleanupRoom();
            backToChallenges();
            
        } catch (error) {
            console.error("Ø®Ø·Ø£ ÙÙŠ Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„ØºØ±ÙØ©:", error);
        }
    }
};

// ============================================
// 9. Ø­Ø°Ù Ø§Ù„ØºØ±ÙØ© (Ù„Ù„Ù…Ø§Ù„Ùƒ ÙÙ‚Ø·)
// ============================================
window.deleteRoom = async function(roomCode) {
    if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„ØºØ±ÙØ© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ')) {
        try {
            const roomRef = doc(db, "rooms", roomCode);
            await deleteDoc(roomRef);
            
            cleanupRoom();
            backToChallenges();
            
            showBeautifulAlert('success', 'ØªÙ… Ø§Ù„Ø­Ø°Ù', 'ØªÙ… Ø­Ø°Ù Ø§Ù„ØºØ±ÙØ© Ø¨Ù†Ø¬Ø§Ø­');
            
        } catch (error) {
            console.error("Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„ØºØ±ÙØ©:", error);
        }
    }
};

// ============================================
// 10. ØªÙ†Ø¸ÙŠÙ Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„ØºØ±ÙØ©
// ============================================
function cleanupRoom() {
    if (roomListenerUnsubscribe) {
        roomListenerUnsubscribe();
        roomListenerUnsubscribe = null;
    }
    
    if (roomTimeout) {
        clearTimeout(roomTimeout);
        roomTimeout = null;
    }
    
    currentRoom = null;
    userReadyStatus = false;
}

// ============================================
// 11. Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø¤Ù‚Øª Ø§Ù„ØºØ±ÙØ©
// ============================================
function setupRoomTimer(roomCode) {
    if (roomTimeout) {
        clearTimeout(roomTimeout);
    }
    
    roomTimeout = setTimeout(async () => {
        try {
            const roomRef = doc(db, "rooms", roomCode);
            const roomSnap = await getDoc(roomRef);
            
            if (roomSnap.exists()) {
                const roomData = roomSnap.data();
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ø¯Ø© ÙˆÙ„Ù… ØªØ¨Ø¯Ø£ Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø©
                if (!roomData.gameStarted) {
                    await deleteDoc(roomRef);
                    showBeautifulAlert('info', 'Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ø¯Ø©', 'Ø§Ù†ØªÙ‡Øª Ù…Ø¯Ø© Ø§Ù„ØºØ±ÙØ© (10 Ø¯Ù‚Ø§Ø¦Ù‚)');
                    cleanupRoom();
                    backToChallenges();
                }
            }
        } catch (error) {
            console.error("Ø®Ø·Ø£ ÙÙŠ Ù…Ø¤Ù‚Øª Ø§Ù„ØºØ±ÙØ©:", error);
        }
    }, 10 * 60 * 1000); // 10 Ø¯Ù‚Ø§Ø¦Ù‚
}

// ============================================
// 12. ØªØ¹ÙŠÙŠÙ† Ù†ÙˆØ¹ Ø§Ù„Ø³Ø¤Ø§Ù„ Ù„Ù„ØºØ±ÙØ©
// ============================================
window.setRoomQType = (t) => {
    window.roomQType = t;
    document.getElementById('room-btn-mcq').className = `py-3 rounded-xl border-2 font-bold transition flex-1 ${t==='mcq'?'border-indigo-600 bg-indigo-50 text-indigo-600':'border-indigo-100 text-gray-500'}`;
    document.getElementById('room-btn-tf').className = `py-3 rounded-xl border-2 font-bold transition flex-1 ${t==='tf'?'border-indigo-600 bg-indigo-50 text-indigo-600':'border-indigo-100 text-gray-500'}`;
};



// ============================================
// Ù†Ø¸Ø§Ù… Ø§Ù„Ù„Ø¹Ø¨ Ø¶Ø¯ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ - Ø§Ù„Ø¬Ø¯ÙŠØ¯
// ============================================

// Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
const AI_CONFIG = {
    ANSWER_DELAY: 4000, // 4 Ø«ÙˆØ§Ù†ÙŠ
    AI_ACCURACY: 0.55, // 55% Ø¯Ù‚Ø©
    NORMAL_QUESTIONS: 10, // Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ù„Ù„Ø¹Ø§Ø¯ÙŠÙŠÙ†
    PREMIUM_QUESTIONS: 15, // Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ù„Ù„Ù…Ù…ÙŠØ²ÙŠÙ†
    RESPONSE_VARIATION: 2000, // ØªØ¨Ø§ÙŠÙ† ÙÙŠ ÙˆÙ‚Øª Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Â±2 Ø«Ø§Ù†ÙŠØ©
    MAX_ACCURACY: 0.65, // Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ø¯Ù‚Ø©
    MIN_ACCURACY: 0.45 // Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø¯Ù‚Ø©
};

// Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
let aiGameInterval = null;
let aiAnswerTimer = null;
let aiPerformanceHistory = []; // Ù„ØªØªØ¨Ø¹ Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ

// ============================================
// 1. Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠ Ø¶Ø¯ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
// ============================================
window.startMatchmaking = async function(type) {
    if (type === 'ai') {
        const subject = document.getElementById('challenge-subject').value;
        
        if (!subject) {
            showBeautifulAlert('warning', 'ØªÙ†Ø¨ÙŠÙ‡', 'ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø§Ø¯Ø© Ø£ÙˆÙ„Ø§Ù‹');
            return;
        }
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©
        if (dailyAIRemaining <= 0) {
            if (userData.isPremium && isPremiumValid(userData)) {
                showBeautifulAlert('error', 'Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª', 
                    'âŒ Ø§Ù†ØªÙ‡Øª Ù…Ø­Ø§ÙˆÙ„Ø§ØªÙƒ Ø§Ù„ÙŠÙˆÙ…ÙŠØ© (15 Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ù„Ù…Ù…ÙŠØ²ÙŠÙ†).\nÙŠÙ…ÙƒÙ†Ùƒ ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø¨Ø¥Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ.');
            } else {
                showBeautifulAlert('error', 'Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª', 
                    'âŒ Ø§Ù†ØªÙ‡Øª Ù…Ø­Ø§ÙˆÙ„Ø§ØªÙƒ Ø§Ù„ÙŠÙˆÙ…ÙŠØ© (10 Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø¹Ø§Ø¯ÙŠÙŠÙ†).\nØ§Ù†ØªØ¸Ø± Ø­ØªÙ‰ Ø§Ù„ØºØ¯ Ø£Ùˆ Ø§Ø´ØªØ±Ùƒ ÙÙŠ Ø§Ù„Ø¨Ø§Ù‚Ø© Ø§Ù„Ù…Ù…ÙŠØ²Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ 15 Ù…Ø­Ø§ÙˆÙ„Ø© ÙŠÙˆÙ…ÙŠØ©.');
            }
            return;
        }
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù†ÙˆØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©
        const questionType = window.currentQType || 'mcq';
        if (!questionType) {
            showBeautifulAlert('warning', 'ØªÙ†Ø¨ÙŠÙ‡', 'ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø£ÙˆÙ„Ø§Ù‹');
            return;
        }
        
        // Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø§Ø´Ø© Ø§Ù„Ø¨Ø­Ø«
        document.getElementById('challenge-active-card').classList.add('hidden');
        document.getElementById('searching-ui').classList.remove('hidden');
        document.getElementById('search-msg').textContent = 'Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªØ­Ø¯ÙŠ Ø¶Ø¯ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ...';
        
        // ØªØ®ÙÙŠØ¶ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©
        dailyAIRemaining--;
        updateAIRemainingDisplay();
        
        // Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ
        const questionCount = userData.isPremium && isPremiumValid(userData) ? 
            AI_CONFIG.PREMIUM_QUESTIONS : AI_CONFIG.NORMAL_QUESTIONS;
        
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©
        try {
            await loadGameQuestions(subject, questionType, questionCount);
            
            // ØªØ¹ÙŠÙŠÙ† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø®ØµÙ… (Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ)
            opponentData = {
                name: "Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ ğŸ¤–",
                photo: "https://ui-avatars.com/api/?name=AI&background=8b5cf6&color=fff",
                uid: "ai_opponent_" + Date.now(),
                grade: userData.grade
            };
            
            gameType = 'ai';
            opponentId = 'ai';
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø§Ø´Ø© VS
            showVSscreen(userData, opponentData);
            
            // Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø© Ø¨Ø¹Ø¯ 3 Ø«ÙˆØ§Ù†ÙŠ
            setTimeout(() => {
                document.getElementById('vs-screen').classList.add('hidden');
                startAIgame();
            }, 3000);
            
        } catch (error) {
            console.error("Ø®Ø·Ø£ ÙÙŠ Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø© Ø¶Ø¯ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ:", error);
            cancelSearch();
            showBeautifulAlert('error', 'Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªØ­Ø¯ÙŠ');
        }
    }
};

// ============================================
// 2. Ø¨Ø¯Ø¡ Ù„Ø¹Ø¨Ø© Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
// ============================================
function startAIgame() {
    if (!isGameActive || gameQuestions.length === 0) {
        showBeautifulAlert('error', 'Ø®Ø·Ø£', 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© Ù…ØªØ§Ø­Ø©');
        return;
    }
    
    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ØªØ§Ø±ÙŠØ® Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
    aiPerformanceHistory = [];
    
    // Ø¥Ø¹Ø¯Ø§Ø¯ Ù„Ø¹Ø¨Ø© Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
    setupAIGame();
    
    // Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©
    document.getElementById('game-overlay').classList.remove('hidden');
    
    document.getElementById('game-p1-img').src = userData.photo;
    document.getElementById('p1-name').textContent = userData.name;
    document.getElementById('game-my-score').textContent = myScore;
    
    document.getElementById('game-p2-img').src = opponentData.photo;
    document.getElementById('p2-name').textContent = opponentData.name;
    document.getElementById('game-op-score').textContent = opponentScore;
    
    const withdrawBtn = document.getElementById('withdraw-game-btn');
    withdrawBtn.classList.remove('hidden');
    withdrawBtn.onclick = withdrawFromAIgame;
    
    showNextQuestionAI();
}

// ============================================
// 3. Ø¥Ø¹Ø¯Ø§Ø¯ Ù„Ø¹Ø¨Ø© Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
// ============================================
function setupAIGame() {
    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
    myScore = 0;
    opponentScore = 0;
    currentQuestionIndex = 0;
    playerAnswers = [];
    opponentAnswers = [];
    isGameActive = true;
    
    // Ø¥Ø¶Ø§ÙØ© 0.1 Ù†Ù‚Ø·Ø© Ø¨Ø¯Ø§Ø¦ÙŠØ© Ù„Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„ØªØ­Ø¯ÙŠ
    opponentScore = 0.1;
}

// ============================================
// 4. Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠ Ù…Ø¹ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
// ============================================
function showNextQuestionAI() {
    if (!isGameActive || currentQuestionIndex >= gameQuestions.length) {
        endAIGame();
        return;
    }
    
    const question = gameQuestions[currentQuestionIndex];
    
    document.getElementById('q-progress').textContent = `${currentQuestionIndex + 1} / ${gameQuestions.length}`;
    document.getElementById('q-text').textContent = question.question;
    
    const answersContainer = document.getElementById('answers-container');
    answersContainer.innerHTML = '';
    
    document.getElementById('waiting-msg').classList.add('hidden');
    document.getElementById('ai-thinking-msg').classList.add('hidden');
    
    // Ø¹Ø±Ø¶ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª
    if (question.type === 'mcq') {
        question.answers.forEach((answer, index) => {
            const btn = document.createElement('button');
            btn.className = 'w-full bg-white border-2 border-gray-200 rounded-xl p-4 text-right font-bold text-gray-700 hover:bg-gray-50 transition answer-neutral';
            btn.textContent = answer;
            btn.onclick = () => selectAnswerAI(index, question);
            answersContainer.appendChild(btn);
        });
    } else {
        const trueBtn = document.createElement('button');
        trueBtn.className = 'w-full bg-white border-2 border-gray-200 rounded-xl p-4 text-right font-bold text-gray-700 hover:bg-gray-50 transition answer-neutral';
        trueBtn.textContent = 'ØµØ­';
        trueBtn.onclick = () => selectAnswerAI(true, question);
        answersContainer.appendChild(trueBtn);
        
        const falseBtn = document.createElement('button');
        falseBtn.className = 'w-full bg-white border-2 border-gray-200 rounded-xl p-4 text-right font-bold text-gray-700 hover:bg-gray-50 transition answer-neutral';
        falseBtn.textContent = 'Ø®Ø·Ø£';
        falseBtn.onclick = () => selectAnswerAI(false, question);
        answersContainer.appendChild(falseBtn);
    }
    
    startTimerAI();
    
    // Ø¨Ø¯Ø¡ ØªÙÙƒÙŠØ± Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
    startAIThinking(question);
}

// ============================================
// 5. Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø¤Ù‚Øª Ù„Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
// ============================================
function startTimerAI() {
    currentGameTimer = 15;
    document.getElementById('game-timer').textContent = currentGameTimer;
    
    if (gameTimerInterval) clearInterval(gameTimerInterval);
    
    gameTimerInterval = setInterval(() => {
        currentGameTimer--;
        document.getElementById('game-timer').textContent = currentGameTimer;
        
        // Ø¥Ø°Ø§ Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª ÙˆÙ„Ù… ÙŠØ¬Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        if (currentGameTimer <= 0) {
            clearInterval(gameTimerInterval);
            if (isGameActive) {
                handleTimeoutAI();
            }
        }
        
        // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ ÙÙŠ Ø§Ù„Ø«Ø§Ù†ÙŠØ© 11
        if (currentGameTimer === 4) { // 15 - 11 = 4 (Ø§Ù„Ø«Ø§Ù†ÙŠØ© 11)
            document.getElementById('ai-thinking-msg').classList.remove('hidden');
        }
    }, 1000);
}

// ============================================
// 6. Ø¨Ø¯Ø¡ ØªÙÙƒÙŠØ± Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
// ============================================
function startAIThinking(question) {
    // Ø­Ø³Ø§Ø¨ ÙˆÙ‚Øª Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© (4 Ø«ÙˆØ§Ù†ÙŠ Ù…Ø¹ ØªØ¨Ø§ÙŠÙ†)
    const baseDelay = AI_CONFIG.ANSWER_DELAY;
    const variation = Math.random() * AI_CONFIG.RESPONSE_VARIATION - (AI_CONFIG.RESPONSE_VARIATION / 2);
    const aiDelay = baseDelay + variation;
    
    // Ø¥Ù„ØºØ§Ø¡ Ø£ÙŠ Ù…Ø¤Ù‚Øª Ø³Ø§Ø¨Ù‚
    if (aiAnswerTimer) clearTimeout(aiAnswerTimer);
    
    // Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø¤Ù‚Øª Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
    aiAnswerTimer = setTimeout(() => {
        if (isGameActive) {
            const aiAnswer = generateSmartAIAnswer(question);
            
            // ØªØ³Ø¬ÙŠÙ„ Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
            opponentAnswers.push({
                questionIndex: currentQuestionIndex,
                answer: aiAnswer,
                isCorrect: aiAnswer === question.correct
            });
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©
            if (aiAnswer === question.correct) {
                opponentScore++;
                document.getElementById('game-op-score').textContent = Math.floor(opponentScore);
            }
            
            // ØªØ­Ø¯ÙŠØ« ØªØ§Ø±ÙŠØ® Ø§Ù„Ø£Ø¯Ø§Ø¡
            updateAIPerformanceHistory(aiAnswer === question.correct);
        }
    }, aiDelay);
}

// ============================================
// 7. ØªÙˆÙ„ÙŠØ¯ Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ø§Ù„Ø°ÙƒÙŠØ©
// ============================================
function generateSmartAIAnswer(question) {
    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¯Ù‚Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø³Ø§Ø¨Ù‚
    let currentAccuracy = calculateCurrentAccuracy();
    
    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø¯Ù‚Ø© Ø¶Ù…Ù† Ø§Ù„Ø­Ø¯ÙˆØ¯ Ø§Ù„Ù…Ø³Ù…ÙˆØ­Ø©
    currentAccuracy = Math.max(AI_CONFIG.MIN_ACCURACY, 
        Math.min(AI_CONFIG.MAX_ACCURACY, currentAccuracy));
    
    // ØªÙˆÙ„ÙŠØ¯ Ø¥Ø¬Ø§Ø¨Ø© Ø¹Ø´ÙˆØ§Ø¦ÙŠØ© Ù…Ø¹ Ù…Ø±Ø§Ø¹Ø§Ø© Ø§Ù„Ø¯Ù‚Ø©
    const random = Math.random();
    
    if (question.type === 'mcq') {
        // Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ù…ØªØ¹Ø¯Ø¯
        if (random < currentAccuracy) {
            // Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©
            return question.correct;
        } else {
            // Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø© (ØªØ¬Ù†Ø¨ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©)
            const wrongOptions = [0, 1, 2].filter(opt => opt !== question.correct);
            return wrongOptions[Math.floor(Math.random() * wrongOptions.length)];
        }
    } else {
        // Ù„Ø£Ø³Ø¦Ù„Ø© ØµØ­/Ø®Ø·Ø£
        if (random < currentAccuracy) {
            // Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©
            return question.correct;
        } else {
            // Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ø®Ø§Ø·Ø¦Ø©
            return !question.correct;
        }
    }
}

// ============================================
// 8. Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¯Ù‚Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
// ============================================
function calculateCurrentAccuracy() {
    if (aiPerformanceHistory.length === 0) {
        return AI_CONFIG.AI_ACCURACY;
    }
    
    // Ø­Ø³Ø§Ø¨ Ù…ØªÙˆØ³Ø· Ø§Ù„Ø£Ø¯Ø§Ø¡
    const correctAnswers = aiPerformanceHistory.filter(result => result).length;
    const averageAccuracy = correctAnswers / aiPerformanceHistory.length;
    
    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø£Ø¯Ø§Ø¡ Ù…Ø±ØªÙØ¹Ø§Ù‹ Ø¬Ø¯Ø§Ù‹ØŒ Ù†Ø®ÙØ¶ Ø§Ù„Ø¯Ù‚Ø©
    if (averageAccuracy > AI_CONFIG.AI_ACCURACY + 0.1) {
        return AI_CONFIG.AI_ACCURACY - 0.05;
    }
    
    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø£Ø¯Ø§Ø¡ Ù…Ù†Ø®ÙØ¶Ø§Ù‹ Ø¬Ø¯Ø§Ù‹ØŒ Ù†Ø±ÙØ¹ Ø§Ù„Ø¯Ù‚Ø©
    if (averageAccuracy < AI_CONFIG.AI_ACCURACY - 0.1) {
        return AI_CONFIG.AI_ACCURACY + 0.05;
    }
    
    return AI_CONFIG.AI_ACCURACY;
}

// ============================================
// 9. ØªØ­Ø¯ÙŠØ« ØªØ§Ø±ÙŠØ® Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
// ============================================
function updateAIPerformanceHistory(isCorrect) {
    aiPerformanceHistory.push(isCorrect);
    
    // Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø¢Ø®Ø± 20 Ø¥Ø¬Ø§Ø¨Ø© ÙÙ‚Ø·
    if (aiPerformanceHistory.length > 20) {
        aiPerformanceHistory.shift();
    }
}

// ============================================
// 10. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¹ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
// ============================================
function selectAnswerAI(answer, question) {
    if (!isGameActive) return;
    
    // Ø¥Ù„ØºØ§Ø¡ Ù…Ø¤Ù‚Øª Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
    if (aiAnswerTimer) clearTimeout(aiAnswerTimer);
    
    clearInterval(gameTimerInterval);
    
    const isCorrect = answer === question.correct;
    
    // ØªØ³Ø¬ÙŠÙ„ Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    playerAnswers.push({
        questionIndex: currentQuestionIndex,
        answer: answer,
        isCorrect: isCorrect
    });
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†ØªÙŠØ¬Ø©
    if (isCorrect) {
        myScore++;
        document.getElementById('game-my-score').textContent = myScore;
    }
    
    // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø©
    highlightAnswersAI(answer, question, isCorrect);
    
    // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠ Ø¨Ø¹Ø¯ ØªØ£Ø®ÙŠØ±
    currentQuestionIndex++;
    setTimeout(() => {
        if (isGameActive) {
            showNextQuestionAI();
        }
    }, 2000);
}

// ============================================
// 11. ØªÙ…ÙŠÙŠØ² Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª
// ============================================
function highlightAnswersAI(userAnswer, question, isUserCorrect) {
    const answersContainer = document.getElementById('answers-container');
    const buttons = answersContainer.querySelectorAll('button');
    
    if (question.type === 'mcq') {
        buttons.forEach((btn, index) => {
            // ØªÙ…ÙŠÙŠØ² Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©
            if (index === question.correct) {
                btn.classList.remove('answer-neutral');
                btn.classList.add('answer-correct');
            }
            // ØªÙ…ÙŠÙŠØ² Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø®Ø§Ø·Ø¦Ø©
            else if (index === userAnswer && !isUserCorrect) {
                btn.classList.remove('answer-neutral');
                btn.classList.add('answer-wrong');
            }
        });
    } else {
        buttons.forEach(btn => {
            const isTrueButton = btn.textContent === 'ØµØ­';
            const isFalseButton = btn.textContent === 'Ø®Ø·Ø£';
            
            // ØªÙ…ÙŠÙŠØ² Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©
            if ((isTrueButton && question.correct === true) || 
                (isFalseButton && question.correct === false)) {
                btn.classList.remove('answer-neutral');
                btn.classList.add('answer-correct');
            }
            // ØªÙ…ÙŠÙŠØ² Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø®Ø§Ø·Ø¦Ø©
            else if ((isTrueButton && userAnswer === true && !isUserCorrect) || 
                     (isFalseButton && userAnswer === false && !isUserCorrect)) {
                btn.classList.remove('answer-neutral');
                btn.classList.add('answer-wrong');
            }
        });
    }
}

// ============================================
// 12. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ÙˆÙ‚Øª
// ============================================
function handleTimeoutAI() {
    if (!isGameActive) return;
    
    const question = gameQuestions[currentQuestionIndex];
    
    // ØªØ³Ø¬ÙŠÙ„ Ø¹Ø¯Ù… Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    playerAnswers.push({
        questionIndex: currentQuestionIndex,
        answer: null,
        isCorrect: false
    });
    
    // Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©
    highlightCorrectAnswerOnly(question);
    
    // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠ
    currentQuestionIndex++;
    setTimeout(() => {
        if (isGameActive) {
            showNextQuestionAI();
        }
    }, 2000);
}

// ============================================
// 13. Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© ÙÙ‚Ø·
// ============================================
function highlightCorrectAnswerOnly(question) {
    const answersContainer = document.getElementById('answers-container');
    const buttons = answersContainer.querySelectorAll('button');
    
    if (question.type === 'mcq') {
        buttons.forEach((btn, index) => {
            if (index === question.correct) {
                btn.classList.remove('answer-neutral');
                btn.classList.add('answer-correct');
            }
        });
    } else {
        buttons.forEach(btn => {
            const isTrueButton = btn.textContent === 'ØµØ­';
            const isFalseButton = btn.textContent === 'Ø®Ø·Ø£';
            
            if ((isTrueButton && question.correct === true) || 
                (isFalseButton && question.correct === false)) {
                btn.classList.remove('answer-neutral');
                btn.classList.add('answer-correct');
            }
        });
    }
}

// ============================================
// 14. Ø¥Ù†Ù‡Ø§Ø¡ Ù„Ø¹Ø¨Ø© Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
// ============================================
async function endAIGame() {
    isGameActive = false;
    clearInterval(gameTimerInterval);
    if (aiAnswerTimer) clearTimeout(aiAnswerTimer);
    
    document.getElementById('game-overlay').classList.add('hidden');
    
    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
    const finalMyScore = Math.floor(myScore);
    const finalOpponentScore = Math.floor(opponentScore);
    
    // ØªØ­Ø¯ÙŠØ« Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù†ØªÙŠØ¬Ø©
    document.getElementById('final-my-score').textContent = finalMyScore;
    document.getElementById('final-op-score').textContent = finalOpponentScore;
    document.getElementById('final-op-name').textContent = opponentData.name;
    
    // ØªØ­Ø¯ÙŠØ¯ Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø©
    let resultTitle, resultMsg, resultIcon, pointsGained;
    const pointsMultiplier = (userData.isPremium && isPremiumValid(userData)) ? 2 : 1;
    
    if (finalMyScore > finalOpponentScore) {
        resultTitle = 'ğŸ‰ ÙÙˆØ² Ø±Ø§Ø¦Ø¹!';
        resultMsg = `Ù„Ù‚Ø¯ ØªÙÙˆÙ‚Øª Ø¹Ù„Ù‰ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ!`;
        resultIcon = 'ğŸ¤–ğŸ’¥';
        pointsGained = finalMyScore * 3 * pointsMultiplier; // Ù…ÙƒØ§ÙØ£Ø© Ø£ÙƒØ¨Ø± Ù„Ù„ÙÙˆØ² Ø¹Ù„Ù‰ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
    } else if (finalMyScore < finalOpponentScore) {
        resultTitle = 'ğŸ¤– Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ ÙŠÙÙˆØ²';
        resultMsg = `Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ ÙƒØ§Ù† Ø£Ø°ÙƒÙ‰ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø±Ø©!`;
        resultIcon = 'ğŸ¤–ğŸ†';
        pointsGained = Math.floor(finalMyScore * 0.5 * pointsMultiplier); // Ù†Ù‚Ø§Ø· Ø£Ù‚Ù„ Ù„Ù„Ø®Ø³Ø§Ø±Ø©
    } else {
        resultTitle = 'âš–ï¸ ØªØ¹Ø§Ø¯Ù„ Ù…Ø«ÙŠØ±';
        resultMsg = `Ù†ØªÙŠØ¬Ø© Ù…ØªÙƒØ§ÙØ¦Ø© Ù…Ø¹ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ!`;
        resultIcon = 'ğŸ¤ğŸ¤–';
        pointsGained = finalMyScore * 2 * pointsMultiplier; // Ù†Ù‚Ø§Ø· Ù…ØªÙˆØ³Ø·Ø© Ù„Ù„ØªØ¹Ø§Ø¯Ù„
    }
    
    // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ù†Ù‚Ø§Ø·
    if (pointsGained < 1 && finalMyScore > 0) {
        pointsGained = 1 * pointsMultiplier;
    }
    
    // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬
    document.getElementById('result-title').textContent = resultTitle;
    document.getElementById('result-msg').textContent = resultMsg;
    document.getElementById('result-icon-container').textContent = resultIcon;
    
    const resultPoints = document.getElementById('result-points-gained-text');
    resultPoints.textContent = pointsGained > 0 ? `+${pointsGained}` : `${pointsGained}`;
    
    // ØªÙ„ÙˆÙŠÙ† ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù†Ù‚Ø§Ø·
    const pointsBox = resultPoints.parentElement;
    if (pointsGained > 0) {
        pointsBox.style.background = 'linear-gradient(135deg, #fef3c7 0%, #fbbf24 100%)';
    } else if (pointsGained < 0) {
        pointsBox.style.background = 'linear-gradient(135deg, #fee2e2 0%, #f87171 100%)';
    } else {
        pointsBox.style.background = 'linear-gradient(135deg, #f1f5f9 0%, #cbd5e1 100%)';
    }
    
    // ØªØ­Ø¯ÙŠØ« Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    await updateUserPoints(pointsGained);
    
    // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø©
    await sendGameNotification(
        currentUser.uid,
        `${finalMyScore}-${finalOpponentScore}`,
        opponentData.name,
        pointsGained,
        true
    );
    
    // Ø¹Ø±Ø¶ Ø´Ø§Ø´Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬
    document.getElementById('result-screen').classList.remove('hidden');
}

// ============================================
// 15. Ø§Ù„Ø§Ù†Ø³Ø­Ø§Ø¨ Ù…Ù† Ù„Ø¹Ø¨Ø© Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
// ============================================
window.withdrawFromAIgame = async function() {
    if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø§Ù†Ø³Ø­Ø§Ø¨ØŸ Ø³ÙŠØªÙ… Ø®ØµÙ… 5 Ù†Ù‚Ø§Ø·.')) {
        return;
    }
    
    isGameActive = false;
    clearInterval(gameTimerInterval);
    if (aiAnswerTimer) clearTimeout(aiAnswerTimer);
    
    await updateUserPoints(-5);
    
    showBeautifulAlert('warning', 'Ø§Ù†Ø³Ø­Ø§Ø¨', 'Ù„Ù‚Ø¯ Ø§Ù†Ø³Ø­Ø¨Øª Ù…Ù† Ø§Ù„ØªØ­Ø¯ÙŠ ÙˆØªÙ… Ø®ØµÙ… 5 Ù†Ù‚Ø§Ø·.');
    
    document.getElementById('game-overlay').classList.add('hidden');
    document.getElementById('searching-ui').classList.add('hidden');
    document.getElementById('challenge-active-card').classList.remove('hidden');
};

// ============================================
// 16. ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©
// ============================================
function updateAIRemainingDisplay() {
    const aiRemainingElement = document.getElementById('ai-remaining');
    if (aiRemainingElement) {
        aiRemainingElement.textContent = dailyAIRemaining;
        
        // ØªØºÙŠÙŠØ± Ø§Ù„Ù„ÙˆÙ† Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ù…Ù†Ø®ÙØ¶Ø©
        if (dailyAIRemaining <= 3) {
            aiRemainingElement.style.backgroundColor = '#f87171';
            aiRemainingElement.style.color = 'white';
        } else if (dailyAIRemaining <= 7) {
            aiRemainingElement.style.backgroundColor = '#fbbf24';
            aiRemainingElement.style.color = 'black';
        } else {
            aiRemainingElement.style.backgroundColor = 'white';
            aiRemainingElement.style.color = '#10b981';
        }
    }
}

// ============================================
// 17. Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©
// ============================================
async function resetDailyAI() {
    const today = new Date().toISOString().split('T')[0];
    
    if (userData.lastAIReset !== today) {
        if (userData.isPremium && isPremiumValid(userData)) {
            dailyAIRemaining = 15;
        } else {
            dailyAIRemaining = 10;
        }
        
        await updateDoc(doc(db, "users", currentUser.uid), {
            dailyAIRemaining: dailyAIRemaining,
            lastAIReset: today
        });
        
        userData.dailyAIRemaining = dailyAIRemaining;
        userData.lastAIReset = today;
        
        updateAIRemainingDisplay();
    }
}

// ============================================
// 18. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
// ============================================
async function checkDailyAI() {
    const today = new Date().toISOString().split('T')[0];
    
    if (userData.lastAIReset !== today) {
        await resetDailyAI();
    } else {
        dailyAIRemaining = userData.dailyAIRemaining || 
            (userData.isPremium && isPremiumValid(userData) ? 15 : 10);
        updateAIRemainingDisplay();
    }
}

// ============================================
// 19. Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø§Ø´Ø© VS
// ============================================
function showVSscreen(player1, player2) {
    document.getElementById('vs-p1-img').src = player1.photo;
    document.getElementById('vs-p1-name').textContent = player1.name;
    
    document.getElementById('vs-p2-img').src = player2.photo;
    document.getElementById('vs-p2-name').textContent = player2.name;
    
    document.getElementById('vs-screen').classList.remove('hidden');
}

// ============================================
// 20. ØªØ¹ÙŠÙŠÙ† Ù†ÙˆØ¹ Ø§Ù„Ø³Ø¤Ø§Ù„
// ============================================
window.setQType = (type) => {
    window.currentQType = type;
    
    // ØªØ­Ø¯ÙŠØ« Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù†ÙˆØ¹
    const mcqBtn = document.getElementById('btn-mcq');
    const tfBtn = document.getElementById('btn-tf');
    
    if (type === 'mcq') {
        mcqBtn.style.borderColor = '#4F46E5';
        mcqBtn.style.color = '#4F46E5';
        mcqBtn.style.backgroundColor = '#EEF2FF';
        
        tfBtn.style.borderColor = '#E0E7FF';
        tfBtn.style.color = '#6B7280';
        tfBtn.style.backgroundColor = 'white';
    } else {
        tfBtn.style.borderColor = '#4F46E5';
        tfBtn.style.color = '#4F46E5';
        tfBtn.style.backgroundColor = '#EEF2FF';
        
        mcqBtn.style.borderColor = '#E0E7FF';
        mcqBtn.style.color = '#6B7280';
        mcqBtn.style.backgroundColor = 'white';
    }
};

// ============================================
// Ø§Ù„ØªÙ†ÙÙŠØ° Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
// ============================================

// Ø¥Ø¶Ø§ÙØ© Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ checkDailyAI Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
// (Ø³ÙŠØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ø²Ø¡ ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ)

// ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù†ÙˆØ¹ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
window.setQType('mcq');

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
// (Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ù‡Ø°Ø§ ÙÙŠ onAuthStateChanged)


// ============================================
// Ù†Ø¸Ø§Ù… Ø§Ù„Ù„Ø¹Ø¨ Ø¶Ø¯ Ù„Ø§Ø¹Ø¨ Ø­Ù‚ÙŠÙ‚ÙŠ - Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ
// ============================================

// ====== 1. Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ======
let matchmakingInterval = null;
let currentSearch = null;
let gameConnection = null;
let opponentHeartbeatInterval = null;
let lastHeartbeatTime = null;
let reconnectionAttempts = 0;
const MAX_RECONNECTION_ATTEMPTS = 3;

// ====== 2. Ù†Ø¸Ø§Ù… Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù„Ø§Ø¹Ø¨ Ø­Ù‚ÙŠÙ‚ÙŠ ======
window.startMatchmaking = async function(type) {
    if (type === 'online') {
        const subject = document.getElementById('challenge-subject').value;
        const questionType = window.currentQType || 'mcq';
        
        if (!subject) {
            showBeautifulAlert('warning', 'ØªÙ†Ø¨ÙŠÙ‡', 'ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø§Ø¯Ø© Ø£ÙˆÙ„Ø§Ù‹');
            return;
        }
        
        if (!questionType) {
            showBeautifulAlert('warning', 'ØªÙ†Ø¨ÙŠÙ‡', 'ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø£ÙˆÙ„Ø§Ù‹');
            return;
        }
        
        // Ø¥Ø®ÙØ§Ø¡ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ­Ø¯ÙŠ ÙˆØ¥Ø¸Ù‡Ø§Ø± ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¨Ø­Ø«
        document.getElementById('challenge-active-card').classList.add('hidden');
        document.getElementById('searching-ui').classList.remove('hidden');
        
        // ØªØ­Ø¯ÙŠØ« Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø¨Ø­Ø«
        const searchMsg = document.getElementById('search-msg');
        searchMsg.textContent = 'ğŸ” Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø®ØµÙ… Ù…Ù†Ø§Ø³Ø¨...';
        
        // ØªØ¹Ø±ÙŠÙ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        currentSearch = {
            userId: currentUser.uid,
            name: userData.name,
            photo: userData.photo,
            grade: userData.grade,
            subject: subject,
            questionType: questionType,
            timestamp: Date.now(),
            isPremium: userData.isPremium && isPremiumValid(userData),
            searchId: generateSearchId()
        };
        
        // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Firebase
        await registerSearch(currentSearch);
        
        // Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù†Ø´Ø·
        startActiveSearch();
        
        // Ø¥Ø¸Ù‡Ø§Ø± Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨Ø­Ø«
        startSearchCounter();
        
    } else if (type === 'ai') {
        // Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ ÙŠØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡Ùˆ
        // ... Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ Ø³Ø§Ø¨Ù‚Ø§Ù‹
    }
};

// ØªÙˆÙ„ÙŠØ¯ Ù…Ø¹Ø±Ù ÙØ±ÙŠØ¯ Ù„Ù„Ø¨Ø­Ø«
function generateSearchId() {
    return 'search_' + currentUser.uid + '_' + Date.now();
}

// ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
async function registerSearch(searchData) {
    try {
        // Ø­Ø°Ù Ø£ÙŠ Ø¨Ø­Ø« Ø³Ø§Ø¨Ù‚ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
        const previousSearchQuery = query(
            collection(db, "matchmaking_searches"),
            where("userId", "==", currentUser.uid)
        );
        const previousSearchSnap = await getDocs(previousSearchQuery);
        
        if (!previousSearchSnap.empty) {
            const batch = writeBatch(db);
            previousSearchSnap.forEach(doc => {
                batch.delete(doc.ref);
            });
            await batch.commit();
        }
        
        // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¬Ø¯ÙŠØ¯
        const searchRef = doc(db, "matchmaking_searches", searchData.searchId);
        await setDoc(searchRef, {
            ...searchData,
            status: 'searching',
            createdAt: serverTimestamp(),
            expiresAt: Timestamp.fromDate(new Date(Date.now() + 2 * 60 * 1000)) // 2 Ø¯Ù‚Ø§Ø¦Ù‚
        });
        
        console.log("âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¨Ø­Ø« Ø¨Ù†Ø¬Ø§Ø­");
        
    } catch (error) {
        console.error("âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¨Ø­Ø«:", error);
    }
}

// Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù†Ø´Ø· Ø¹Ù† Ø®ØµÙ…
async function startActiveSearch() {
    if (matchmakingInterval) clearInterval(matchmakingInterval);
    
    matchmakingInterval = setInterval(async () => {
        try {
            if (!currentSearch) {
                clearInterval(matchmakingInterval);
                return;
            }
            
            // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø®ØµÙ… Ù…Ù†Ø§Ø³Ø¨
            const opponent = await findSuitableOpponent();
            
            if (opponent) {
                clearInterval(matchmakingInterval);
                await createMatch(opponent);
            } else {
                // ØªØ­Ø¯ÙŠØ« Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø¨Ø­Ø«
                updateSearchMessage();
            }
            
        } catch (error) {
            console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«:", error);
        }
    }, 2000); // Ø¨Ø­Ø« ÙƒÙ„ 2 Ø«Ø§Ù†ÙŠØ©
}

// Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø®ØµÙ… Ù…Ù†Ø§Ø³Ø¨
async function findSuitableOpponent() {
    try {
        const q = query(
            collection(db, "matchmaking_searches"),
            where("userId", "!=", currentUser.uid),
            where("status", "==", "searching"),
            where("subject", "==", currentSearch.subject),
            where("questionType", "==", currentSearch.questionType)
        );
        
        const querySnapshot = await getDocs(q);
        
        if (querySnapshot.empty) {
            return null;
        }
        
        let bestMatch = null;
        let bestScore = -1;
        
        querySnapshot.forEach(doc => {
            const opponentData = doc.data();
            
            // Ø­Ø³Ø§Ø¨ Ø¯Ø±Ø¬Ø© Ø§Ù„ØªØ·Ø§Ø¨Ù‚
            const matchScore = calculateMatchScore(opponentData);
            
            if (matchScore > bestScore) {
                bestScore = matchScore;
                bestMatch = {
                    id: doc.id,
                    ...opponentData
                };
            }
        });
        
        // Ø¥Ø°Ø§ ÙˆØ¬Ø¯Ù†Ø§ Ø®ØµÙ… Ù…Ù†Ø§Ø³Ø¨
        if (bestMatch && bestScore >= 0) {
            // Ø­Ø°Ù Ø¨Ø­Ø« Ø§Ù„Ø®ØµÙ…
            await deleteDoc(doc(db, "matchmaking_searches", bestMatch.id));
            
            return bestMatch;
        }
        
        return null;
        
    } catch (error) {
        console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø®ØµÙ…:", error);
        return null;
    }
}

// Ø­Ø³Ø§Ø¨ Ø¯Ø±Ø¬Ø© Ø§Ù„ØªØ·Ø§Ø¨Ù‚ Ø¨ÙŠÙ† Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†
function calculateMatchScore(opponentData) {
    let score = 0;
    
    // 1. Ù†ÙØ³ Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ© (40 Ù†Ù‚Ø·Ø©)
    if (opponentData.grade === currentSearch.grade) {
        score += 40;
    } 
    // 2. Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…Ø´ØªØ±ÙƒØ© Ø¨ÙŠÙ† Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ù„Ø¹Ù„Ù…ÙŠ ÙˆØ§Ù„Ø£Ø¯Ø¨ÙŠ (20 Ù†Ù‚Ø·Ø©)
    else if (['6sci', '6lit'].includes(currentSearch.grade) && 
             ['6sci', '6lit'].includes(opponentData.grade) &&
             ['Ø§Ø³Ù„Ø§Ù…ÙŠØ©', 'Ø¹Ø±Ø¨ÙŠ', 'Ø§Ù†ÙƒÙ„ÙŠØ²ÙŠ'].includes(currentSearch.subject)) {
        score += 20;
    }
    // 3. Ø®ØµÙ… Ù…Ù† Ù…Ø±Ø­Ù„Ø© Ù…Ø®ØªÙ„ÙØ© (ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­) = 0 Ù†Ù‚Ø·Ø©
    else {
        return -1; // ØºÙŠØ± Ù…Ù†Ø§Ø³Ø¨
    }
    
    // 4. Ù†ÙØ³ Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø¹Ø§Ø¯ÙŠ/Ù…Ù…ÙŠØ²) (10 Ù†Ù‚Ø·Ø©)
    if (opponentData.isPremium === currentSearch.isPremium) {
        score += 10;
    }
    
    // 5. ÙØ±Ù‚ Ø§Ù„ÙˆÙ‚Øª ÙÙŠ Ø§Ù„Ø¨Ø­Ø« (Ø£Ø³Ø±Ø¹ = Ø£ÙØ¶Ù„) (10 Ù†Ù‚Ø·Ø©)
    const timeDiff = Math.abs(Date.now() - opponentData.timestamp);
    if (timeDiff < 30000) { // Ø£Ù‚Ù„ Ù…Ù† 30 Ø«Ø§Ù†ÙŠØ©
        score += 10;
    } else if (timeDiff < 60000) { // Ø£Ù‚Ù„ Ù…Ù† Ø¯Ù‚ÙŠÙ‚Ø©
        score += 5;
    }
    
    return score;
}

// ØªØ­Ø¯ÙŠØ« Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø¨Ø­Ø«
function updateSearchMessage() {
    if (!currentSearch) return;
    
    const searchMsg = document.getElementById('search-msg');
    const searchTime = Math.floor((Date.now() - currentSearch.timestamp) / 1000);
    
    const messages = [
        'ğŸ” Ù†Ø¨Ø­Ø« Ø¹Ù† Ø®ØµÙ… Ø¨Ù†ÙØ³ Ø§Ù„ØµÙ ÙˆØ§Ù„Ù…Ø§Ø¯Ø©...',
        'ğŸ‘¥ Ù†Ø¨Ø­Ø« Ø¹Ù† Ù„Ø§Ø¹Ø¨ Ø­Ù‚ÙŠÙ‚ÙŠ...',
        'ğŸ® Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø®ØµÙ… Ù…Ù†Ø§Ø³Ø¨...',
        'â³ Ø§Ù„Ø¨Ø­Ø« Ù‚Ø¯ ÙŠØ³ØªØºØ±Ù‚ Ø¨Ø¶Ø¹ Ø«ÙˆØ§Ù†ÙŠ...'
    ];
    
    // ØªØºÙŠÙŠØ± Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙƒÙ„ 5 Ø«ÙˆØ§Ù†ÙŠ
    const messageIndex = Math.floor(searchTime / 5) % messages.length;
    searchMsg.textContent = messages[messageIndex];
    
    // Ø¥Ø¶Ø§ÙØ© Ø¹Ø¯Ø§Ø¯ Ø§Ù„ÙˆÙ‚Øª
    const timerElement = document.querySelector('#searching-ui .text-xl');
    if (timerElement) {
        timerElement.textContent = `â±ï¸ ${Math.floor(searchTime / 60)}:${(searchTime % 60).toString().padStart(2, '0')}`;
    }
}

// Ø¨Ø¯Ø¡ Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨Ø­Ø«
function startSearchCounter() {
    const counterDiv = document.createElement('div');
    counterDiv.className = 'mt-4 text-sm text-gray-500';
    counterDiv.innerHTML = '<span class="font-bold">â±ï¸ 0:00</span>';
    
    const searchingUI = document.getElementById('searching-ui');
    const existingCounter = searchingUI.querySelector('.text-sm');
    if (existingCounter) existingCounter.remove();
    
    searchingUI.appendChild(counterDiv);
    
    let seconds = 0;
    const counterInterval = setInterval(() => {
        seconds++;
        const minutes = Math.floor(seconds / 60);
        const remainingSeconds = seconds % 60;
        counterDiv.innerHTML = `<span class="font-bold">â±ï¸ ${minutes}:${remainingSeconds.toString().padStart(2, '0')}</span>`;
        
        // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¨Ø­Ø« Ø¨Ø¹Ø¯ Ø¯Ù‚ÙŠÙ‚ØªÙŠÙ†
        if (seconds >= 120) {
            clearInterval(counterInterval);
            cancelSearch('Ø§Ù†ØªÙ‡Ù‰ ÙˆÙ‚Øª Ø§Ù„Ø¨Ø­Ø«');
        }
    }, 1000);
}

// ====== 3. Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø© ======
async function createMatch(opponentData) {
    try {
        // Ø¥Ø®ÙØ§Ø¡ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¨Ø­Ø«
        document.getElementById('searching-ui').classList.add('hidden');
        
        // Ø­Ø°Ù Ø¨Ø­Ø« Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
        if (currentSearch) {
            await deleteDoc(doc(db, "matchmaking_searches", currentSearch.searchId));
        }
        
        // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¹Ø±Ù ÙØ±ÙŠØ¯ Ù„Ù„Ù…Ø¨Ø§Ø±Ø§Ø©
        const matchId = 'match_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©
        const questionCount = 10; // 10 Ø£Ø³Ø¦Ù„Ø© Ù„ÙƒÙ„ Ù…Ø¨Ø§Ø±Ø§Ø©
        await loadGameQuestions(currentSearch.subject, currentSearch.questionType, questionCount);
        
        // Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø©
        const matchData = {
            matchId: matchId,
            player1: {
                uid: currentUser.uid,
                name: userData.name,
                photo: userData.photo,
                grade: userData.grade,
                score: 0,
                ready: false
            },
            player2: {
                uid: opponentData.userId,
                name: opponentData.name,
                photo: opponentData.photo,
                grade: opponentData.grade,
                score: 0,
                ready: false
            },
            subject: currentSearch.subject,
            questionType: currentSearch.questionType,
            questions: gameQuestions.map(q => ({
                id: q.id,
                question: q.question,
                type: q.type,
                answers: q.answers || [],
                correct: q.correct
            })),
            currentQuestion: 0,
            status: 'waiting',
            createdAt: serverTimestamp(),
            lastActivity: serverTimestamp(),
            turn: currentUser.uid, // ÙŠØ¨Ø¯Ø£ Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø°ÙŠ ÙˆØ¬Ø¯ Ø§Ù„Ø®ØµÙ…
            answers: {},
            timer: 15,
            gameStarted: false
        };
        
        // Ø­ÙØ¸ Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø© ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        const matchRef = doc(db, "online_matches", matchId);
        await setDoc(matchRef, matchData);
        
        // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        gameId = matchId;
        opponentId = opponentData.userId;
        opponentData = {
            name: opponentData.name,
            photo: opponentData.photo,
            uid: opponentData.userId
        };
        gameType = 'online';
        
        // Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø§Ø´Ø© VS
        showVSscreen(userData, opponentData);
        
        // Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø©
        startMatchListener(matchId);
        
        // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ø®ØµÙ…
        await sendMatchNotification(opponentData.userId, matchId, userData.name);
        
    } catch (error) {
        console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø©:", error);
        showBeautifulAlert('error', 'Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø©');
        cancelSearch();
    }
}

// ====== 4. Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ù…Ø¨Ø§Ø±Ø§Ø© (Ø§ØªØµØ§Ù„ ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ) ======
function startMatchListener(matchId) {
    if (gameConnection) {
        gameConnection();
    }
    
    const matchRef = doc(db, "online_matches", matchId);
    
    gameConnection = onSnapshot(matchRef, async (snapshot) => {
        if (!snapshot.exists()) {
            // Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø© Ù…Ø­Ø°ÙˆÙØ©
            handleMatchEnded('ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø© Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ø®ØµÙ…');
            return;
        }
        
        const matchData = snapshot.data();
        const currentTime = Date.now();
        
        // ØªØ­Ø¯ÙŠØ« ÙˆÙ‚Øª Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø£Ø®ÙŠØ±
        if (matchData.lastActivity) {
            const lastActivityTime = matchData.lastActivity.toDate().getTime();
            const inactiveTime = currentTime - lastActivityTime;
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø®ØµÙ… ØºÙŠØ± Ù†Ø´Ø· Ù„Ø£ÙƒØ«Ø± Ù…Ù† 30 Ø«Ø§Ù†ÙŠØ©
            if (inactiveTime > 30000 && !matchData.gameStarted) {
                handleOpponentDisconnected();
                return;
            }
        }
        
        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø©
        switch (matchData.status) {
            case 'waiting':
                handleWaitingState(matchData);
                break;
                
            case 'starting':
                handleStartingState(matchData);
                break;
                
            case 'in_progress':
                handleInProgressState(matchData);
                break;
                
            case 'finished':
                handleFinishedState(matchData);
                break;
                
            case 'disconnected':
                handleDisconnectedState(matchData);
                break;
        }
    });
}

// ====== 5. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø© ======

// Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±
function handleWaitingState(matchData) {
    const isPlayer1 = matchData.player1.uid === currentUser.uid;
    const player = isPlayer1 ? matchData.player1 : matchData.player2;
    const opponent = isPlayer1 ? matchData.player2 : matchData.player1;
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¬Ø§Ù‡Ø²ÙŠØ© Ø§Ù„Ø®ØµÙ…
    if (opponent.ready && !player.ready) {
        showBeautifulAlert('info', 'Ø§Ù„Ø®ØµÙ… Ø¬Ø§Ù‡Ø²', `${opponent.name} Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¨Ø¯Ø¡!`);
    }
    
    // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±
    updateWaitingUI(matchData);
}

// Ø­Ø§Ù„Ø© Ø§Ù„Ø¨Ø¯Ø¡
async function handleStartingState(matchData) {
    // Ø¥Ø®ÙØ§Ø¡ Ø´Ø§Ø´Ø© VS ÙˆØ¨Ø¯Ø¡ Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø©
    document.getElementById('vs-screen').classList.add('hidden');
    
    // Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø©
    startOnlineGame(matchData);
    
    // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ù„Ù‰ Ø¬Ø§Ù‡Ø²
    await updateMatchStatus(gameId, {
        [`player${matchData.player1.uid === currentUser.uid ? '1' : '2'}.ready`]: true
    });
}

// Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø© Ù‚ÙŠØ¯ Ø§Ù„ØªÙ‚Ø¯Ù…
function handleInProgressState(matchData) {
    if (!isGameActive) {
        return;
    }
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†ØªØ§Ø¦Ø¬
    const isPlayer1 = matchData.player1.uid === currentUser.uid;
    const myScore = isPlayer1 ? matchData.player1.score : matchData.player2.score;
    const opponentScore = isPlayer1 ? matchData.player2.score : matchData.player1.score;
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø©
    document.getElementById('game-my-score').textContent = myScore;
    document.getElementById('game-op-score').textContent = opponentScore;
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª
    checkOpponentAnswer(matchData);
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø©
    if (matchData.currentQuestion >= matchData.questions.length) {
        endOnlineGame(matchData);
    }
}

// Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø© Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØ©
function handleFinishedState(matchData) {
    if (!matchData.winner) return;
    
    const isPlayer1 = matchData.player1.uid === currentUser.uid;
    const isWinner = (isPlayer1 && matchData.winner === 'player1') || 
                    (!isPlayer1 && matchData.winner === 'player2');
    
    // Ø¥Ø®ÙØ§Ø¡ Ø´Ø§Ø´Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©
    document.getElementById('game-overlay').classList.add('hidden');
    
    // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
    showFinalResult(matchData, isWinner);
    
    // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù†ØªÙŠØ¬Ø©
    sendGameResultNotification(matchData, isWinner);
}

// Ø­Ø§Ù„Ø© Ø§Ù†Ù‚Ø·Ø§Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„
function handleDisconnectedState(matchData) {
    const disconnectedPlayer = matchData.disconnectedPlayer;
    const isMe = disconnectedPlayer === currentUser.uid;
    
    if (isMe) {
        showBeautifulAlert('error', 'Ø§Ù†Ù‚Ø·Ø§Ø¹', 'Ø§Ù†Ù‚Ø·Ø¹ Ø§ØªØµØ§Ù„Ùƒ Ø¨Ø§Ù„Ù„Ø¹Ø¨Ø©');
        cancelSearch();
    } else {
        showBeautifulAlert('warning', 'Ø§Ù†Ù‚Ø·Ø¹ Ø§Ù„Ø®ØµÙ…', 'Ø§Ù†Ù‚Ø·Ø¹ Ø§ØªØµØ§Ù„ Ø§Ù„Ø®ØµÙ…. Ø§Ù†ØªØ¸Ø± 30 Ø«Ø§Ù†ÙŠØ© Ø£Ùˆ Ø§Ø®Ø±Ø¬');
        
        // Ø¨Ø¯Ø¡ Ù…Ø¤Ù‚Øª Ø§Ù„Ø§Ù†Ù‚Ø·Ø§Ø¹
        startDisconnectTimer(matchData);
    }
}

// ====== 6. Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø© Ø¹Ø¨Ø± Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª ======
function startOnlineGame(matchData) {
    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù„Ø¹Ø¨Ø©
    myScore = 0;
    opponentScore = 0;
    currentQuestionIndex = 0;
    playerAnswers = [];
    opponentAnswers = [];
    isGameActive = true;
    
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©
    gameQuestions = matchData.questions || [];
    
    // Ø¥Ø¸Ù‡Ø§Ø± ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©
    document.getElementById('game-overlay').classList.remove('hidden');
    
    // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†
    const isPlayer1 = matchData.player1.uid === currentUser.uid;
    
    document.getElementById('game-p1-img').src = isPlayer1 ? userData.photo : matchData.player2.photo;
    document.getElementById('p1-name').textContent = isPlayer1 ? userData.name : matchData.player2.name;
    document.getElementById('game-my-score').textContent = myScore;
    
    document.getElementById('game-p2-img').src = isPlayer1 ? matchData.player2.photo : userData.photo;
    document.getElementById('p2-name').textContent = isPlayer1 ? matchData.player2.name : userData.name;
    document.getElementById('game-op-score').textContent = opponentScore;
    
    // Ø²Ø± Ø§Ù„Ø§Ù†Ø³Ø­Ø§Ø¨
    const withdrawBtn = document.getElementById('withdraw-game-btn');
    withdrawBtn.classList.remove('hidden');
    withdrawBtn.onclick = () => withdrawFromOnlineGame(matchData.matchId);
    
    // Ø¨Ø¯Ø¡ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø£ÙˆÙ„
    showNextOnlineQuestion(matchData);
    
    // Ø¨Ø¯Ø¡ Ù†Ø¸Ø§Ù… Heartbeat
    startHeartbeat(matchData.matchId);
}

// ====== 7. Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø¹Ø¨Ø± Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª ======
function showNextOnlineQuestion(matchData) {
    if (!isGameActive || currentQuestionIndex >= gameQuestions.length) {
        return;
    }
    
    const question = gameQuestions[currentQuestionIndex];
    
    // ØªØ­Ø¯ÙŠØ« ØªÙ‚Ø¯Ù… Ø§Ù„Ø³Ø¤Ø§Ù„
    document.getElementById('q-progress').textContent = `${currentQuestionIndex + 1} / ${gameQuestions.length}`;
    document.getElementById('q-text').textContent = question.question;
    
    const answersContainer = document.getElementById('answers-container');
    answersContainer.innerHTML = '';
    
    // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
    document.getElementById('waiting-msg').classList.add('hidden');
    document.getElementById('ai-thinking-msg').classList.add('hidden');
    
    // Ø¹Ø±Ø¶ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª
    if (question.type === 'mcq') {
        question.answers.forEach((answer, index) => {
            const btn = document.createElement('button');
            btn.className = 'w-full bg-white border-2 border-gray-200 rounded-xl p-4 text-right font-bold text-gray-700 hover:bg-gray-50 transition answer-neutral';
            btn.textContent = answer;
            btn.onclick = () => selectOnlineAnswer(index, question, matchData.matchId);
            answersContainer.appendChild(btn);
        });
    } else {
        const trueBtn = document.createElement('button');
        trueBtn.className = 'w-full bg-white border-2 border-gray-200 rounded-xl p-4 text-right font-bold text-gray-700 hover:bg-gray-50 transition answer-neutral';
        trueBtn.textContent = 'ØµØ­';
        trueBtn.onclick = () => selectOnlineAnswer(true, question, matchData.matchId);
        answersContainer.appendChild(trueBtn);
        
        const falseBtn = document.createElement('button');
        falseBtn.className = 'w-full bg-white border-2 border-gray-200 rounded-xl p-4 text-right font-bold text-gray-700 hover:bg-gray-50 transition answer-neutral';
        falseBtn.textContent = 'Ø®Ø·Ø£';
        falseBtn.onclick = () => selectOnlineAnswer(false, question, matchData.matchId);
        answersContainer.appendChild(falseBtn);
    }
    
    // Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø¤Ù‚Øª
    startOnlineTimer(matchData.matchId, question);
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    updateCurrentQuestion(matchData.matchId, currentQuestionIndex);
}

// ====== 8. Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø¤Ù‚Øª Ø¹Ø¨Ø± Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª ======
function startOnlineTimer(matchId, question) {
    let timeLeft = 15;
    document.getElementById('game-timer').textContent = timeLeft;
    
    // Ø¥Ø±Ø³Ø§Ù„ Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø¤Ù‚Øª Ù„Ù„Ø®ØµÙ…
    sendTimerStart(matchId, timeLeft);
    
    if (gameTimerInterval) clearInterval(gameTimerInterval);
    
    gameTimerInterval = setInterval(async () => {
        timeLeft--;
        document.getElementById('game-timer').textContent = timeLeft;
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¤Ù‚Øª Ù„Ù„Ø®ØµÙ…
        if (timeLeft % 5 === 0) {
            updateTimer(matchId, timeLeft);
        }
        
        // Ø¹Ù†Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ÙˆÙ‚Øª
        if (timeLeft <= 0) {
            clearInterval(gameTimerInterval);
            
            // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© ÙƒØ®Ø§Ø·Ø¦Ø©
            await handleTimeoutOnline(matchId, question);
            
            // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠ
            currentQuestionIndex++;
            if (currentQuestionIndex < gameQuestions.length) {
                setTimeout(() => {
                    showNextOnlineQuestion(matchData);
                }, 2000);
            } else {
                endOnlineGame();
            }
        }
    }, 1000);
}

// ====== 9. Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¹Ø¨Ø± Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª ======
async function selectOnlineAnswer(answer, question, matchId) {
    if (!isGameActive) return;
    
    clearInterval(gameTimerInterval);
    
    const isCorrect = answer === question.correct;
    
    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©
    playerAnswers.push({
        questionIndex: currentQuestionIndex,
        answer: answer,
        isCorrect: isCorrect,
        time: Date.now()
    });
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†ØªÙŠØ¬Ø©
    if (isCorrect) {
        myScore++;
        document.getElementById('game-my-score').textContent = myScore;
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†ØªÙŠØ¬Ø© ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        await updatePlayerScore(matchId, myScore);
    }
    
    // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ù„Ù„Ø®ØµÙ…
    await sendAnswerToOpponent(matchId, currentQuestionIndex, answer, isCorrect);
    
    // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø©
    highlightAnswers(answer, question, isCorrect);
    
    // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠ Ø¨Ø¹Ø¯ ØªØ£Ø®ÙŠØ±
    setTimeout(async () => {
        currentQuestionIndex++;
        
        if (currentQuestionIndex < gameQuestions.length) {
            showNextOnlineQuestion(matchData);
        } else {
            await endOnlineGame();
        }
    }, 2000);
}

// ====== 10. Ù†Ø¸Ø§Ù… Heartbeat (Ù†Ø¨Ø¶Ø§Øª Ø§Ù„Ø­ÙŠØ§Ø©) ======
function startHeartbeat(matchId) {
    if (opponentHeartbeatInterval) clearInterval(opponentHeartbeatInterval);
    
    // Ø¥Ø±Ø³Ø§Ù„ Ù†Ø¨Ø¶Ø© ÙƒÙ„ 5 Ø«ÙˆØ§Ù†ÙŠ
    opponentHeartbeatInterval = setInterval(async () => {
        try {
            await updateDoc(doc(db, "online_matches", matchId), {
                lastActivity: serverTimestamp(),
                [`player${matchData.player1.uid === currentUser.uid ? '1' : '2'}.lastHeartbeat`]: Date.now()
            });
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù†Ø¨Ø¶Ø§Øª Ø§Ù„Ø®ØµÙ…
            await checkOpponentHeartbeat(matchId);
            
        } catch (error) {
            console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Heartbeat:", error);
        }
    }, 5000);
}

// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù†Ø¨Ø¶Ø§Øª Ø§Ù„Ø®ØµÙ…
async function checkOpponentHeartbeat(matchId) {
    try {
        const matchSnap = await getDoc(doc(db, "online_matches", matchId));
        if (!matchSnap.exists()) return;
        
        const matchData = matchSnap.data();
        const isPlayer1 = matchData.player1.uid === currentUser.uid;
        const opponentHeartbeat = isPlayer1 ? matchData.player2.lastHeartbeat : matchData.player1.lastHeartbeat;
        
        if (opponentHeartbeat) {
            const timeSinceHeartbeat = Date.now() - opponentHeartbeat;
            
            // Ø¥Ø°Ø§ Ù…Ø± Ø£ÙƒØ«Ø± Ù…Ù† 30 Ø«Ø§Ù†ÙŠØ© Ø¨Ø¯ÙˆÙ† Ù†Ø¨Ø¶Ø§Øª
            if (timeSinceHeartbeat > 30000) {
                handleOpponentDisconnected();
            }
        }
    } catch (error) {
        console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Heartbeat:", error);
    }
}

// ====== 11. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù†Ù‚Ø·Ø§Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„ ======
function handleOpponentDisconnected() {
    if (!isGameActive) return;
    
    showBeautifulAlert('warning', 'Ø§Ù†Ù‚Ø·Ø¹ Ø§Ù„Ø®ØµÙ…', 'Ø§Ù†Ù‚Ø·Ø¹ Ø§ØªØµØ§Ù„ Ø§Ù„Ø®ØµÙ…. Ø§Ù†ØªØ¸Ø± 30 Ø«Ø§Ù†ÙŠØ©...');
    
    // Ø¨Ø¯Ø¡ Ù…Ø¤Ù‚Øª Ø§Ù„Ø§Ù†Ù‚Ø·Ø§Ø¹
    const disconnectTimer = setTimeout(async () => {
        if (isGameActive) {
            // Ø¥Ø°Ø§ Ù„Ù… ÙŠØ¹Ø¯ Ø§Ù„Ø®ØµÙ… Ø®Ù„Ø§Ù„ 30 Ø«Ø§Ù†ÙŠØ©ØŒ Ø§Ø¹ØªØ¨Ø§Ø±Ùƒ Ø§Ù„ÙØ§Ø¦Ø²
            await declareWinnerByDisconnect();
        }
    }, 30000);
    
    // Ø²Ø± Ø§Ù„Ø®Ø±ÙˆØ¬ Ø§Ù„Ø³Ø±ÙŠØ¹
    const quickExitBtn = document.createElement('button');
    quickExitBtn.className = 'mt-4 bg-red-500 text-white px-4 py-2 rounded-lg';
    quickExitBtn.textContent = 'Ø®Ø±ÙˆØ¬ Ø³Ø±ÙŠØ¹ (+10 Ù†Ù‚Ø§Ø·)';
    quickExitBtn.onclick = async () => {
        clearTimeout(disconnectTimer);
        await declareWinnerByDisconnect();
    };
    
    document.querySelector('#game-overlay .p-5').appendChild(quickExitBtn);
}

async function declareWinnerByDisconnect() {
    const pointsGained = 10;
    
    await updateUserPoints(pointsGained);
    
    showBeautifulAlert('success', 'ÙÙˆØ²', `ğŸ† ÙØ²Øª Ø¨Ø³Ø¨Ø¨ Ø§Ù†Ù‚Ø·Ø§Ø¹ Ø§Ù„Ø®ØµÙ…! +${pointsGained} Ù†Ù‚Ø§Ø·`);
    
    // Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø©
    await endMatch(gameId, 'disconnected');
    
    document.getElementById('game-overlay').classList.add('hidden');
    document.getElementById('challenge-active-card').classList.remove('hidden');
}

// ====== 12. Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø© ======
async function endOnlineGame() {
    isGameActive = false;
    
    // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ø¤Ù‚ØªØ§Øª
    if (gameTimerInterval) clearInterval(gameTimerInterval);
    if (opponentHeartbeatInterval) clearInterval(opponentHeartbeatInterval);
    if (gameConnection) gameConnection();
    
    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
    const finalMyScore = myScore;
    const finalOpponentScore = opponentScore;
    
    // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙØ§Ø¦Ø²
    let winner = null;
    let pointsGained = 0;
    
    if (finalMyScore > finalOpponentScore) {
        winner = currentUser.uid;
        pointsGained = finalMyScore * 2;
    } else if (finalMyScore < finalOpponentScore) {
        winner = opponentId;
        pointsGained = Math.floor(finalMyScore * 0.5);
    } else {
        pointsGained = finalMyScore;
    }
    
    // Ù…Ø¶Ø§Ø¹ÙØ© Ø§Ù„Ù†Ù‚Ø§Ø· Ù„Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ† Ø§Ù„Ù…Ù…ÙŠØ²ÙŠÙ†
    if (userData.isPremium && isPremiumValid(userData)) {
        pointsGained *= 2;
    }
    
    // ØªØ­Ø¯ÙŠØ« Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    await updateUserPoints(pointsGained);
    
    // ØªØ­Ø¯ÙŠØ« Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø©
    await updateMatchResult(gameId, winner, {
        player1Score: matchData.player1.uid === currentUser.uid ? finalMyScore : finalOpponentScore,
        player2Score: matchData.player2.uid === currentUser.uid ? finalMyScore : finalOpponentScore
    });
    
    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
    showFinalResultOnline(finalMyScore, finalOpponentScore, pointsGained);
}

// ====== 13. Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¨Ø­Ø« ======
window.cancelSearch = function(reason) {
    if (matchmakingInterval) {
        clearInterval(matchmakingInterval);
        matchmakingInterval = null;
    }
    
    if (currentSearch) {
        // Ø­Ø°Ù Ø§Ù„Ø¨Ø­Ø« Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        deleteDoc(doc(db, "matchmaking_searches", currentSearch.searchId));
        currentSearch = null;
    }
    
    document.getElementById('searching-ui').classList.add('hidden');
    document.getElementById('challenge-active-card').classList.remove('hidden');
    
    if (reason) {
        showBeautifulAlert('info', 'ØªÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡', reason);
    }
};

// ====== 14. Ù…Ø³Ø§Ø¹Ø¯Ø© Ø§Ù„Ø®ØµÙ… ======
async function sendAnswerToOpponent(matchId, questionIndex, answer, isCorrect) {
    try {
        await updateDoc(doc(db, "online_matches", matchId), {
            [`answers.q${questionIndex}_${currentUser.uid}`]: {
                answer: answer,
                isCorrect: isCorrect,
                timestamp: Date.now()
            }
        });
    } catch (error) {
        console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©:", error);
    }
}

async function updatePlayerScore(matchId, score) {
    try {
        const isPlayer1 = matchData.player1.uid === currentUser.uid;
        await updateDoc(doc(db, "online_matches", matchId), {
            [`player${isPlayer1 ? '1' : '2'}.score`]: score
        });
    } catch (error) {
        console.error("âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†ØªÙŠØ¬Ø©:", error);
    }
}

// ====== 15. Ø¯Ø¹Ù… Firebase Functions ======
// Ù‡Ø°Ù‡ ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ø¥Ø¹Ø¯Ø§Ø¯ Firebase Functions Ù…Ù†ÙØµÙ„
// Ø³Ø£Ù‚Ø¯Ù… Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ù‡Ù†Ø§

// Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø©
async function updateMatchStatus(matchId, updates) {
    try {
        await updateDoc(doc(db, "online_matches", matchId), updates);
    } catch (error) {
        console.error("âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø©:", error);
    }
}

// ====== 16. Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ======
function updateWaitingUI(matchData) {
    // ÙŠÙ…ÙƒÙ† ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù‡Ù†Ø§
    console.log("Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±...");
}

function showFinalResultOnline(myScore, opponentScore, pointsGained) {
    // ØªØ­Ø¯ÙŠØ« Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù†ØªÙŠØ¬Ø©
    document.getElementById('final-my-score').textContent = myScore;
    document.getElementById('final-op-score').textContent = opponentScore;
    document.getElementById('final-op-name').textContent = opponentData.name;
    
    // ØªØ­Ø¯ÙŠØ¯ Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø©
    let resultTitle, resultMsg, resultIcon;
    
    if (myScore > opponentScore) {
        resultTitle = 'ğŸ‰ Ø§Ù†ØªØµØ±Øª!';
        resultMsg = 'Ø£Ø­Ø³Ù†Øª! Ù„Ù‚Ø¯ ÙØ²Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø©';
        resultIcon = 'ğŸ†';
    } else if (myScore < opponentScore) {
        resultTitle = 'ğŸ’” Ø®Ø³Ø±Øª';
        resultMsg = 'Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ ÙÙŠ Ø§Ù„Ù…Ø±Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©';
        resultIcon = 'ğŸ˜¢';
    } else {
        resultTitle = 'ğŸ¤ ØªØ¹Ø§Ø¯Ù„';
        resultMsg = 'Ù†ØªÙŠØ¬Ø© Ù…ØªÙƒØ§ÙØ¦Ø© Ø¨ÙŠÙ† Ø§Ù„Ø·Ø±ÙÙŠÙ†';
        resultIcon = 'âš–ï¸';
    }
    
    document.getElementById('result-title').textContent = resultTitle;
    document.getElementById('result-msg').textContent = resultMsg;
    document.getElementById('result-icon-container').textContent = resultIcon;
    
    const resultPoints = document.getElementById('result-points-gained-text');
    resultPoints.textContent = pointsGained > 0 ? `+${pointsGained}` : `${pointsGained}`;
    
    // ØªÙ„ÙˆÙŠÙ† ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù†Ù‚Ø§Ø·
    const pointsBox = resultPoints.parentElement;
    if (pointsGained > 0) {
        pointsBox.style.background = 'linear-gradient(135deg, #fef3c7 0%, #fbbf24 100%)';
    } else if (pointsGained < 0) {
        pointsBox.style.background = 'linear-gradient(135deg, #fee2e2 0%, #f87171 100%)';
    } else {
        pointsBox.style.background = 'linear-gradient(135deg, #f1f5f9 0%, #cbd5e1 100%)';
    }
    
    // Ø¹Ø±Ø¶ Ø´Ø§Ø´Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬
    document.getElementById('result-screen').classList.remove('hidden');
}

// ====== 17. Ø§Ù„ØªÙ†Ø¸ÙŠÙ Ø¹Ù†Ø¯ Ø§Ù„Ø®Ø±ÙˆØ¬ ======
window.withdrawFromOnlineGame = async function(matchId) {
    if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø§Ù†Ø³Ø­Ø§Ø¨ØŸ Ø³ÙŠØªÙ… Ø®ØµÙ… 10 Ù†Ù‚Ø§Ø· ÙˆØ³ÙŠØ­ØµÙ„ Ø§Ù„Ø®ØµÙ… Ø¹Ù„Ù‰ 10 Ù†Ù‚Ø§Ø·.')) {
        return;
    }
    
    isGameActive = false;
    
    // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ø¤Ù‚ØªØ§Øª ÙˆØ§Ù„Ù…Ø³ØªÙ…Ø¹ÙŠÙ†
    if (gameTimerInterval) clearInterval(gameTimerInterval);
    if (opponentHeartbeatInterval) clearInterval(opponentHeartbeatInterval);
    if (gameConnection) gameConnection();
    
    // Ø®ØµÙ… 10 Ù†Ù‚Ø§Ø·
    await updateUserPoints(-10);
    
    // Ù…Ù†Ø­ Ø§Ù„Ø®ØµÙ… 10 Ù†Ù‚Ø§Ø·
    if (opponentId) {
        await updateDoc(doc(db, "users", opponentId), {
            points: increment(10)
        });
    }
    
    // Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø©
    await updateMatchStatus(matchId, {
        status: 'finished',
        winner: opponentId,
        reason: 'withdrawal'
    });
    
    showBeautifulAlert('warning', 'Ø§Ù†Ø³Ø­Ø§Ø¨', 'Ù„Ù‚Ø¯ Ø§Ù†Ø³Ø­Ø¨Øª Ù…Ù† Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø© ÙˆØªÙ… Ø®ØµÙ… 10 Ù†Ù‚Ø§Ø· Ù…Ù†Ùƒ.');
    
    document.getElementById('game-overlay').classList.add('hidden');
    document.getElementById('searching-ui').classList.add('hidden');
    document.getElementById('challenge-active-card').classList.remove('hidden');
};

// ====== 18. ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù… ======
// Ø¥Ø¶Ø§ÙØ© Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ù„Ù„ØªÙ‡ÙŠØ¦Ø© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
document.addEventListener('DOMContentLoaded', function() {
    // ØªÙ†Ø¸ÙŠÙ Ø£ÙŠ Ù…Ø¨Ø§Ø±ÙŠØ§Øª Ø³Ø§Ø¨Ù‚Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
    cleanupPreviousMatches();
});

async function cleanupPreviousMatches() {
    try {
        const q = query(
            collection(db, "online_matches"),
            where("status", "in", ['waiting', 'starting', 'in_progress']),
            where("player1.uid", "==", currentUser?.uid)
        );
        
        const snap = await getDocs(q);
        const batch = writeBatch(db);
        
        snap.forEach(doc => {
            batch.update(doc.ref, {
                status: 'cancelled',
                reason: 'cleanup'
            });
        });
        
        await batch.commit();
        
    } catch (error) {
        console.error("âŒ Ø®Ø·Ø£ ÙÙŠ ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ø¨Ø§Ø±ÙŠØ§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©:", error);
    }
}



    </script>
</body>
</html>
