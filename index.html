<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù‡ÙƒØ± Ø§Ù„ÙˆØ²Ø§Ø±ÙŠ</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">

    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        dark: '#0f172a',
                        darker: '#020617',
                        primary: '#3b82f6',
                        accent: '#22c55e',
                        danger: '#ef4444',
                        surface: '#1e293b'
                    },
                    fontFamily: {
                        sans: ['Tajawal', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        /* Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ§Øª ÙˆÙ…Ù†Ø¹ Ø§Ù„Ù†Ø³Ø® */
        body {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            font-family: 'Tajawal', sans-serif;
            background-color: #020617;
            color: white;
            overflow-x: hidden;
            overscroll-behavior-y: contain; 
        }

        /* Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙØ­Ø§Øª - Ø¥ØµÙ„Ø§Ø­ Ø§Ù„ØªØ¯Ø§Ø®Ù„ */
        .page-section {
            display: none; /* Ø¥Ø®ÙØ§Ø¡ Ø§ÙØªØ±Ø§Ø¶ÙŠ */
            width: 100%;
            min-height: 100vh;
            padding-bottom: 80px;
        }

        /* ÙƒÙ„Ø§Ø³ Ù„Ø¥Ø¬Ø¨Ø§Ø± Ø§Ù„Ø¹Ù†ØµØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¸Ù‡ÙˆØ± */
        .show-section {
            display: block !important;
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª */
        .input-field {
            background: #1e293b;
            border: 1px solid #334155;
            color: white;
            transition: all 0.3s ease;
        }
        .input-field:focus {
            border-color: #3b82f6;
            outline: none;
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.3);
        }

        /* Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9); /* Ø®Ù„ÙÙŠØ© Ø£ØºÙ…Ù‚ */
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: #1e293b;
            padding: 20px;
            border-radius: 16px;
            width: 90%;
            max-width: 400px;
            border: 1px solid #3b82f6;
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.2);
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø³ÙÙ„ÙŠ */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: #0f172a;
            border-top: 1px solid #1e293b;
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            z-index: 50;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.5);
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #64748b;
            font-size: 0.8rem;
            cursor: pointer;
            transition: color 0.3s;
        }

        .nav-item.active {
            color: #3b82f6;
        }
        
        .nav-item i {
            font-size: 1.2rem;
            margin-bottom: 4px;
        }

        /* Ø§Ù„ØºØ±ÙØ© */
        .room-stats {
            background: rgba(15, 23, 42, 0.9);
            border: 1px solid #3b82f6;
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 0.9rem;
            font-weight: bold;
            color: #3b82f6;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        .ready-btn {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
        }
        .ready-btn.is-ready {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .timer-bar {
            height: 4px;
            background: #22c55e;
            width: 100%;
            transition: width 1s linear;
        }
    </style>
</head>
<body>

    <!-- Loading Screen -->
    <div id="loading-screen" class="fixed inset-0 z-[200] bg-darker flex flex-col items-center justify-center">
        <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-primary"></div>
        <p class="mt-4 text-primary font-bold">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù‡ÙƒØ± Ø§Ù„ÙˆØ²Ø§Ø±ÙŠ...</p>
    </div>

    <!-- 1. Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ (Ù…Ù†ÙØµÙ„Ø© ØªÙ…Ø§Ù…Ø§Ù‹) -->
    <div id="auth-container" class="fixed inset-0 z-[60] bg-darker flex items-center justify-center p-4 show-section">
        <div class="w-full max-w-md bg-surface p-8 rounded-2xl shadow-2xl border border-gray-800 relative z-10">
            <h1 class="text-3xl font-bold text-center mb-2 text-primary">Ù‡ÙƒØ± Ø§Ù„ÙˆØ²Ø§Ø±ÙŠ</h1>
            <p class="text-center text-gray-400 mb-8 text-sm">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ­Ø¯ÙŠØ§Øª Ø§Ù„Ø£ÙˆÙ„ ÙÙŠ Ø§Ù„Ø¹Ø±Ø§Ù‚</p>

            <!-- Login Form -->
            <div id="login-form">
                <input type="email" id="login-email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" class="input-field w-full p-3 rounded-lg mb-4 text-left" dir="ltr">
                <input type="password" id="login-password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" class="input-field w-full p-3 rounded-lg mb-6 text-left" dir="ltr">
                <button onclick="handleLogin()" class="w-full bg-primary hover:bg-blue-600 text-white font-bold py-3 rounded-lg transition shadow-lg shadow-blue-500/30">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
                <p class="mt-4 text-center text-gray-400 text-sm">
                    Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ <span onclick="toggleAuth('register')" class="text-primary cursor-pointer hover:underline">Ø§Ù†Ø´Ø¦ Ø­Ø³Ø§Ø¨</span>
                </p>
            </div>

            <!-- Register Form -->
            <div id="register-form" class="hidden">
                <input type="text" id="reg-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø§Ù„Ù„Ù‚Ø¨)" class="input-field w-full p-3 rounded-lg mb-4">
                <input type="email" id="reg-email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" class="input-field w-full p-3 rounded-lg mb-4 text-left" dir="ltr">
                <input type="password" id="reg-password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" class="input-field w-full p-3 rounded-lg mb-6 text-left" dir="ltr">
                <button onclick="handleRegister()" class="w-full bg-accent hover:bg-green-600 text-white font-bold py-3 rounded-lg transition shadow-lg shadow-green-500/30">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
                <p class="mt-4 text-center text-gray-400 text-sm">
                    Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ <span onclick="toggleAuth('login')" class="text-primary cursor-pointer hover:underline">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</span>
                </p>
            </div>
        </div>
    </div>

    <!-- 2. Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
    <div id="main-app" class="hidden w-full h-full relative">
        
        <!-- Ù‚Ø³Ù… Ø§Ù„ØªØ­Ø¯ÙŠØ§Øª -->
        <div id="challenges-page" class="page-section pt-6 px-4">
            <h2 class="text-2xl font-bold mb-6 text-white border-b border-gray-700 pb-2">Ø§Ù„ØªØ­Ø¯ÙŠØ§Øª <i class="fas fa-gamepad text-primary mr-2"></i></h2>
            
            <div class="grid grid-cols-1 gap-4 mt-10">
                <!-- Create Room -->
                <div onclick="openCreateRoomModal()" class="bg-gradient-to-r from-blue-900 to-slate-900 border border-blue-500/30 p-6 rounded-xl flex items-center justify-between cursor-pointer hover:border-blue-500 transition shadow-lg">
                    <div>
                        <h3 class="text-xl font-bold text-white">Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ©</h3>
                        <p class="text-gray-400 text-sm mt-1">Ø£Ù†Ø´Ø¦ ØºØ±ÙØ© ÙˆØªØ­Ø¯Ù‰ ØµØ¯ÙŠÙ‚Ùƒ</p>
                    </div>
                    <div class="h-12 w-12 bg-blue-600/20 rounded-full flex items-center justify-center">
                        <i class="fas fa-plus text-blue-500 text-xl"></i>
                    </div>
                </div>

                <!-- Join Room -->
                <div onclick="openJoinRoomModal()" class="bg-gradient-to-r from-emerald-900 to-slate-900 border border-emerald-500/30 p-6 rounded-xl flex items-center justify-between cursor-pointer hover:border-emerald-500 transition shadow-lg">
                    <div>
                        <h3 class="text-xl font-bold text-white">Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ØºØ±ÙØ©</h3>
                        <p class="text-gray-400 text-sm mt-1">Ø§Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ© Ù„Ù„Ø§Ù†Ø¶Ù…Ø§Ù…</p>
                    </div>
                    <div class="h-12 w-12 bg-emerald-600/20 rounded-full flex items-center justify-center">
                        <i class="fas fa-search text-emerald-500 text-xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ù‚Ø³Ù… Ø±ÙØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© -->
        <div id="upload-page" class="page-section pt-6 px-4">
            <h2 class="text-2xl font-bold mb-6 text-white border-b border-gray-700 pb-2">Ø±ÙØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© <i class="fas fa-cloud-upload-alt text-accent mr-2"></i></h2>
            
            <div class="bg-surface p-6 rounded-xl border border-gray-700 shadow-lg">
                <label class="block text-gray-400 text-sm mb-2">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø¯Ø©</label>
                <select id="q-subject" class="input-field w-full p-3 rounded-lg mb-4">
                    <option value="islamic">Ø¥Ø³Ù„Ø§Ù…ÙŠØ©</option>
                    <option value="arabic">Ø¹Ø±Ø¨ÙŠ</option>
                    <option value="english">Ø¥Ù†ÙƒÙ„ÙŠØ²ÙŠ</option>
                </select>

                <label class="block text-gray-400 text-sm mb-2">Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„</label>
                <textarea id="q-text" rows="4" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø³Ø¤Ø§Ù„ Ù‡Ù†Ø§..." class="input-field w-full p-3 rounded-lg mb-4"></textarea>

                <label class="block text-gray-400 text-sm mb-2">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©</label>
                <div class="flex gap-4 mb-6">
                    <label class="flex-1 cursor-pointer">
                        <input type="radio" name="q-answer" value="true" class="hidden peer">
                        <div class="p-3 text-center rounded-lg bg-gray-800 border border-gray-600 peer-checked:bg-green-600 peer-checked:border-green-500 transition">
                            <i class="fas fa-check"></i> ØµØ­
                        </div>
                    </label>
                    <label class="flex-1 cursor-pointer">
                        <input type="radio" name="q-answer" value="false" class="hidden peer">
                        <div class="p-3 text-center rounded-lg bg-gray-800 border border-gray-600 peer-checked:bg-red-600 peer-checked:border-red-500 transition">
                            <i class="fas fa-times"></i> Ø®Ø·Ø£
                        </div>
                    </label>
                </div>

                <button onclick="submitQuestion()" class="w-full bg-accent hover:bg-green-600 text-white font-bold py-3 rounded-lg shadow-lg">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø³Ø¤Ø§Ù„</button>
            </div>
        </div>

        <!-- Ù‚Ø³Ù… Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø© (Ù„Ù„Ø£Ø¯Ù…Ù†) -->
        <div id="admin-page" class="page-section pt-6 px-4">
            <div class="flex justify-between items-center border-b border-gray-700 pb-2 mb-6">
                <h2 class="text-2xl font-bold text-white">Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</h2>
                <button onclick="forceRefreshAdmin()" class="bg-primary text-white text-xs px-3 py-1 rounded hover:bg-blue-600"><i class="fas fa-sync"></i> ØªØ­Ø¯ÙŠØ«</button>
            </div>
            
            <div id="admin-questions-list" class="space-y-4 pb-20">
                <!-- Questions loaded dynamically -->
                <p class="text-center text-gray-500 mt-10">Ø§Ø¶ØºØ· ØªØ­Ø¯ÙŠØ« Ù„Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©...</p>
            </div>
        </div>

        <!-- Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø³ÙÙ„ÙŠ -->
        <nav class="bottom-nav">
            <div onclick="switchTab('challenges')" class="nav-item active" id="nav-challenges">
                <i class="fas fa-trophy"></i>
                <span>Ø§Ù„ØªØ­Ø¯ÙŠØ§Øª</span>
            </div>
            <div onclick="switchTab('upload')" class="nav-item" id="nav-upload">
                <i class="fas fa-plus-circle"></i>
                <span>Ø±ÙØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</span>
            </div>
            <div onclick="switchTab('admin')" class="nav-item hidden" id="nav-admin">
                <i class="fas fa-check-double"></i>
                <span>Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</span>
            </div>
            <div onclick="logout()" class="nav-item text-red-500">
                <i class="fas fa-sign-out-alt"></i>
                <span>Ø®Ø±ÙˆØ¬</span>
            </div>
        </nav>
    </div>

    <!-- ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØºØ±ÙØ© ÙˆØ§Ù„Ù„Ø¹Ø¨ (Ø·Ø¨Ù‚Ø© ÙƒØ§Ù…Ù„Ø© ÙÙˆÙ‚ Ø§Ù„ÙƒÙ„) -->
    <div id="room-interface" class="fixed inset-0 bg-darker z-[90] hidden flex flex-col">
        
        <!-- Header Info -->
        <div class="absolute top-4 left-4 z-10 flex flex-col gap-2 items-start">
            <div class="room-stats">
                <i class="fas fa-users"></i> Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† (<span id="user-count">1/2</span>)
            </div>
            <div class="room-stats border-green-500 text-green-500">
                <i class="fas fa-check-circle"></i> Ø¬Ø§Ù‡Ø² (<span id="ready-count">0/2</span>)
            </div>
        </div>

        <div class="absolute top-4 right-4 bg-surface px-4 py-2 rounded-lg border border-gray-700 text-sm">
            ID: <span id="display-room-id" class="font-mono text-primary font-bold text-lg">---</span>
        </div>

        <!-- Lobby View -->
        <div id="lobby-view" class="flex-1 flex flex-col items-center justify-center p-6 relative">
            <div class="text-center mb-10">
                <div class="w-24 h-24 bg-surface rounded-full flex items-center justify-center mx-auto mb-4 border-2 border-primary shadow-[0_0_30px_rgba(59,130,246,0.3)]">
                    <i class="fas fa-gamepad text-4xl text-primary"></i>
                </div>
                <h2 class="text-2xl font-bold mb-1" id="lobby-subject">Ø§Ù„Ù…Ø§Ø¯Ø©: ---</h2>
                <p class="text-gray-400 text-sm">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ù†Ø§ÙØ³...</p>
            </div>

            <div class="flex items-center justify-center w-full gap-4 mb-10">
                <div class="text-center">
                    <div class="w-16 h-16 bg-blue-900 rounded-full flex items-center justify-center mx-auto mb-2">
                        <i class="fas fa-user text-white"></i>
                    </div>
                    <p class="text-sm font-bold text-blue-400" id="p1-name">Ø£Ù†Øª</p>
                </div>
                <div class="text-2xl font-black italic text-red-500">VS</div>
                <div class="text-center">
                    <div class="w-16 h-16 bg-gray-800 rounded-full flex items-center justify-center mx-auto mb-2 relative">
                        <i class="fas fa-user text-gray-500" id="p2-icon"></i>
                        <div id="p2-status-dot" class="absolute bottom-0 right-0 w-4 h-4 rounded-full bg-red-500 border-2 border-darker"></div>
                    </div>
                    <p class="text-sm font-bold text-gray-400" id="p2-name">Ø§Ù†ØªØ¸Ø§Ø±...</p>
                </div>
            </div>

            <div class="flex gap-4 w-full max-w-sm">
                <button onclick="toggleReady()" id="btn-ready" class="ready-btn flex-1 py-4 rounded-xl text-white font-bold shadow-lg transition transform active:scale-95">
                    Ø¬Ø§Ù‡Ø²
                </button>
                <button onclick="leaveRoom()" id="btn-leave" class="bg-surface border border-red-500/50 text-red-500 px-6 rounded-xl font-bold hover:bg-red-900/20 transition">
                    Ù…ØºØ§Ø¯Ø±Ø©
                </button>
            </div>
            
            <p class="text-xs text-gray-600 mt-6 text-center">
                ØªØºÙ„Ù‚ Ø§Ù„ØºØ±ÙØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ 10 Ø¯Ù‚Ø§Ø¦Ù‚<br>
                Ø³ÙŠØªÙ… Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø§ØªØµØ§Ù„Ùƒ Ø­ØªÙ‰ Ù„Ùˆ ÙƒØ§Ù† Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª Ø¶Ø¹ÙŠÙØ§Ù‹
            </p>
        </div>

        <!-- Game View -->
        <div id="game-view" class="hidden flex-1 flex flex-col p-6 pt-20">
            <div class="w-full bg-gray-800 h-1 rounded-full mb-8 overflow-hidden">
                <div id="timer-bar" class="timer-bar" style="width: 100%;"></div>
            </div>

            <div class="flex-1 flex flex-col items-center justify-center">
                <span class="text-gray-500 text-sm mb-2">Ø§Ù„Ø³Ø¤Ø§Ù„ <span id="q-index">1</span> Ù…Ù† 10</span>
                <div class="bg-surface w-full p-6 rounded-2xl border border-gray-700 shadow-xl mb-8 min-h-[150px] flex items-center justify-center text-center">
                    <h3 id="game-q-text" class="text-xl font-medium leading-relaxed">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¤Ø§Ù„...</h3>
                </div>

                <div class="grid grid-cols-2 gap-4 w-full">
                    <button onclick="submitAnswer(true)" class="bg-green-600/20 border border-green-600/50 hover:bg-green-600 text-green-500 hover:text-white py-6 rounded-xl text-xl font-bold transition">
                        <i class="fas fa-check block mb-1"></i> ØµØ­
                    </button>
                    <button onclick="submitAnswer(false)" class="bg-red-600/20 border border-red-600/50 hover:bg-red-600 text-red-500 hover:text-white py-6 rounded-xl text-xl font-bold transition">
                        <i class="fas fa-times block mb-1"></i> Ø®Ø·Ø£
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Results View -->
        <div id="results-view" class="hidden flex-1 flex flex-col items-center justify-center p-6 pt-20 text-center">
             <i class="fas fa-trophy text-6xl text-yellow-400 mb-6 drop-shadow-[0_0_15px_rgba(250,204,21,0.5)]"></i>
             <h2 class="text-3xl font-bold text-white mb-2">Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø©!</h2>
             
             <div class="bg-surface w-full max-w-sm rounded-xl border border-gray-700 p-6 mt-8">
                 <div class="flex justify-between items-center border-b border-gray-700 pb-4 mb-4">
                     <span class="text-blue-400 font-bold" id="res-p1-name">Ø£Ù†Øª</span>
                     <span class="text-2xl font-bold text-white" id="res-p1-score">0</span>
                 </div>
                 <div class="flex justify-between items-center">
                     <span class="text-red-400 font-bold" id="res-p2-name">Ø§Ù„Ø®ØµÙ…</span>
                     <span class="text-2xl font-bold text-white" id="res-p2-score">0</span>
                 </div>
             </div>

             <div class="mt-8 text-lg font-bold" id="winnerText">
                 ...
             </div>

             <button onclick="returnToLobby()" class="mt-10 bg-primary w-full max-w-xs py-4 rounded-xl text-white font-bold shadow-lg">
                 Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØºØ±ÙØ©
             </button>
        </div>

    </div>

    <!-- Modals -->
    <div id="create-room-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4 text-center">Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ© Ø¬Ø¯ÙŠØ¯Ø©</h3>
            <label class="block text-sm text-gray-400 mb-2">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø¯Ø©:</label>
            <select id="room-subject" class="input-field w-full p-3 rounded-lg mb-6">
                <option value="islamic">Ø¥Ø³Ù„Ø§Ù…ÙŠØ©</option>
                <option value="arabic">Ø¹Ø±Ø¨ÙŠ</option>
                <option value="english">Ø¥Ù†ÙƒÙ„ÙŠØ²ÙŠ</option>
            </select>
            <div class="flex gap-2">
                <button onclick="createRoom()" class="flex-1 bg-primary text-white py-2 rounded-lg font-bold">Ø§Ù„ØªØ§Ù„ÙŠ (Ø¥Ù†Ø´Ø§Ø¡)</button>
                <button onclick="closeModals()" class="flex-1 bg-surface border border-gray-600 text-gray-300 py-2 rounded-lg">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

    <div id="join-room-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4 text-center">Ø§Ù†Ø¶Ù… Ø¥Ù„Ù‰ ØºØ±ÙØ©</h3>
            <label class="block text-sm text-gray-400 mb-2">Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ©:</label>
            <input type="number" id="join-room-id" placeholder="123456" class="input-field w-full p-3 rounded-lg mb-6 text-center text-xl tracking-widest">
            <div class="flex gap-2">
                <button onclick="joinRoom()" class="flex-1 bg-accent text-white py-2 rounded-lg font-bold">Ø¯Ø®ÙˆÙ„</button>
                <button onclick="closeModals()" class="flex-1 bg-surface border border-gray-600 text-gray-300 py-2 rounded-lg">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

    <!-- Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, onSnapshot, updateDoc, setDoc, getDoc, query, where, getDocs, deleteDoc, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Configuration
        const firebaseConfig = {
          apiKey: "AIzaSyCTagUwMRX9_2RgU4l4q-1jRs3JlgR8mt8",
          authDomain: "what-s-his-name.firebaseapp.com",
          projectId: "what-s-his-name",
          storageBucket: "what-s-his-name.firebasestorage.app",
          messagingSenderId: "105145923894",
          appId: "1:105145923894:web:6a8ee2193871bfb51f5b97",
          measurementId: "G-WBBXGH10M2"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // State
        let currentUser = null;
        let currentRoomId = null;
        let roomUnsubscribe = null;
        let isOwner = false;
        let isAdmin = false;
        let gameTimerInterval = null;
        const ADMIN_EMAIL = "mslmalmyaly223@gmail.com";

        // --- Auth & Visibility Fixes ---
        onAuthStateChanged(auth, async (user) => {
            const loading = document.getElementById('loading-screen');
            const authContainer = document.getElementById('auth-container');
            const mainApp = document.getElementById('main-app');

            if (user) {
                currentUser = user;
                // FIX 1: Force hide auth container and show main app
                loading.classList.add('hidden');
                authContainer.classList.remove('show-section'); // Remove class
                authContainer.style.display = 'none'; // Force Inline CSS
                
                mainApp.classList.remove('hidden');
                mainApp.classList.add('block');
                
                // Admin Check
                if(user.email.toLowerCase() === ADMIN_EMAIL.toLowerCase()) {
                    isAdmin = true;
                    document.getElementById('nav-admin').classList.remove('hidden');
                    loadAdminQuestions(); // Load immediately
                } else {
                    isAdmin = false;
                    document.getElementById('nav-admin').classList.add('hidden');
                }
                
                // Default Tab
                switchTab('challenges');

            } else {
                currentUser = null;
                isAdmin = false;
                // FIX 1: Show auth, hide app
                loading.classList.add('hidden');
                mainApp.classList.add('hidden');
                mainApp.classList.remove('block');
                
                authContainer.style.display = 'flex'; // Restore Flex
                authContainer.classList.add('show-section');
            }
        });

        window.handleLogin = async () => {
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-password').value;
            if(!email || !pass) return Swal.fire('Ø®Ø·Ø£', 'ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„', 'error');
            try {
                await signInWithEmailAndPassword(auth, email, pass);
            } catch (e) {
                Swal.fire('Ø®Ø·Ø£', 'ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: ' + e.message, 'error');
            }
        };

        window.handleRegister = async () => {
            const name = document.getElementById('reg-name').value;
            const email = document.getElementById('reg-email').value;
            const pass = document.getElementById('reg-password').value;
            if(!name || !email || !pass) return Swal.fire('Ø®Ø·Ø£', 'ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„', 'error');
            try {
                const userCred = await createUserWithEmailAndPassword(auth, email, pass);
                await updateProfile(userCred.user, { displayName: name });
                await setDoc(doc(db, "users", userCred.user.uid), { name, email, role: 'user' });
            } catch (e) {
                Swal.fire('Ø®Ø·Ø£', 'ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨: ' + e.message, 'error');
            }
        };

        window.logout = () => signOut(auth);

        window.toggleAuth = (type) => {
            if(type === 'register') {
                document.getElementById('login-form').classList.add('hidden');
                document.getElementById('register-form').classList.remove('hidden');
            } else {
                document.getElementById('register-form').classList.add('hidden');
                document.getElementById('login-form').classList.remove('hidden');
            }
        };

        // --- Navigation ---
        window.switchTab = (tabId) => {
            // Hide all pages
            document.querySelectorAll('.page-section').forEach(p => {
                p.classList.remove('show-section');
                p.style.display = 'none';
            });
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            
            // Show target page
            const target = document.getElementById(`${tabId}-page`);
            target.style.display = 'block';
            setTimeout(() => target.classList.add('show-section'), 10);
            
            document.getElementById(`nav-${tabId}`).classList.add('active');
            
            if(tabId === 'admin' && isAdmin) loadAdminQuestions();
        };

        // --- Admin Fixes ---
        window.forceRefreshAdmin = () => loadAdminQuestions();

        async function loadAdminQuestions() {
            if(!isAdmin) return;
            const list = document.getElementById('admin-questions-list');
            list.innerHTML = '<div class="text-center text-primary mt-10"><i class="fas fa-spinner fa-spin fa-2x"></i><br>Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©...</div>';
            
            try {
                // Simplified query to avoid index issues initially
                const q = query(collection(db, "questions"), where("status", "==", "pending"));
                const snapshot = await getDocs(q);
                
                list.innerHTML = '';
                if(snapshot.empty) {
                    list.innerHTML = `
                        <div class="flex flex-col items-center justify-center mt-10 text-gray-500">
                            <i class="fas fa-check-circle text-4xl mb-2 text-green-500/50"></i>
                            <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© Ù…Ø¹Ù„Ù‚Ø© Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</p>
                        </div>`;
                    return;
                }

                snapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    const div = document.createElement('div');
                    div.className = 'bg-surface p-4 rounded-lg border border-gray-700 flex flex-col gap-2 shadow-md';
                    const subName = data.subject === 'islamic' ? 'Ø¥Ø³Ù„Ø§Ù…ÙŠØ©' : data.subject === 'arabic' ? 'Ø¹Ø±Ø¨ÙŠ' : 'Ø¥Ù†ÙƒÙ„ÙŠØ²ÙŠ';
                    
                    div.innerHTML = `
                        <div class="flex justify-between items-center text-xs text-gray-400 border-b border-gray-700 pb-2">
                            <span class="bg-gray-800 px-2 py-1 rounded">${subName}</span>
                            <span class="${data.answer ? 'text-green-500' : 'text-red-500'} font-bold bg-gray-900 px-2 py-1 rounded border border-gray-700">Ø§Ù„Ø¬ÙˆØ§Ø¨: ${data.answer ? 'ØµØ­' : 'Ø®Ø·Ø£'}</span>
                        </div>
                        <p class="text-white text-lg font-medium py-2">${data.text}</p>
                        <div class="flex gap-3 mt-2">
                            <button onclick="window.approveQ('${docSnap.id}')" class="flex-1 bg-green-600 hover:bg-green-500 text-white py-2 rounded-lg text-sm font-bold shadow-lg shadow-green-900/20 transition">
                                <i class="fas fa-check"></i> Ù…ÙˆØ§ÙÙ‚Ø©
                            </button>
                            <button onclick="window.deleteQ('${docSnap.id}')" class="flex-1 bg-red-600 hover:bg-red-500 text-white py-2 rounded-lg text-sm font-bold shadow-lg shadow-red-900/20 transition">
                                <i class="fas fa-trash"></i> Ø­Ø°Ù
                            </button>
                        </div>
                    `;
                    list.appendChild(div);
                });
            } catch (error) {
                console.error("Admin Load Error:", error);
                list.innerHTML = `<p class="text-center text-red-500 mt-10">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.<br>${error.message}</p>`;
            }
        }

        window.approveQ = async (id) => {
            try {
                await updateDoc(doc(db, "questions", id), { status: 'approved' });
                const div = document.activeElement.closest('.bg-surface'); // Find the card
                if(div) div.remove(); // Optimistic UI removal
                Swal.fire({ toast: true, position: 'top-end', icon: 'success', title: 'ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©', timer: 1500, showConfirmButton: false });
            } catch(e) { Swal.fire('Ø®Ø·Ø£', e.message, 'error'); }
        };

        window.deleteQ = async (id) => {
            try {
                await deleteDoc(doc(db, "questions", id));
                const div = document.activeElement.closest('.bg-surface');
                if(div) div.remove();
                Swal.fire({ toast: true, position: 'top-end', icon: 'success', title: 'ØªÙ… Ø§Ù„Ø­Ø°Ù', timer: 1500, showConfirmButton: false });
            } catch(e) { Swal.fire('Ø®Ø·Ø£', e.message, 'error'); }
        };

        // --- Question Upload ---
        window.submitQuestion = async () => {
            const subject = document.getElementById('q-subject').value;
            const text = document.getElementById('q-text').value;
            const answerEls = document.getElementsByName('q-answer');
            let answer = null;
            for(let el of answerEls) if(el.checked) answer = el.value === 'true';

            if(!text || answer === null) return Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', 'ÙŠØ±Ø¬Ù‰ Ø¥ÙƒÙ…Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø¤Ø§Ù„', 'warning');

            try {
                await addDoc(collection(db, "questions"), {
                    subject, text, answer,
                    status: isAdmin ? 'approved' : 'pending',
                    createdBy: currentUser.uid,
                    createdAt: Date.now()
                });
                Swal.fire('ØªÙ…', isAdmin ? 'ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø¤Ø§Ù„ (ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù„Ø£Ù†Ùƒ Ø£Ø¯Ù…Ù†)' : 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø³Ø¤Ø§Ù„ Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©', 'success');
                document.getElementById('q-text').value = '';
            } catch (e) {
                Swal.fire('Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„', 'error');
            }
        };

        // --- Room & Game Logic (Same as before but cleaned up) ---
        window.openCreateRoomModal = () => document.getElementById('create-room-modal').style.display = 'flex';
        window.openJoinRoomModal = () => document.getElementById('join-room-modal').style.display = 'flex';
        window.closeModals = () => document.querySelectorAll('.modal-overlay').forEach(m => m.style.display = 'none');

        window.createRoom = async () => {
            const subject = document.getElementById('room-subject').value;
            closeModals();
            const roomId = Math.floor(100000 + Math.random() * 900000).toString();
            
            // Fetch questions
            const qQuery = query(collection(db, "questions"), where("subject", "==", subject), where("status", "==", "approved"));
            const qSnap = await getDocs(qQuery);
            let allQs = [];
            qSnap.forEach(d => allQs.push(d.data()));
            allQs.sort(() => 0.5 - Math.random());
            const selectedQuestions = allQs.slice(0, 10);
            
            if(selectedQuestions.length < 1) return Swal.fire('Ø¹Ø°Ø±Ø§Ù‹', 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© ÙƒØ§ÙÙŠØ© Ù„Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø§Ø¯Ø© Ø­Ø§Ù„ÙŠØ§Ù‹', 'info');

            const roomData = {
                roomId, subject,
                host: { uid: currentUser.uid, name: currentUser.displayName, ready: false, score: 0 },
                guest: null, createdAt: Date.now(), status: 'waiting',
                questions: selectedQuestions, currentQuestionIndex: 0, nextQuestionTime: 0
            };

            await setDoc(doc(db, "rooms", roomId), roomData);
            enterRoom(roomId, true);
        };

        window.joinRoom = async () => {
            const roomId = document.getElementById('join-room-id').value;
            if(!roomId) return;
            closeModals();
            const roomRef = doc(db, "rooms", roomId);
            const roomSnap = await getDoc(roomRef);
            if(!roomSnap.exists()) return Swal.fire('Ø®Ø·Ø£', 'Ø§Ù„ØºØ±ÙØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©', 'error');
            const data = roomSnap.data();
            if(data.guest && data.guest.uid !== currentUser.uid) return Swal.fire('Ù…Ù…ØªÙ„Ø¦Ø©', 'Ø§Ù„ØºØ±ÙØ© Ù…Ù…ØªÙ„Ø¦Ø©', 'error');
            if(Date.now() - data.createdAt > 600000) return Swal.fire('Ù…Ù†ØªÙ‡ÙŠØ©', 'Ø§Ù†ØªÙ‡Ù‰ ÙˆÙ‚Øª Ø§Ù„ØºØ±ÙØ©', 'error');

            if(!data.guest) {
                await updateDoc(roomRef, { guest: { uid: currentUser.uid, name: currentUser.displayName, ready: false, score: 0 } });
            }
            enterRoom(roomId, false);
        };

        function enterRoom(roomId, owner) {
            currentRoomId = roomId;
            isOwner = owner;
            document.getElementById('room-interface').classList.remove('hidden');
            document.getElementById('lobby-view').classList.remove('hidden');
            document.getElementById('game-view').classList.add('hidden');
            document.getElementById('results-view').classList.add('hidden');
            document.getElementById('display-room-id').innerText = roomId;
            document.getElementById('btn-leave').innerText = isOwner ? "Ø­Ø°Ù Ø§Ù„ØºØ±ÙØ©" : "Ù…ØºØ§Ø¯Ø±Ø©";
            
            resetLobbyUI();

            roomUnsubscribe = onSnapshot(doc(db, "rooms", roomId), (snapshot) => {
                if(!snapshot.exists()) {
                    exitRoomLocal();
                    Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', 'ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØºØ±ÙØ©', 'info');
                    return;
                }
                const data = snapshot.data();
                if(Date.now() - data.createdAt > 600000) { leaveRoom(); return; }
                updateLobbyUI(data);
                handleGameFlow(data);
            });
        }

        function updateLobbyUI(data) {
            const subName = data.subject === 'islamic' ? 'Ø¥Ø³Ù„Ø§Ù…ÙŠØ©' : data.subject === 'arabic' ? 'Ø¹Ø±Ø¨ÙŠ' : 'Ø¥Ù†ÙƒÙ„ÙŠØ²ÙŠ';
            document.getElementById('lobby-subject').innerText = `Ø§Ù„Ù…Ø§Ø¯Ø©: ${subName}`;
            const userCount = data.guest ? 2 : 1;
            document.getElementById('user-count').innerText = `${userCount}/2`;
            let readyCount = 0;
            if(data.host.ready) readyCount++;
            if(data.guest && data.guest.ready) readyCount++;
            document.getElementById('ready-count').innerText = `${readyCount}/2`;
            document.getElementById('p1-name').innerText = isOwner ? data.host.name : (data.guest?.name || 'Ø£Ù†Øª');
            
            const p2StatusDot = document.getElementById('p2-status-dot');
            const p2Name = document.getElementById('p2-name');
            const p2Icon = document.getElementById('p2-icon');

            if (isOwner) {
                if(data.guest) {
                    p2Name.innerText = data.guest.name;
                    p2Icon.className = "fas fa-user text-white";
                    p2StatusDot.className = `absolute bottom-0 right-0 w-4 h-4 rounded-full border-2 border-darker ${data.guest.ready ? 'bg-green-500' : 'bg-yellow-500'}`;
                } else {
                    p2Name.innerText = "Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ù†Ø§ÙØ³...";
                    p2Icon.className = "fas fa-user text-gray-500";
                    p2StatusDot.className = "absolute bottom-0 right-0 w-4 h-4 rounded-full bg-red-500 border-2 border-darker";
                }
            } else {
                p2Name.innerText = data.host.name;
                p2Icon.className = "fas fa-user-crown text-yellow-500";
                p2StatusDot.className = `absolute bottom-0 right-0 w-4 h-4 rounded-full border-2 border-darker ${data.host.ready ? 'bg-green-500' : 'bg-yellow-500'}`;
            }

            const myState = isOwner ? data.host.ready : (data.guest ? data.guest.ready : false);
            const btn = document.getElementById('btn-ready');
            if(myState) {
                btn.innerText = "Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¬Ø§Ù‡Ø²ÙŠØ©";
                btn.classList.add('is-ready');
            } else {
                btn.innerText = "Ø¬Ø§Ù‡Ø²";
                btn.classList.remove('is-ready');
            }
        }

        window.toggleReady = async () => {
            if(!currentRoomId) return;
            const roomRef = doc(db, "rooms", currentRoomId);
            const snap = await getDoc(roomRef);
            const data = snap.data();
            if(isOwner) { await updateDoc(roomRef, { "host.ready": !data.host.ready }); }
            else { await updateDoc(roomRef, { "guest.ready": !data.guest.ready }); }
        };

        window.leaveRoom = async () => {
            if(!currentRoomId) return;
            if(roomUnsubscribe) roomUnsubscribe();
            if(isOwner) { await deleteDoc(doc(db, "rooms", currentRoomId)); }
            else { 
                const roomRef = doc(db, "rooms", currentRoomId);
                try { await updateDoc(roomRef, { guest: null, status: 'waiting', "host.ready": false }); } catch(e) {}
            }
            exitRoomLocal();
        };

        function exitRoomLocal() {
            currentRoomId = null;
            document.getElementById('room-interface').classList.add('hidden');
        }

        function handleGameFlow(data) {
            if (data.host.ready && data.guest?.ready && data.status === 'waiting') {
                if(isOwner) {
                    updateDoc(doc(db, "rooms", currentRoomId), {
                        status: 'playing', currentQuestionIndex: 0, nextQuestionTime: Date.now() + 15000
                    });
                }
            }
            if (data.status === 'playing') startGameUI(data);
            else if (data.status === 'finished') showResults(data);
            else {
                document.getElementById('lobby-view').classList.remove('hidden');
                document.getElementById('game-view').classList.add('hidden');
                document.getElementById('results-view').classList.add('hidden');
            }
        }

        function startGameUI(data) {
            document.getElementById('lobby-view').classList.add('hidden');
            document.getElementById('results-view').classList.add('hidden');
            document.getElementById('game-view').classList.remove('hidden');

            const qIndex = data.currentQuestionIndex;
            const question = data.questions[qIndex];
            document.getElementById('q-index').innerText = qIndex + 1;
            document.getElementById('game-q-text').innerText = question.text;

            const now = Date.now();
            const remaining = Math.max(0, Math.ceil((data.nextQuestionTime - now) / 1000));
            const percentage = (remaining / 15) * 100;
            document.getElementById('timer-bar').style.width = `${percentage}%`;
            
            if(isOwner && now > data.nextQuestionTime) {
                if(qIndex < 9) {
                    updateDoc(doc(db, "rooms", currentRoomId), { currentQuestionIndex: qIndex + 1, nextQuestionTime: Date.now() + 15000 });
                } else {
                    updateDoc(doc(db, "rooms", currentRoomId), { status: 'finished' });
                }
            }
        }

        window.submitAnswer = async (val) => {
            const roomRef = doc(db, "rooms", currentRoomId);
            const snap = await getDoc(roomRef);
            const data = snap.data();
            const currentQ = data.questions[data.currentQuestionIndex];
            
            const Toast = Swal.mixin({ toast: true, position: 'top', showConfirmButton: false, timer: 1000 });
            if (val === currentQ.answer) {
                Toast.fire({ icon: 'success', title: 'Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©' });
                if(isOwner) { await updateDoc(roomRef, { "host.score": (data.host.score || 0) + 1 }); }
                else { await updateDoc(roomRef, { "guest.score": (data.guest.score || 0) + 1 }); }
            } else {
                Toast.fire({ icon: 'error', title: 'Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø©' });
            }
            document.getElementById('game-view').classList.add('pointer-events-none');
            setTimeout(() => document.getElementById('game-view').classList.remove('pointer-events-none'), 1000);
        };

        function showResults(data) {
            document.getElementById('game-view').classList.add('hidden');
            document.getElementById('results-view').classList.remove('hidden');
            document.getElementById('res-p1-score').innerText = isOwner ? data.host.score : data.guest.score;
            document.getElementById('res-p2-score').innerText = isOwner ? data.guest.score : data.host.score;
            const myS = isOwner ? data.host.score : data.guest.score;
            const oppS = isOwner ? data.guest.score : data.host.score;
            const winnerText = document.getElementById('winnerText');
            if(myS > oppS) {
                winnerText.innerText = "Ù…Ø¨Ø±ÙˆÙƒ! Ù„Ù‚Ø¯ ÙØ²Øª ğŸ†";
                winnerText.className = "mt-8 text-2xl font-bold text-green-500";
            } else if (myS < oppS) {
                winnerText.innerText = "Ø­Ø¸ Ø£ÙˆÙØ±! Ù„Ù‚Ø¯ Ø®Ø³Ø±Øª ğŸ˜”";
                winnerText.className = "mt-8 text-2xl font-bold text-red-500";
            } else {
                winnerText.innerText = "ØªØ¹Ø§Ø¯Ù„! ğŸ¤";
                winnerText.className = "mt-8 text-2xl font-bold text-gray-400";
            }
        }

        window.returnToLobby = async () => {
            if(!currentRoomId) return;
            const roomRef = doc(db, "rooms", currentRoomId);
            if(isOwner) {
                 await updateDoc(roomRef, { status: 'waiting', "host.ready": false, "host.score": 0, "guest.ready": false, "guest.score": 0, currentQuestionIndex: 0});
            } else {
                Swal.fire('Ø§Ù†ØªØ¸Ø§Ø±', 'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø§Ù„Ùƒ Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØºØ±ÙØ©', 'info');
            }
        };

        function resetLobbyUI() {
             document.getElementById('btn-ready').classList.remove('is-ready');
             document.getElementById('btn-ready').innerText = "Ø¬Ø§Ù‡Ø²";
        }
    </script>
</body>
</html>
