<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù‡ÙƒØ± Ø§Ù„ÙˆØ²Ø§Ø±ÙŠ</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Google Fonts (Cairo) -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800&display=swap" rel="stylesheet">

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, getDoc, updateDoc, deleteDoc, onSnapshot, query, where, serverTimestamp, arrayUnion, setDoc, getDocs, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";

        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ÙØ§ÙŠØ±Ø¨ÙŠØ³
        const firebaseConfig = {
            apiKey: "AIzaSyCTagUwMRX9_2RgU4l4q-1jRs3JlgR8mt8",
            authDomain: "what-s-his-name.firebaseapp.com",
            projectId: "what-s-his-name",
            storageBucket: "what-s-his-name.firebasestorage.app",
            messagingSenderId: "105145923894",
            appId: "1:105145923894:web:6a8ee2193871bfb51f5b97",
            measurementId: "G-WBBXGH10M2"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // Global Variables
        window.db = db;
        window.auth = auth;
        window.currentUser = null;
        window.currentRoomId = null;
        window.unsubRoom = null;
        window.gameTimer = null;
        window.questionTimer = null;
        window.isAdmin = false;
        window.isHost = false; // Will be determined dynamically

        // --- AUTH FUNCTIONS ---
        window.handleAuth = async (type) => {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const name = document.getElementById('username')?.value;
            const errorMsg = document.getElementById('authError');
            
            errorMsg.innerText = "";
            document.getElementById('btnSubmitAuth').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...';

            try {
                if (type === 'signup') {
                    if(!name) throw new Error("ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø§Ø³Ù…");
                    const cred = await createUserWithEmailAndPassword(auth, email, password);
                    await updateProfile(cred.user, { displayName: name });
                    // Save user data
                    await setDoc(doc(db, "users", cred.user.uid), {
                        name: name,
                        email: email,
                        role: email === "mslmalmyaly223@gmail.com" ? "admin" : "user",
                        createdAt: serverTimestamp()
                    });
                } else {
                    await signInWithEmailAndPassword(auth, email, password);
                }
            } catch (error) {
                console.error(error);
                let msg = "Ø­Ø¯Ø« Ø®Ø·Ø£: " + error.message;
                if(error.code === 'auth/invalid-credential') msg = "Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø£Ùˆ Ø§Ù„Ø±Ù…Ø² ØºÙ„Ø· ÙŠØ§ Ø¨Ø·Ù„";
                if(error.code === 'auth/email-already-in-use') msg = "Ø§Ù„Ø¨Ø±ÙŠØ¯ Ù‡Ø°Ø§ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ù‚Ø¨Ù„";
                if(error.code === 'auth/weak-password') msg = "Ø§Ù„Ø±Ù…Ø² Ø¶Ø¹ÙŠÙØŒ Ø®Ù„ÙŠÙ‡ Ø£Ù‚ÙˆÙ‰";
                if(error.code === 'auth/network-request-failed') msg = "ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ù†ØªØŒ Ù…Ø§ÙƒÙˆ Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±";
                errorMsg.innerText = msg;
                document.getElementById('btnSubmitAuth').innerText = type === 'signup' ? 'Ø§Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨' : 'Ø¯Ø®ÙˆÙ„';
            }
        };

        window.logout = () => {
            if(confirm("Ù…ØªØ£ÙƒØ¯ ØªØ±ÙŠØ¯ ØªØ³Ø¬Ù„ Ø®Ø±ÙˆØ¬ØŸ")) {
                signOut(auth).then(() => location.reload());
            }
        };

        // --- APP STATE OBSERVER ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                window.currentUser = user;
                document.getElementById('authSection').classList.add('hidden');
                document.getElementById('appSection').classList.remove('hidden');
                document.getElementById('userNameDisplay').innerText = user.displayName;
                
                if(user.email === "mslmalmyaly223@gmail.com") {
                    window.isAdmin = true;
                    document.getElementById('adminTab').classList.remove('hidden');
                }
            } else {
                document.getElementById('authSection').classList.remove('hidden');
                document.getElementById('appSection').classList.add('hidden');
            }
        });

        // --- NAVIGATION ---
        window.switchTab = (tabId) => {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(tabId).classList.remove('hidden');
            
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('text-blue-500', 'bg-blue-900/20'));
            const activeBtn = document.querySelector(`[onclick="switchTab('${tabId}')"]`);
            if(activeBtn) activeBtn.classList.add('text-blue-500', 'bg-blue-900/20');

            if(tabId === 'adminPanel') loadPendingQuestions();
        };

        // --- UPLOAD QUESTIONS ---
        window.submitQuestion = async () => {
            const subject = document.getElementById('qSubject').value;
            const text = document.getElementById('qText').value;
            const answer = document.getElementById('qAnswer').value === 'true';
            
            if(!text) return alert("Ø§ÙƒØªØ¨ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø±Ø­Ù…Ø© Ù„ÙˆØ§Ù„Ø¯ÙŠÙƒ");

            const btn = document.getElementById('btnSendQ');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ø±Ø³Ø§Ù„...';
            btn.disabled = true;

            try {
                await addDoc(collection(db, "questions"), {
                    subject,
                    text,
                    answer,
                    approved: false,
                    author: window.currentUser.displayName,
                    authorId: window.currentUser.uid,
                    createdAt: serverTimestamp()
                });
                alert("Ø¹Ø§Ø´Øª Ø§ÙŠØ¯Ùƒ! ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø³Ø¤Ø§Ù„ Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©.");
                document.getElementById('qText').value = "";
            } catch (e) {
                console.error("Upload Error:", e);
                if(e.code === 'permission-denied') {
                    alert("ÙØ´Ù„! Ù…Ø§ Ø¹Ù†Ø¯Ùƒ ØµÙ„Ø§Ø­ÙŠØ©. ØªØ£ÙƒØ¯ Ù…Ù† Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Rules) ÙÙŠ Ø§Ù„ÙØ§ÙŠØ±Ø¨ÙŠØ³.");
                } else {
                    alert("ÙØ´Ù„ Ø§Ù„Ø§Ø±Ø³Ø§Ù„: " + e.message);
                }
            } finally {
                btn.innerHTML = 'Ø§Ø±Ø³Ø§Ù„ Ø§Ù„Ø³Ø¤Ø§Ù„';
                btn.disabled = false;
            }
        };

        // --- ADMIN: REVIEW QUESTIONS ---
        async function loadPendingQuestions() {
            if(!window.isAdmin) return;
            const qContainer = document.getElementById('pendingQuestions');
            qContainer.innerHTML = '<div class="text-center text-gray-400 mt-10"><i class="fas fa-spinner fa-spin fa-2x"></i><br>Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©...</div>';
            
            try {
                const q = query(collection(db, "questions"), where("approved", "==", false));
                const snapshot = await getDocs(q);
                
                qContainer.innerHTML = "";
                if (snapshot.empty) {
                    qContainer.innerHTML = '<div class="text-center text-gray-400 mt-10">Ù…Ø§ÙƒÙˆ Ø£Ø³Ø¦Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© ğŸ¤·â€â™‚ï¸</div>';
                    return;
                }

                snapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    const div = document.createElement('div');
                    div.className = "bg-slate-800 p-4 rounded-lg mb-3 border border-slate-700 shadow-md";
                    div.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div class="flex-1 ml-2">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="text-xs bg-blue-600 px-2 py-1 rounded text-white">${data.subject}</span>
                                    <span class="text-xs text-gray-500">Ø¨ÙˆØ§Ø³Ø·Ø©: ${data.author || 'Ù…Ø¬Ù‡ÙˆÙ„'}</span>
                                </div>
                                <p class="text-white font-bold leading-relaxed">${data.text}</p>
                                <p class="text-sm text-green-400 mt-1">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©: ${data.answer ? 'ØµØ­' : 'Ø®Ø·Ø£'}</p>
                            </div>
                            <div class="flex flex-col gap-2">
                                <button onclick="approveQuestion('${docSnap.id}')" class="bg-green-600 hover:bg-green-500 w-10 h-10 rounded-full text-white shadow"><i class="fas fa-check"></i></button>
                                <button onclick="deleteQuestion('${docSnap.id}')" class="bg-red-600 hover:bg-red-500 w-10 h-10 rounded-full text-white shadow"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                    `;
                    qContainer.appendChild(div);
                });
            } catch (e) {
                console.error("Admin Load Error:", e);
                qContainer.innerHTML = `<div class="text-center text-red-400 mt-10">Ø­Ø¯Ø« Ø®Ø·Ø£: ${e.message}</div>`;
            }
        }

        window.approveQuestion = async (id) => {
            try {
                await updateDoc(doc(db, "questions", id), { approved: true });
                loadPendingQuestions();
            } catch(e) { alert("Ø®Ø·Ø£: " + e.message); }
        };
        window.deleteQuestion = async (id) => {
            if(!confirm("ØªØ­Ø°Ù Ø§Ù„Ø³Ø¤Ø§Ù„ØŸ")) return;
            try {
                await deleteDoc(doc(db, "questions", id));
                loadPendingQuestions();
            } catch(e) { alert("Ø®Ø·Ø£: " + e.message); }
        };

        // --- ROOM LOGIC ---

        window.showCreateModal = () => document.getElementById('createRoomModal').classList.remove('hidden');
        window.closeCreateModal = () => document.getElementById('createRoomModal').classList.add('hidden');
        window.showSearchModal = () => document.getElementById('searchRoomModal').classList.remove('hidden');
        window.closeSearchModal = () => document.getElementById('searchRoomModal').classList.add('hidden');

        window.createRoom = async () => {
            const subject = document.getElementById('roomSubject').value;
            const roomId = Math.floor(100000 + Math.random() * 900000).toString();
            
            const btn = document.getElementById('btnCreateRoom');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ù†Ø´Ø§Ø¡...';
            btn.disabled = true;

            try {
                const expireTime = new Date();
                expireTime.setMinutes(expireTime.getMinutes() + 10);

                await setDoc(doc(db, "rooms", roomId), {
                    host: window.currentUser.uid,
                    hostName: window.currentUser.displayName,
                    guest: null,
                    guestName: null,
                    subject: subject,
                    status: "waiting",
                    hostReady: false,
                    guestReady: false,
                    createdAt: serverTimestamp(),
                    expiresAt: expireTime.getTime(),
                    questions: []
                });
                
                window.currentRoomId = roomId;
                // isHost will be set correctly in enterRoomUI
                closeCreateModal();
                enterRoomUI(roomId);

            } catch (e) {
                console.error(e);
                alert("Ø®Ø·Ø£: " + e.message);
            } finally {
                btn.innerHTML = 'Ø§Ù„ØªØ§Ù„ÙŠ (Ø§Ù†Ø´Ø§Ø¡) <i class="fas fa-arrow-left mr-2"></i>';
                btn.disabled = false;
            }
        };

        window.joinRoom = async () => {
            const roomId = document.getElementById('roomIdInput').value;
            if(!roomId) return;

            const btn = document.getElementById('btnJoinRoom');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...';

            try {
                const roomRef = doc(db, "rooms", roomId);
                const roomSnap = await getDoc(roomRef);

                if (!roomSnap.exists()) {
                    alert("Ø§Ù„ØºØ±ÙØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©!");
                    btn.innerHTML = 'Ø¨Ø­Ø« ÙˆØ¯Ø®ÙˆÙ„ <i class="fas fa-search mr-2"></i>';
                    return;
                }

                const data = roomSnap.data();
                if (data.guest && data.guest !== window.currentUser.uid) {
                    alert("Ø§Ù„ØºØ±ÙØ© Ù…Ù…ØªÙ„Ø¦Ø©!");
                    btn.innerHTML = 'Ø¨Ø­Ø« ÙˆØ¯Ø®ÙˆÙ„ <i class="fas fa-search mr-2"></i>';
                    return;
                }

                if (!data.guest) {
                    await updateDoc(roomRef, {
                        guest: window.currentUser.uid,
                        guestName: window.currentUser.displayName
                    });
                }

                window.currentRoomId = roomId;
                closeSearchModal();
                enterRoomUI(roomId);

            } catch (e) {
                console.error(e);
                alert("Ø®Ø·Ø£: " + e.message);
            } finally {
                btn.innerHTML = 'Ø¨Ø­Ø« ÙˆØ¯Ø®ÙˆÙ„ <i class="fas fa-search mr-2"></i>';
            }
        };

        // --- REALTIME ROOM UI ---
        function enterRoomUI(roomId) {
            document.getElementById('challengesHome').classList.add('hidden');
            document.getElementById('roomLobby').classList.remove('hidden');
            document.getElementById('displayRoomId').innerText = roomId;

            if(window.unsubRoom) window.unsubRoom(); // Clear old listener

            window.unsubRoom = onSnapshot(doc(db, "rooms", roomId), async (docSnap) => {
                if (!docSnap.exists()) {
                    alert("ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØºØ±ÙØ©");
                    leaveRoomLogic(true); 
                    return;
                }

                const data = docSnap.data();
                
                // CRITICAL: Determine role on every update
                window.isHost = (window.currentUser.uid === data.host);

                if(Date.now() > data.expiresAt) {
                    alert("Ø§Ù†ØªÙ‡Ù‰ ÙˆÙ‚Øª Ø§Ù„ØºØ±ÙØ©");
                    if(window.isHost) await deleteDoc(doc(db, "rooms", roomId));
                    return;
                }

                let readyCount = (data.hostReady ? 1 : 0) + (data.guestReady ? 1 : 0);
                let userCount = 1 + (data.guest ? 1 : 0);
                
                const statusBadge = document.getElementById('roomStatusBadge');
                statusBadge.innerText = `${readyCount}/${userCount} Ø¬Ø§Ù‡Ø²Ø©`;
                statusBadge.className = readyCount === userCount && userCount > 1 
                    ? "bg-green-600 text-white px-3 py-1 rounded-full text-sm font-bold shadow-lg transition-all" 
                    : "bg-slate-700 text-gray-300 px-3 py-1 rounded-full text-sm font-bold transition-all";

                document.getElementById('hostName').innerText = data.hostName;
                updateReadyStatus('hostStatus', data.hostReady);

                if (data.guest) {
                    document.getElementById('guestCard').classList.remove('opacity-50');
                    document.getElementById('guestName').innerText = data.guestName;
                    updateReadyStatus('guestStatus', data.guestReady);
                } else {
                    document.getElementById('guestCard').classList.add('opacity-50');
                    document.getElementById('guestName').innerText = "ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±...";
                    document.getElementById('guestStatus').innerHTML = '<span class="text-xs text-yellow-500 animate-pulse">ÙŠÙ†ØªØ¸Ø± Ù„Ø§Ø¹Ø¨...</span>';
                }

                // Update Ready Button based on CORRECT role
                const readyBtn = document.getElementById('readyBtn');
                const myReadyState = window.isHost ? data.hostReady : data.guestReady;
                
                // Only update button text if NOT loading (disabled)
                if (!readyBtn.disabled) {
                    if (data.status === 'waiting') {
                        if (myReadyState) {
                            readyBtn.innerText = "Ø§Ù„ØºØ§Ø¡ Ø§Ù„Ø¬Ø§Ù‡Ø²ÙŠØ© âŒ";
                            readyBtn.className = "w-full py-4 bg-red-600 rounded-xl text-white font-bold text-xl shadow-lg hover:bg-red-700 transition";
                        } else {
                            readyBtn.innerText = "Ø¬Ù€Ù€Ù€Ù€Ù€Ø§Ù‡Ù€Ù€Ù€Ù€Ù€Ø² âœ…";
                            readyBtn.className = "w-full py-4 bg-blue-500 hover:bg-blue-600 rounded-xl text-white font-bold text-xl shadow-lg shadow-blue-500/50 animate-pulse transition";
                        }
                    }
                }

                const leaveBtn = document.getElementById('leaveBtn');
                if (window.isHost) {
                    leaveBtn.innerText = "Ø­Ø°Ù Ø§Ù„ØºØ±ÙØ© ğŸ—‘ï¸";
                    leaveBtn.onclick = async () => {
                        if(confirm("ØªØ­Ø°Ù Ø§Ù„ØºØ±ÙØ©ØŸ")) await deleteDoc(doc(db, "rooms", roomId));
                    }
                } else {
                    leaveBtn.innerText = "Ù…ØºØ§Ø¯Ø±Ø© ğŸƒ";
                    leaveBtn.onclick = () => leaveRoomUser();
                }

                if (data.status === 'waiting' && data.hostReady && data.guestReady && data.questions && data.questions.length > 0) {
                     await updateDoc(doc(db, "rooms", roomId), { status: 'playing' });
                }

                if (data.status === 'playing') {
                    document.getElementById('roomLobby').classList.add('hidden');
                    document.getElementById('gameArea').classList.remove('hidden');
                    if(!window.gameActive) startGame(data.questions);
                }

                if (window.isHost && data.hostReady && data.guestReady && (!data.questions || data.questions.length === 0)) {
                    fetchAndSetQuestions(roomId, data.subject);
                }
            }, (error) => {
                console.error("Room Listener Error:", error);
            });
        }

        function updateReadyStatus(elementId, isReady) {
            const el = document.getElementById(elementId);
            el.innerHTML = isReady 
                ? `<span class="text-green-500 font-bold text-lg flex items-center gap-2"><i class="fas fa-check-circle"></i> Ø¬Ø§Ù‡Ø²Ø©</span>`
                : `<span class="text-gray-500 font-bold text-lg">ØºÙŠØ± Ø¬Ø§Ù‡Ø²</span>`;
        }

        // --- FIXED TOGGLE READY FUNCTION ---
        async function toggleReady() {
            if(!window.currentRoomId) return;
            
            const btn = document.getElementById('readyBtn');
            // Save text to restore in case of error, though listener usually updates it
            const originalText = btn.innerText; 
            
            // 1. Loading State
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø§Ù†ØªØ¸Ø±...';
            btn.disabled = true;

            const roomRef = doc(db, "rooms", window.currentRoomId);
            
            try {
                // 2. Fetch fresh data to be absolutely sure of role
                const snap = await getDoc(roomRef);
                if (!snap.exists()) {
                    alert("Ø§Ù„ØºØ±ÙØ© Ø§Ø®ØªÙØª!");
                    btn.disabled = false;
                    return;
                }
                const data = snap.data();
                
                // 3. Determine Field dynamically
                const amIHost = (window.currentUser.uid === data.host);
                const field = amIHost ? 'hostReady' : 'guestReady';
                
                const currentVal = data[field];
                
                // 4. Update
                await updateDoc(roomRef, { [field]: !currentVal });
                
                // Success! Listener will update the UI. 
                // We keep it disabled for a split second to prevent double clicks until listener fires.
                setTimeout(() => { btn.disabled = false; }, 500);

            } catch(e) {
                console.error("Toggle Error:", e);
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£: " + e.message);
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        async function leaveRoomUser() {
            if(!window.currentRoomId) return;
            if(!confirm("ØªØ±ÙŠØ¯ ØªØºØ§Ø¯Ø±ØŸ")) return;

            try {
                await updateDoc(doc(db, "rooms", window.currentRoomId), {
                    guest: null,
                    guestName: null,
                    guestReady: false,
                    status: 'waiting'
                });
            } catch(e) { console.error(e); }
            
            leaveRoomLogic();
        }

        function leaveRoomLogic(forced = false) {
            if(window.unsubRoom) window.unsubRoom();
            window.currentRoomId = null;
            window.gameActive = false;
            document.getElementById('roomLobby').classList.add('hidden');
            document.getElementById('gameArea').classList.add('hidden');
            document.getElementById('challengesHome').classList.remove('hidden');
            if(!forced) alert("ØªÙ…Øª Ø§Ù„Ù…ØºØ§Ø¯Ø±Ø©");
        }

        // --- GAME LOGIC ---

        async function fetchAndSetQuestions(roomId, subject) {
            try {
                const qRef = collection(db, "questions");
                const qQuery = query(qRef, where("subject", "==", subject), where("approved", "==", true), limit(30));
                const snap = await getDocs(qQuery);
                
                let allQ = [];
                snap.forEach(d => allQ.push({id: d.id, ...d.data()}));
                
                if(allQ.length < 1) {
                    alert("Ù…Ø§ÙƒÙˆ Ø§Ø³Ø¦Ù„Ø© ÙƒØ§ÙÙŠØ© Ø¨Ù‡Ø§ÙŠ Ø§Ù„Ù…Ø§Ø¯Ø©!");
                    await updateDoc(doc(db, "rooms", roomId), { hostReady: false, guestReady: false }); 
                    return;
                }

                allQ = allQ.sort(() => 0.5 - Math.random()).slice(0, 10);

                await updateDoc(doc(db, "rooms", roomId), {
                    questions: allQ,
                    status: 'waiting' 
                });
            } catch (e) {
                console.error(e);
                alert("Ø®Ø·Ø£ Ø¨Ø¬Ù„Ø¨ Ø§Ù„Ø§Ø³Ø¦Ù„Ø©");
            }
        }

        window.gameActive = false;
        let currentQIndex = 0;
        let localScore = 0;
        let gameQuestions = [];

        function startGame(questions) {
            window.gameActive = true;
            gameQuestions = questions;
            currentQIndex = 0;
            localScore = 0;
            showQuestion();
        }

        function showQuestion() {
            if (currentQIndex >= gameQuestions.length) {
                endGame();
                return;
            }

            const q = gameQuestions[currentQIndex];
            document.getElementById('qCount').innerText = `Ø§Ù„Ø³Ø¤Ø§Ù„ ${currentQIndex + 1} / 10`;
            document.getElementById('gameQuestionText').innerText = q.text;
            
            document.getElementById('btnTrue').classList.remove('bg-green-600', 'bg-red-600', 'opacity-50', '!bg-green-600', '!bg-red-600');
            document.getElementById('btnFalse').classList.remove('bg-green-600', 'bg-red-600', 'opacity-50', '!bg-green-600', '!bg-red-600');
            document.getElementById('btnTrue').disabled = false;
            document.getElementById('btnFalse').disabled = false;

            let timeLeft = 15;
            document.getElementById('timerBar').style.width = '100%';
            document.getElementById('timerText').innerText = timeLeft + "Ø«";
            
            if(window.questionTimer) clearInterval(window.questionTimer);
            
            window.questionTimer = setInterval(() => {
                timeLeft--;
                const percent = (timeLeft / 15) * 100;
                document.getElementById('timerBar').style.width = `${percent}%`;
                document.getElementById('timerText').innerText = timeLeft + "Ø«";
                
                if (timeLeft <= 0) {
                    clearInterval(window.questionTimer);
                    handleAnswer(null); 
                }
            }, 1000);
        }

        window.handleAnswer = (userAnswer) => {
            clearInterval(window.questionTimer);
            const q = gameQuestions[currentQIndex];
            const correct = q.answer; 
            
            const btnTrue = document.getElementById('btnTrue');
            const btnFalse = document.getElementById('btnFalse');
            
            btnTrue.disabled = true;
            btnFalse.disabled = true;

            if (userAnswer === correct) {
                localScore++;
                if(userAnswer === true) btnTrue.classList.add('!bg-green-600');
                if(userAnswer === false) btnFalse.classList.add('!bg-green-600');
            } else if (userAnswer !== null) {
                if(userAnswer === true) btnTrue.classList.add('!bg-red-600');
                if(userAnswer === false) btnFalse.classList.add('!bg-red-600');
            }

            if(correct) btnTrue.classList.add('bg-green-600', 'bg-opacity-50');
            else btnFalse.classList.add('bg-green-600', 'bg-opacity-50');

            setTimeout(() => {
                currentQIndex++;
                showQuestion();
            }, 1500);
        };

        async function endGame() {
            window.gameActive = false;
            document.getElementById('gameArea').innerHTML = `
                <div class="flex flex-col items-center justify-center h-full text-center p-6 animate-pulse">
                    <i class="fas fa-trophy text-6xl text-yellow-400 mb-6"></i>
                    <h2 class="text-3xl font-bold text-white mb-2">Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø©!</h2>
                    <p class="text-gray-400 text-lg mb-6">Ø£Ø¯Ø§Ø¡ Ø¨Ø·ÙˆÙ„ÙŠ ğŸ’ª</p>
                    <div class="bg-slate-700 p-6 rounded-2xl w-full max-w-xs mb-8 border border-slate-600">
                        <span class="block text-gray-400 text-sm mb-1">Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</span>
                        <span class="text-5xl font-extrabold text-white">${localScore} <span class="text-2xl text-gray-500">/ 10</span></span>
                    </div>
                    <button onclick="resetToLobby()" class="w-full max-w-xs bg-blue-600 hover:bg-blue-700 text-white px-8 py-4 rounded-xl font-bold shadow-lg transition transform active:scale-95">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØºØ±ÙØ©</button>
                </div>
            `;
        }

        window.resetToLobby = async () => {
            document.getElementById('gameArea').classList.add('hidden');
            document.getElementById('roomLobby').classList.remove('hidden');
            
            document.getElementById('gameArea').innerHTML = `
                <div class="w-full bg-slate-800 rounded-2xl p-6 shadow-2xl border border-slate-700 relative overflow-hidden">
                    <div class="h-2 bg-slate-700 w-full absolute top-0 left-0">
                        <div id="timerBar" class="h-full bg-yellow-400 transition-all duration-1000 ease-linear" style="width: 100%;"></div>
                    </div>
                    <div class="flex justify-between text-gray-400 text-sm mt-4 mb-8">
                        <span id="qCount">Ø§Ù„Ø³Ø¤Ø§Ù„ 1 / 10</span>
                        <span id="timerText">15Ø«</span>
                    </div>
                    <h2 id="gameQuestionText" class="text-2xl text-white font-bold text-center mb-12 leading-relaxed h-32 flex items-center justify-center">
                        Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¤Ø§Ù„...
                    </h2>
                    <div class="space-y-4">
                        <button id="btnTrue" onclick="handleAnswer(true)" class="w-full bg-slate-700 hover:bg-slate-600 text-white py-4 rounded-xl text-xl font-bold transition-all border-2 border-transparent hover:border-green-500">
                            ØµØ­ <i class="fas fa-check ml-2"></i>
                        </button>
                        <button id="btnFalse" onclick="handleAnswer(false)" class="w-full bg-slate-700 hover:bg-slate-600 text-white py-4 rounded-xl text-xl font-bold transition-all border-2 border-transparent hover:border-red-500">
                            Ø®Ø·Ø£ <i class="fas fa-times ml-2"></i>
                        </button>
                    </div>
                </div>
            `;

            if (window.currentRoomId) {
                // Determine field again to be safe
                const roomRef = doc(db, "rooms", window.currentRoomId);
                const snap = await getDoc(roomRef);
                if(snap.exists()) {
                     const data = snap.data();
                     const amIHost = (window.currentUser.uid === data.host);
                     const field = amIHost ? 'hostReady' : 'guestReady';
                     await updateDoc(roomRef, { [field]: false, status: 'waiting' });
                }
            }
        };

    </script>

    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #0f172a; /* Slate 900 */
            color: white;
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
            overscroll-behavior: none;
        }
        
        ::-webkit-scrollbar {
            width: 0px;
            background: transparent;
        }

        .modal-enter {
            animation: slideUp 0.3s ease-out forwards;
        }

        @keyframes slideUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .avatar-ring {
            background: linear-gradient(45deg, #3b82f6, #8b5cf6);
        }
    </style>
</head>
<body class="h-screen w-screen overflow-hidden flex flex-col">

    <!-- AUTH SECTION -->
    <div id="authSection" class="flex-1 flex flex-col items-center justify-center p-6 space-y-6 bg-slate-900 z-50">
        <div class="text-center animate-bounce">
            <h1 class="text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-600 mb-2">Ù‡ÙƒØ± Ø§Ù„ÙˆØ²Ø§Ø±ÙŠ</h1>
            <p class="text-gray-400 text-lg">ØªØ­Ø¯Ù‰ Ø£ØµØ¯Ù‚Ø§Ø¦Ùƒ ÙˆØ§Ø¶Ù…Ù† Ø§Ù„Ù†Ø¬Ø§Ø­ ğŸ“</p>
        </div>

        <div class="w-full max-w-sm space-y-4 bg-slate-800 p-6 rounded-3xl shadow-2xl border border-slate-700 relative overflow-hidden">
            <div class="absolute top-0 right-0 w-20 h-20 bg-blue-500 blur-3xl opacity-20 pointer-events-none"></div>

            <div class="flex bg-slate-700 rounded-xl p-1 mb-6">
                <button onclick="document.getElementById('signupFields').classList.add('hidden'); document.getElementById('btnSubmitAuth').onclick = () => handleAuth('login'); document.getElementById('btnSubmitAuth').innerText = 'Ø¯Ø®ÙˆÙ„'; this.classList.add('bg-slate-600', 'shadow'); this.nextElementSibling.classList.remove('bg-slate-600', 'shadow');" class="flex-1 py-3 rounded-lg text-sm font-bold bg-slate-600 shadow transition-all duration-300">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</button>
                <button onclick="document.getElementById('signupFields').classList.remove('hidden'); document.getElementById('btnSubmitAuth').onclick = () => handleAuth('signup'); document.getElementById('btnSubmitAuth').innerText = 'Ø§Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨'; this.classList.add('bg-slate-600', 'shadow'); this.previousElementSibling.classList.remove('bg-slate-600', 'shadow');" class="flex-1 py-3 rounded-lg text-sm font-bold transition-all duration-300">Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</button>
            </div>

            <div id="signupFields" class="hidden">
                <input type="text" id="username" placeholder="Ø§Ø³Ù…Ùƒ Ø¨Ø§Ù„Ù„Ø¹Ø¨Ø©" class="w-full bg-slate-900 border border-slate-600 rounded-xl p-4 text-white focus:outline-none focus:border-blue-500 mb-3 transition">
            </div>
            <input type="email" id="email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø§Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" class="w-full bg-slate-900 border border-slate-600 rounded-xl p-4 text-white focus:outline-none focus:border-blue-500 mb-3 transition">
            <input type="password" id="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" class="w-full bg-slate-900 border border-slate-600 rounded-xl p-4 text-white focus:outline-none focus:border-blue-500 transition">
            
            <p id="authError" class="text-red-500 text-sm text-center font-bold min-h-[20px]"></p>

            <button id="btnSubmitAuth" onclick="handleAuth('login')" class="w-full bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white font-bold py-4 rounded-xl shadow-lg transition transform active:scale-95 text-lg">Ø¯Ø®ÙˆÙ„</button>
        </div>
    </div>

    <!-- APP SECTION -->
    <div id="appSection" class="hidden h-full flex flex-col">
        <header class="p-4 flex justify-between items-center bg-slate-800 shadow-lg z-10 border-b border-slate-700">
            <div class="flex items-center gap-3">
                <div class="w-12 h-12 rounded-full bg-gradient-to-tr from-blue-500 to-purple-600 flex items-center justify-center font-bold text-xl shadow-lg border-2 border-slate-700">
                    <i class="fas fa-user-astronaut"></i>
                </div>
                <div>
                    <h2 id="userNameDisplay" class="font-bold text-lg leading-none mb-1">...</h2>
                    <span class="text-xs text-green-400 bg-green-400/10 px-2 py-0.5 rounded-full border border-green-400/20">Ù…ØªØµÙ„ <i class="fas fa-wifi text-[8px] ml-1"></i></span>
                </div>
            </div>
            <button onclick="logout()" class="text-red-400 hover:bg-red-500/10 p-3 rounded-full transition"><i class="fas fa-sign-out-alt text-xl"></i></button>
        </header>

        <main class="flex-1 overflow-y-auto p-4 pb-28 relative scroll-smooth">
            
            <div id="challengesTab" class="tab-content h-full">
                <div id="challengesHome" class="space-y-6 mt-6">
                    <div class="bg-gradient-to-br from-indigo-900 to-slate-800 p-6 rounded-3xl border border-indigo-500/30 text-center relative overflow-hidden">
                         <div class="absolute top-0 left-0 w-32 h-32 bg-blue-500 blur-[60px] opacity-20"></div>
                        <h2 class="text-3xl font-bold mb-2 text-white">Ø³Ø§Ø­Ø© Ø§Ù„ØªØ­Ø¯ÙŠ âš”ï¸</h2>
                        <p class="text-indigo-200 text-sm">Ø£Ø«Ø¨Øª Ø¬Ø¯Ø§Ø±ØªÙƒ ÙˆØªØ­Ø¯Ù‰ Ø§Ù„Ø·Ù„Ø§Ø¨</p>
                    </div>

                    <div class="grid grid-cols-1 gap-5">
                        <button onclick="showCreateModal()" class="group relative overflow-hidden bg-gradient-to-r from-blue-600 to-blue-800 p-8 rounded-3xl shadow-xl transform transition hover:scale-[1.02] active:scale-95 text-right border border-blue-500/30">
                            <div class="absolute left-0 top-0 h-full w-24 bg-white opacity-10 -skew-x-12 transform -translate-x-10 group-hover:translate-x-full transition duration-700"></div>
                            <div class="relative z-10">
                                <h3 class="text-2xl font-bold mb-2 text-white">Ø§Ù†Ø´Ø§Ø¡ ØºØ±ÙØ©</h3>
                                <p class="text-blue-100 text-sm">Ø³ÙˆÙŠ ØºØ±ÙØ© Ø®Ø§ØµØ© ÙˆØ´Ø§Ø±Ùƒ Ø§Ù„ÙƒÙˆØ¯</p>
                            </div>
                            <i class="fas fa-plus-circle absolute left-6 top-1/2 transform -translate-y-1/2 text-5xl text-blue-400/30 group-hover:text-blue-400/50 transition"></i>
                        </button>

                        <button onclick="showSearchModal()" class="group relative overflow-hidden bg-slate-800 border border-slate-600 p-8 rounded-3xl shadow-xl transform transition hover:scale-[1.02] active:scale-95 text-right">
                            <div class="relative z-10">
                                <h3 class="text-2xl font-bold mb-2 text-white">Ø¨Ø­Ø« Ø¹Ù† ØºØ±ÙØ©</h3>
                                <p class="text-gray-400 text-sm">Ø§Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ© ÙˆØ§Ù„Ø¹Ø¨ ÙÙˆØ±Ø§Ù‹</p>
                            </div>
                            <i class="fas fa-search absolute left-6 top-1/2 transform -translate-y-1/2 text-5xl text-slate-600 group-hover:text-slate-500 transition"></i>
                        </button>
                    </div>
                </div>

                <div id="roomLobby" class="hidden flex flex-col h-full justify-between pb-4">
                    <div class="bg-slate-800 rounded-3xl p-6 shadow-2xl border border-slate-700 relative mt-2">
                        <div class="flex justify-between items-start mb-8 border-b border-slate-700 pb-4">
                            <div id="roomStatusBadge" class="bg-slate-700 px-4 py-2 rounded-full text-sm font-bold">
                                0/2 Ø¬Ø§Ù‡Ø²Ø©
                            </div>
                            <div class="text-right">
                                <h2 class="text-yellow-400 font-bold text-xl mb-1 flex items-center gap-2 justify-end">
                                    ØºØ±ÙØ© Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø© <i class="fas fa-chess-board text-blue-500"></i>
                                </h2>
                                <p class="text-gray-400 text-xs">Ø±Ù‚Ù… Ø§Ù„ØºØ±ÙØ©</p>
                                <p id="displayRoomId" class="text-white font-mono text-2xl tracking-widest font-bold">------</p>
                            </div>
                        </div>

                        <div class="space-y-6">
                            <div class="flex items-center justify-between bg-slate-900/50 p-3 rounded-2xl border border-slate-700/50">
                                <div class="flex items-center gap-3">
                                    <div class="w-14 h-14 rounded-full avatar-ring p-0.5 shadow-lg">
                                        <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Felix" class="w-full h-full rounded-full bg-slate-900" alt="avatar">
                                    </div>
                                    <div>
                                        <h3 id="hostName" class="font-bold text-lg text-white">Ø§Ù„Ù…Ø§Ù„Ùƒ</h3>
                                        <span class="text-[10px] text-blue-300 bg-blue-900/50 px-2 py-0.5 rounded border border-blue-500/20">Ø§Ù„Ù…Ø§Ù„Ùƒ (HOST)</span>
                                    </div>
                                </div>
                                <div id="hostStatus"></div>
                            </div>

                            <div id="guestCard" class="flex items-center justify-between bg-slate-900/50 p-3 rounded-2xl border border-slate-700/50 opacity-50 transition-all duration-300">
                                <div class="flex items-center gap-3">
                                    <div class="w-14 h-14 rounded-full border-2 border-slate-600 p-0.5 shadow-lg">
                                        <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Aneka" class="w-full h-full rounded-full bg-slate-900" alt="avatar">
                                    </div>
                                    <div>
                                        <h3 id="guestName" class="font-bold text-lg text-white">...</h3>
                                        <span class="text-[10px] text-gray-500">Ø§Ù„Ù…Ù†Ø§ÙØ³</span>
                                    </div>
                                </div>
                                <div id="guestStatus"></div>
                            </div>
                        </div>

                        <div class="mt-8 text-center text-gray-500 text-xs bg-slate-900 py-2 rounded-lg">
                            <i class="fas fa-info-circle mr-1"></i> ÙŠØ¬Ø¨ Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ù…ÙŠØ¹ Ø¶ØºØ· "Ø¬Ø§Ù‡Ø²" Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©
                        </div>
                    </div>

                    <div class="flex gap-3 mt-4">
                        <button id="leaveBtn" class="flex-1 py-4 bg-slate-800 text-red-400 hover:text-red-300 hover:bg-slate-700 rounded-2xl font-bold border border-slate-600 shadow-lg transition">Ù…ØºØ§Ø¯Ø±Ø©</button>
                        <button id="readyBtn" onclick="toggleReady()" class="flex-[2] py-4 bg-blue-600 hover:bg-blue-500 rounded-2xl text-white font-bold text-xl shadow-lg shadow-blue-900/50 transition transform active:scale-95">
                            Ø¬Ù€Ù€Ù€Ù€Ù€Ø§Ù‡Ù€Ù€Ù€Ù€Ù€Ø²
                        </button>
                    </div>
                </div>

                <div id="gameArea" class="hidden h-full flex items-center justify-center p-2">
                    <div class="w-full bg-slate-800 rounded-3xl p-6 shadow-2xl border border-slate-700 relative overflow-hidden">
                        <div class="h-2 bg-slate-700 w-full absolute top-0 left-0">
                            <div id="timerBar" class="h-full bg-yellow-400 transition-all duration-1000 ease-linear shadow-[0_0_10px_#facc15]" style="width: 100%;"></div>
                        </div>

                        <div class="flex justify-between text-gray-300 text-sm mt-6 mb-8 font-bold">
                            <span id="qCount" class="bg-slate-900 px-3 py-1 rounded-lg">Ø§Ù„Ø³Ø¤Ø§Ù„ 1 / 10</span>
                            <span id="timerText" class="bg-slate-900 px-3 py-1 rounded-lg text-yellow-400">15Ø«</span>
                        </div>

                        <h2 id="gameQuestionText" class="text-2xl text-white font-bold text-center mb-10 leading-relaxed h-32 flex items-center justify-center select-none">
                            Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¤Ø§Ù„...
                        </h2>

                        <div class="space-y-4">
                            <button id="btnTrue" onclick="handleAnswer(true)" class="w-full bg-slate-700 hover:bg-slate-600 text-white py-5 rounded-2xl text-2xl font-bold transition-all border-2 border-transparent hover:border-green-500 shadow-lg flex items-center justify-center gap-3">
                                ØµØ­ <i class="fas fa-check-circle text-green-400"></i>
                            </button>
                            <button id="btnFalse" onclick="handleAnswer(false)" class="w-full bg-slate-700 hover:bg-slate-600 text-white py-5 rounded-2xl text-2xl font-bold transition-all border-2 border-transparent hover:border-red-500 shadow-lg flex items-center justify-center gap-3">
                                Ø®Ø·Ø£ <i class="fas fa-times-circle text-red-400"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="uploadTab" class="hidden tab-content p-2 pt-6">
                <div class="bg-slate-800 p-6 rounded-3xl border border-slate-700 shadow-2xl space-y-5">
                     <div class="text-center mb-4">
                        <div class="inline-block p-3 rounded-full bg-blue-900/30 text-blue-400 mb-2"><i class="fas fa-pen-nib text-2xl"></i></div>
                        <h2 class="text-xl font-bold text-white">Ø³Ø§Ù‡Ù… ÙÙŠ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</h2>
                        <p class="text-gray-400 text-xs">Ø³Ø¤Ø§Ù„Ùƒ Ø±Ø§Ø­ ÙŠØ¸Ù‡Ø± Ù„ÙƒÙ„ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø¨Ø¹Ø¯ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©</p>
                    </div>

                    <div>
                        <label class="block text-gray-300 text-sm font-bold mb-2">Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©</label>
                        <div class="relative">
                            <select id="qSubject" class="w-full bg-slate-900 border border-slate-600 rounded-xl p-4 text-white appearance-none focus:border-blue-500 focus:outline-none">
                                <option value="Ø§Ø³Ù„Ø§Ù…ÙŠØ©">ğŸ“– Ø§Ø³Ù„Ø§Ù…ÙŠØ©</option>
                                <option value="Ø¹Ø±Ø¨ÙŠ">ğŸ“œ Ø¹Ø±Ø¨ÙŠ</option>
                                <option value="Ø§Ù†ÙƒÙ„ÙŠØ²ÙŠ">ğŸ…°ï¸ Ø§Ù†ÙƒÙ„ÙŠØ²ÙŠ</option>
                            </select>
                            <div class="absolute inset-y-0 left-0 flex items-center px-4 pointer-events-none text-gray-500">
                                <i class="fas fa-chevron-down"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-gray-300 text-sm font-bold mb-2">Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„</label>
                        <textarea id="qText" rows="4" class="w-full bg-slate-900 border border-slate-600 rounded-xl p-4 text-white focus:border-blue-500 focus:outline-none" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¨ÙˆØ¶ÙˆØ­ ÙˆØ¨Ø¯ÙˆÙ† Ø£Ø®Ø·Ø§Ø¡ Ø§Ù…Ù„Ø§Ø¦ÙŠØ©..."></textarea>
                    </div>

                    <div>
                        <label class="block text-gray-300 text-sm font-bold mb-2">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©</label>
                        <div class="flex gap-4">
                             <label class="flex-1 cursor-pointer">
                                <input type="radio" name="ans" id="radTrue" value="true" class="peer hidden" onchange="document.getElementById('qAnswer').value='true'" checked>
                                <div class="bg-slate-900 border border-slate-600 p-4 rounded-xl text-center peer-checked:bg-green-600 peer-checked:border-green-500 peer-checked:text-white transition">
                                    ØµØ­ <i class="fas fa-check ml-1"></i>
                                </div>
                            </label>
                            <label class="flex-1 cursor-pointer">
                                <input type="radio" name="ans" id="radFalse" value="false" class="peer hidden" onchange="document.getElementById('qAnswer').value='false'">
                                <div class="bg-slate-900 border border-slate-600 p-4 rounded-xl text-center peer-checked:bg-red-600 peer-checked:border-red-500 peer-checked:text-white transition">
                                    Ø®Ø·Ø£ <i class="fas fa-times ml-1"></i>
                                </div>
                            </label>
                            <input type="hidden" id="qAnswer" value="true">
                        </div>
                    </div>

                    <button id="btnSendQ" onclick="submitQuestion()" class="w-full bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white font-bold py-4 rounded-xl shadow-lg mt-2 transition transform active:scale-95">Ø§Ø±Ø³Ø§Ù„ Ø§Ù„Ø³Ø¤Ø§Ù„</button>
                </div>
            </div>

            <div id="adminPanel" class="hidden tab-content p-2 pt-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-red-400 bg-red-900/20 px-4 py-2 rounded-full border border-red-900/50"><i class="fas fa-shield-alt mr-2"></i>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h2>
                    <button onclick="loadPendingQuestions()" class="text-sm bg-slate-800 p-2 rounded-lg"><i class="fas fa-sync-alt"></i> ØªØ­Ø¯ÙŠØ«</button>
                </div>
                
                <div id="pendingQuestions" class="space-y-4 pb-20">
                    <!-- Loaded dynamically -->
                </div>
            </div>

        </main>

        <nav class="fixed bottom-0 w-full bg-slate-800/90 backdrop-blur-md border-t border-slate-700 p-3 flex justify-around z-40 pb-6 shadow-[0_-5px_20px_rgba(0,0,0,0.5)]">
            <button onclick="switchTab('challengesTab')" class="nav-btn flex-1 flex flex-col items-center p-2 rounded-2xl text-blue-500 bg-blue-900/20 transition-all duration-300">
                <i class="fas fa-gamepad text-2xl mb-1"></i>
                <span class="text-[10px] font-bold">Ø§Ù„ØªØ­Ø¯ÙŠØ§Øª</span>
            </button>
            <button onclick="switchTab('uploadTab')" class="nav-btn flex-1 flex flex-col items-center p-2 rounded-2xl text-gray-400 hover:text-gray-200 transition-all duration-300">
                <i class="fas fa-cloud-upload-alt text-2xl mb-1"></i>
                <span class="text-[10px] font-bold">Ø±ÙØ¹ Ø³Ø¤Ø§Ù„</span>
            </button>
            <button id="adminTab" onclick="switchTab('adminPanel')" class="hidden nav-btn flex-1 flex flex-col items-center p-2 rounded-2xl text-red-400 hover:text-red-300 transition-all duration-300">
                <i class="fas fa-shield-alt text-2xl mb-1"></i>
                <span class="text-[10px] font-bold">Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</span>
            </button>
        </nav>
    </div>

    <!-- MODALS -->

    <div id="createRoomModal" class="hidden fixed inset-0 z-[60] flex items-end sm:items-center justify-center bg-black/80 backdrop-blur-sm transition-opacity">
        <div class="bg-slate-800 w-full max-w-md p-8 rounded-t-[2.5rem] sm:rounded-[2.5rem] border-t sm:border border-slate-700 modal-enter shadow-2xl relative">
            <div class="absolute top-4 left-1/2 transform -translate-x-1/2 w-12 h-1.5 bg-slate-600 rounded-full sm:hidden"></div>
            
            <div class="flex justify-between items-center mb-8 mt-4 sm:mt-0">
                <h3 class="text-2xl font-bold text-white">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØºØ±ÙØ© âš™ï¸</h3>
                <button onclick="closeCreateModal()" class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center text-gray-400 hover:bg-slate-600 transition"><i class="fas fa-times"></i></button>
            </div>
            
            <label class="block text-gray-400 text-sm mb-3 font-bold">Ø§Ø®ØªØ± Ù…Ø§Ø¯Ø© Ø§Ù„ØªØ­Ø¯ÙŠ</label>
            <div class="relative mb-8">
                <select id="roomSubject" class="w-full bg-slate-900 border border-slate-600 rounded-2xl p-5 text-white text-lg appearance-none focus:border-blue-500 focus:outline-none shadow-inner">
                    <option value="Ø§Ø³Ù„Ø§Ù…ÙŠØ©">ğŸ“– Ø§Ø³Ù„Ø§Ù…ÙŠØ©</option>
                    <option value="Ø¹Ø±Ø¨ÙŠ">ğŸ“œ Ø¹Ø±Ø¨ÙŠ</option>
                    <option value="Ø§Ù†ÙƒÙ„ÙŠØ²ÙŠ">ğŸ…°ï¸ Ø§Ù†ÙƒÙ„ÙŠØ²ÙŠ</option>
                </select>
                <div class="absolute inset-y-0 left-0 flex items-center px-5 pointer-events-none text-gray-500">
                    <i class="fas fa-chevron-down"></i>
                </div>
            </div>

            <button id="btnCreateRoom" onclick="createRoom()" class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white font-bold py-5 rounded-2xl text-lg shadow-lg shadow-blue-600/30 transition transform active:scale-95">
                Ø§Ù„ØªØ§Ù„ÙŠ (Ø§Ù†Ø´Ø§Ø¡) <i class="fas fa-arrow-left mr-2"></i>
            </button>
        </div>
    </div>

    <div id="searchRoomModal" class="hidden fixed inset-0 z-[60] flex items-end sm:items-center justify-center bg-black/80 backdrop-blur-sm transition-opacity">
        <div class="bg-slate-800 w-full max-w-md p-8 rounded-t-[2.5rem] sm:rounded-[2.5rem] border-t sm:border border-slate-700 modal-enter shadow-2xl relative">
             <div class="absolute top-4 left-1/2 transform -translate-x-1/2 w-12 h-1.5 bg-slate-600 rounded-full sm:hidden"></div>

            <div class="flex justify-between items-center mb-8 mt-4 sm:mt-0">
                <h3 class="text-2xl font-bold text-white">Ø¯Ø®ÙˆÙ„ ØºØ±ÙØ© ğŸš€</h3>
                <button onclick="closeSearchModal()" class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center text-gray-400 hover:bg-slate-600 transition"><i class="fas fa-times"></i></button>
            </div>
            
            <label class="block text-gray-400 text-sm mb-3 font-bold">Ø§ÙŠØ¯ÙŠ Ø§Ù„ØºØ±ÙØ© (Ø§Ù„Ø±Ù‚Ù…)</label>
            <input type="number" id="roomIdInput" placeholder="Ù…Ø«Ø§Ù„: 582910" class="w-full bg-slate-900 border border-slate-600 rounded-2xl p-5 text-white text-2xl mb-8 tracking-[0.5em] text-center font-mono focus:border-green-500 focus:outline-none shadow-inner" style="direction: ltr;">

            <button id="btnJoinRoom" onclick="joinRoom()" class="w-full bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white font-bold py-5 rounded-2xl text-lg shadow-lg shadow-green-600/30 transition transform active:scale-95">
                Ø¨Ø­Ø« ÙˆØ¯Ø®ÙˆÙ„ <i class="fas fa-search mr-2"></i>
            </button>
        </div>
    </div>

</body>
</html>
